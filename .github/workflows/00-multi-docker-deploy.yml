name: ðŸ³ Multi-Docker Deploy | All Services
# PostgreSQL + Redis + Blacklist ì´ë¯¸ì§€ ë³€ê²½ ê°ì§€ ë° ìžë™ ë°°í¬

on:
  push:
    branches:
      - main
    paths:
      - 'docker/postgresql/**'
      - 'docker/redis/**'
      - '*.py'
      - 'main.py'
      - 'Dockerfile'
      - 'requirements*.txt'
      - 'package.json'
  workflow_dispatch:
    inputs:
      force_rebuild_all:
        description: 'Force rebuild all Docker images'
        required: false
        default: false
        type: boolean
      rebuild_postgresql:
        description: 'Force rebuild PostgreSQL'
        required: false
        default: false
        type: boolean
      rebuild_redis:
        description: 'Force rebuild Redis'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: registry.jclee.me
  REGISTRY_USER: admin
  REGISTRY_PASS: bingogo1

jobs:
  # ============================================
  # ìŠ¤ë§ˆíŠ¸ Docker ì´ë¯¸ì§€ ë³€ê²½ ê°ì§€
  # ============================================
  detect-docker-changes:
    name: "ðŸ” Multi-Docker Change Detection"
    runs-on: ubuntu-latest
    outputs:
      blacklist_changed: ${{ steps.changes.outputs.blacklist_changed }}
      postgresql_changed: ${{ steps.changes.outputs.postgresql_changed }}
      redis_changed: ${{ steps.changes.outputs.redis_changed }}
      any_changed: ${{ steps.changes.outputs.any_changed }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2
        
    - name: "ðŸ“Š Generate Version"
      id: version
      run: |
        # Package version from package.json + git commit count
        if [ -f package.json ]; then
          PACKAGE_VERSION=$(grep '"version"' package.json | head -1 | cut -d'"' -f4 || echo "1.0.0")
        else
          PACKAGE_VERSION="1.0.0"
        fi
        
        # Use the package version directly
        VERSION="$PACKAGE_VERSION"
        TIMESTAMP=$(date +%Y%m%d-%H%M)
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
        
        echo "ðŸ“¦ Build Version: $VERSION"
        echo "ðŸ• Timestamp: $TIMESTAMP"
        
    - name: "ðŸ” Smart Docker Change Detection"
      id: changes
      run: |
        echo "ðŸ” Docker ì´ë¯¸ì§€ ë³€ê²½ ê°ì§€ ì‹œìž‘..."
        
        # ì´ˆê¸°í™”
        BLACKLIST_CHANGED=false
        POSTGRESQL_CHANGED=false
        REDIS_CHANGED=false
        ANY_CHANGED=false
        
        # Manual íŠ¸ë¦¬ê±° í™•ì¸
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "ðŸ“Œ Manual trigger detected"
          
          if [ "${{ github.event.inputs.force_rebuild_all }}" = "true" ]; then
            echo "ðŸ”¨ Force rebuild all requested"
            BLACKLIST_CHANGED=true
            POSTGRESQL_CHANGED=true
            REDIS_CHANGED=true
            ANY_CHANGED=true
          else
            if [ "${{ github.event.inputs.rebuild_postgresql }}" = "true" ]; then
              POSTGRESQL_CHANGED=true
              ANY_CHANGED=true
              echo "ðŸ”¨ Force rebuild PostgreSQL"
            fi
            if [ "${{ github.event.inputs.rebuild_redis }}" = "true" ]; then
              REDIS_CHANGED=true
              ANY_CHANGED=true
              echo "ðŸ”¨ Force rebuild Redis"
            fi
          fi
        else
          # ë³€ê²½ëœ íŒŒì¼ ê°ì§€
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          
          if [ -n "$CHANGED_FILES" ]; then
            echo "ðŸ“ Changes detected:"
            echo "$CHANGED_FILES"
            echo ""
            
            # Blacklist ì•± ë³€ê²½ ê°ì§€
            if echo "$CHANGED_FILES" | grep -q "\.py$\|^main\.py\|Dockerfile\|requirements.*\.txt\|package\.json"; then
              BLACKLIST_CHANGED=true
              ANY_CHANGED=true
              echo "âœ… Blacklist: ë³€ê²½ ê°ì§€ë¨"
            fi
            
            # PostgreSQL ë³€ê²½ ê°ì§€
            if echo "$CHANGED_FILES" | grep -q "docker/postgresql/"; then
              POSTGRESQL_CHANGED=true
              ANY_CHANGED=true
              echo "âœ… PostgreSQL: ë³€ê²½ ê°ì§€ë¨"
            fi
            
            # Redis ë³€ê²½ ê°ì§€  
            if echo "$CHANGED_FILES" | grep -q "docker/redis/"; then
              REDIS_CHANGED=true
              ANY_CHANGED=true
              echo "âœ… Redis: ë³€ê²½ ê°ì§€ë¨"
            fi
          else
            echo "â„¹ï¸ No relevant changes detected"
          fi
        fi
        
        # ì¶œë ¥ ì„¤ì •
        echo "blacklist_changed=$BLACKLIST_CHANGED" >> $GITHUB_OUTPUT
        echo "postgresql_changed=$POSTGRESQL_CHANGED" >> $GITHUB_OUTPUT
        echo "redis_changed=$REDIS_CHANGED" >> $GITHUB_OUTPUT
        echo "any_changed=$ANY_CHANGED" >> $GITHUB_OUTPUT
        
        # ìš”ì•½
        echo ""
        echo "ðŸ“Š Docker Change Detection Summary:"
        echo "  Blacklist: $BLACKLIST_CHANGED"
        echo "  PostgreSQL: $POSTGRESQL_CHANGED" 
        echo "  Redis: $REDIS_CHANGED"
        echo "  Any Changed: $ANY_CHANGED"

  # ============================================
  # Blacklist ì•± ë¹Œë“œ ë° í‘¸ì‹œ
  # ============================================
  build-blacklist:
    name: "ðŸ›¡ï¸ Build Blacklist App"
    needs: detect-docker-changes
    if: needs.detect-docker-changes.outputs.blacklist_changed == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: "ðŸ³ Login to Registry"
      run: |
        echo "${{ env.REGISTRY_PASS }}" | docker login ${{ env.REGISTRY }} -u ${{ env.REGISTRY_USER }} --password-stdin
    
    - name: "ðŸ—ï¸ Build & Push Blacklist"
      run: |
        VERSION="${{ needs.detect-docker-changes.outputs.version }}"
        TIMESTAMP="${{ needs.detect-docker-changes.outputs.timestamp }}"
        
        echo "ðŸ›¡ï¸ Building Blacklist v$VERSION..."
        
        # ë©€í‹° íƒœê·¸ ë¹Œë“œ
        docker build -t ${{ env.REGISTRY }}/blacklist:latest \
          -t ${{ env.REGISTRY }}/blacklist:$VERSION \
          -t ${{ env.REGISTRY }}/blacklist:$TIMESTAMP \
          --build-arg BUILD_VERSION=$VERSION \
          --build-arg BUILD_NUMBER=${{ github.run_number }} \
          --build-arg COMMIT_SHA=${{ github.sha }} \
          --label "com.centurylinklabs.watchtower.enable=true" \
          .
        
        echo "ðŸ“¤ Pushing Blacklist images..."
        docker push ${{ env.REGISTRY }}/blacklist:latest
        docker push ${{ env.REGISTRY }}/blacklist:$VERSION
        docker push ${{ env.REGISTRY }}/blacklist:$TIMESTAMP
        
        echo "âœ… Blacklist build & push completed"

  # ============================================
  # PostgreSQL ë¹Œë“œ ë° í‘¸ì‹œ
  # ============================================
  build-postgresql:
    name: "ðŸ˜ Build PostgreSQL"
    needs: detect-docker-changes
    if: needs.detect-docker-changes.outputs.postgresql_changed == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: "ðŸ³ Login to Registry"
      run: |
        echo "${{ env.REGISTRY_PASS }}" | docker login ${{ env.REGISTRY }} -u ${{ env.REGISTRY_USER }} --password-stdin
    
    - name: "ðŸ—ï¸ Build & Push PostgreSQL"
      run: |
        VERSION="${{ needs.detect-docker-changes.outputs.version }}"
        TIMESTAMP="${{ needs.detect-docker-changes.outputs.timestamp }}"
        
        echo "ðŸ˜ Building Custom PostgreSQL v$VERSION..."
        
        # PostgreSQL ë¹Œë“œ (docker/postgresql ë””ë ‰í† ë¦¬ì—ì„œ)
        docker build -t ${{ env.REGISTRY }}/blacklist-postgresql:latest \
          -t ${{ env.REGISTRY }}/blacklist-postgresql:$VERSION \
          -t ${{ env.REGISTRY }}/blacklist-postgresql:$TIMESTAMP \
          --label "com.centurylinklabs.watchtower.enable=true" \
          ./docker/postgresql/
        
        echo "ðŸ“¤ Pushing PostgreSQL images..."
        docker push ${{ env.REGISTRY }}/blacklist-postgresql:latest
        docker push ${{ env.REGISTRY }}/blacklist-postgresql:$VERSION
        docker push ${{ env.REGISTRY }}/blacklist-postgresql:$TIMESTAMP
        
        echo "âœ… PostgreSQL build & push completed"

  # ============================================
  # Redis ë¹Œë“œ ë° í‘¸ì‹œ
  # ============================================
  build-redis:
    name: "ðŸŸ¥ Build Redis"
    needs: detect-docker-changes
    if: needs.detect-docker-changes.outputs.redis_changed == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: "ðŸ³ Login to Registry"
      run: |
        echo "${{ env.REGISTRY_PASS }}" | docker login ${{ env.REGISTRY }} -u ${{ env.REGISTRY_USER }} --password-stdin
    
    - name: "ðŸ—ï¸ Build & Push Redis"
      run: |
        VERSION="${{ needs.detect-docker-changes.outputs.version }}"
        TIMESTAMP="${{ needs.detect-docker-changes.outputs.timestamp }}"
        
        echo "ðŸŸ¥ Building Custom Redis v$VERSION..."
        
        # Redis ë¹Œë“œ (docker/redis ë””ë ‰í† ë¦¬ì—ì„œ)
        docker build -t ${{ env.REGISTRY }}/blacklist-redis:latest \
          -t ${{ env.REGISTRY }}/blacklist-redis:$VERSION \
          -t ${{ env.REGISTRY }}/blacklist-redis:$TIMESTAMP \
          --label "com.centurylinklabs.watchtower.enable=true" \
          ./docker/redis/
        
        echo "ðŸ“¤ Pushing Redis images..."
        docker push ${{ env.REGISTRY }}/blacklist-redis:latest
        docker push ${{ env.REGISTRY }}/blacklist-redis:$VERSION
        docker push ${{ env.REGISTRY }}/blacklist-redis:$TIMESTAMP
        
        echo "âœ… Redis build & push completed"

  # ============================================
  # Watchtower ì•Œë¦¼ (ìžë™ ë°°í¬ íŠ¸ë¦¬ê±°)
  # ============================================
  notify-watchtower:
    name: "ðŸ¤– Notify Watchtower for Auto-Deploy"
    needs: [detect-docker-changes, build-blacklist, build-postgresql, build-redis]
    if: always() && needs.detect-docker-changes.outputs.any_changed == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: "ðŸ“¢ Watchtower Update Notification"
      run: |
        echo "ðŸ¤– Docker ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ì™„ë£Œ - Watchtower ìžë™ ë°°í¬ ëŒ€ê¸° ì¤‘..."
        
        # ì—…ë°ì´íŠ¸ëœ ì´ë¯¸ì§€ ëª©ë¡
        UPDATED_IMAGES=""
        
        if [ "${{ needs.detect-docker-changes.outputs.blacklist_changed }}" = "true" ] && [ "${{ needs.build-blacklist.result }}" = "success" ]; then
          UPDATED_IMAGES="$UPDATED_IMAGES\n  âœ… blacklist:latest"
        fi
        
        if [ "${{ needs.detect-docker-changes.outputs.postgresql_changed }}" = "true" ] && [ "${{ needs.build-postgresql.result }}" = "success" ]; then
          UPDATED_IMAGES="$UPDATED_IMAGES\n  âœ… blacklist-postgresql:latest"
        fi
        
        if [ "${{ needs.detect-docker-changes.outputs.redis_changed }}" = "true" ] && [ "${{ needs.build-redis.result }}" = "success" ]; then
          UPDATED_IMAGES="$UPDATED_IMAGES\n  âœ… blacklist-redis:latest"
        fi
        
        echo "ðŸ“¦ Updated Images:"
        echo -e "$UPDATED_IMAGES"
        echo ""
        echo "ðŸ¤– Watchtower will automatically detect and deploy these updated images"
        echo "ðŸ• Expected deployment time: 1-3 minutes"
        echo "ðŸŒ Monitor at: https://blacklist.jclee.me/health"

  # ============================================
  # ìš”ì•½ ë¦¬í¬íŠ¸
  # ============================================
  summary:
    name: "ðŸ“Š Multi-Docker Deploy Summary"
    needs: [detect-docker-changes, build-blacklist, build-postgresql, build-redis, notify-watchtower]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: "ðŸ“Š Generate Multi-Docker Summary"
      run: |
        echo "# ðŸ³ Multi-Docker Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸ“¦ Docker Images Status" >> $GITHUB_STEP_SUMMARY
        echo "| Image | Changed | Build Status | Version |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|---------|--------------|---------|" >> $GITHUB_STEP_SUMMARY
        
        # Blacklist ìƒíƒœ
        if [ "${{ needs.detect-docker-changes.outputs.blacklist_changed }}" = "true" ]; then
          if [ "${{ needs.build-blacklist.result }}" = "success" ]; then
            echo "| ðŸ›¡ï¸ Blacklist | âœ… Changed | âœ… Built & Pushed | ${{ needs.detect-docker-changes.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ›¡ï¸ Blacklist | âœ… Changed | âŒ Build Failed | - |" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "| ðŸ›¡ï¸ Blacklist | â­ï¸ No Changes | - | - |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # PostgreSQL ìƒíƒœ
        if [ "${{ needs.detect-docker-changes.outputs.postgresql_changed }}" = "true" ]; then
          if [ "${{ needs.build-postgresql.result }}" = "success" ]; then
            echo "| ðŸ˜ PostgreSQL | âœ… Changed | âœ… Built & Pushed | ${{ needs.detect-docker-changes.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ˜ PostgreSQL | âœ… Changed | âŒ Build Failed | - |" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "| ðŸ˜ PostgreSQL | â­ï¸ No Changes | - | - |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Redis ìƒíƒœ  
        if [ "${{ needs.detect-docker-changes.outputs.redis_changed }}" = "true" ]; then
          if [ "${{ needs.build-redis.result }}" = "success" ]; then
            echo "| ðŸŸ¥ Redis | âœ… Changed | âœ… Built & Pushed | ${{ needs.detect-docker-changes.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸŸ¥ Redis | âœ… Changed | âŒ Build Failed | - |" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "| ðŸŸ¥ Redis | â­ï¸ No Changes | - | - |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“Œ Deployment Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Registry:** ${{ env.REGISTRY }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** ${{ needs.detect-docker-changes.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Number:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Auto Deploy:** Watchtower ðŸ¤–" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸŒ Access & Monitoring" >> $GITHUB_STEP_SUMMARY
        echo "- **Production:** https://blacklist.jclee.me/" >> $GITHUB_STEP_SUMMARY
        echo "- **Health Check:** https://blacklist.jclee.me/health" >> $GITHUB_STEP_SUMMARY
        echo "- **Registry:** https://registry.jclee.me/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ì„±ê³µ ì—¬ë¶€
        SUCCESS_COUNT=0
        TOTAL_BUILDS=0
        
        if [ "${{ needs.detect-docker-changes.outputs.blacklist_changed }}" = "true" ]; then
          TOTAL_BUILDS=$((TOTAL_BUILDS + 1))
          if [ "${{ needs.build-blacklist.result }}" = "success" ]; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          fi
        fi
        
        if [ "${{ needs.detect-docker-changes.outputs.postgresql_changed }}" = "true" ]; then
          TOTAL_BUILDS=$((TOTAL_BUILDS + 1))
          if [ "${{ needs.build-postgresql.result }}" = "success" ]; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          fi
        fi
        
        if [ "${{ needs.detect-docker-changes.outputs.redis_changed }}" = "true" ]; then
          TOTAL_BUILDS=$((TOTAL_BUILDS + 1))
          if [ "${{ needs.build-redis.result }}" = "success" ]; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          fi
        fi
        
        if [ "$TOTAL_BUILDS" -eq 0 ]; then
          echo "## â„¹ï¸ No builds required - No changes detected" >> $GITHUB_STEP_SUMMARY
        elif [ "$SUCCESS_COUNT" -eq "$TOTAL_BUILDS" ]; then
          echo "## ðŸŽ‰ All Docker Builds: SUCCESS ($SUCCESS_COUNT/$TOTAL_BUILDS)" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âš ï¸ Docker Builds: PARTIAL SUCCESS ($SUCCESS_COUNT/$TOTAL_BUILDS)" >> $GITHUB_STEP_SUMMARY
        fi