name: Quick Offline Build

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'requirements.txt'
      - 'Dockerfile'
      - 'src/**'

jobs:
  quick-build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build offline package
      run: |
        # Create package structure
        mkdir -p offline-pkg/{wheels,src,scripts}
        
        # Download dependencies
        pip download -r requirements.txt -d offline-pkg/wheels/
        
        # Copy essential files
        cp -r src templates static main.py init_database.py requirements.txt offline-pkg/
        cp .env.example offline-pkg/.env
        
        # Create simple installer
        cat > offline-pkg/install.sh << 'SCRIPT'
        #!/bin/bash
        python3 -m venv venv
        source venv/bin/activate
        pip install --no-index --find-links=wheels -r requirements.txt
        python init_database.py
        echo "Ready! Run: python main.py"
        SCRIPT
        chmod +x offline-pkg/install.sh
        
        # Package it
        tar -czf blacklist-offline-$(date +%Y%m%d).tar.gz offline-pkg/
        
    - name: Upload package
      uses: actions/upload-artifact@v3
      with:
        name: offline-package-quick
        path: blacklist-offline-*.tar.gz
        retention-days: 7