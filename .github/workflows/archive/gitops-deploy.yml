name: GitOps Deploy Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  gitops-deploy:
    runs-on: self-hosted  # jclee.me self-hosted runner ÏÇ¨Ïö©
    
    steps:
    - uses: actions/checkout@v4
      
    - name: üè∑Ô∏è Generate Immutable Tag
      id: tag
      run: |
        TAG=$(date +%Y%m%d-%H%M%S)-$(git rev-parse --short HEAD)
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "üì¶ Immutable Tag: $TAG"
        
    - name: üê≥ Build & Push Docker Image  
      run: |
        PROJECT_NAME=$(basename $(pwd))
        docker build -t registry.jclee.me/$PROJECT_NAME:${{ steps.tag.outputs.tag }} .
        docker login registry.jclee.me -u admin -p bingogo1
        docker push registry.jclee.me/$PROJECT_NAME:${{ steps.tag.outputs.tag }}
        
    - name: üîß Update GitOps Manifest
      run: |
        PROJECT_NAME=$(basename $(pwd))
        sed -i "s|image: registry.jclee.me/$PROJECT_NAME:.*|image: registry.jclee.me/$PROJECT_NAME:${{ steps.tag.outputs.tag }}|" deployment.yaml
        
    - name: üìù Commit GitOps Changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add deployment.yaml
        git commit -m "feat(gitops): ÏûêÎèô Î∞∞Ìè¨ - ${{ steps.tag.outputs.tag }}" || exit 0
        git push
        
    - name: üöÄ ArgoCD Sync
      run: |
        PROJECT_NAME=$(basename $(pwd))
        ARGOCD_TOKEN="eyJhbGciOiJSUzI1NiIsImtpZCI6Ikxobzd5NUhuUmV0S0pJQTkwN1F5dUZtcDdUeXlKRTdSX2t6NGo0ZWlmUUUifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiLCJrM3MiXSwiZXhwIjoxNzU3NDY0NzIzLCJpYXQiOjE3NTQ4NzI3MjMsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwianRpIjoiNzY1NzY4ODAtOWExZC00MDBkLThhMTEtMzUzYjA2MTQ2MTRmIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJhcmdvY2QiLCJzZXJ2aWNlYWNjb3VudCI6eyJuYW1lIjoiYXJnb2NkLXNlcnZlciIsInVpZCI6IjNlYTBmZThmLTRkZDgtNGFjZS1hN2U0LTdhZDY3Mzg4NjVjZSJ9fSwibmJmIjoxNzU0ODcyNzIzLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6YXJnb2NkOmFyZ29jZC1zZXJ2ZXIifQ.YsMuZY-U8-1TS9OQcdozBT7smHcTZ1VYmYSsIr0x6v12ra0-ug-m_ya2u8ObXGWsfC3Xut0aMwqoXkfQAd3fvi6SytIaIhYfwmL49DVWb-J7X6dUDSK5dTDAUrW8RKswCHdCscwlubO7VmfSXazixkzy_WzqnAX3Bmv70qbMsi_1zRdu8odlQX32FPgODGC3WG4lCFQxAnXm8yKxKFVkHgOA7i_a37yhzms41Yh2d5x1gjSCWcIw6fWNGxmXRhIkxqkGer0lxN_IVsVAZOxVi1zI40wA55c9U45PK_lhTjQtVvLToexlg_DuAOJSJOemh1QkLhEux-fnwo_LdoGirg"
        argocd app sync $PROJECT_NAME \
          --server argo.jclee.me \
          --auth-token $ARGOCD_TOKEN \
          --grpc-web