name: Auto Retry Failed Deployment

on:
  workflow_run:
    workflows: ["Auto Deploy to Registry"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      force_retry:
        description: 'Force retry even if last run was successful'
        required: false
        type: boolean
        default: false

jobs:
  retry-if-failed:
    runs-on: self-hosted
    if: >
      github.event.workflow_run.conclusion == 'failure' ||
      (github.event_name == 'workflow_dispatch' && inputs.force_retry)
    
    steps:
    - name: Wait before retry
      run: |
        echo "üîÑ Previous deployment failed, waiting before retry..."
        echo "Failed workflow: ${{ github.event.workflow_run.html_url }}"
        echo "Failure reason: ${{ github.event.workflow_run.conclusion }}"
        sleep 30  # Wait 30 seconds before retry
        
    - name: Check workflow failure details
      run: |
        echo "üìä Analyzing failure details..."
        echo "Workflow ID: ${{ github.event.workflow_run.id }}"
        echo "Workflow name: ${{ github.event.workflow_run.name }}"
        echo "Branch: ${{ github.event.workflow_run.head_branch }}"
        echo "SHA: ${{ github.event.workflow_run.head_sha }}"
        echo "Created at: ${{ github.event.workflow_run.created_at }}"
        echo "Updated at: ${{ github.event.workflow_run.updated_at }}"
    
    - name: Trigger retry deployment
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const result = await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'main-deploy.yml',
            ref: '${{ github.event.workflow_run.head_branch || github.ref }}',
          });
          
          console.log('üîÑ Retry deployment triggered successfully');
          console.log('Workflow dispatch result:', result.status);
    
    - name: Notify retry attempt
      run: |
        echo "üîÑ AUTO-RETRY DEPLOYMENT INITIATED"
        echo "======================================="
        echo "Original failed run: ${{ github.event.workflow_run.html_url }}"
        echo "Retry triggered at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "Branch: ${{ github.event.workflow_run.head_branch }}"
        echo "Commit: ${{ github.event.workflow_run.head_sha }}"
        echo ""
        echo "‚è≥ Check workflow status:"
        echo "https://github.com/${{ github.repository }}/actions"
        echo ""
        echo "üéØ This auto-retry system helps ensure reliable deployments"
        echo "======================================="

  cleanup-failed-artifacts:
    runs-on: self-hosted
    if: github.event.workflow_run.conclusion == 'failure'
    
    steps:
    - name: Clean up failed deployment artifacts
      run: |
        echo "üßπ Cleaning up from failed deployment..."
        
        # Clean up any partial Docker builds
        docker builder prune -f || true
        
        # Remove any test containers that might be left running
        docker rm -f test-container test-redis test-postgres || true
        docker network rm test-network || true
        
        # Clean up build cache if corrupted
        rm -rf /tmp/.buildx-cache-corrupted || true
        
        # Clean up dangling images
        docker image prune -f || true
        
        echo "‚úÖ Cleanup completed"