name: Build and Deploy

permissions:
  contents: read
  packages: write

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: registry.jclee.me
  IMAGE_NAME: blacklist

jobs:
  # ë¹ ë¥¸ ì²´í¬ë“¤ì„ ë³‘ë ¬ë¡œ ì‹¤í–‰
  quality-checks:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
      
      - name: Python Syntax Check
        run: |
          echo "ðŸ” Running Python syntax checks..."
          python3 -m py_compile src/core/har_based_regtech_collector.py || echo "âš ï¸ Syntax issues in REGTECH collector"
          python3 -m py_compile src/core/har_based_secudium_collector.py || echo "âš ï¸ Syntax issues in SECUDIUM collector"
          python3 -m py_compile src/core/collection_manager.py || echo "âš ï¸ Syntax issues in collection manager"
          echo "âœ… Syntax checks completed"

      - name: Basic Security Check
        run: |
          echo "ðŸ”’ Running basic security checks..."
          # Check for hardcoded secrets
          if grep -r -E "(password|secret|key|token)\s*=\s*['\"][^'\"]*['\"]" --include="*.py" src/ 2>/dev/null; then
            echo "âš ï¸ Potential hardcoded secrets found!"
          else
            echo "âœ… No hardcoded secrets detected"
          fi
          echo "âœ… Security checks completed"

  # Docker ë¹Œë“œ ë° ë ˆì§€ìŠ¤íŠ¸ë¦¬ í‘¸ì‹œ
  build-and-push:
    needs: quality-checks
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      
      - name: Login to Docker Registry
        run: |
          echo "ðŸ” Logging into registry..."
          # Docker Hub ìžê²©ì¦ëª…ì„ registry.jclee.meì—ë„ ì‚¬ìš©
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login registry.jclee.me -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          echo "âœ… Registry login completed"
          
      - name: Build and Push Docker Image
        run: |
          echo "ðŸ”¨ Building Docker image..."
          
          # ë¹Œë“œ ì‹œê°„ê³¼ ì»¤ë°‹ ì •ë³´
          BUILD_TIME=$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')
          
          # Docker ì´ë¯¸ì§€ ë¹Œë“œ
          docker build \
            -f deployment/Dockerfile \
            --target production \
            --build-arg BUILD_TIME="$BUILD_TIME" \
            --build-arg GIT_COMMIT="${{ github.sha }}" \
            --build-arg GIT_BRANCH="${{ github.ref_name }}" \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            .
          
          echo "ðŸ“¤ Pushing to registry..."
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          
          echo "âœ… Build and push completed successfully!"

  # Watchtower ìžë™ ë°°í¬ ëŒ€ê¸° ë° ê²€ì¦
  verify-deployment:
    needs: build-and-push
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Trigger Watchtower Deployment
        run: |
          echo "ðŸ”” Triggering Watchtower deployment via webhook..."
          echo "ðŸ“¥ New image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          
          # Watchtower ì›¹í›… í˜¸ì¶œ
          WEBHOOK_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            https://watchtower.jclee.me/v1/update \
            -H "Authorization: Bearer MySuperSecretToken12345" \
            --connect-timeout 10 --max-time 30 2>&1 || echo "Failed")
          
          HTTP_CODE=$(echo "$WEBHOOK_RESPONSE" | tail -n1)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Watchtower webhook successful! Deployment triggered."
            # ì›¹í›… ì„±ê³µì‹œ ì§§ê²Œ ëŒ€ê¸°
            sleep 30
          else
            echo "âš ï¸ Watchtower webhook failed (HTTP: $HTTP_CODE)"
            echo "Response: $WEBHOOK_RESPONSE"
            echo "ðŸ”„ Falling back to polling deployment..."
            # ì›¹í›… ì‹¤íŒ¨ì‹œ ë” ê¸¸ê²Œ ëŒ€ê¸° (í´ë§ ë°©ì‹)
            sleep 90
          fi
          
          echo "âœ… Watchtower deployment initiated"

      - name: Verify Deployment
        run: |
          echo "ðŸ” Verifying deployment..."
          
          # ìµœëŒ€ 10ë²ˆ ì‹œë„ (5ë¶„)
          MAX_ATTEMPTS=30
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "ðŸ” Attempt $ATTEMPT/$MAX_ATTEMPTS: Testing application health..."
            
            # Health ì²´í¬
            if curl -f -s --connect-timeout 5 --max-time 10 "https://blacklist.jclee.me/health" > /dev/null 2>&1; then
              echo "âœ… Application is healthy!"
              break
            else
              echo "â³ Application not ready yet, waiting 10 seconds..."
              sleep 10
            fi
            
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "âŒ Application failed to become healthy"
              curl -v "https://blacklist.jclee.me/health" || true
              exit 1
            fi
          done

      - name: Smoke Tests
        run: |
          echo "ðŸ§ª Running smoke tests..."
          
          # í•µì‹¬ ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
          endpoints=(
            "https://blacklist.jclee.me/health"
            "https://blacklist.jclee.me/api/stats"
            "https://blacklist.jclee.me/api/collection/status"
            "https://blacklist.jclee.me/test"
          )
          
          for endpoint in "${endpoints[@]}"; do
            echo "Testing $endpoint..."
            if curl -f -s --max-time 10 "$endpoint" > /dev/null; then
              echo "âœ… $endpoint: OK"
            else
              echo "âŒ $endpoint: FAILED"
              # ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰ (ì¼ë¶€ ì—”ë“œí¬ì¸íŠ¸ëŠ” ì•„ì§ ë¬¸ì œê°€ ìžˆì„ ìˆ˜ ìžˆìŒ)
            fi
          done
          
          echo "âœ… Smoke tests completed!"

  # ë°°í¬ ì™„ë£Œ ì•Œë¦¼
  notify:
    needs: [build-and-push, verify-deployment]
    runs-on: self-hosted
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: Deployment Summary
        run: |
          echo "## ë°°í¬ ì™„ë£Œ ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ìƒíƒœ | ${{ needs.verify-deployment.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì´ë¯¸ì§€ | ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì»¤ë°‹ | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ë¸Œëžœì¹˜ | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | https://blacklist.jclee.me |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.verify-deployment.result }}" != "success" ]; then
            echo "âš ï¸ **ì£¼ì˜**: ë°°í¬ ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸŽ‰ **ì„±ê³µ**: ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!" >> $GITHUB_STEP_SUMMARY
          fi