name: Build Only

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Build target'
        required: true
        default: 'build'
        type: choice
        options:
        - build
        - test
        - deploy

env:
  REGISTRY: registry.jclee.me
  IMAGE_NAME: blacklist

jobs:
  build:
    if: github.event.inputs.target == 'build'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host
          config-inline: |
            [registry."registry.jclee.me"]
              http = true
              insecure = true
        
      - name: Login to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: qws941
          password: bingogo1l7!
        
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

  test:
    if: github.event.inputs.target == 'test'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Run tests
        run: |
          python3 -m pytest --version || echo "pytest not found"
          echo "âœ… Test completed"

  deploy:
    if: github.event.inputs.target == 'deploy'
    runs-on: self-hosted
    steps:
      - name: Deploy to production
        run: |
          echo "ðŸš€ Deploying to production..."
          ssh -o StrictHostKeyChecking=no -p 1111 docker@registry.jclee.me "
            docker pull registry.jclee.me/blacklist:latest
            docker stop blacklist-app || true
            docker rm blacklist-app || true
            docker run -d --name blacklist-app -p 2541:2541 \
              -e REGTECH_USERNAME=nextrade \
              -e REGTECH_PASSWORD=Sprtmxm1@3 \
              -e SECUDIUM_USERNAME=nextrade \
              -e SECUDIUM_PASSWORD=Sprtmxm1@3 \
              registry.jclee.me/blacklist:latest
          "
          echo "âœ… Deploy completed"