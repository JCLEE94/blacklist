name: CI/CD Pipeline - Charts GitOps

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '*.txt'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# ë™ì‹œ ì‹¤í–‰ ì œì–´
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: registry.jclee.me
  IMAGE_NAME: blacklist
  PYTHON_VERSION: '3.11'
  CHARTS_REPO: ${{ vars.CHARTS_REPO || 'https://github.com/jclee/charts.git' }}
  CHARTS_PATH: charts/blacklist

jobs:
  # 1. ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  quality-check:
    name: Quality Check
    runs-on: self-hosted
    outputs:
      quality-passed: ${{ steps.result.outputs.passed }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 black isort mypy bandit safety

      - name: Run Linting
        continue-on-error: true
        run: |
          echo "ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì‹¤í–‰..."
          flake8 src/ --max-line-length=88 --extend-ignore=E203,W503 --exit-zero
          black --check src/ --diff || echo "âš ï¸ Black formatting issues found"
          isort src/ --check-only --diff || echo "âš ï¸ Import sorting issues found"
          mypy src/ --ignore-missing-imports --no-error-summary || echo "âš ï¸ Type checking issues found"

      - name: Run Security Scan
        continue-on-error: true
        run: |
          echo "ğŸ”’ ë³´ì•ˆ ìŠ¤ìº” ì‹¤í–‰..."
          bandit -r src/ -ll || echo "âš ï¸ Security issues found"
          safety check || echo "âš ï¸ Dependency vulnerabilities found"

      - name: Set Result
        id: result
        run: echo "passed=true" >> $GITHUB_OUTPUT

  # 2. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  test:
    name: Run Tests
    runs-on: self-hosted
    needs: quality-check
    outputs:
      test-passed: ${{ steps.result.outputs.passed }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-mock

      - name: Run Unit Tests
        continue-on-error: true
        run: |
          echo "ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
          pytest tests/ -v --cov=src --cov-report=term-missing || echo "âš ï¸ Some tests failed"

      - name: Run Integration Tests
        continue-on-error: true
        run: |
          echo "ğŸ”— í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
          python -m pytest tests/integration/ -v || echo "âš ï¸ Integration tests failed"

      - name: Set Result
        id: result
        run: echo "passed=true" >> $GITHUB_OUTPUT

  # 3. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
  build-image:
    name: Build & Push Docker Image
    runs-on: self-hosted
    needs: [quality-check, test]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
      short-sha: ${{ steps.vars.outputs.short-sha }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set Variables
        id: vars
        run: |
          echo "short-sha=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          echo "timestamp=$(date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2
        with:
          driver-opts: network=host
          config-inline: |
            [registry."registry.jclee.me"]
              http = true
              insecure = true

      - name: Login to Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME || 'admin' }}
          password: ${{ secrets.REGISTRY_PASSWORD || 'bingogo1' }}

      - name: Generate Metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=sha-,format=short
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ steps.vars.outputs.timestamp }}

      - name: Build and Push Image
        id: build
        uses: docker/build-push-action@v4
        with:
          context: .
          file: deployment/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_COMMIT=${{ github.sha }}
            VERSION=${{ steps.vars.outputs.short-sha }}

      - name: Image Security Scan
        continue-on-error: true
        run: |
          echo "ğŸ” ì´ë¯¸ì§€ ë³´ì•ˆ ìŠ¤ìº”..."
          # Trivyë‚˜ ë‹¤ë¥¸ ì´ë¯¸ì§€ ìŠ¤ìº” ë„êµ¬ë¥¼ ì—¬ê¸°ì— ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.short-sha }}"

  # 4. Helm ì°¨íŠ¸ ì—…ë°ì´íŠ¸ (charts.jclee.me ë¦¬í¬ì§€í† ë¦¬)
  update-helm-chart:
    name: Update Helm Chart
    runs-on: self-hosted
    needs: build-image
    if: |
      github.ref == 'refs/heads/main' && 
      needs.build-image.result == 'success'
    outputs:
      chart-version: ${{ steps.update.outputs.chart-version }}
      pr-url: ${{ steps.update.outputs.pr-url }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Clone Charts Repository
        run: |
          echo "ğŸ“¦ Charts ë¦¬í¬ì§€í† ë¦¬ í´ë¡ ..."
          git clone ${{ env.CHARTS_REPO }} charts-repo
          cd charts-repo

      - name: Update Chart Values
        id: update
        run: |
          cd charts-repo
          
          # ì°¨íŠ¸ ë²„ì „ ìƒì„±
          CHART_VERSION="1.0.$(date +%Y%m%d%H%M%S)"
          IMAGE_TAG="sha-${{ needs.build-image.outputs.short-sha }}"
          
          echo "chart-version=$CHART_VERSION" >> $GITHUB_OUTPUT
          
          # values.yaml ì—…ë°ì´íŠ¸
          if [ -f "${{ env.CHARTS_PATH }}/values.yaml" ]; then
            echo "ğŸ“ values.yaml ì—…ë°ì´íŠ¸..."
            
            # ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
            sed -i "s|tag:.*|tag: \"$IMAGE_TAG\"|g" ${{ env.CHARTS_PATH }}/values.yaml
            
            # Chart.yaml ì—…ë°ì´íŠ¸
            sed -i "s|version:.*|version: $CHART_VERSION|g" ${{ env.CHARTS_PATH }}/Chart.yaml
            sed -i "s|appVersion:.*|appVersion: \"$IMAGE_TAG\"|g" ${{ env.CHARTS_PATH }}/Chart.yaml
            
            echo "âœ… ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
            echo "  - Chart Version: $CHART_VERSION"
            echo "  - Image Tag: $IMAGE_TAG"
          else
            echo "âŒ values.yaml not found at ${{ env.CHARTS_PATH }}/values.yaml"
            exit 1
          fi

      - name: Create Pull Request
        id: pr
        run: |
          cd charts-repo
          
          # ë¸Œëœì¹˜ ìƒì„±
          BRANCH_NAME="update-blacklist-$(date +%Y%m%d%H%M%S)"
          git checkout -b $BRANCH_NAME
          
          # ë³€ê²½ì‚¬í•­ ì»¤ë°‹
          git add .
          git commit -m "chore: update blacklist chart to ${{ steps.update.outputs.chart-version }}
          
          - Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ needs.build-image.outputs.short-sha }}
          - Commit: ${{ github.sha }}
          - Triggered by: ${{ github.actor }}"
          
          # í‘¸ì‹œ (GitHub í† í° ì‚¬ìš©)
          git remote set-url origin https://x-access-token:${{ secrets.CHARTS_REPO_TOKEN }}@github.com/jclee/charts.git
          git push origin $BRANCH_NAME
          
          # PR ìƒì„±
          PR_BODY="## Blacklist Chart Update
          
          **Image Details:**
          - Registry: ${{ env.REGISTRY }}
          - Image: ${{ env.IMAGE_NAME }}:sha-${{ needs.build-image.outputs.short-sha }}
          - Chart Version: ${{ steps.update.outputs.chart-version }}
          
          **Source Changes:**
          - Repository: ${{ github.repository }}
          - Commit: ${{ github.sha }}
          - Branch: ${{ github.ref_name }}
          - Author: ${{ github.actor }}
          
          **Build Info:**
          - Workflow: ${{ github.workflow }}
          - Run ID: ${{ github.run_id }}
          - Build Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          This PR was automatically created by the CI/CD pipeline."
          
          # GitHub CLIë¡œ PR ìƒì„±
          PR_URL=$(gh pr create \
            --title "chore: update blacklist chart to ${{ steps.update.outputs.chart-version }}" \
            --body "$PR_BODY" \
            --head $BRANCH_NAME \
            --base main \
            --repo jclee/charts || echo "")
          
          echo "pr-url=$PR_URL" >> $GITHUB_OUTPUT
          
          if [ -n "$PR_URL" ]; then
            echo "âœ… PR ìƒì„± ì™„ë£Œ: $PR_URL"
          else
            echo "âš ï¸ PR ìƒì„± ì‹¤íŒ¨, ìˆ˜ë™ìœ¼ë¡œ í™•ì¸ í•„ìš”"
          fi
        env:
          GH_TOKEN: ${{ secrets.CHARTS_REPO_TOKEN }}

  # 5. ArgoCD ë™ê¸°í™” ì•Œë¦¼
  notify-argocd:
    name: Notify ArgoCD
    runs-on: self-hosted
    needs: [build-image, update-helm-chart]
    if: |
      always() &&
      github.ref == 'refs/heads/main' &&
      needs.build-image.result == 'success'
    steps:
      - name: Trigger ArgoCD Sync
        continue-on-error: true
        run: |
          echo "ğŸ”„ ArgoCD ë™ê¸°í™” ì•Œë¦¼..."
          
          # ArgoCD API í˜¸ì¶œ (í† í°ì´ ìˆëŠ” ê²½ìš°)
          if [ -n "${{ secrets.ARGOCD_TOKEN }}" ]; then
            echo "ğŸ“¡ ArgoCD API í˜¸ì¶œ..."
            
            curl -k -X POST \
              -H "Authorization: Bearer ${{ secrets.ARGOCD_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d '{"prune": true, "dryRun": false}' \
              "${{ vars.ARGOCD_URL || 'https://argo.jclee.me' }}/api/v1/applications/blacklist/sync" || echo "âš ï¸ ArgoCD API í˜¸ì¶œ ì‹¤íŒ¨"
          else
            echo "âš ï¸ ARGOCD_TOKENì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ"
          fi

      - name: Webhook Notification
        continue-on-error: true
        run: |
          # ì›¹í›… ì•Œë¦¼ (ì„ íƒì‚¬í•­)
          if [ -n "${{ secrets.DEPLOYMENT_WEBHOOK_URL }}" ]; then
            echo "ğŸ“¢ ë°°í¬ ì›¹í›… ì•Œë¦¼..."
            
            curl -X POST \
              -H "Content-Type: application/json" \
              -d '{
                "text": "ğŸš€ Blacklist ë°°í¬ ì¤€ë¹„ ì™„ë£Œ",
                "attachments": [{
                  "color": "good",
                  "fields": [
                    {"title": "ì´ë¯¸ì§€", "value": "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ needs.build-image.outputs.short-sha }}", "short": true},
                    {"title": "ì°¨íŠ¸ ë²„ì „", "value": "${{ needs.update-helm-chart.outputs.chart-version }}", "short": true},
                    {"title": "ì»¤ë°‹", "value": "${{ github.sha }}", "short": true},
                    {"title": "ì‘ì„±ì", "value": "${{ github.actor }}", "short": true}
                  ]
                }]
              }' \
              "${{ secrets.DEPLOYMENT_WEBHOOK_URL }}" || echo "âš ï¸ ì›¹í›… ì•Œë¦¼ ì‹¤íŒ¨"
          fi

  # 6. ë°°í¬ ê²°ê³¼ ìš”ì•½
  deployment-summary:
    name: Deployment Summary
    runs-on: self-hosted
    needs: [build-image, update-helm-chart, notify-argocd]
    if: always()
    steps:
      - name: Print Summary
        run: |
          echo "ğŸ¯ CI/CD íŒŒì´í”„ë¼ì¸ ì™„ë£Œ"
          echo "========================"
          echo ""
          echo "ğŸ“¦ **Docker ì´ë¯¸ì§€**"
          echo "  - Registry: ${{ env.REGISTRY }}"
          echo "  - Image: ${{ env.IMAGE_NAME }}:sha-${{ needs.build-image.outputs.short-sha }}"
          echo ""
          echo "ğŸ“Š **Helm ì°¨íŠ¸**"
          echo "  - Repository: charts.jclee.me"
          echo "  - Chart Version: ${{ needs.update-helm-chart.outputs.chart-version || 'N/A' }}"
          echo "  - PR URL: ${{ needs.update-helm-chart.outputs.pr-url || 'N/A' }}"
          echo ""
          echo "ğŸ”— **ë°°í¬ ë§í¬**"
          echo "  - ArgoCD: ${{ vars.ARGOCD_URL || 'https://argo.jclee.me' }}"
          echo "  - Service: ${{ vars.SERVICE_URL || 'https://blacklist.jclee.me' }}"
          echo "  - Health: ${{ vars.SERVICE_URL || 'https://blacklist.jclee.me' }}/health"
          echo ""
          echo "ğŸ“ **ì»¤ë°‹ ì •ë³´**"
          echo "  - SHA: ${{ github.sha }}"
          echo "  - Author: ${{ github.actor }}"
          echo "  - Branch: ${{ github.ref_name }}"
          echo "  - Message: ${{ github.event.head_commit.message }}"
          echo ""
          echo "âœ… Charts ë¦¬í¬ì§€í† ë¦¬ PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "   ArgoCDê°€ ìë™ìœ¼ë¡œ ë³€ê²½ì‚¬í•­ì„ ê°ì§€í•˜ê³  ë°°í¬í•©ë‹ˆë‹¤."
          
          # ìƒíƒœ ê²€ì‚¬
          echo ""
          echo "ğŸ“‹ **ì‹¤í–‰ ê²°ê³¼**"
          echo "  - ì´ë¯¸ì§€ ë¹Œë“œ: ${{ needs.build-image.result }}"
          echo "  - ì°¨íŠ¸ ì—…ë°ì´íŠ¸: ${{ needs.update-helm-chart.result }}"
          echo "  - ArgoCD ì•Œë¦¼: ${{ needs.notify-argocd.result }}"