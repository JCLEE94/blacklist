name: Claude Manual Trigger

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]
  workflow_dispatch:
    inputs:
      task:
        description: 'Task for Claude to perform'
        required: true
        default: 'Please review and improve the codebase'

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  claude-manual:
    name: Claude Manual Task
    # @claude ë©˜ì…˜ì´ë‚˜ ìˆ˜ë™ ì‹¤í–‰ì¼ ë•Œë§Œ ì‹¤í–‰
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && contains(github.event.issue.body, '@claude'))
    runs-on: self-hosted
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Manual Task
        uses: grll/claude-code-base-action@beta
        with:
          use_oauth: "true"
          claude_access_token: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          claude_refresh_token: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          claude_expires_at: ${{ secrets.CLAUDE_EXPIRES_AT }}
          secrets_admin_pat: ${{ secrets.SECRETS_ADMIN_PAT }}
          
          prompt: |
            ë‹¹ì‹ ì€ Blacklist ìœ„í˜‘ ì¸í…”ë¦¬ì „ìŠ¤ í”Œë«í¼ì˜ ì „ë¬¸ ê°œë°œìì…ë‹ˆë‹¤.
            
            {% if github.event_name == 'workflow_dispatch' %}
            **ìˆ˜ë™ ì‹¤í–‰ ì‘ì—…**: {{ github.event.inputs.task }}
            {% else %}
            **GitHubì—ì„œ ìš”ì²­ëœ ì‘ì—…ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.**
            {% endif %}
            
            ## í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸
            - **ì‹œìŠ¤í…œ**: Enterprise threat intelligence platform
            - **ì•„í‚¤í…ì²˜**: GitOps ê¸°ë°˜ ë°°í¬, ë©€í‹°ì†ŒìŠ¤ ë°ì´í„° ìˆ˜ì§‘, FortiGate ì—°ë™
            - **ê¸°ìˆ ìŠ¤íƒ**: Flask 2.3.3 + Gunicorn, SQLite, Redis, Docker/K8s, ArgoCD
            
            ## í•µì‹¬ ì»´í¬ë„ŒíŠ¸
            - **ì˜ì¡´ì„± ì£¼ì…**: src/core/container.py ì¤‘ì•™ ì„œë¹„ìŠ¤ ê´€ë¦¬
            - **ë°ì´í„° ìˆ˜ì§‘**: REGTECH, SECUDIUM ë©€í‹°ì†ŒìŠ¤ ìˆ˜ì§‘ê¸°
            - **GitOps ë°°í¬**: ArgoCD + GitHub Actions CI/CD
            - **ìºì‹±**: Redis primary + memory fallback
            
            ## ê°œë°œ ì§€ì¹¨
            1. **ë³´ì•ˆ ìš°ì„ **: í•˜ë“œì½”ë”© ê¸ˆì§€, í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©
            2. **ì„±ëŠ¥ ìµœì í™”**: orjson, ì—°ê²° í’€ë§, ì••ì¶• í™œìš©
            3. **ì—ëŸ¬ ì²˜ë¦¬**: êµ¬ì¡°í™”ëœ ì˜ˆì™¸ ì²˜ë¦¬ ë° ë¡œê¹…
            4. **í…ŒìŠ¤íŠ¸**: ëª¨ë“  ë³€ê²½ì‚¬í•­ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ í•„ìˆ˜
            5. **GitOps**: Git ì»¤ë°‹ ê¸°ë°˜ ë°°í¬ ìë™í™”
            
            í•­ìƒ í”„ë¡œë•ì…˜ ì¤€ë¹„ëœ ë³´ì•ˆ ì½”ë“œë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.
            í•œêµ­ì–´ë¡œ ëª…í™•í•˜ê²Œ ì„¤ëª…í•˜ê³  ì‘ë‹µí•´ì£¼ì„¸ìš”.
          
          allowed_tools: "Bash(git:*,docker:*,kubectl:*,python:*,npm:*,curl:*,find:*,grep:*),View,Edit,MultiEdit,Write,GlobTool,GrepTool,BatchTool"
          auto_commit: "true"
          commit_message: "ğŸ¤– Claude ìˆ˜ë™ ì‘ì—… ì™„ë£Œ"
          create_pr: "true"
          pr_title: "ğŸ¤– Claude ìˆ˜ë™ ì‘ì—… ê²°ê³¼"
          pr_body: |
            Claudeê°€ ìˆ˜í–‰í•œ ìˆ˜ë™ ì‘ì—… ê²°ê³¼ì…ë‹ˆë‹¤.
            
            **ì‘ì—… ë‚´ìš©**: 
            {% if github.event_name == 'workflow_dispatch' %}
            {{ github.event.inputs.task }}
            {% else %}
            GitHub Issues/PRì—ì„œ ìš”ì²­ëœ ì‘ì—…
            {% endif %}
            
            **ë³€ê²½ì‚¬í•­ ê²€í†  í›„ ìŠ¹ì¸í•´ì£¼ì„¸ìš”.**
          
          max_conversation_turns: 15
          timeout_minutes: 45