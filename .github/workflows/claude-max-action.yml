name: Claude Max Code Base Action

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/ci-optimized.yml'
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  claude-max-action:
    # Push ì´ë²¤íŠ¸ì´ê±°ë‚˜ @claude ë©˜ì…˜ì´ ìˆì„ ë•Œ ì‹¤í–‰
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && contains(github.event.issue.body, '@claude'))
    runs-on: self-hosted
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Max Code Base Action
        uses: grll/claude-code-base-action@beta
        with:
          # OAuth ì‚¬ìš© ì„¤ì •
          use_oauth: "true"
          
          # Claude Max ì¸ì¦ í† í°
          claude_access_token: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          claude_refresh_token: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          claude_expires_at: ${{ secrets.CLAUDE_EXPIRES_AT }}
          
          # GitHub í† í°
          secrets_admin_pat: ${{ secrets.SECRETS_ADMIN_PAT }}
          
          # í”„ë¡¬í”„íŠ¸ ì„¤ì •
          prompt: |
            ë‹¹ì‹ ì€ Blacklist ìœ„í˜‘ ì¸í…”ë¦¬ì „ìŠ¤ í”Œë«í¼ì˜ ì „ë¬¸ ê°œë°œìì…ë‹ˆë‹¤.
            
            ## ìë™ ì½”ë“œ ê°œì„  ëª¨ë“œ
            {% if github.event_name == 'push' %}
            **ë©”ì¸ ë¸Œëœì¹˜ì— í‘¸ì‹œê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. Self-hosted runnerì—ì„œ ìë™ ì½”ë“œ ë¶„ì„ ë° ê°œì„ ì„ ìˆ˜í–‰í•˜ì„¸ìš”:**
            
            ## ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬ë“¤:
            1. **Bash**: git, docker, kubectl, python, curl, find, grep ëª…ë ¹ì–´
            2. **íŒŒì¼ ë„êµ¬**: View, Edit, MultiEdit, Writeë¡œ ì½”ë“œ ìˆ˜ì •
            3. **ê²€ìƒ‰ ë„êµ¬**: GlobTool, GrepToolë¡œ íŒ¨í„´ ë¶„ì„
            
            ## ìˆ˜í–‰í•  ì‘ì—… (ìš°ì„ ìˆœìœ„ ìˆœ):
            1. **ë³´ì•ˆ ìŠ¤ìº”**: 
               - `grep -r "password\|secret\|token" src/` ë¡œ í•˜ë“œì½”ë”© í™•ì¸
               - SQL ì¸ì ì…˜, XSS ì·¨ì•½ì  íŒ¨í„´ ê²€ìƒ‰
            2. **ì„±ëŠ¥ ìµœì í™”**: 
               - ëŠë¦° ì¿¼ë¦¬, ìºì‹± ëˆ„ë½ íŒ¨í„´ ë¶„ì„
               - ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ê°€ëŠ¥ì„± ê²€í† 
            3. **ì½”ë“œ í’ˆì§ˆ**: 
               - íƒ€ì… íŒíŠ¸ ëˆ„ë½ í™•ì¸ ë° ì¶”ê°€
               - docstring ëˆ„ë½ í™•ì¸ ë° ì¶”ê°€
               - ì—ëŸ¬ í•¸ë“¤ë§ ê°œì„ 
            4. **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€**: 
               - `find . -name "test_*.py"` ë¡œ í…ŒìŠ¤íŠ¸ íŒŒì¼ í™•ì¸
               - ëˆ„ë½ëœ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì¶”ê°€
            5. **ì˜ì¡´ì„± ì—…ë°ì´íŠ¸**: 
               - requirements.txt ë³´ì•ˆ ì·¨ì•½ì  í™•ì¸
            
            ë°œê²¬ëœ ë¬¸ì œë“¤ì„ ì¦‰ì‹œ ìˆ˜ì •í•˜ê³  ì»¤ë°‹í•´ì£¼ì„¸ìš”. 
            ì¤‘ìš”í•œ ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ `git checkout -b` ë¡œ ë³„ë„ ë¸Œëœì¹˜ì—ì„œ ì‘ì—…í•´ì£¼ì„¸ìš”.
            {% else %}
            GitHub Issuesë‚˜ PRì—ì„œ ìš”ì²­ëœ ì‘ì—…ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.
            {% endif %}
            
            ## í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸
            - **ì‹œìŠ¤í…œ**: Enterprise threat intelligence platform
            - **ì•„í‚¤í…ì²˜**: GitOps ê¸°ë°˜ ë°°í¬, ë©€í‹°ì†ŒìŠ¤ ë°ì´í„° ìˆ˜ì§‘, FortiGate ì—°ë™
            - **ê¸°ìˆ ìŠ¤íƒ**: Flask 2.3.3 + Gunicorn, SQLite, Redis, Docker/K8s, ArgoCD
            
            ## í•µì‹¬ ì»´í¬ë„ŒíŠ¸
            - **ì˜ì¡´ì„± ì£¼ì…**: src/core/container.py ì¤‘ì•™ ì„œë¹„ìŠ¤ ê´€ë¦¬
            - **ë°ì´í„° ìˆ˜ì§‘**: REGTECH, SECUDIUM ë©€í‹°ì†ŒìŠ¤ ìˆ˜ì§‘ê¸°
            - **GitOps ë°°í¬**: ArgoCD + GitHub Actions CI/CD
            - **ìºì‹±**: Redis primary + memory fallback
            
            ## ê°œë°œ ì§€ì¹¨
            1. **ë³´ì•ˆ ìš°ì„ **: í•˜ë“œì½”ë”© ê¸ˆì§€, í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©
            2. **ì„±ëŠ¥ ìµœì í™”**: orjson, ì—°ê²° í’€ë§, ì••ì¶• í™œìš©
            3. **ì—ëŸ¬ ì²˜ë¦¬**: êµ¬ì¡°í™”ëœ ì˜ˆì™¸ ì²˜ë¦¬ ë° ë¡œê¹…
            4. **í…ŒìŠ¤íŠ¸**: ëª¨ë“  ë³€ê²½ì‚¬í•­ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ í•„ìˆ˜
            5. **GitOps**: Git ì»¤ë°‹ ê¸°ë°˜ ë°°í¬ ìë™í™”
            
            ## ì£¼ìš” ì—”ë“œí¬ì¸íŠ¸
            - /api/blacklist/active: í™œì„± IP ëª©ë¡
            - /api/fortigate: FortiGate External Connector í˜•ì‹
            - /api/collection/*: ë°ì´í„° ìˆ˜ì§‘ ê´€ë¦¬
            
            í•­ìƒ í”„ë¡œë•ì…˜ ì¤€ë¹„ëœ ë³´ì•ˆ ì½”ë“œë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.
            í•œêµ­ì–´ë¡œ ëª…í™•í•˜ê²Œ ì„¤ëª…í•˜ê³  ì‘ë‹µí•´ì£¼ì„¸ìš”.
          
          # í—ˆìš©ëœ ë„êµ¬ ì„¤ì • (Self-hosted runnerìš©)
          allowed_tools: "Bash(git:*,docker:*,kubectl:*,python:*,npm:*,curl:*,find:*,grep:*),View,Edit,MultiEdit,Write,GlobTool,GrepTool,BatchTool"
          
          # ìë™ ìˆ˜ì • ë° ì»¤ë°‹ í™œì„±í™”
          auto_commit: "true"
          commit_message: "ğŸ¤– Claude Max ìë™ ì½”ë“œ ê°œì„ "
          create_pr: "true"
          pr_title: "ğŸ¤– Claude Max ìë™ ì½”ë“œ ê°œì„ "
          pr_body: |
            Claude Maxê°€ ìë™ìœ¼ë¡œ ê°ì§€í•˜ê³  ìˆ˜ì •í•œ í•­ëª©ë“¤:
            - ë³´ì•ˆ ì·¨ì•½ì  ìˆ˜ì •
            - ì„±ëŠ¥ ìµœì í™”
            - ì½”ë“œ í’ˆì§ˆ ê°œì„ 
            - í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ í–¥ìƒ
            
          # ëª¨ë¸ ì„¤ì •
          model: "claude-3-5-sonnet-20241022"
          
          # MCP ì„œë²„ ì„¤ì • (Self-hosted runner ìµœì í™”)
          mcp_servers: |
            {
              "filesystem": {
                "command": "python3",
                "args": ["-m", "mcp.servers.filesystem"],
                "env": {
                  "ALLOWED_DIRECTORIES": "${{ github.workspace }}"
                }
              },
              "git": {
                "command": "python3", 
                "args": ["-m", "mcp.servers.git"],
                "env": {
                  "GIT_REPO_PATH": "${{ github.workspace }}"
                }
              }
            }
          
          # í™˜ê²½ ë³€ìˆ˜
          claude_env: |
            PROJECT_NAME=blacklist
            REGISTRY=registry.jclee.me
            ARGOCD_SERVER=argo.jclee.me
            PRODUCTION_URL=https://blacklist.jclee.me
            GITHUB_TOKEN=${{ secrets.SECRETS_ADMIN_PAT }}
            
          # ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ì¶”ê°€ ì§€ì¹¨)
          system_prompt: |
            ë‹¹ì‹ ì€ blacklist í”„ë¡œì íŠ¸ì˜ ì „ë¬¸ ê°œë°œìì…ë‹ˆë‹¤.
            
            ì¤‘ìš”í•œ ê·œì¹™:
            1. ëª¨ë“  ë³€ê²½ì‚¬í•­ì€ gitìœ¼ë¡œ ì»¤ë°‹í•˜ê¸° ì „ì— ë°˜ë“œì‹œ í…ŒìŠ¤íŠ¸
            2. í™˜ê²½ë³€ìˆ˜ ì‚¬ìš© ê°•ì œ - í•˜ë“œì½”ë”© ì ˆëŒ€ ê¸ˆì§€
            3. ë³´ì•ˆ ìš°ì„  - SQL ì¸ì ì…˜, XSS ë“± ì·¨ì•½ì  ë°©ì§€
            4. ì„±ëŠ¥ ê³ ë ¤ - ìºì‹±, ì¸ë±ì‹±, ì—°ê²° í’€ë§ ì ìš©
            5. ì—ëŸ¬ í•¸ë“¤ë§ - ì˜ˆì™¸ ìƒí™©ì— ëŒ€í•œ ì ì ˆí•œ ì²˜ë¦¬
            
            ì½”ë“œ ìŠ¤íƒ€ì¼:
            - Python: PEP 8 ì¤€ìˆ˜
            - SQL: íŒŒë¼ë¯¸í„°í™”ëœ ì¿¼ë¦¬ ì‚¬ìš©
            - Docker: ë©€í‹°ìŠ¤í…Œì´ì§€ ë¹Œë“œ í™œìš©
            - K8s: ë¦¬ì†ŒìŠ¤ ì œí•œ ë° í—¬ìŠ¤ì²´í¬ í¬í•¨
            
            ì‘ë‹µ ì‹œ:
            - ë³€ê²½ ì´ìœ ì™€ ê·¼ê±° ëª…í™•íˆ ì„¤ëª…
            - í…ŒìŠ¤íŠ¸ ë°©ë²• ì œì‹œ
            - ì ì¬ì  ë¶€ì‘ìš© ì–¸ê¸‰
            - í•œêµ­ì–´ë¡œ ì¹œì ˆí•˜ê³  ìƒì„¸í•˜ê²Œ ì„¤ëª…
          
          # ëŒ€í™” í„´ ì œí•œ (ë³µì¡í•œ ì‘ì—…ì„ ìœ„í•´)
          max_conversation_turns: 10
          
          # íƒ€ì„ì•„ì›ƒ ì„¤ì •
          timeout_minutes: 30