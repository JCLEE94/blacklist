name: 🧪 개발 환경 배포 | Development Deploy

on:
  push:
    branches: [develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/BRANCH_STRATEGY.md'
  pull_request:
    branches: [develop]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: registry.jclee.me
  IMAGE_NAME: blacklist-dev

jobs:
  # ========================================
  # 변경 감지 및 버전 생성
  # ========================================
  prepare:
    name: "🔍 개발 변경 감지 & 버전 생성"
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.changes.outputs.should_deploy }}
      version: ${{ steps.version.outputs.version }}
      git_hash: ${{ steps.version.outputs.git_hash }}
      git_count: ${{ steps.version.outputs.git_count }}
      build_version: ${{ steps.version.outputs.build_version }}
      changed_files: ${{ steps.changes.outputs.changed_files }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2
        
    - name: "🔍 개발 환경 변경 감지"
      id: changes
      run: |
        echo "🔍 개발 환경 변경사항 분석 중..."
        
        SHOULD_DEPLOY=true  # 개발 환경은 항상 배포
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
        
        echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
        echo "changed_files=${CHANGED_FILES//$'\n'/ }" >> $GITHUB_OUTPUT
        
        echo "📊 결과: 개발 배포 = $SHOULD_DEPLOY"
        echo "📝 변경 파일: $CHANGED_FILES"

    - name: "📦 개발 버전 생성"  
      id: version
      run: |
        echo "📦 개발 버전 생성 중..."
        
        # Git 정보
        GIT_COUNT=$(git rev-list --count HEAD)
        GIT_HASH=$(git rev-parse --short HEAD)
        GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
        
        # 개발 버전: 1.0.커밋수.해시-dev
        DYNAMIC_VERSION="1.0.${GIT_COUNT}.${GIT_HASH}-dev"
        
        # 개발 빌드 버전
        BUILD_VERSION="dev-$(date +%Y%m%d)-${{ github.run_number }}"
        
        echo "version=$DYNAMIC_VERSION" >> $GITHUB_OUTPUT
        echo "git_hash=$GIT_HASH" >> $GITHUB_OUTPUT  
        echo "git_count=$GIT_COUNT" >> $GITHUB_OUTPUT
        echo "build_version=$BUILD_VERSION" >> $GITHUB_OUTPUT
        
        echo "📦 개발 버전: $DYNAMIC_VERSION"
        echo "🏗️ 빌드 버전: $BUILD_VERSION"

  # ========================================
  # 개발 환경 테스트
  # ========================================
  test:
    name: "🧪 개발 환경 테스트"
    needs: prepare
    if: needs.prepare.outputs.should_deploy == 'true' && inputs.skip_tests != 'true'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: "📦 테스트 의존성 설치"
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov black flake8
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: "🔍 코드 품질 검사"
      run: |
        echo "🔍 Flake8 린팅..."
        flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
        
        echo "🎨 Black 포매팅 검사..."
        black --check --diff src/ || true
    
    - name: "🧪 단위 테스트 실행"
      run: |
        echo "🧪 개발 환경 테스트 실행..."
        pytest -v --tb=short || echo "일부 테스트 실패 (개발 환경에서는 허용)"

  # ========================================
  # Docker 이미지 빌드
  # ========================================
  build:
    name: "🐳 개발 이미지 빌드 & 푸시"
    needs: [prepare, test]
    if: always() && needs.prepare.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: "🐳 레지스트리 로그인"
      run: |
        echo "${{ secrets.REGISTRY_PASSWORD || 'bingogo1' }}" | docker login ${{ env.REGISTRY }} -u admin --password-stdin
    
    - name: "🏗️ 개발 이미지 빌드 & 푸시"
      run: |
        VERSION="${{ needs.prepare.outputs.version }}"
        BUILD_VERSION="${{ needs.prepare.outputs.build_version }}"
        
        echo "🧪 Blacklist 개발 환경 빌드 중..."
        echo "📦 버전: $VERSION"
        
        # 개발 환경 빌드
        docker build \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$BUILD_VERSION \
          --build-arg DYNAMIC_VERSION=$VERSION \
          --build-arg BUILD_VERSION=$BUILD_VERSION \
          --build-arg BUILD_NUMBER=${{ github.run_number }} \
          --build-arg COMMIT_SHA=${{ github.sha }} \
          --build-arg COMMIT_COUNT=${{ needs.prepare.outputs.git_count }} \
          --build-arg GIT_HASH=${{ needs.prepare.outputs.git_hash }} \
          --build-arg GITHUB_ACTIONS=true \
          --build-arg FLASK_ENV=development \
          --label "environment=development" \
          --label "version=$VERSION" \
          --label "build=$BUILD_VERSION" \
          .
        
        echo "📤 개발 레지스트리 푸시..."
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION
        
        echo "✅ 개발 빌드 완료: $VERSION"

  # ========================================
  # 개발 환경 배포
  # ========================================
  deploy:
    name: "🚀 개발 환경 배포"
    needs: [prepare, build]
    if: always() && needs.prepare.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    environment:
      name: development
      url: https://dev-blacklist.jclee.me
    
    steps:
    - name: "🚀 개발 환경 배포 시뮬레이션"
      run: |
        echo "🧪 개발 환경 배포 중..."
        NEW_VERSION="${{ needs.prepare.outputs.version }}"
        
        echo "📦 개발 버전: $NEW_VERSION"
        echo "🌐 개발 URL: https://dev-blacklist.jclee.me"
        echo "🏗️ 환경: Development"
        
        # 개발 환경 배포 로직 (시뮬레이션)
        echo "✅ 개발 환경 배포 완료"

  # ========================================
  # 개발 결과 요약
  # ========================================  
  summary:
    name: "📊 개발 배포 요약"
    needs: [prepare, test, build, deploy]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: "📊 개발 결과 요약 생성"
      run: |
        echo "# 🧪 Blacklist 개발 환경 배포 리포트" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## 📦 개발 버전 정보" >> $GITHUB_STEP_SUMMARY
        echo "- **개발 버전:** ${{ needs.prepare.outputs.version || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **빌드 버전:** ${{ needs.prepare.outputs.build_version || 'N/A' }}" >> $GITHUB_STEP_SUMMARY  
        echo "- **Git 해시:** ${{ needs.prepare.outputs.git_hash || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **커밋 수:** ${{ needs.prepare.outputs.git_count || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## 🚀 개발 배포 상태" >> $GITHUB_STEP_SUMMARY
        echo "| 단계 | 상태 | 결과 |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
        
        # 테스트 결과
        if [ "${{ needs.test.result }}" = "success" ]; then
          echo "| 🧪 테스트 | ✅ | 통과 |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ inputs.skip_tests }}" = "true" ]; then
          echo "| 🧪 테스트 | ⏭️ | 스킵 |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| 🧪 테스트 | ⚠️ | 일부 실패 (개발환경 허용) |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # 빌드 결과
        if [ "${{ needs.build.result }}" = "success" ]; then
          echo "| 🐳 이미지 빌드 | ✅ | 성공 |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| 🐳 이미지 빌드 | ❌ | 실패 |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # 배포 결과  
        if [ "${{ needs.deploy.result }}" = "success" ]; then
          echo "| 🚀 개발 배포 | ✅ | 성공 |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| 🚀 개발 배포 | ❌ | 실패 |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## 🌐 개발 환경 접속" >> $GITHUB_STEP_SUMMARY
        echo "- **🧪 개발 시스템:** https://dev-blacklist.jclee.me/" >> $GITHUB_STEP_SUMMARY
        echo "- **📊 개발 대시보드:** https://dev-blacklist.jclee.me/dashboard" >> $GITHUB_STEP_SUMMARY
        echo "- **💚 헬스체크:** https://dev-blacklist.jclee.me/health" >> $GITHUB_STEP_SUMMARY
        echo "- **📦 버전 정보:** https://dev-blacklist.jclee.me/api/version" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## 📝 변경사항" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "${{ needs.prepare.outputs.changed_files || 'No changes detected' }}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        
        # 최종 상태
        echo "## 🧪 개발 환경 배포 완료!" >> $GITHUB_STEP_SUMMARY
        echo "개발 버전이 성공적으로 배포되었습니다." >> $GITHUB_STEP_SUMMARY