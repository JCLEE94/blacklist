name: ðŸ§ª ê°œë°œ í™˜ê²½ ë°°í¬ | Development Deploy

on:
  push:
    branches: [develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/BRANCH_STRATEGY.md'
  pull_request:
    branches: [develop]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: registry.jclee.me
  IMAGE_NAME: blacklist-dev

jobs:
  # ========================================
  # ë³€ê²½ ê°ì§€ ë° ë²„ì „ ìƒì„±
  # ========================================
  prepare:
    name: "ðŸ” ê°œë°œ ë³€ê²½ ê°ì§€ & ë²„ì „ ìƒì„±"
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.changes.outputs.should_deploy }}
      version: ${{ steps.version.outputs.version }}
      git_hash: ${{ steps.version.outputs.git_hash }}
      git_count: ${{ steps.version.outputs.git_count }}
      build_version: ${{ steps.version.outputs.build_version }}
      changed_files: ${{ steps.changes.outputs.changed_files }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2
        
    - name: "ðŸ” ê°œë°œ í™˜ê²½ ë³€ê²½ ê°ì§€"
      id: changes
      run: |
        echo "ðŸ” ê°œë°œ í™˜ê²½ ë³€ê²½ì‚¬í•­ ë¶„ì„ ì¤‘..."
        
        SHOULD_DEPLOY=true  # ê°œë°œ í™˜ê²½ì€ í•­ìƒ ë°°í¬
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
        
        echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
        echo "changed_files=${CHANGED_FILES//$'\n'/ }" >> $GITHUB_OUTPUT
        
        echo "ðŸ“Š ê²°ê³¼: ê°œë°œ ë°°í¬ = $SHOULD_DEPLOY"
        echo "ðŸ“ ë³€ê²½ íŒŒì¼: $CHANGED_FILES"

    - name: "ðŸ“¦ ê°œë°œ ë²„ì „ ìƒì„±"  
      id: version
      run: |
        echo "ðŸ“¦ ê°œë°œ ë²„ì „ ìƒì„± ì¤‘..."
        
        # Git ì •ë³´
        GIT_COUNT=$(git rev-list --count HEAD)
        GIT_HASH=$(git rev-parse --short HEAD)
        GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
        
        # ê°œë°œ ë²„ì „: 1.0.ì»¤ë°‹ìˆ˜.í•´ì‹œ-dev
        DYNAMIC_VERSION="1.0.${GIT_COUNT}.${GIT_HASH}-dev"
        
        # ê°œë°œ ë¹Œë“œ ë²„ì „
        BUILD_VERSION="dev-$(date +%Y%m%d)-${{ github.run_number }}"
        
        echo "version=$DYNAMIC_VERSION" >> $GITHUB_OUTPUT
        echo "git_hash=$GIT_HASH" >> $GITHUB_OUTPUT  
        echo "git_count=$GIT_COUNT" >> $GITHUB_OUTPUT
        echo "build_version=$BUILD_VERSION" >> $GITHUB_OUTPUT
        
        echo "ðŸ“¦ ê°œë°œ ë²„ì „: $DYNAMIC_VERSION"
        echo "ðŸ—ï¸ ë¹Œë“œ ë²„ì „: $BUILD_VERSION"

  # ========================================
  # ê°œë°œ í™˜ê²½ í…ŒìŠ¤íŠ¸
  # ========================================
  test:
    name: "ðŸ§ª ê°œë°œ í™˜ê²½ í…ŒìŠ¤íŠ¸"
    needs: prepare
    if: needs.prepare.outputs.should_deploy == 'true' && inputs.skip_tests != 'true'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: "ðŸ“¦ í…ŒìŠ¤íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜"
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov black flake8
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: "ðŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬"
      run: |
        echo "ðŸ” Flake8 ë¦°íŒ…..."
        flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
        
        echo "ðŸŽ¨ Black í¬ë§¤íŒ… ê²€ì‚¬..."
        black --check --diff src/ || true
    
    - name: "ðŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
      run: |
        echo "ðŸ§ª ê°œë°œ í™˜ê²½ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
        pytest -v --tb=short || echo "ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (ê°œë°œ í™˜ê²½ì—ì„œëŠ” í—ˆìš©)"

  # ========================================
  # Docker ì´ë¯¸ì§€ ë¹Œë“œ
  # ========================================
  build:
    name: "ðŸ³ ê°œë°œ ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ"
    needs: [prepare, test]
    if: always() && needs.prepare.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: "ðŸ³ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸"
      run: |
        echo "${{ secrets.REGISTRY_PASSWORD || 'bingogo1' }}" | docker login ${{ env.REGISTRY }} -u admin --password-stdin
    
    - name: "ðŸ—ï¸ ê°œë°œ ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ"
      run: |
        VERSION="${{ needs.prepare.outputs.version }}"
        BUILD_VERSION="${{ needs.prepare.outputs.build_version }}"
        
        echo "ðŸ§ª Blacklist ê°œë°œ í™˜ê²½ ë¹Œë“œ ì¤‘..."
        echo "ðŸ“¦ ë²„ì „: $VERSION"
        
        # ê°œë°œ í™˜ê²½ ë¹Œë“œ
        docker build \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$BUILD_VERSION \
          --build-arg DYNAMIC_VERSION=$VERSION \
          --build-arg BUILD_VERSION=$BUILD_VERSION \
          --build-arg BUILD_NUMBER=${{ github.run_number }} \
          --build-arg COMMIT_SHA=${{ github.sha }} \
          --build-arg COMMIT_COUNT=${{ needs.prepare.outputs.git_count }} \
          --build-arg GIT_HASH=${{ needs.prepare.outputs.git_hash }} \
          --build-arg GITHUB_ACTIONS=true \
          --build-arg FLASK_ENV=development \
          --label "environment=development" \
          --label "version=$VERSION" \
          --label "build=$BUILD_VERSION" \
          .
        
        echo "ðŸ“¤ ê°œë°œ ë ˆì§€ìŠ¤íŠ¸ë¦¬ í‘¸ì‹œ..."
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION
        
        echo "âœ… ê°œë°œ ë¹Œë“œ ì™„ë£Œ: $VERSION"

  # ========================================
  # ê°œë°œ í™˜ê²½ ë°°í¬
  # ========================================
  deploy:
    name: "ðŸš€ ê°œë°œ í™˜ê²½ ë°°í¬"
    needs: [prepare, build]
    if: always() && needs.prepare.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    environment:
      name: development
      url: https://dev-blacklist.jclee.me
    
    steps:
    - name: "ðŸš€ ê°œë°œ í™˜ê²½ ë°°í¬ ì‹œë®¬ë ˆì´ì…˜"
      run: |
        echo "ðŸ§ª ê°œë°œ í™˜ê²½ ë°°í¬ ì¤‘..."
        NEW_VERSION="${{ needs.prepare.outputs.version }}"
        
        echo "ðŸ“¦ ê°œë°œ ë²„ì „: $NEW_VERSION"
        echo "ðŸŒ ê°œë°œ URL: https://dev-blacklist.jclee.me"
        echo "ðŸ—ï¸ í™˜ê²½: Development"
        
        # ê°œë°œ í™˜ê²½ ë°°í¬ ë¡œì§ (ì‹œë®¬ë ˆì´ì…˜)
        echo "âœ… ê°œë°œ í™˜ê²½ ë°°í¬ ì™„ë£Œ"

  # ========================================
  # ê°œë°œ ê²°ê³¼ ìš”ì•½
  # ========================================  
  summary:
    name: "ðŸ“Š ê°œë°œ ë°°í¬ ìš”ì•½"
    needs: [prepare, test, build, deploy]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: "ðŸ“Š ê°œë°œ ê²°ê³¼ ìš”ì•½ ìƒì„±"
      run: |
        echo "# ðŸ§ª Blacklist ê°œë°œ í™˜ê²½ ë°°í¬ ë¦¬í¬íŠ¸" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸ“¦ ê°œë°œ ë²„ì „ ì •ë³´" >> $GITHUB_STEP_SUMMARY
        echo "- **ê°œë°œ ë²„ì „:** ${{ needs.prepare.outputs.version || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ë¹Œë“œ ë²„ì „:** ${{ needs.prepare.outputs.build_version || 'N/A' }}" >> $GITHUB_STEP_SUMMARY  
        echo "- **Git í•´ì‹œ:** ${{ needs.prepare.outputs.git_hash || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ì»¤ë°‹ ìˆ˜:** ${{ needs.prepare.outputs.git_count || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸš€ ê°œë°œ ë°°í¬ ìƒíƒœ" >> $GITHUB_STEP_SUMMARY
        echo "| ë‹¨ê³„ | ìƒíƒœ | ê²°ê³¼ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
        
        # í…ŒìŠ¤íŠ¸ ê²°ê³¼
        if [ "${{ needs.test.result }}" = "success" ]; then
          echo "| ðŸ§ª í…ŒìŠ¤íŠ¸ | âœ… | í†µê³¼ |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ inputs.skip_tests }}" = "true" ]; then
          echo "| ðŸ§ª í…ŒìŠ¤íŠ¸ | â­ï¸ | ìŠ¤í‚µ |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸ§ª í…ŒìŠ¤íŠ¸ | âš ï¸ | ì¼ë¶€ ì‹¤íŒ¨ (ê°œë°œí™˜ê²½ í—ˆìš©) |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # ë¹Œë“œ ê²°ê³¼
        if [ "${{ needs.build.result }}" = "success" ]; then
          echo "| ðŸ³ ì´ë¯¸ì§€ ë¹Œë“œ | âœ… | ì„±ê³µ |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸ³ ì´ë¯¸ì§€ ë¹Œë“œ | âŒ | ì‹¤íŒ¨ |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # ë°°í¬ ê²°ê³¼  
        if [ "${{ needs.deploy.result }}" = "success" ]; then
          echo "| ðŸš€ ê°œë°œ ë°°í¬ | âœ… | ì„±ê³µ |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸš€ ê°œë°œ ë°°í¬ | âŒ | ì‹¤íŒ¨ |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŒ ê°œë°œ í™˜ê²½ ì ‘ì†" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ§ª ê°œë°œ ì‹œìŠ¤í…œ:** https://dev-blacklist.jclee.me/" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ“Š ê°œë°œ ëŒ€ì‹œë³´ë“œ:** https://dev-blacklist.jclee.me/dashboard" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ’š í—¬ìŠ¤ì²´í¬:** https://dev-blacklist.jclee.me/health" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ“¦ ë²„ì „ ì •ë³´:** https://dev-blacklist.jclee.me/api/version" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“ ë³€ê²½ì‚¬í•­" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "${{ needs.prepare.outputs.changed_files || 'No changes detected' }}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        
        # ìµœì¢… ìƒíƒœ
        echo "## ðŸ§ª ê°œë°œ í™˜ê²½ ë°°í¬ ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
        echo "ê°œë°œ ë²„ì „ì´ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY