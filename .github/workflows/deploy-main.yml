name: ðŸš€ ë©”ì¸ ë°°í¬ íŒŒì´í”„ë¼ì¸ | Production Deploy

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/deploy-pages.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy even if version matches'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: registry.jclee.me
  IMAGE_NAME: blacklist

jobs:
  # ========================================
  # ë³€ê²½ ê°ì§€ ë° ë²„ì „ ìƒì„±
  # ========================================
  prepare:
    name: "ðŸ” ë³€ê²½ ê°ì§€ & ë™ì  ë²„ì „ ìƒì„±"
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.changes.outputs.should_deploy }}
      version: ${{ steps.version.outputs.version }}
      git_hash: ${{ steps.version.outputs.git_hash }}
      git_count: ${{ steps.version.outputs.git_count }}
      build_version: ${{ steps.version.outputs.build_version }}
      changed_files: ${{ steps.changes.outputs.changed_files }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2  # ë³€ê²½ ê°ì§€ìš©
        
    - name: "ðŸ” ìŠ¤ë§ˆíŠ¸ ë³€ê²½ ê°ì§€"
      id: changes
      run: |
        echo "ðŸ” ë³€ê²½ì‚¬í•­ ë¶„ì„ ì¤‘..."
        
        SHOULD_DEPLOY=false
        FORCE_DEPLOY="${{ inputs.force_deploy }}"
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "$FORCE_DEPLOY" = "true" ]; then
          echo "ðŸ”¨ ê°•ì œ ë°°í¬ ìš”ì²­"
          SHOULD_DEPLOY=true
          CHANGED_FILES="Manual trigger"
        else
          # ë³€ê²½ëœ íŒŒì¼ í™•ì¸
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          
          if echo "$CHANGED_FILES" | grep -qE "\.(py|yml|yaml|txt|json)$|^Dockerfile|^main\.py"; then
            echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼ ë³€ê²½ ê°ì§€"
            SHOULD_DEPLOY=true
          else
            echo "â„¹ï¸ ë°°í¬ ë¶ˆí•„ìš”í•œ ë³€ê²½ì‚¬í•­"
            SHOULD_DEPLOY=false
          fi
        fi
        
        echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
        echo "changed_files=${CHANGED_FILES//$'\n'/ }" >> $GITHUB_OUTPUT
        
        echo "ðŸ“Š ê²°ê³¼: ë°°í¬ í•„ìš” = $SHOULD_DEPLOY"
        echo "ðŸ“ ë³€ê²½ íŒŒì¼: $CHANGED_FILES"

    - name: "ðŸ“¦ ë™ì  ë²„ì „ ìƒì„±"  
      id: version
      if: steps.changes.outputs.should_deploy == 'true'
      run: |
        echo "ðŸ“¦ ë™ì  ë²„ì „ ìƒì„± ì¤‘..."
        
        # Git ì •ë³´
        GIT_COUNT=$(git rev-list --count HEAD)
        GIT_HASH=$(git rev-parse --short HEAD)
        GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
        
        # ë™ì  ë²„ì „: 1.0.ì»¤ë°‹ìˆ˜.í•´ì‹œ
        DYNAMIC_VERSION="1.0.${GIT_COUNT}.${GIT_HASH}"
        
        # ë¹Œë“œ ë²„ì „
        BUILD_VERSION="v$(date +%Y%m%d)-${{ github.run_number }}"
        
        echo "version=$DYNAMIC_VERSION" >> $GITHUB_OUTPUT
        echo "git_hash=$GIT_HASH" >> $GITHUB_OUTPUT  
        echo "git_count=$GIT_COUNT" >> $GITHUB_OUTPUT
        echo "build_version=$BUILD_VERSION" >> $GITHUB_OUTPUT
        
        echo "ðŸ“¦ ë™ì  ë²„ì „: $DYNAMIC_VERSION"
        echo "ðŸ—ï¸ ë¹Œë“œ ë²„ì „: $BUILD_VERSION"

  # ========================================
  # Docker ì´ë¯¸ì§€ ë¹Œë“œ
  # ========================================
  build:
    name: "ðŸ³ Docker ë¹Œë“œ & ë ˆì§€ìŠ¤íŠ¸ë¦¬ í‘¸ì‹œ"
    needs: prepare
    if: needs.prepare.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: "ðŸ³ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸"
      run: |
        echo "${{ secrets.REGISTRY_PASSWORD || 'bingogo1' }}" | docker login ${{ env.REGISTRY }} -u admin --password-stdin
    
    - name: "ðŸ—ï¸ ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ"
      run: |
        VERSION="${{ needs.prepare.outputs.version }}"
        BUILD_VERSION="${{ needs.prepare.outputs.build_version }}"
        
        echo "ðŸ›¡ï¸ Blacklist ì‹œìŠ¤í…œ ë¹Œë“œ ì¤‘..."
        echo "ðŸ“¦ ë²„ì „: $VERSION"
        
        # íš¨ìœ¨ì ì¸ ë©€í‹° íƒœê·¸ ë¹Œë“œ
        docker build \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$BUILD_VERSION \
          --build-arg DYNAMIC_VERSION=$VERSION \
          --build-arg BUILD_VERSION=$BUILD_VERSION \
          --build-arg BUILD_NUMBER=${{ github.run_number }} \
          --build-arg COMMIT_SHA=${{ github.sha }} \
          --build-arg COMMIT_COUNT=${{ needs.prepare.outputs.git_count }} \
          --build-arg GIT_HASH=${{ needs.prepare.outputs.git_hash }} \
          --build-arg GITHUB_ACTIONS=true \
          --build-arg FLASK_ENV=production \
          --label "version=$VERSION" \
          --label "build=$BUILD_VERSION" \
          .
        
        echo "ðŸ“¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ í‘¸ì‹œ..."
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION
        
        echo "âœ… ë¹Œë“œ ì™„ë£Œ: $VERSION"

  # ========================================
  # í”„ë¡œë•ì…˜ ë°°í¬
  # ========================================
  deploy:
    name: "ðŸš€ í”„ë¡œë•ì…˜ ë°°í¬ & í—¬ìŠ¤ì²´í¬"
    needs: [prepare, build]
    if: needs.prepare.outputs.should_deploy == 'true'
    runs-on: self-hosted
    
    steps:
    - name: "ðŸ”„ ìŠ¤ë§ˆíŠ¸ ë°°í¬ ì‹¤í–‰"
      run: |
        echo "ðŸš€ í”„ë¡œë•ì…˜ ë°°í¬ ì‹œìž‘..."
        NEW_VERSION="${{ needs.prepare.outputs.version }}"
        
        # ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
        echo "${{ secrets.REGISTRY_PASSWORD || 'bingogo1' }}" | docker login ${{ env.REGISTRY }} -u admin --password-stdin
        
        # ìµœì‹  ì´ë¯¸ì§€ í’€
        docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        
        # í˜„ìž¬ ë²„ì „ í™•ì¸
        CURRENT_VERSION="none"
        if docker exec blacklist curl -s http://localhost:2542/api/version 2>/dev/null | grep -o '"version":"[^"]*"' >/dev/null 2>&1; then
          CURRENT_VERSION=$(docker exec blacklist curl -s http://localhost:2542/api/version 2>/dev/null | grep -o '"version":"[^"]*"' | cut -d'"' -f4)
        fi
        
        echo "ðŸ“Š í˜„ìž¬: $CURRENT_VERSION â†’ ìƒˆ ë²„ì „: $NEW_VERSION"
        
        # ë°°í¬ ê²°ì •
        FORCE_DEPLOY="${{ inputs.force_deploy }}"
        if [ "$CURRENT_VERSION" != "$NEW_VERSION" ] || [ "$FORCE_DEPLOY" = "true" ]; then
          echo "ðŸ”„ ë²„ì „ ì—…ë°ì´íŠ¸ ì‹¤í–‰..."
          
          # ë¬´ì¤‘ë‹¨ ìž¬ë°°í¬
          docker stop blacklist 2>/dev/null || true
          docker rm blacklist 2>/dev/null || true
          
          # ìµœì í™”ëœ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
          docker run -d \
            --name blacklist \
            --restart unless-stopped \
            --network bridge \
            -p 32542:2542 \
            -v blacklist-data:/app/instance \
            -v blacklist-logs:/app/logs \
            --memory=1g \
            --cpus=1.0 \
            -e FLASK_ENV=production \
            -e DATABASE_URL=sqlite:///app/instance/blacklist.db \
            -e PYTHONUNBUFFERED=1 \
            --health-cmd="curl -f http://localhost:2542/health || exit 1" \
            --health-interval=30s \
            --health-retries=3 \
            --health-start-period=40s \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          
          echo "âœ… ë°°í¬ ì™„ë£Œ: $NEW_VERSION"
        else
          echo "â­ï¸ ë™ì¼í•œ ë²„ì „, ë°°í¬ ìŠ¤í‚µ"
        fi

    - name: "ðŸ¥ í¬ê´„ì  í—¬ìŠ¤ì²´í¬"
      run: |
        echo "ðŸ¥ ì‹œìŠ¤í…œ ìƒíƒœ ê²€ì¦..."
        
        # ì»¨í…Œì´ë„ˆ ì‹œìž‘ ëŒ€ê¸°
        sleep 20
        
        # 1. ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
        if ! docker ps --format "{{.Names}}" | grep -q "^blacklist$"; then
          echo "âŒ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹¤íŒ¨"
          exit 1
        fi
        
        # 2. ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬
        for i in {1..10}; do
          echo "ðŸ” í—¬ìŠ¤ì²´í¬ ì‹œë„ $i/10..."
          if docker exec blacklist curl -f http://localhost:2542/health >/dev/null 2>&1; then
            echo "âœ… ë‚´ë¶€ í—¬ìŠ¤ì²´í¬ í†µê³¼"
            break
          elif [ $i -eq 10 ]; then
            echo "âŒ ë‚´ë¶€ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
            docker logs blacklist --tail 20
            exit 1
          fi
          sleep 5
        done
        
        # 3. ì™¸ë¶€ ì ‘ê·¼ í…ŒìŠ¤íŠ¸ 
        for i in {1..5}; do
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://blacklist.jclee.me/health || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… ì™¸ë¶€ ì ‘ê·¼ ì •ìƒ"
            break
          elif [ $i -eq 5 ]; then
            echo "âš ï¸ ì™¸ë¶€ ì ‘ê·¼ ì´ìŠˆ (HTTP $HTTP_CODE)"
          fi
          sleep 10
        done
        
        # 4. ë²„ì „ í™•ì¸
        DEPLOYED_VERSION=$(curl -s https://blacklist.jclee.me/api/version | grep -o '"version":"[^"]*"' | cut -d'"' -f4 || echo "unknown")
        echo "ðŸ“¦ ë°°í¬ëœ ë²„ì „: $DEPLOYED_VERSION"
        
        echo "ðŸŽ‰ ë°°í¬ ë° ê²€ì¦ ì™„ë£Œ!"

  # ========================================
  # ë°°í¬ ê²°ê³¼ ìš”ì•½
  # ========================================  
  summary:
    name: "ðŸ“Š ë°°í¬ ìš”ì•½ ë¦¬í¬íŠ¸"
    needs: [prepare, build, deploy]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: "ðŸ“Š ê²°ê³¼ ìš”ì•½ ìƒì„±"
      run: |
        echo "# ðŸ›¡ï¸ Blacklist ì‹œìŠ¤í…œ ë°°í¬ ë¦¬í¬íŠ¸" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸ“¦ ë²„ì „ ì •ë³´" >> $GITHUB_STEP_SUMMARY
        echo "- **ë™ì  ë²„ì „:** ${{ needs.prepare.outputs.version || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ë¹Œë“œ ë²„ì „:** ${{ needs.prepare.outputs.build_version || 'N/A' }}" >> $GITHUB_STEP_SUMMARY  
        echo "- **Git í•´ì‹œ:** ${{ needs.prepare.outputs.git_hash || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ì»¤ë°‹ ìˆ˜:** ${{ needs.prepare.outputs.git_count || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸš€ ë°°í¬ ìƒíƒœ" >> $GITHUB_STEP_SUMMARY
        echo "| ë‹¨ê³„ | ìƒíƒœ | ê²°ê³¼ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
        
        # ë³€ê²½ ê°ì§€ ê²°ê³¼
        if [ "${{ needs.prepare.outputs.should_deploy }}" = "true" ]; then
          echo "| ðŸ” ë³€ê²½ ê°ì§€ | âœ… | ë°°í¬ í•„ìš” |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸ” ë³€ê²½ ê°ì§€ | â­ï¸ | ë°°í¬ ë¶ˆí•„ìš” |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # ë¹Œë“œ ê²°ê³¼
        if [ "${{ needs.build.result }}" = "success" ]; then
          echo "| ðŸ³ ì´ë¯¸ì§€ ë¹Œë“œ | âœ… | ì„±ê³µ |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.prepare.outputs.should_deploy }}" = "true" ]; then
          echo "| ðŸ³ ì´ë¯¸ì§€ ë¹Œë“œ | âŒ | ì‹¤íŒ¨ |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸ³ ì´ë¯¸ì§€ ë¹Œë“œ | â­ï¸ | ìŠ¤í‚µ |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # ë°°í¬ ê²°ê³¼  
        if [ "${{ needs.deploy.result }}" = "success" ]; then
          echo "| ðŸš€ í”„ë¡œë•ì…˜ ë°°í¬ | âœ… | ì„±ê³µ |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.prepare.outputs.should_deploy }}" = "true" ]; then
          echo "| ðŸš€ í”„ë¡œë•ì…˜ ë°°í¬ | âŒ | ì‹¤íŒ¨ |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸš€ í”„ë¡œë•ì…˜ ë°°í¬ | â­ï¸ | ìŠ¤í‚µ |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŒ ì‹œìŠ¤í…œ ì ‘ì†" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸŒ ë¼ì´ë¸Œ ì‹œìŠ¤í…œ:** https://blacklist.jclee.me/" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ“Š ëŒ€ì‹œë³´ë“œ:** https://blacklist.jclee.me/dashboard" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ’š í—¬ìŠ¤ì²´í¬:** https://blacklist.jclee.me/health" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ“¦ ë²„ì „ ì •ë³´:** https://blacklist.jclee.me/api/version" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸ“ ë³€ê²½ì‚¬í•­" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "${{ needs.prepare.outputs.changed_files || 'No changes detected' }}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        
        # ìµœì¢… ìƒíƒœ
        if [ "${{ needs.deploy.result }}" = "success" ]; then
          echo "## ðŸŽ‰ ë°°í¬ ì„±ê³µ!" >> $GITHUB_STEP_SUMMARY
          echo "ì‹œìŠ¤í…œì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.prepare.outputs.should_deploy }}" = "false" ]; then
          echo "## â­ï¸ ë°°í¬ ìŠ¤í‚µ" >> $GITHUB_STEP_SUMMARY
          echo "ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ ë°°í¬ë¥¼ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
        else
          echo "## âš ï¸ ë°°í¬ ì´ìŠˆ" >> $GITHUB_STEP_SUMMARY
          echo "ë°°í¬ ê³¼ì •ì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
        fi