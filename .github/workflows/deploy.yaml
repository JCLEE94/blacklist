name: 'Blacklist K8s GitOps Deploy Pipeline'

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'scripts/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  REGISTRY: registry.jclee.me
  IMAGE_NAME: jclee94/blacklist

jobs:
  build-and-push:
    name: 'Build and Push Docker Image'
    runs-on: ubuntu-latest
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
    - name: 'Checkout Repository'
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: 'Set up Docker Buildx'
      uses: docker/setup-buildx-action@v3
      
    - name: 'Login to Registry'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.DOCKER_REGISTRY_USER }}
        password: ${{ secrets.DOCKER_REGISTRY_PASS }}
    
    - name: 'Generate Version'
      id: version
      run: |
        # Auto-increment version
        if [ -f VERSION ]; then
          CURRENT_VERSION=$(cat VERSION)
        else
          CURRENT_VERSION="1.0.0"
        fi
        
        IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
        PATCH=$((PATCH + 1))
        
        if [ $PATCH -ge 100 ]; then
          PATCH=0
          MINOR=$((MINOR + 1))
        fi
        
        if [ $MINOR -ge 100 ]; then
          MINOR=0
          MAJOR=$((MAJOR + 1))
        fi
        
        NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
        echo "$NEW_VERSION" > VERSION
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "date=$(date +'%Y-%m-%d-%H%M%S')" >> $GITHUB_OUTPUT
        
        echo "ðŸ”„ Version: $CURRENT_VERSION â†’ $NEW_VERSION"
    
    - name: 'Extract Metadata'
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=raw,value=latest,enable={{is_default_branch}}
          type=raw,value=${{ steps.version.outputs.version }}
          type=raw,value=${{ steps.version.outputs.sha_short }}
          type=raw,value={{date 'YYYY-MM-DD-HHmmss' tz='Asia/Seoul'}}
        labels: |
          org.opencontainers.image.title=Blacklist Management System
          org.opencontainers.image.description=Python Flask threat intelligence platform for K8s
          org.opencontainers.image.vendor=jclee.me
          org.opencontainers.image.version=${{ steps.version.outputs.version }}
    
    - name: 'Build and Push Image'
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        platforms: linux/amd64
        build-args: |
          VERSION=${{ steps.version.outputs.version }}
          BUILD_DATE=${{ steps.version.outputs.date }}
          VCS_REF=${{ steps.version.outputs.sha_short }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        provenance: false
    
    - name: 'Commit Version Update'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add VERSION
        
        if ! git diff --staged --quiet; then
          git commit -m "chore: bump version to ${{ steps.version.outputs.version }} [skip ci]"
          git push origin main
        fi

  deploy-gitops:
    name: 'K8s GitOps Deployment'
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: 'ArgoCD Auto-Sync Status'
      run: |
        echo "ðŸ”„ ArgoCD GitOps Deployment Pipeline"
        echo "=================================="
        echo ""
        echo "ðŸ“¦ **Docker Image:** ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
        echo "ðŸ·ï¸  **Version:** ${{ needs.build-and-push.outputs.version }}"
        echo "ðŸ“ **K8s Path:** k8s/overlays/production"
        echo "ðŸŽ¯ **Namespace:** default"
        echo "ðŸŒ **Cluster:** k8s.jclee.me"
        echo ""
        echo "âš™ï¸  **ArgoCD Configuration:**"
        echo "  - Auto Sync: âœ… Enabled"
        echo "  - Self Heal: âœ… Enabled"
        echo "  - Prune: âœ… Enabled" 
        echo "  - Sync Wave: 1"
        echo ""
        echo "ðŸ”— **Monitoring URLs:**"
        echo "  - ArgoCD: https://argo.jclee.me/applications/blacklist-production"
        echo "  - Application: https://blacklist.jclee.me"
        echo "  - Health Check: https://blacklist.jclee.me/health"
    
    - name: 'Watchtower Fallback'
      run: |
        echo "ðŸ³ **Watchtower Backup Deployment**"
        echo "================================="
        echo ""
        echo "WatchtowerëŠ” 60ì´ˆ ê°„ê²©ìœ¼ë¡œ ìƒˆ ì´ë¯¸ì§€ë¥¼ ê°ì§€í•˜ê³  ìžë™ ë°°í¬í•©ë‹ˆë‹¤."
        echo "ArgoCDê°€ ì‹¤íŒ¨í•˜ëŠ” ê²½ìš° Watchtowerê°€ Docker Composeë¡œ fallback ì œê³µí•©ë‹ˆë‹¤."
        echo ""
        echo "ðŸ“ **Watchtower ëŒ€ìƒ ì„œë²„:**"
        echo "  - 192.168.50.110 (K8s Node)"
        echo "  - Docker Compose í™˜ê²½"

  verify-deployment:
    name: 'Deployment Verification'
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-gitops]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: 'Wait for Deployment'
      run: |
        echo "â³ K8s ë¡¤ë§ ì—…ë°ì´íŠ¸ ëŒ€ê¸° ì¤‘..."
        echo "ArgoCD syncì™€ pod ìž¬ì‹œìž‘ì„ ìœ„í•´ 2ë¶„ ëŒ€ê¸°í•©ë‹ˆë‹¤."
        sleep 120
    
    - name: 'Health Check Verification'
      run: |
        echo "ðŸ¥ ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ í™•ì¸..."
        
        # Health check with retry
        for i in {1..5}; do
          if curl -f -s --max-time 10 https://blacklist.jclee.me/health; then
            echo "âœ… Health check ì„±ê³µ (ì‹œë„ $i/5)"
            break
          else
            echo "â³ Health check ì‹¤íŒ¨ - ìž¬ì‹œë„ $i/5 (30ì´ˆ í›„)"
            sleep 30
          fi
        done
    
    - name: 'Generate Deployment Summary'
      run: |
        echo "### ðŸš€ K8s GitOps ë°°í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ë°°í¬ ì •ë³´:**" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ·ï¸ ë²„ì „: \`${{ needs.build-and-push.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¦ ì´ë¯¸ì§€: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŽ¯ ë„¤ìž„ìŠ¤íŽ˜ì´ìŠ¤: \`default\`" >> $GITHUB_STEP_SUMMARY
        echo "- â˜¸ï¸ í´ëŸ¬ìŠ¤í„°: \`k8s.jclee.me\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ë°°í¬ ë°©ì‹:**" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”„ ArgoCD GitOps (Primary)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ³ Watchtower (Fallback)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ì ‘ê·¼ URL:**" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ ì• í”Œë¦¬ì¼€ì´ì…˜: https://blacklist.jclee.me" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“Š ArgoCD ëŒ€ì‹œë³´ë“œ: https://argo.jclee.me" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ” ìƒíƒœ í™•ì¸: https://blacklist.jclee.me/health" >> $GITHUB_STEP_SUMMARY