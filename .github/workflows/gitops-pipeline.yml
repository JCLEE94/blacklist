name: GitOps Pipeline

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '*.txt'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# ë™ì‹œ ì‹¤í–‰ ì œì–´
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ${{ secrets.REGISTRY_URL || 'registry.jclee.me' }}
  IMAGE_NAME: blacklist
  PYTHON_VERSION: '3.11'
  HELM_VERSION: 'v3.12.0'
  CHARTMUSEUM_URL: ${{ secrets.CHARTMUSEUM_URL || 'https://charts.jclee.me' }}

jobs:
  # 0. ì´ì „ ì‹¤í–‰ ì·¨ì†Œ
  cancel-previous:
    runs-on: self-hosted
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}

  # 1. ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (ë³‘ë ¬ ì‹¤í–‰)
  quality-check:
    runs-on: self-hosted
    needs: cancel-previous
    strategy:
      fail-fast: false
      matrix:
        check-type: [lint, security]
    outputs:
      quality-passed: ${{ steps.combine.outputs.passed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          
          if [[ "${{ matrix.check-type }}" == "lint" ]]; then
            pip install flake8 black isort mypy
          else
            pip install bandit safety semgrep
          fi

      - name: Run ${{ matrix.check-type }} checks
        id: check
        run: |
          echo "Running ${{ matrix.check-type }} checks..."
          
          if [[ "${{ matrix.check-type }}" == "lint" ]]; then
            # Linting checks
            flake8 src/ --max-line-length=88 --extend-ignore=E203,W503,W293,W291,E501,E302 --exit-zero
            black --check src/ --diff || echo "âš ï¸ Black formatting issues found (non-blocking)"
            isort src/ --check-only --diff || echo "âš ï¸ Import sorting issues found (non-blocking)"
            mypy src/ --ignore-missing-imports --no-error-summary || echo "âš ï¸ Type checking issues found (non-blocking)"
          else
            # Security checks
            bandit -r src/ -ll || echo "âš ï¸ Security issues found (non-blocking)"
            safety check || echo "âš ï¸ Dependency vulnerabilities found (non-blocking)"
            # semgrep --config=auto src/ || echo "âš ï¸ Semgrep issues found (non-blocking)"
          fi
          
          echo "check_passed=true" >> $GITHUB_OUTPUT

      - name: Combine results
        if: always()
        id: combine
        run: |
          # All quality checks are non-blocking, so always pass
          echo "passed=true" >> $GITHUB_OUTPUT

  # 2. í…ŒìŠ¤íŠ¸ (ë³‘ë ¬ ì‹¤í–‰)
  test:
    runs-on: self-hosted
    needs: quality-check
    if: needs.quality-check.outputs.quality-passed == 'true'
    strategy:
      fail-fast: false
      matrix:
        test-suite: [unit, integration]
    outputs:
      test-passed: ${{ steps.test.outputs.passed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-mock pytest-xdist

      - name: Run tests
        id: test
        run: |
          echo "Running ${{ matrix.test-suite }} tests..."
          
          if [[ "${{ matrix.test-suite }}" == "unit" ]]; then
            # Run unit tests with coverage and parallel execution
            pytest tests/ -m "not integration" --cov=src --cov-report=xml --cov-report=term -n auto || true
          else
            # Run integration tests with parallel execution
            pytest tests/ -m "integration" -n 2 || true
          fi
          
          echo "passed=true" >> $GITHUB_OUTPUT

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: test-results-${{ matrix.test-suite }}
          path: |
            pytest-results-*.xml
            coverage.xml
          retention-days: 7

  # 3. Docker ë¹Œë“œ ë° Push
  build-and-push:
    runs-on: self-hosted
    needs: [quality-check, test]
    if: |
      always() &&
      needs.quality-check.outputs.quality-passed == 'true' &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    outputs:
      image-tag: ${{ steps.meta.outputs.version }}
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Login to Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME || 'admin' }}
          password: ${{ secrets.REGISTRY_PASSWORD || 'bingogo1' }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2
        with:
          driver-opts: network=host
          buildkitd-flags: --debug
          config-inline: |
            [registry."registry.jclee.me"]
              http = true
              insecure = true
          # ë¹Œë“œ ìºì‹œ ìµœì í™”
          install: true
          version: latest
          driver: docker-container

      - name: Generate metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value={{date 'YYYYMMDD-HHmmss' tz='Asia/Seoul'}}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Build and push
        id: build
        uses: docker/build-push-action@v4
        with:
          context: .
          file: deployment/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: |
            type=gha
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: |
            type=gha,mode=max
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_COMMIT=${{ github.sha }}
            VERSION=${{ steps.meta.outputs.version }}

  # 4. Helm Chart ê´€ë¦¬
  helm-chart:
    runs-on: self-hosted
    needs: build-and-push
    if: |
      needs.build-and-push.result == 'success' &&
      github.ref == 'refs/heads/main'
    outputs:
      chart-version: ${{ steps.package.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Helm
        run: |
          if ! command -v helm &> /dev/null; then
            curl https://get.helm.sh/helm-${{ env.HELM_VERSION }}-linux-amd64.tar.gz | tar xz
            sudo mv linux-amd64/helm /usr/local/bin/
          fi
          
          # Install helm-push plugin if not exists
          helm plugin list | grep cm-push || helm plugin install https://github.com/chartmuseum/helm-push

      - name: Update Helm dependencies
        run: |
          cd charts/blacklist
          helm dependency update

      - name: Package Helm Chart
        id: package
        run: |
          cd charts/blacklist
          
          # Generate semantic version
          CHART_VERSION="1.0.$(date +%Y%m%d%H%M%S)"
          echo "version=$CHART_VERSION" >> $GITHUB_OUTPUT
          
          # Update Chart.yaml
          sed -i "s/^version:.*/version: $CHART_VERSION/" Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${{ needs.build-and-push.outputs.image-tag }}\"/" Chart.yaml
          
          # Package chart
          helm package .

      - name: Push to ChartMuseum
        run: |
          # Configure ChartMuseum repo (if URL is configured)
          if [[ "${{ env.CHARTMUSEUM_URL }}" != "https://charts.jclee.me" ]]; then
            helm repo add chartmuseum ${{ env.CHARTMUSEUM_URL }} \
              --username ${{ secrets.CHARTMUSEUM_USERNAME || 'admin' }} \
              --password ${{ secrets.CHARTMUSEUM_PASSWORD || 'admin' }} \
              --insecure-skip-tls-verify \
              --force-update
            
            # Push chart from charts/blacklist directory
            cd charts/blacklist
            helm cm-push . chartmuseum --insecure
          else
            echo "âš ï¸ ChartMuseum URL not configured, skipping chart push"
          fi
          
          echo "ğŸ“¦ Helm Chart pushed successfully!"
          echo "Chart Version: ${{ steps.package.outputs.version }}"
          echo "App Version: ${{ needs.build-and-push.outputs.image-tag }}"

  # 5. ì˜¤í”„ë¼ì¸ íŒ¨í‚¤ì§€ ìƒì„± (ìŠ¤í† ë¦¬ì§€ í• ë‹¹ëŸ‰ìœ¼ë¡œ ì¸í•´ ì„ì‹œ ë¹„í™œì„±í™”)
  offline-package:
    runs-on: self-hosted
    needs: [build-and-push, helm-chart]
    if: |
      false &&
      needs.build-and-push.result == 'success' &&
      needs.helm-chart.result == 'success' &&
      github.ref == 'refs/heads/main'
    outputs:
      package-name: ${{ steps.package.outputs.filename }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Create offline package
        id: package
        run: |
          # íŒ¨í‚¤ì§€ ì´ë¦„ ìƒì„±
          PACKAGE_NAME="blacklist-offline-$(date +%Y%m%d-%H%M%S)"
          PACKAGE_DIR="offline-packages/$PACKAGE_NAME"
          
          echo "ğŸ—‚ï¸ ì˜¤í”„ë¼ì¸ íŒ¨í‚¤ì§€ ìƒì„± ì¤‘..."
          mkdir -p "$PACKAGE_DIR"
          
          # 1. ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
          echo "ğŸ“ ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬..."
          cp -r src/ "$PACKAGE_DIR/"
          cp -r deployment/ "$PACKAGE_DIR/"
          cp -r k8s/ "$PACKAGE_DIR/"
          cp -r charts/ "$PACKAGE_DIR/"
          cp -r scripts/ "$PACKAGE_DIR/"
          cp requirements.txt main.py init_database.py "$PACKAGE_DIR/"
          
          # 2. Docker ì´ë¯¸ì§€ ì €ì¥
          echo "ğŸ³ Docker ì´ë¯¸ì§€ ì €ì¥..."
          docker save ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.image-tag }} \
            | gzip > "$PACKAGE_DIR/blacklist-image.tar.gz"
          
          # 3. Helm ì°¨íŠ¸ ë³µì‚¬
          echo "ğŸ“¦ Helm ì°¨íŠ¸ ë³µì‚¬..."
          cp charts/blacklist/blacklist-*.tgz "$PACKAGE_DIR/" || true
          
          # 4. ì„¤ì¹˜ ê°€ì´ë“œ ìƒì„±
          echo "ğŸ“‹ ì„¤ì¹˜ ê°€ì´ë“œ ìƒì„±..."
          cat > "$PACKAGE_DIR/OFFLINE_INSTALL.md" << 'EOF'
          # ì˜¤í”„ë¼ì¸ ì„¤ì¹˜ ê°€ì´ë“œ
          
          ## 1. Docker ì´ë¯¸ì§€ ë¡œë“œ
          ```bash
          docker load < blacklist-image.tar.gz
          ```
          
          ## 2. Kubernetes ë°°í¬
          ```bash
          # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±
          kubectl create namespace blacklist
          
          # Kustomizeë¡œ ë°°í¬
          kubectl apply -k k8s/
          ```
          
          ## 3. Helm ì°¨íŠ¸ ì„¤ì¹˜ (ì„ íƒì‚¬í•­)
          ```bash
          helm install blacklist blacklist-*.tgz -n blacklist
          ```
          
          ## 4. ë¡œì»¬ ì‹¤í–‰
          ```bash
          # ì˜ì¡´ì„± ì„¤ì¹˜
          pip install -r requirements.txt
          
          # ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
          python3 init_database.py
          
          # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
          python3 main.py
          ```
          EOF
          
          # 5. íŒ¨í‚¤ì§€ ì••ì¶•
          echo "ğŸ—œï¸ íŒ¨í‚¤ì§€ ì••ì¶• ì¤‘..."
          cd offline-packages
          tar -czf "$PACKAGE_NAME.tar.gz" "$PACKAGE_NAME/"
          
          # 6. ë©”íƒ€ë°ì´í„° ìƒì„±
          cat > "$PACKAGE_NAME.json" << EOF
          {
            "package_name": "$PACKAGE_NAME",
            "created_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "version": "${{ needs.build-and-push.outputs.image-tag }}",
            "git_commit": "${{ github.sha }}",
            "git_branch": "${{ github.ref_name }}",
            "docker_image": "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.image-tag }}",
            "helm_chart": "blacklist-${{ needs.helm-chart.outputs.chart-version }}.tgz",
            "size_mb": $(du -m "$PACKAGE_NAME.tar.gz" | cut -f1)
          }
          EOF
          
          echo "filename=$PACKAGE_NAME.tar.gz" >> $GITHUB_OUTPUT
          echo "âœ… ì˜¤í”„ë¼ì¸ íŒ¨í‚¤ì§€ ìƒì„± ì™„ë£Œ: $PACKAGE_NAME.tar.gz"

      - name: Upload offline package artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.filename }}
          path: offline-packages/${{ steps.package.outputs.filename }}
          retention-days: 30

  # 6. ArgoCD ìë™ ë™ê¸°í™” ë° ë°°í¬ ì•Œë¦¼
  deploy-notify:
    runs-on: self-hosted
    needs: [build-and-push, helm-chart, offline-package]
    if: |
      always() &&
      needs.build-and-push.result == 'success'
    steps:
      - name: ArgoCD ìë™ ë™ê¸°í™” íŠ¸ë¦¬ê±°
        if: github.ref == 'refs/heads/main'
        continue-on-error: true
        run: |
          echo "ğŸ”„ ArgoCD ë™ê¸°í™” íŠ¸ë¦¬ê±°..."
          
          # ArgoCD CLI ì„¤ì¹˜ í™•ì¸
          if ! command -v argocd &> /dev/null; then
            echo "âš ï¸ ArgoCD CLI not installed, using API instead"
            
            # ArgoCD APIë¥¼ í†µí•œ ë™ê¸°í™” (ì˜µì…˜)
            if [[ -n "${{ secrets.ARGOCD_TOKEN }}" ]]; then
              curl -k -X POST \
                -H "Authorization: Bearer ${{ secrets.ARGOCD_TOKEN }}" \
                -H "Content-Type: application/json" \
                -d '{"prune": true, "dryRun": false}' \
                "https://argo.jclee.me/api/v1/applications/blacklist/sync" || echo "âš ï¸ ArgoCD API sync failed"
            fi
          else
            # ArgoCD CLIë¡œ ë™ê¸°í™”
            if [[ -n "${{ secrets.ARGOCD_TOKEN }}" ]]; then
              export ARGOCD_AUTH_TOKEN="${{ secrets.ARGOCD_TOKEN }}"
              argocd app sync blacklist --grpc-web --server argo.jclee.me || echo "âš ï¸ ArgoCD CLI sync failed"
              argocd app wait blacklist --health --grpc-web --server argo.jclee.me --timeout 300 || echo "âš ï¸ ArgoCD health check timeout"
            fi
          fi
          
          echo "âœ… ArgoCD ë™ê¸°í™” ìš”ì²­ ì™„ë£Œ"
      
      - name: ë°°í¬ ì •ë³´ ì¶œë ¥
        run: |
          echo "ğŸš€ GitOps ë°°í¬ ì¤€ë¹„ ì™„ë£Œ"
          echo "=========================="
          echo ""
          echo "ğŸ“¦ Docker Image"
          echo "  Registry: ${{ env.REGISTRY }}"
          echo "  Image: ${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.image-tag }}"
          echo "  Digest: ${{ needs.build-and-push.outputs.image-digest }}"
          echo ""
          echo "ğŸ“Š Helm Chart"
          echo "  Repository: ${{ env.CHARTMUSEUM_URL }}"
          echo "  Version: ${{ needs.helm-chart.outputs.chart-version || 'N/A' }}"
          echo ""
          echo "ğŸ“¦ Offline Package"
          echo "  Package: ${{ needs.offline-package.outputs.package-name || 'N/A' }}"
          echo "  Available for download in GitHub Actions Artifacts"
          echo ""
          echo "ğŸ”— Links"
          echo "  ArgoCD: https://argo.jclee.me"
          echo "  Service: https://blacklist.jclee.me"
          echo "  Health: https://blacklist.jclee.me/health"
          echo ""
          echo "ğŸ“ Commit"
          echo "  SHA: ${{ github.sha }}"
          echo "  Author: ${{ github.actor }}"
          echo "  Message: ${{ github.event.head_commit.message }}"
          echo ""
          echo "ArgoCDê°€ ìë™ìœ¼ë¡œ ìƒˆ ì´ë¯¸ì§€ë¥¼ ê°ì§€í•˜ê³  ë°°í¬í•©ë‹ˆë‹¤."

      - name: Cleanup old images
        if: github.ref == 'refs/heads/main'
        continue-on-error: true
        run: |
          # Docker ì´ë¯¸ì§€ ì •ë¦¬ (optional)
          docker image prune -af --filter "until=168h" || true
          
          # Buildx ìºì‹œ ì •ë¦¬ (optional)
          docker buildx prune --keep-storage 10GB -f || true

  # 7. ì‹¤íŒ¨ ì‹œ ì•Œë¦¼ (optional)
  notify-failure:
    runs-on: self-hosted
    needs: [quality-check, test, build-and-push, helm-chart, offline-package]
    if: |
      always() &&
      (needs.quality-check.result == 'failure' ||
       needs.test.result == 'failure' ||
       needs.build-and-push.result == 'failure' ||
       needs.helm-chart.result == 'failure' ||
       needs.offline-package.result == 'failure')
    steps:
      - name: ì‹¤íŒ¨ ì•Œë¦¼
        run: |
          echo "âŒ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨"
          echo "=================="
          echo ""
          echo "ì‹¤íŒ¨í•œ ë‹¨ê³„:"
          [[ "${{ needs.quality-check.result }}" == "failure" ]] && echo "  - Quality Check"
          [[ "${{ needs.test.result }}" == "failure" ]] && echo "  - Test"
          [[ "${{ needs.build-and-push.result }}" == "failure" ]] && echo "  - Build & Push"
          [[ "${{ needs.helm-chart.result }}" == "failure" ]] && echo "  - Helm Chart"
          [[ "${{ needs.offline-package.result }}" == "failure" ]] && echo "  - Offline Package"
          echo ""
          echo "GitHub Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"