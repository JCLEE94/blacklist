name: Kubernetes Build and Deploy

permissions:
  contents: read
  packages: write

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: registry.jclee.me
  IMAGE_NAME: blacklist

jobs:
  # ë¹ ë¥¸ ì²´í¬ë“¤ì„ ë³‘ë ¬ë¡œ ì‹¤í–‰
  quality-checks:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
      
      - name: Python Syntax Check
        run: |
          echo "ğŸ” Running Python syntax checks..."
          python3 -m py_compile src/core/har_based_regtech_collector.py || echo "âš ï¸ Syntax issues in REGTECH collector"
          python3 -m py_compile src/core/har_based_secudium_collector.py || echo "âš ï¸ Syntax issues in SECUDIUM collector"
          python3 -m py_compile src/core/collection_manager.py || echo "âš ï¸ Syntax issues in collection manager"
          echo "âœ… Syntax checks completed"

      - name: Basic Security Check
        run: |
          echo "ğŸ”’ Running basic security checks..."
          # Check for hardcoded secrets
          if grep -r -E "(password|secret|key|token)\s*=\s*['\"][^'\"]*['\"]" --include="*.py" src/ 2>/dev/null; then
            echo "âš ï¸ Potential hardcoded secrets found!"
          else
            echo "âœ… No hardcoded secrets detected"
          fi
          echo "âœ… Security checks completed"

  # Docker ë¹Œë“œ ë° ë ˆì§€ìŠ¤íŠ¸ë¦¬ í‘¸ì‹œ
  build-and-push:
    needs: quality-checks
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      
      - name: Login to Docker Registry
        run: |
          echo "ğŸ” Logging into registry..."
          # Docker Hub ìê²©ì¦ëª…ì„ registry.jclee.meì—ë„ ì‚¬ìš©
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login registry.jclee.me -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          echo "âœ… Registry login completed"
          
      - name: Build and Push Docker Image
        run: |
          echo "ğŸ”¨ Building Docker image..."
          
          # ë¹Œë“œ ì‹œê°„ê³¼ ì»¤ë°‹ ì •ë³´
          BUILD_TIME=$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')
          
          # Docker ì´ë¯¸ì§€ ë¹Œë“œ
          docker build \
            -f deployment/Dockerfile \
            --target production \
            --build-arg BUILD_TIME="$BUILD_TIME" \
            --build-arg GIT_COMMIT="${{ github.sha }}" \
            --build-arg GIT_BRANCH="${{ github.ref_name }}" \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            .
          
          echo "ğŸ“¤ Pushing to registry..."
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          
          echo "âœ… Build and push completed successfully!"

  # Kubernetes ë°°í¬ ë° ê²€ì¦
  deploy-to-k8s:
    needs: build-and-push
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Kubernetes Access
        run: |
          echo "ğŸ”‘ Setting up Kubernetes access..."
          # kubeconfig ì„¤ì • (self-hosted runnerì— ì´ë¯¸ ì„¤ì •ë˜ì–´ ìˆì–´ì•¼ í•¨)
          export KUBECONFIG=${{ github.workspace }}/.kube/config
          
          # ë˜ëŠ” í™˜ê²½ë³€ìˆ˜ì—ì„œ kubeconfig ìƒì„±
          if [ -n "${{ secrets.KUBE_CONFIG }}" ]; then
            echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ${{ github.workspace }}/.kube/config
            chmod 600 ${{ github.workspace }}/.kube/config
          fi
          
          # ì—°ê²° í…ŒìŠ¤íŠ¸
          kubectl version --client
          kubectl get nodes
          echo "âœ… Kubernetes access configured"
      
      - name: Deploy to Kubernetes
        run: |
          echo "ğŸš€ Deploying to Kubernetes..."
          
          # Kustomizeë¡œ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
          cd k8s
          if command -v kustomize &> /dev/null; then
            kustomize edit set image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          else
            # kustomizeê°€ ì—†ìœ¼ë©´ kubectl ì‚¬ìš©
            kubectl set image deployment/blacklist blacklist=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} -n blacklist --dry-run=client -o yaml > temp-deployment.yaml
          fi
          
          # ë°°í¬ ì ìš©
          kubectl apply -k . || kubectl apply -f .
          
          # ë¡¤ì•„ì›ƒ ëŒ€ê¸°
          kubectl rollout status deployment/blacklist -n blacklist --timeout=300s
          
          echo "âœ… Kubernetes deployment completed"

      - name: Verify Kubernetes Deployment
        run: |
          echo "ğŸ” Verifying Kubernetes deployment..."
          
          # Pod ìƒíƒœ í™•ì¸
          echo "ğŸ“Š Pod status:"
          kubectl get pods -n blacklist -l app=blacklist
          
          # Service ìƒíƒœ í™•ì¸
          echo "ğŸŒ Service status:"
          kubectl get svc -n blacklist
          
          # ìµœì‹  ì´ë²¤íŠ¸ í™•ì¸
          echo "ğŸ“… Recent events:"
          kubectl get events -n blacklist --sort-by='.lastTimestamp' | tail -10
          
          # NodePortë¥¼ í†µí•œ Health ì²´í¬
          NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
          NODE_PORT=$(kubectl get svc blacklist-nodeport -n blacklist -o jsonpath='{.spec.ports[0].nodePort}')
          
          echo "ğŸ” Testing via NodePort: http://$NODE_IP:$NODE_PORT/health"
          
          # ìµœëŒ€ 30ë²ˆ ì‹œë„ (5ë¶„)
          MAX_ATTEMPTS=30
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "ğŸ” Attempt $ATTEMPT/$MAX_ATTEMPTS: Testing application health..."
            
            # Health ì²´í¬
            if curl -f -s --connect-timeout 5 --max-time 10 "http://$NODE_IP:$NODE_PORT/health" > /dev/null 2>&1; then
              echo "âœ… Application is healthy!"
              break
            else
              echo "â³ Application not ready yet, waiting 10 seconds..."
              sleep 10
            fi
            
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "âŒ Application failed to become healthy"
              kubectl logs deployment/blacklist -n blacklist --tail=50
              exit 1
            fi
          done

      - name: Smoke Tests
        run: |
          echo "ğŸ§ª Running smoke tests..."
          
          # NodePortë¥¼ í†µí•œ í…ŒìŠ¤íŠ¸
          NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
          NODE_PORT=$(kubectl get svc blacklist-nodeport -n blacklist -o jsonpath='{.spec.ports[0].nodePort}')
          BASE_URL="http://$NODE_IP:$NODE_PORT"
          
          # í•µì‹¬ ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
          endpoints=(
            "$BASE_URL/health"
            "$BASE_URL/api/stats"
            "$BASE_URL/api/collection/status"
            "$BASE_URL/test"
          )
          
          for endpoint in "${endpoints[@]}"; do
            echo "Testing $endpoint..."
            if curl -f -s --max-time 10 "$endpoint" > /dev/null; then
              echo "âœ… $endpoint: OK"
            else
              echo "âŒ $endpoint: FAILED"
              # ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰ (ì¼ë¶€ ì—”ë“œí¬ì¸íŠ¸ëŠ” ì•„ì§ ë¬¸ì œê°€ ìˆì„ ìˆ˜ ìˆìŒ)
            fi
          done
          
          echo "âœ… Smoke tests completed!"

  # ë°°í¬ ì™„ë£Œ ì•Œë¦¼
  notify:
    needs: [build-and-push, deploy-to-k8s]
    runs-on: self-hosted
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: Deployment Summary
        run: |
          echo "## ë°°í¬ ì™„ë£Œ ğŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ìƒíƒœ | ${{ needs.deploy-to-k8s.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì´ë¯¸ì§€ | ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì»¤ë°‹ | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ë¸Œëœì¹˜ | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | https://blacklist.jclee.me |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy-to-k8s.result }}" != "success" ]; then
            echo "âš ï¸ **ì£¼ì˜**: Kubernetes ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
          else
            echo "ğŸ‰ **ì„±ê³µ**: Kubernetes ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Send Success Notification
        if: needs.deploy-to-k8s.result == 'success'
        run: |
          echo "ğŸ“¢ Kubernetes ë°°í¬ ì„±ê³µ ì•Œë¦¼..."
          
          # ë°°í¬ ì •ë³´ ìˆ˜ì§‘
          DEPLOYMENT_INFO=$(kubectl get deployment blacklist -n blacklist -o json)
          READY_REPLICAS=$(echo "$DEPLOYMENT_INFO" | jq '.status.readyReplicas // 0')
          DESIRED_REPLICAS=$(echo "$DEPLOYMENT_INFO" | jq '.spec.replicas // 0')
          
          echo "âœ… Kubernetes ë°°í¬ ì™„ë£Œ:"
          echo "   - Ready: $READY_REPLICAS/$DESIRED_REPLICAS replicas"
          echo "   - Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "   - Namespace: blacklist"
          
          # ArgoCDê°€ ì„¤ì¹˜ë˜ì–´ ìˆë‹¤ë©´ ë™ê¸°í™”
          if command -v argocd &> /dev/null; then
            echo "ğŸ”„ Syncing ArgoCD application..."
            argocd app sync blacklist --async || echo "âš ï¸ ArgoCD sync failed (not critical)"
          fi
          
          echo "âœ… ë°°í¬ ì„±ê³µ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ"