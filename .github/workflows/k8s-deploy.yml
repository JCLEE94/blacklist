name: Enhanced Kubernetes CI/CD Pipeline

permissions:
  contents: read
  packages: write

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no changes'
        required: false
        default: 'false'
        type: boolean

env:
  REGISTRY: registry.jclee.me
  IMAGE_NAME: blacklist
  NAMESPACE: blacklist

jobs:
  # ë¹ ë¥¸ ì²´í¬ë“¤ì„ ë³‘ë ¬ë¡œ ì‹¤í–‰
  quality-checks:
    runs-on: self-hosted
    outputs:
      should_deploy: ${{ steps.check_changes.outputs.should_deploy }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2
      
      - name: Check for relevant changes
        id: check_changes
        run: |
          echo "ğŸ” Checking for relevant changes..."
          
          # ë°°í¬ ê´€ë ¨ íŒŒì¼ë“¤ ì²´í¬
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\.(py|yml|yaml|dockerfile|sh|ps1)$|requirements\.txt|^k8s/|^scripts/|^deployment/' | wc -l)
          
          if [ "$CHANGED_FILES" -gt 0 ] || [ "${{ github.event.inputs.force_deploy }}" == "true" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… Deployment needed: $CHANGED_FILES relevant files changed"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "â© No deployment needed: No relevant files changed"
          fi
      
      - name: Python Syntax Check
        run: |
          echo "ğŸ” Running Python syntax checks..."
          python3 -m py_compile src/core/har_based_regtech_collector.py || echo "âš ï¸ Syntax issues in REGTECH collector"
          python3 -m py_compile src/core/har_based_secudium_collector.py || echo "âš ï¸ Syntax issues in SECUDIUM collector"
          python3 -m py_compile src/core/collection_manager.py || echo "âš ï¸ Syntax issues in collection manager"
          python3 -m py_compile src/core/unified_service.py || echo "âš ï¸ Syntax issues in unified service"
          echo "âœ… Syntax checks completed"

      - name: Basic Security Check
        run: |
          echo "ğŸ”’ Running basic security checks..."
          # Check for hardcoded secrets
          if grep -r -E "(password|secret|key|token)\s*=\s*['\"][^'\"]*['\"]" --include="*.py" src/ 2>/dev/null; then
            echo "âš ï¸ Potential hardcoded secrets found!"
          else
            echo "âœ… No hardcoded secrets detected"
          fi
          echo "âœ… Security checks completed"

  # Docker ë¹Œë“œ ë° ë ˆì§€ìŠ¤íŠ¸ë¦¬ í‘¸ì‹œ
  build-and-push:
    needs: quality-checks
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main' && needs.quality-checks.outputs.should_deploy == 'true'
    outputs:
      image_tag: ${{ steps.build.outputs.image_tag }}
      build_time: ${{ steps.build.outputs.build_time }}
    steps:
      - uses: actions/checkout@v3
      
      - name: Login to Docker Registry
        run: |
          echo "ğŸ” Logging into registry..."
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login registry.jclee.me -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          echo "âœ… Registry login completed"
          
      - name: Build and Push Docker Image
        id: build
        run: |
          echo "ğŸ”¨ Building Docker image..."
          
          # ë¹Œë“œ ì‹œê°„ê³¼ ì»¤ë°‹ ì •ë³´
          BUILD_TIME=$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')
          SHORT_SHA_8=${GITHUB_SHA:0:8}
          SHORT_SHA_7=${GITHUB_SHA:0:7}
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          # ë‹¤ì–‘í•œ ì´ë¯¸ì§€ íƒœê·¸ë“¤ (ìë™ ì—…ë°ì´í„° í˜¸í™˜ì„± í–¥ìƒ)
          LATEST_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          SHA8_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${SHORT_SHA_8}"
          SHA7_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${SHORT_SHA_7}"
          BRANCH_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}"
          TIMESTAMP_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TIMESTAMP}"
          
          # Docker ì´ë¯¸ì§€ ë¹Œë“œ (ë‹¤ì¤‘ íƒœê·¸)
          docker build \
            -f deployment/Dockerfile \
            --target production \
            --build-arg BUILD_TIME="$BUILD_TIME" \
            --build-arg GIT_COMMIT="${{ github.sha }}" \
            --build-arg GIT_BRANCH="${{ github.ref_name }}" \
            -t "$LATEST_TAG" \
            -t "$SHA8_TAG" \
            -t "$SHA7_TAG" \
            -t "$BRANCH_TAG" \
            -t "$TIMESTAMP_TAG" \
            .
          
          echo "ğŸ“¤ Pushing to registry..."
          docker push "$LATEST_TAG"
          docker push "$SHA8_TAG"
          docker push "$SHA7_TAG"
          docker push "$BRANCH_TAG"
          docker push "$TIMESTAMP_TAG"
          
          # ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬
          docker image prune -f --filter "until=24h"
          
          # ì¶œë ¥ ì„¤ì • (ìë™ ì—…ë°ì´í„°ê°€ ê°ì§€í•  ìˆ˜ ìˆëŠ” íƒœê·¸ ìš°ì„ )
          echo "image_tag=${SHORT_SHA_7}" >> $GITHUB_OUTPUT
          echo "image_tag_8=${SHORT_SHA_8}" >> $GITHUB_OUTPUT
          echo "timestamp_tag=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          
          echo "âœ… Build and push completed successfully!"
          echo "ğŸ“¦ Image tags:"
          echo "   - Latest: $LATEST_TAG"
          echo "   - SHA-7: $SHA7_TAG"
          echo "   - SHA-8: $SHA8_TAG"
          echo "   - Branch: $BRANCH_TAG"
          echo "   - Timestamp: $TIMESTAMP_TAG"

  # Kubernetes ë°°í¬ ë° ê²€ì¦
  deploy-to-k8s:
    needs: [quality-checks, build-and-push]
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main' && needs.quality-checks.outputs.should_deploy == 'true'
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Kubernetes Access
        run: |
          echo "ğŸ”‘ Setting up Kubernetes access..."
          
          # kubeconfig ì—°ê²° í…ŒìŠ¤íŠ¸
          kubectl version --client
          kubectl get nodes --no-headers | head -3
          echo "âœ… Kubernetes access configured"
      
      - name: Deploy to Kubernetes using script
        run: |
          echo "ğŸš€ Deploying to Kubernetes using deployment script..."
          
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          export IMAGE_TAG="${{ needs.build-and-push.outputs.image_tag }}"
          export DEPLOYMENT_REASON="CI/CD Pipeline - Commit ${{ github.sha }}"
          
          echo "ğŸ“‹ Deployment info:"
          echo "   - Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
          echo "   - Namespace: ${{ env.NAMESPACE }}"
          echo "   - Reason: $DEPLOYMENT_REASON"
          
          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          chmod +x scripts/deploy.sh
          ./scripts/deploy.sh
          
          echo "âœ… Deployment script completed"

      - name: Force Image Update
        run: |
          echo "ğŸ”„ Forcing image update..."
          
          # ì´ë¯¸ì§€ ê°•ì œ ì—…ë°ì´íŠ¸
          kubectl set image deployment/blacklist \
            blacklist="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.image_tag }}" \
            -n ${{ env.NAMESPACE }}
          
          # ë¡¤ì•„ì›ƒ ì¬ì‹œì‘ (ì´ë¯¸ì§€ê°€ ê°™ì•„ë„ ê°•ì œ ì¬ë°°í¬)
          kubectl rollout restart deployment/blacklist -n ${{ env.NAMESPACE }}
          
          # ë¡¤ì•„ì›ƒ ìƒíƒœ ëŒ€ê¸°
          kubectl rollout status deployment/blacklist -n ${{ env.NAMESPACE }} --timeout=600s
          
          echo "âœ… Image update completed"

      - name: Verify Deployment
        run: |
          echo "ğŸ” Verifying deployment..."
          
          # Pod ìƒíƒœ í™•ì¸
          echo "ğŸ“Š Pod status:"
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=blacklist -o wide
          
          # ì´ë¯¸ì§€ íƒœê·¸ í™•ì¸
          CURRENT_IMAGE=$(kubectl get deployment blacklist -n ${{ env.NAMESPACE }} -o jsonpath='{.spec.template.spec.containers[0].image}')
          echo "ğŸ·ï¸  Current image: $CURRENT_IMAGE"
          
          # Service ìƒíƒœ í™•ì¸
          echo "ğŸŒ Service status:"
          kubectl get svc -n ${{ env.NAMESPACE }}
          
          # ConfigMapê³¼ Secret í™•ì¸
          echo "ğŸ“„ Config resources:"
          kubectl get configmap,secret -n ${{ env.NAMESPACE }} --no-headers | grep blacklist || echo "No blacklist configs found"
          
          # ìµœì‹  ì´ë²¤íŠ¸ í™•ì¸
          echo "ğŸ“… Recent events:"
          kubectl get events -n ${{ env.NAMESPACE }} --sort-by='.lastTimestamp' | tail -15
          
          echo "âœ… Verification completed"

      - name: Health Check
        run: |
          echo "ğŸ¥ Running health checks..."
          
          # NodePortë¡œ ì ‘ì† ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
          NODE_PORT=$(kubectl get svc blacklist -n ${{ env.NAMESPACE }} -o jsonpath='{.spec.ports[0].nodePort}' 2>/dev/null || echo "32541")
          
          BASE_URL="http://$NODE_IP:$NODE_PORT"
          echo "ğŸ”— Testing via: $BASE_URL"
          
          # ìµœëŒ€ 60ë²ˆ ì‹œë„ (10ë¶„)
          MAX_ATTEMPTS=60
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "ğŸ” Health check attempt $ATTEMPT/$MAX_ATTEMPTS..."
            
            # Health ì²´í¬
            if curl -f -s --connect-timeout 5 --max-time 10 "$BASE_URL/health" > /dev/null 2>&1; then
              echo "âœ… Application is healthy!"
              
              # ì¶”ê°€ ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
              echo "ğŸ§ª Testing additional endpoints..."
              curl -f -s --max-time 5 "$BASE_URL/api/stats" > /dev/null && echo "âœ… /api/stats: OK" || echo "âš ï¸ /api/stats: Failed"
              curl -f -s --max-time 5 "$BASE_URL/test" > /dev/null && echo "âœ… /test: OK" || echo "âš ï¸ /test: Failed"
              curl -f -s --max-time 5 "$BASE_URL/api/collection/status" > /dev/null && echo "âœ… /api/collection/status: OK" || echo "âš ï¸ /api/collection/status: Failed"
              
              break
            else
              echo "â³ Application not ready yet, waiting 10 seconds..."
              sleep 10
            fi
            
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "âŒ Application failed to become healthy after 10 minutes"
              echo "ğŸ“ Pod logs:"
              kubectl logs deployment/blacklist -n ${{ env.NAMESPACE }} --tail=50
              echo "ğŸ” Pod description:"
              kubectl describe pods -n ${{ env.NAMESPACE }} -l app=blacklist
              exit 1
            fi
          done
          
          echo "âœ… Health checks passed!"

      - name: Performance Check
        run: |
          echo "âš¡ Running performance checks..."
          
          NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
          NODE_PORT=$(kubectl get svc blacklist -n ${{ env.NAMESPACE }} -o jsonpath='{.spec.ports[0].nodePort}' 2>/dev/null || echo "32541")
          BASE_URL="http://$NODE_IP:$NODE_PORT"
          
          # ì‘ë‹µ ì‹œê°„ ì²´í¬
          echo "ğŸ“Š Checking response times..."
          for i in {1..5}; do
            RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}\n' "$BASE_URL/health")
            echo "   Response $i: ${RESPONSE_TIME}s"
            
            # 2ì´ˆ ì´ìƒì´ë©´ ê²½ê³ 
            if [ "$(echo "$RESPONSE_TIME > 2.0" | bc -l)" -eq 1 ]; then
              echo "âš ï¸ Slow response detected: ${RESPONSE_TIME}s"
            fi
          done
          
          echo "âœ… Performance checks completed"

      - name: Post-Deployment Tasks
        run: |
          echo "ğŸ”§ Running post-deployment tasks..."
          
          # ìë™ ìˆ˜ì§‘ í™•ì¸
          echo "ğŸ”„ Checking auto-collection status..."
          NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
          NODE_PORT=$(kubectl get svc blacklist -n ${{ env.NAMESPACE }} -o jsonpath='{.spec.ports[0].nodePort}' 2>/dev/null || echo "32541")
          
          # 5ì´ˆ ëŒ€ê¸° í›„ ìˆ˜ì§‘ ìƒíƒœ í™•ì¸
          sleep 5
          COLLECTION_STATUS=$(curl -s "http://$NODE_IP:$NODE_PORT/api/collection/status" 2>/dev/null || echo "Failed to get status")
          echo "ğŸ“Š Collection status: $COLLECTION_STATUS"
          
          # ì´ì „ ReplicaSet ì •ë¦¬ (ìµœì‹  3ê°œë§Œ ìœ ì§€)
          echo "ğŸ§¹ Cleaning up old ReplicaSets..."
          kubectl delete rs -n ${{ env.NAMESPACE }} -l app=blacklist --field-selector='status.replicas=0' || echo "No old ReplicaSets to clean"
          
          echo "âœ… Post-deployment tasks completed"

  # ë°°í¬ ì™„ë£Œ ì•Œë¦¼ ë° ì •ë¦¬
  notify-and-cleanup:
    needs: [quality-checks, build-and-push, deploy-to-k8s]
    runs-on: self-hosted
    if: always() && github.ref == 'refs/heads/main' && needs.quality-checks.outputs.should_deploy == 'true'
    steps:
      - name: Deployment Summary
        run: |
          echo "## ğŸš€ Kubernetes ë°°í¬ ì™„ë£Œ ë¦¬í¬íŠ¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š ë°°í¬ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ìƒíƒœ | ${{ needs.deploy-to-k8s.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì´ë¯¸ì§€ íƒœê·¸ | \`${{ needs.build-and-push.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ë¹Œë“œ ì‹œê°„ | ${{ needs.build-and-push.outputs.build_time }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì»¤ë°‹ | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ë¸Œëœì¹˜ | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ë„¤ì„ìŠ¤í˜ì´ìŠ¤ | \`${{ env.NAMESPACE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ì ‘ì† URL | https://blacklist.jclee.me |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy-to-k8s.result }}" != "success" ]; then
            echo "### âš ï¸ ë°°í¬ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
            echo "Kubernetes ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒì„ í™•ì¸í•´ì£¼ì„¸ìš”:" >> $GITHUB_STEP_SUMMARY
            echo "- ì´ë¯¸ì§€ ë¹Œë“œ ìƒíƒœ" >> $GITHUB_STEP_SUMMARY
            echo "- Kubernetes í´ëŸ¬ìŠ¤í„° ìƒíƒœ" >> $GITHUB_STEP_SUMMARY
            echo "- Pod ë¡œê·¸ ë° ì´ë²¤íŠ¸" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ğŸ‰ ë°°í¬ ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
            echo "ìƒˆë¡œìš´ ë²„ì „ì´ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### ğŸ”— ì ‘ì† ì •ë³´" >> $GITHUB_STEP_SUMMARY
            echo "- ëŒ€ì‹œë³´ë“œ: https://blacklist.jclee.me/" >> $GITHUB_STEP_SUMMARY
            echo "- API ë¬¸ì„œ: https://blacklist.jclee.me/docs" >> $GITHUB_STEP_SUMMARY
            echo "- Health Check: https://blacklist.jclee.me/health" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cleanup Docker Images
        if: needs.deploy-to-k8s.result == 'success'
        run: |
          echo "ğŸ§¹ Cleaning up Docker images..."
          
          # 7ì¼ ì´ìƒ ëœ ì´ë¯¸ì§€ ì •ë¦¬
          docker image prune -a -f --filter "until=168h" || echo "Docker cleanup skipped"
          
          # ë¹Œë“œ ìºì‹œ ì •ë¦¬
          docker builder prune -f --filter "until=48h" || echo "Builder cache cleanup skipped"
          
          echo "âœ… Docker cleanup completed"

      - name: Trigger Webhook (Optional)
        if: needs.deploy-to-k8s.result == 'success'
        run: |
          echo "ğŸ”” Triggering deployment webhook..."
          
          # ì›¹í›…ì´ ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´ í˜¸ì¶œ
          if [ -n "${{ secrets.DEPLOYMENT_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.DEPLOYMENT_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{
                "event": "deployment_success",
                "image": "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.image_tag }}",
                "commit": "${{ github.sha }}",
                "branch": "${{ github.ref_name }}",
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'",
                "url": "https://blacklist.jclee.me"
              }' || echo "Webhook call failed (non-critical)"
          else
            echo "No webhook URL configured"
          fi
          
          echo "âœ… Notification tasks completed"