name: Auto Deploy to Registry

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: registry.jclee.me
  IMAGE_NAME: blacklist
  DOCKER_BUILDKIT: 1

jobs:
  build-and-deploy:
    runs-on: self-hosted
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Docker image
      run: |
        docker build -f docker/Dockerfile \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          .

    - name: Push to registry
      run: |
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

    - name: Cleanup old images
      run: |
        docker image prune -f
        docker images | grep ${{ env.IMAGE_NAME }} | grep -v latest | head -n -3 | awk '{print $3}' | xargs -r docker rmi || true

    - name: Docker Compose Deployment Notification
      run: |
        echo "🐳 DOCKER COMPOSE 기반 배포 완료"
        echo "✅ Image pushed to registry: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
        echo "🔄 Watchtower 자동 업데이트: 1시간 내 배포"
        echo ""
        echo "📋 즉시 수동 배포:"
        echo "  docker-compose pull && docker-compose up -d"
        echo ""
        echo "📊 서비스 상태 확인:"
        echo "  docker-compose ps"
        echo "  curl http://localhost:32542/health"
        echo ""
        echo "🎯 Compose 기반 완전 전환 완료 - K8s 의존성 제거됨"