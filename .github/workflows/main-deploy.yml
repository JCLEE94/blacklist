name: Blacklist Smart Deploy (SafeWork íŒ¨í„´ ì ìš©)
# SafeWork ë ˆí¬ì§€í† ë¦¬ì˜ í˜ì‹ ì ì¸ ë°°í¬ íŒ¨í„´ì„ blacklistì— ìµœì í™” ì ìš©

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/github-pages.yml'
      - '.github/workflows/offline-package.yml'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: registry.jclee.me
  REGISTRY_USER: jclee94
  IMAGE_NAME: blacklist

jobs:
  # ============================================
  # ìŠ¤ë§ˆíŠ¸ ë³€ê²½ ê°ì§€ (SafeWork íŒ¨í„´ ì ìš©)
  # ============================================
  detect-changes:
    name: "ðŸ” Smart Change Detection"
    runs-on: ubuntu-latest
    outputs:
      app_changed: ${{ steps.changes.outputs.app_changed }}
      docker_changed: ${{ steps.changes.outputs.docker_changed }}
      any_changed: ${{ steps.changes.outputs.any_changed }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2
        
    - name: "ðŸ” Smart Change Detection"
      id: changes
      run: |
        echo "ðŸ” SafeWork ìŠ¤íƒ€ì¼ ë³€ê²½ ê°ì§€ ì‹œìž‘..."
        
        # ì´ˆê¸°í™”
        APP_CHANGED=false
        DOCKER_CHANGED=false
        ANY_CHANGED=false
        
        # Manual íŠ¸ë¦¬ê±° = ì „ì²´ ë¹Œë“œ
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "ðŸ“Œ Manual trigger - building all"
          APP_CHANGED=true
          DOCKER_CHANGED=true
          ANY_CHANGED=true
        else
          # ì½˜í…ì¸  í•´ì‹œ ê¸°ë°˜ ë³€ê²½ ê°ì§€
          echo "ðŸ” Computing content hashes for change detection..."
          
          # í˜„ìž¬ ì†ŒìŠ¤ í•´ì‹œ ê³„ì‚° - ì‹¤ì œ í”„ë¡œì íŠ¸ êµ¬ì¡°ì— ë§žê²Œ ìˆ˜ì •
          APP_HASH=$(find . -type f \( -name "*.py" -o -name "main.py" \) ! -path "./.github/*" ! -path "./build/*" ! -path "./htmlcov*" ! -path "./.git/*" -exec sha256sum {} \; 2>/dev/null | sha256sum | cut -d' ' -f1 || echo "none")
          DOCKER_HASH=$(find . -maxdepth 1 -name "Dockerfile*" -o -name "docker-compose*" -o -name "requirements*" -o -name "package.json" -exec sha256sum {} \; 2>/dev/null | sha256sum | cut -d' ' -f1 || echo "none")
          
          echo "ðŸ“Š Source hashes:"
          echo "  App/Source: ${APP_HASH:0:12}..."
          echo "  Docker/Config: ${DOCKER_HASH:0:12}..."
          echo ""
          
          # ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ ê°•ì œ ë¹Œë“œ ê°ì§€
          COMMIT_MSG=$(git log -1 --pretty=%B)
          FORCE_BUILD=false
          
          if echo "$COMMIT_MSG" | grep -qi "\[force\].*build\|\[rebuild\]"; then
            echo "ðŸ”¨ Forced build detected in commit message"
            FORCE_BUILD=true
          fi
          
          # ë³€ê²½ëœ íŒŒì¼ ê°ì§€
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          
          if [ -n "$CHANGED_FILES" ] || [ "$FORCE_BUILD" = "true" ]; then
            echo "ðŸ“ Changes detected or forced build requested"
            echo "Changed files: $CHANGED_FILES"
            echo ""
            
            # ì•± ì†ŒìŠ¤ ë³€ê²½ ê°ì§€ - ì‹¤ì œ í”„ë¡œì íŠ¸ êµ¬ì¡°ì— ë§žê²Œ ìˆ˜ì •
            if echo "$CHANGED_FILES" | grep -q "\.py$\|^main\.py\|^commands/\|^scripts/\|^tests/" || [ "$FORCE_BUILD" = "true" ]; then
              APP_CHANGED=true
              ANY_CHANGED=true
              echo "âœ… App/Source: Will rebuild"
            else
              echo "â„¹ï¸ App/Source: No changes - keeping stable"
            fi
            
            # Docker ì„¤ì • ë³€ê²½ ê°ì§€
            if echo "$CHANGED_FILES" | grep -q "Dockerfile\|docker-compose\|requirements\|package.json\|\.yml$" || [ "$FORCE_BUILD" = "true" ]; then
              DOCKER_CHANGED=true
              ANY_CHANGED=true
              echo "âœ… Docker/Config: Will rebuild"
            else
              echo "â„¹ï¸ Docker/Config: No changes"
            fi
          else
            echo "â„¹ï¸ No changes detected - skipping builds"
          fi
        fi
        
        # ì¶œë ¥ ì„¤ì •
        echo "app_changed=$APP_CHANGED" >> $GITHUB_OUTPUT
        echo "docker_changed=$DOCKER_CHANGED" >> $GITHUB_OUTPUT
        echo "any_changed=$ANY_CHANGED" >> $GITHUB_OUTPUT
        
        # ìš”ì•½
        echo ""
        echo "ðŸ“Š Smart Detection Summary:"
        echo "  App Changed: $APP_CHANGED"
        echo "  Docker Changed: $DOCKER_CHANGED"
        echo "  Any Changed: $ANY_CHANGED"

  # ============================================
  # Blacklist ì•± ë¹Œë“œ (SafeWork ìŠ¤íƒ€ì¼)
  # ============================================
  build-blacklist:
    name: "ðŸ›¡ï¸ Build Blacklist App"
    needs: detect-changes
    if: needs.detect-changes.outputs.any_changed == 'true'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_hash: ${{ steps.build.outputs.build_hash }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: "ðŸ³ Login to Registry"
      run: |
        # Use admin/bingogo1 for private registry registry.jclee.me
        REGISTRY_USER="admin"
        REGISTRY_PASS="${{ secrets.REGISTRY_PASSWORD }}"
        
        # Fallback to known password if secret not set
        if [ -z "$REGISTRY_PASS" ]; then
          echo "âš ï¸ Using default registry password"
          REGISTRY_PASS="bingogo1"
        fi
        
        # Login with proper credentials
        echo "$REGISTRY_PASS" | docker login ${{ env.REGISTRY }} -u $REGISTRY_USER --password-stdin || {
          echo "âš ï¸ First attempt failed, trying direct credentials"
          echo "bingogo1" | docker login ${{ env.REGISTRY }} -u admin --password-stdin
        }
    
    - name: "ðŸ“Š Version & Build Info"
      id: version
      run: |
        # SafeWork ìŠ¤íƒ€ì¼ ë™ì  ë²„ì „ ìƒì„±
        BUILD_VERSION="v$(date +%Y%m%d)-${{ github.run_number }}"
        PACKAGE_VERSION=$(cat package.json | grep '"version"' | cut -d'"' -f4 || echo "1.0.0")
        
        echo "version=$BUILD_VERSION" >> $GITHUB_OUTPUT
        echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
        
        echo "ðŸ“¦ Build Version: $BUILD_VERSION"
        echo "ðŸ“‹ Package Version: $PACKAGE_VERSION"
    
    - name: "ðŸ—ï¸ Build & Push Blacklist"
      id: build
      run: |
        echo "ðŸ›¡ï¸ Building Blacklist Management System..."
        
        # SafeWork ìŠ¤íƒ€ì¼ ë¹Œë“œ ì•„ê·œë¨¼íŠ¸
        BUILD_VERSION="${{ steps.version.outputs.version }}"
        
        # ë©€í‹° íƒœê·¸ ë¹Œë“œ (SafeWork íŒ¨í„´)
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$BUILD_VERSION \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          --build-arg BUILD_VERSION=$BUILD_VERSION \
          --build-arg BUILD_NUMBER=${{ github.run_number }} \
          --build-arg COMMIT_SHA=${{ github.sha }} \
          --build-arg BUILD_TIMESTAMP=$(date -Iseconds) \
          --label "app=blacklist" \
          --label "version=$BUILD_VERSION" \
          --label "build-number=${{ github.run_number }}" \
          --label "commit-sha=${{ github.sha }}" \
          --label "com.centurylinklabs.watchtower.enable=true" \
          .
        
        # ë¹Œë“œ í•´ì‹œ ìƒì„± (ë¬´ê²°ì„± ê²€ì¦ìš©)
        BUILD_HASH=$(docker images --digests ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest --format "{{.Digest}}" | head -1 || echo "unknown")
        echo "build_hash=$BUILD_HASH" >> $GITHUB_OUTPUT
        
        echo "ðŸ·ï¸ Tagged images:"
        echo "  - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
        echo "  - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$BUILD_VERSION"
        echo "  - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
        echo "ðŸ“‹ Build Info: $BUILD_VERSION (Build: ${{ github.run_number }}, SHA: ${{ github.sha }})"
        
        echo "ðŸ“¤ Pushing to registry..."
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$BUILD_VERSION
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        
        echo "âœ… Blacklist build & push completed"
            
  # ============================================
  # SafeWork ìŠ¤íƒ€ì¼ ìŠ¤ë§ˆíŠ¸ ë°°í¬
  # ============================================
  deploy:
    name: "ðŸš€ Smart Deploy"
    needs: [detect-changes, build-blacklist]
    if: |
      always() && 
      needs.detect-changes.outputs.any_changed == 'true' &&
      !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    
    steps:
    - name: "ðŸŒ Ensure Network (SafeWork íŒ¨í„´)"
      run: |
        # Docker ë„¤íŠ¸ì›Œí¬ ìžë™ ìƒì„± (SafeWorkì—ì„œ ì°¨ìš©)
        docker network create blacklist-net 2>/dev/null || echo "Network exists"
        echo "âœ… Network 'blacklist-net' ready"
    
    - name: "ðŸ›¡ï¸ Deploy Blacklist with Version Check"
      run: |
        echo "ðŸ›¡ï¸ Deploying Blacklist Management System..."
        
        # SafeWork ìŠ¤íƒ€ì¼ ë²„ì „ ë¹„êµ ë°°í¬
        echo "ðŸ“Š Checking current deployment..."
        
        # í˜„ìž¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ë²„ì „ í™•ì¸
        CURRENT_VERSION=""
        if docker exec blacklist curl -s http://localhost:2542/health 2>/dev/null | grep -o '"version":"[^"]*"' >/dev/null 2>&1; then
          CURRENT_VERSION=$(docker exec blacklist curl -s http://localhost:2542/health 2>/dev/null | grep -o '"version":"[^"]*"' | cut -d'"' -f4 || echo "Unknown")
          echo "ðŸ“¦ Current deployed: $CURRENT_VERSION"
        else
          CURRENT_VERSION="Unknown"
          echo "ðŸ“¦ Current deployed: Not available"
        fi
        
        # ìƒˆ ë¹Œë“œ ë²„ì „
        NEW_VERSION="${{ needs.build-blacklist.outputs.version }}"
        echo "ðŸ“¦ New build: $NEW_VERSION"
        
        # ë²„ì „ ë¹„êµ ë° ì—…ë°ì´íŠ¸ ê²°ì • (SafeWork ë¡œì§)
        if [ "$CURRENT_VERSION" != "$NEW_VERSION" ] || [ "$CURRENT_VERSION" = "Unknown" ]; then
          echo "ðŸ”„ Update required:"
          echo "   ðŸ“Š Version: $CURRENT_VERSION -> $NEW_VERSION"
          UPDATE_REQUIRED=true
        else
          echo "âœ… Already up to date: $CURRENT_VERSION"
          UPDATE_REQUIRED=false
        fi
        
        # ì—…ë°ì´íŠ¸ ì‹¤í–‰
        if [ "$UPDATE_REQUIRED" = true ]; then
          echo "ðŸ”„ Updating to latest version..."
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ì§€ ë° ì œê±°
          docker stop blacklist 2>/dev/null || true
          docker rm blacklist 2>/dev/null || true
          
          # Watchtower ìŠ¤íƒ€ì¼ ìžë™ ë°°í¬ ì‹œë®¬ë ˆì´ì…˜
          docker run -d \
            --name blacklist \
            --network blacklist-net \
            --restart unless-stopped \
            -p 32542:2542 \
            -v blacklist-data:/app/instance \
            -v blacklist-logs:/app/logs \
            -e FLASK_ENV=production \
            -e DATABASE_URL=sqlite:///app/instance/blacklist.db \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          
          echo "âœ… Blacklist successfully updated!"
          echo "   ðŸ“Š Version: $CURRENT_VERSION -> $NEW_VERSION"
          echo "   ðŸŒ Available at: https://blacklist.jclee.me"
        else
          echo "â­ï¸ Deployment skipped - already latest version"
        fi
          
    - name: "ðŸ¥ Health Check (SafeWork ìŠ¤íƒ€ì¼)"
      run: |
        echo "ðŸ¥ Waiting for services..."
        sleep 15
        
        echo "ðŸ“Š Container Status:"
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep blacklist || true
        
        echo ""
        echo "ðŸ” Service Health Check:"
        
        # ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ ì²´í¬
        if docker exec blacklist curl -f http://localhost:2542/health >/dev/null 2>&1; then
          echo "âœ… Blacklist App: Healthy"
          
          # ìƒì„¸ ì •ë³´ ì¶œë ¥
          HEALTH_RESPONSE=$(docker exec blacklist curl -s http://localhost:2542/health 2>/dev/null || echo "{}")
          echo "ðŸ“‹ Health Response: $HEALTH_RESPONSE"
        else
          echo "âš ï¸ Blacklist App: Not ready"
        fi
        
        # ì™¸ë¶€ ì ‘ê·¼ í…ŒìŠ¤íŠ¸
        echo ""
        echo "ðŸŒ External Access Test:"
        for i in {1..5}; do
          echo "Attempt $i/5: Testing external access..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://blacklist.jclee.me/health || echo "000")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… External access: Healthy"
            break
          else
            echo "âš ï¸ HTTP $HTTP_CODE - retrying..."
            sleep 10
          fi
        done
        
        echo ""
        echo "âœ¨ Deployment health check completed!"

  # ============================================
  # SafeWork ìŠ¤íƒ€ì¼ ìš”ì•½ ë¦¬í¬íŠ¸
  # ============================================
  summary:
    name: "ðŸ“Š Deployment Summary"
    needs: [detect-changes, build-blacklist, deploy]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: "ðŸ“Š Generate Summary (SafeWork ìŠ¤íƒ€ì¼)"
      run: |
        echo "# ðŸ›¡ï¸ Blacklist Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸ“¦ Build Status" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Changed | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|---------|--------|"
        
        # App ìƒíƒœ
        if [ "${{ needs.detect-changes.outputs.app_changed }}" = "true" ]; then
          if [ "${{ needs.build-blacklist.result }}" = "success" ]; then
            echo "| ðŸ›¡ï¸ Blacklist App | âœ… Changed | âœ… Built & Deployed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ›¡ï¸ Blacklist App | âœ… Changed | âŒ Build Failed |" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "| ðŸ›¡ï¸ Blacklist App | â­ï¸ No Changes | - |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Docker ìƒíƒœ
        if [ "${{ needs.detect-changes.outputs.docker_changed }}" = "true" ]; then
          echo "| ðŸ³ Docker Config | âœ… Changed | âœ… Applied |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸ³ Docker Config | â­ï¸ No Changes | - |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“Œ Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** ${{ needs.build-blacklist.outputs.version || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Number:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Registry:** ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Hash:** ${{ needs.build-blacklist.outputs.build_hash || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸŒ Access Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Production:** https://blacklist.jclee.me/" >> $GITHUB_STEP_SUMMARY
        echo "- **Health Check:** https://blacklist.jclee.me/health" >> $GITHUB_STEP_SUMMARY
        echo "- **API Docs:** https://blacklist.jclee.me/api/" >> $GITHUB_STEP_SUMMARY
        echo "- **Local Access:** http://localhost:32542" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ì „ì²´ ì„±ê³µ ì—¬ë¶€
        if [ "${{ needs.deploy.result }}" = "success" ]; then
          echo "## ðŸŽ‰ Deployment Result: SUCCESS" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âš ï¸ Deployment Result: PARTIAL/FAILED" >> $GITHUB_STEP_SUMMARY
        fi