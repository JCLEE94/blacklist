name: Auto Deploy to Registry

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: registry.jclee.me
  IMAGE_NAME: blacklist
  DOCKER_BUILDKIT: 1

jobs:
  build-and-deploy:
    runs-on: self-hosted
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Docker image
      run: |
        docker build -f docker/Dockerfile \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          .

    - name: Push to registry
      run: |
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

    - name: Cleanup old images
      run: |
        docker image prune -f
        docker images | grep ${{ env.IMAGE_NAME }} | grep -v latest | head -n -3 | awk '{print $3}' | xargs -r docker rmi || true

    - name: Docker Compose Deployment Notification
      run: |
        echo "ğŸ³ DOCKER COMPOSE ê¸°ë°˜ ë°°í¬ ì™„ë£Œ"
        echo "âœ… Image pushed to registry: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
        echo "ğŸ”„ Watchtower ìë™ ì—…ë°ì´íŠ¸: 1ì‹œê°„ ë‚´ ë°°í¬"
        echo ""
        echo "ğŸ“‹ ì¦‰ì‹œ ìˆ˜ë™ ë°°í¬:"
        echo "  docker-compose pull && docker-compose up -d"
        echo ""
        echo "ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸:"
        echo "  docker-compose ps"
        echo "  curl http://localhost:32542/health"
        echo ""
        echo "ğŸ¯ Compose ê¸°ë°˜ ì™„ì „ ì „í™˜ ì™„ë£Œ - K8s ì˜ì¡´ì„± ì œê±°ë¨"