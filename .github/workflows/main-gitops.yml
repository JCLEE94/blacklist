name: ğŸš€ GitOps Deployment Pipeline

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '*.md'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½ ì„ íƒ'
        required: true
        type: choice
        options:
        - development
        - staging
        - production
        default: 'development'
      force_rebuild:
        description: 'ê°•ì œ ì´ë¯¸ì§€ ì¬ë¹Œë“œ'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ${{ vars.REGISTRY_DOMAIN || 'registry.jclee.me' }}
  PROJECT_NAME: ${{ vars.PROJECT_NAME || 'blacklist' }}
  ARGOCD_SERVER: ${{ vars.ARGOCD_DOMAIN || 'argo.jclee.me' }}
  K8S_NAMESPACE: ${{ vars.K8S_NAMESPACE || 'default' }}

jobs:
  # ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  quality-checks:
    name: ğŸ§¹ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        pip install -r requirements.txt
        pip install flake8 black isort bandit safety pytest pytest-cov

    - name: ğŸ¨ ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬ (Black)
      run: |
        black --check --diff src/ tests/ || true
        echo "::notice::Black í¬ë§·íŒ… ê²€ì‚¬ ì™„ë£Œ"

    - name: ğŸ“ Import ì •ë ¬ ê²€ì‚¬ (isort)
      run: |
        isort --check-only --diff src/ tests/ || true
        echo "::notice::Import ì •ë ¬ ê²€ì‚¬ ì™„ë£Œ"

    - name: ğŸ” ë¦°íŒ… ê²€ì‚¬ (flake8)
      run: |
        flake8 src/ --max-line-length=88 --extend-ignore=E203,W503 --statistics
        echo "::notice::Flake8 ë¦°íŒ… ê²€ì‚¬ ì™„ë£Œ"

    - name: ğŸ”’ ë³´ì•ˆ ê²€ì‚¬ (Bandit)
      run: |
        bandit -r src/ -ll -f json -o bandit-report.json || true
        bandit -r src/ -ll || true
        echo "::notice::ë³´ì•ˆ ê²€ì‚¬ ì™„ë£Œ"

    - name: ğŸ›¡ï¸ ì˜ì¡´ì„± ì·¨ì•½ì  ê²€ì‚¬ (Safety)
      run: |
        safety check || true
        echo "::notice::ì˜ì¡´ì„± ì·¨ì•½ì  ê²€ì‚¬ ì™„ë£Œ"

    - name: ğŸ“ íŒŒì¼ í¬ê¸° ê²€ì‚¬ (500ì¤„ ì œí•œ)
      run: |
        echo "ğŸ” 500ì¤„ ì´ˆê³¼ íŒŒì¼ ê²€ì‚¬..."
        find src/ -name "*.py" -exec wc -l {} + | awk '$1 > 500 {print "âŒ", $2, "íŒŒì¼ì´", $1, "ì¤„ë¡œ 500ì¤„ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤"}' || true
        OVERSIZED=$(find src/ -name "*.py" -exec wc -l {} + | awk '$1 > 500 {print $2}' | wc -l)
        if [ "$OVERSIZED" -gt 0 ]; then
          echo "::warning::$OVERSIZEDê°œ íŒŒì¼ì´ 500ì¤„ì„ ì´ˆê³¼í•©ë‹ˆë‹¤."
        else
          echo "::notice::ëª¨ë“  íŒŒì¼ì´ 500ì¤„ ì œí•œì„ ì¤€ìˆ˜í•©ë‹ˆë‹¤."
        fi

    - name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        if [ -d "tests" ]; then
          pytest -v --cov=src --cov-report=xml --cov-report=term || true
          echo "::notice::í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì™„ë£Œ"
        else
          echo "::notice::í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤."
        fi

    - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
      if: always()
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false

  # ğŸ·ï¸ ìë™ ë²„ì „ ê´€ë¦¬
  versioning:
    name: ğŸ·ï¸ ë²„ì „ ê´€ë¦¬
    runs-on: ubuntu-latest
    needs: quality-checks
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}

    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ·ï¸ ìë™ ë²„ì „ íƒœê¹…
      id: version
      run: |
        # í˜„ì¬ ë‚ ì§œì™€ ì‹œê°„ì„ ê¸°ë°˜ìœ¼ë¡œ ë²„ì „ ìƒì„±
        VERSION="v$(date +'%Y.%m.%d')-${GITHUB_SHA::7}"
        
        # ê¸°ì¡´ íƒœê·¸ê°€ ìˆëŠ”ì§€ í™•ì¸
        if git tag -l "$VERSION" | grep -q "$VERSION"; then
          VERSION="$VERSION-$(date +'%H%M%S')"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=$VERSION" >> $GITHUB_OUTPUT
        echo "::notice::ìƒì„±ëœ ë²„ì „: $VERSION"

        # Git íƒœê·¸ ìƒì„± (main ë¸Œëœì¹˜ì—ì„œë§Œ)
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "$VERSION" -m "ğŸš€ Release $VERSION"
          git push origin "$VERSION"
          echo "::notice::Git íƒœê·¸ ìƒì„±ë¨: $VERSION"
        fi

  # ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
  build-and-push:
    name: ğŸ³ Docker ë¹Œë“œ & í‘¸ì‹œ
    runs-on: ubuntu-latest
    needs: [quality-checks, versioning]
    if: always() && !cancelled()
    outputs:
      image: ${{ steps.image.outputs.image }}
      digest: ${{ steps.build.outputs.digest }}

    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸ³ Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v3

    - name: ğŸ”‘ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.REGISTRY_USER }}
        password: ${{ secrets.REGISTRY_PASS }}

    - name: ğŸ·ï¸ ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/jclee94/${{ env.PROJECT_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=raw,value=latest,enable={{is_default_branch}}
          type=raw,value=${{ needs.versioning.outputs.version }},enable=true
          type=sha,prefix={{branch}}-

    - name: ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        platforms: linux/amd64,linux/arm64
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILDTIME=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          VERSION=${{ needs.versioning.outputs.version }}

    - name: ğŸ¯ ì´ë¯¸ì§€ ì •ë³´ ì¶œë ¥
      id: image
      run: |
        IMAGE="${{ env.REGISTRY }}/jclee94/${{ env.PROJECT_NAME }}:${{ needs.versioning.outputs.version }}"
        echo "image=$IMAGE" >> $GITHUB_OUTPUT
        echo "::notice::ë¹Œë“œëœ ì´ë¯¸ì§€: $IMAGE"

    - name: ğŸ” ì´ë¯¸ì§€ ë³´ì•ˆ ìŠ¤ìº” (Trivy)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ steps.image.outputs.image }}
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: ğŸ“Š ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ì—…ë¡œë“œ
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'

  # ğŸ“ K8s ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
  update-manifests:
    name: ğŸ“ K8s ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    runs-on: ubuntu-latest
    needs: [build-and-push, versioning]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ”§ í™˜ê²½ë³„ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
      run: |
        # í™˜ê²½ ê²°ì •
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          ENVIRONMENT="${{ github.event.inputs.environment }}"
        else
          ENVIRONMENT="production"
        fi
        
        echo "ğŸ¯ ë°°í¬ í™˜ê²½: $ENVIRONMENT"
        echo "ğŸ³ ì´ë¯¸ì§€: ${{ needs.build-and-push.outputs.image }}"
        
        # K8s ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ëŠ” ê²½ìš°)
        mkdir -p k8s/overlays/$ENVIRONMENT
        
        # Kustomization íŒŒì¼ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ íŒŒì¼ ìƒì„±
        if [ ! -f "k8s/overlays/$ENVIRONMENT/kustomization.yaml" ]; then
          cat > k8s/overlays/$ENVIRONMENT/kustomization.yaml << EOF
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: ${{ env.K8S_NAMESPACE }}

resources:
- ../../base

images:
- name: ${{ env.REGISTRY }}/jclee94/${{ env.PROJECT_NAME }}
  newTag: ${{ needs.versioning.outputs.version }}

patchesStrategicMerge:
- resource-patch.yaml
EOF
          echo "::notice::Kustomization íŒŒì¼ ìƒì„±ë¨"
        fi

        # ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
        sed -i "s|newTag:.*|newTag: ${{ needs.versioning.outputs.version }}|" k8s/overlays/$ENVIRONMENT/kustomization.yaml
        
        # íŒ¨ì¹˜ íŒŒì¼ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ íŒŒì¼ ìƒì„±
        if [ ! -f "k8s/overlays/$ENVIRONMENT/resource-patch.yaml" ]; then
          cat > k8s/overlays/$ENVIRONMENT/resource-patch.yaml << EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ${{ env.PROJECT_NAME }}
  labels:
    environment: $ENVIRONMENT
    version: ${{ needs.versioning.outputs.version }}
spec:
  template:
    metadata:
      labels:
        environment: $ENVIRONMENT
        version: ${{ needs.versioning.outputs.version }}
    spec:
      containers:
      - name: ${{ env.PROJECT_NAME }}
        env:
        - name: ENVIRONMENT
          value: $ENVIRONMENT
        - name: VERSION
          value: ${{ needs.versioning.outputs.version }}
EOF
          echo "::notice::ë¦¬ì†ŒìŠ¤ íŒ¨ì¹˜ íŒŒì¼ ìƒì„±ë¨"
        fi

        # ë³€ê²½ì‚¬í•­ í™•ì¸
        if git diff --quiet; then
          echo "::notice::ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
        else
          echo "::notice::ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ë¨"
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add k8s/
          git commit -m "ğŸš€ Deploy ${{ env.PROJECT_NAME }} ${{ needs.versioning.outputs.version }} to $ENVIRONMENT

          - Environment: $ENVIRONMENT
          - Image: ${{ needs.build-and-push.outputs.image }}
          - Commit: ${{ github.sha }}
          - Triggered by: ${{ github.actor }}"
          git push
          echo "::notice::ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì»¤ë°‹ ë° í‘¸ì‹œ ì™„ë£Œ"
        fi

  # ğŸ”„ ArgoCD ë™ê¸°í™”
  argocd-sync:
    name: ğŸ”„ ArgoCD ë™ê¸°í™”
    runs-on: ubuntu-latest
    needs: [update-manifests, versioning]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ğŸ¯ í™˜ê²½ ì„¤ì •
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          ENVIRONMENT="${{ github.event.inputs.environment }}"
        else
          ENVIRONMENT="production"
        fi
        echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_ENV
        echo "APP_NAME=${{ env.PROJECT_NAME }}-$ENVIRONMENT" >> $GITHUB_ENV

    - name: â³ ArgoCD ë™ê¸°í™” ëŒ€ê¸°
      run: |
        echo "::notice::ArgoCDê°€ Git ë³€ê²½ì‚¬í•­ì„ ê°ì§€í•  ë•Œê¹Œì§€ ëŒ€ê¸° ì¤‘..."
        sleep 30

    - name: ğŸ”„ ArgoCD ì• í”Œë¦¬ì¼€ì´ì…˜ ë™ê¸°í™”
      run: |
        echo "ğŸ”„ ArgoCD ë™ê¸°í™” ì‹œì‘..."
        echo "ğŸ“± ì• í”Œë¦¬ì¼€ì´ì…˜: ${{ env.APP_NAME }}"
        echo "ğŸŒ ArgoCD ì„œë²„: ${{ env.ARGOCD_SERVER }}"
        
        # ArgoCD APIë¥¼ í†µí•œ ë™ê¸°í™” íŠ¸ë¦¬ê±°
        SYNC_RESPONSE=$(curl -s -w "%{http_code}" \
          -X POST "https://${{ env.ARGOCD_SERVER }}/api/v1/applications/${{ env.APP_NAME }}/sync" \
          -H "Authorization: Bearer ${{ secrets.ARGOCD_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
            "prune": true,
            "dryRun": false,
            "strategy": {
              "apply": {
                "force": false
              }
            }
          }' || echo "000")
        
        HTTP_CODE="${SYNC_RESPONSE: -3}"
        RESPONSE_BODY="${SYNC_RESPONSE%???}"
        
        if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 202 ]; then
          echo "::notice::ArgoCD ë™ê¸°í™” ì„±ê³µì ìœ¼ë¡œ íŠ¸ë¦¬ê±°ë¨ (HTTP $HTTP_CODE)"
        else
          echo "::warning::ArgoCD ë™ê¸°í™” íŠ¸ë¦¬ê±° ì‹¤íŒ¨ (HTTP $HTTP_CODE)"
          echo "Response: $RESPONSE_BODY"
        fi

    - name: â±ï¸ ë°°í¬ ìƒíƒœ í™•ì¸
      run: |
        echo "ğŸ” ë°°í¬ ìƒíƒœ í™•ì¸ ì¤‘..."
        
        for i in {1..12}; do
          echo "ğŸ“Š ì‹œë„ $i/12..."
          
          # ArgoCD ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ ì¡°íšŒ
          APP_STATUS=$(curl -s \
            "https://${{ env.ARGOCD_SERVER }}/api/v1/applications/${{ env.APP_NAME }}" \
            -H "Authorization: Bearer ${{ secrets.ARGOCD_TOKEN }}" | \
            python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    health = data.get('status', {}).get('health', {}).get('status', 'Unknown')
    sync = data.get('status', {}).get('sync', {}).get('status', 'Unknown')
    print(f'Health: {health}, Sync: {sync}')
except:
    print('Status: Unknown')
" 2>/dev/null || echo "Status: Unknown")

          echo "ğŸ“ˆ í˜„ì¬ ìƒíƒœ: $APP_STATUS"
          
          if echo "$APP_STATUS" | grep -q "Health: Healthy.*Sync: Synced"; then
            echo "::notice::âœ… ë°°í¬ ì„±ê³µ! ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒ ìƒíƒœì…ë‹ˆë‹¤."
            echo "DEPLOYMENT_SUCCESS=true" >> $GITHUB_ENV
            break
          elif echo "$APP_STATUS" | grep -q "Health: Degraded\|Sync: OutOfSync"; then
            echo "::warning::âš ï¸ ë°°í¬ ì¤‘ ë¬¸ì œ ë°œìƒ"
          fi
          
          if [ $i -eq 12 ]; then
            echo "::error::âŒ ë°°í¬ ìƒíƒœ í™•ì¸ ì‹œê°„ ì´ˆê³¼"
            echo "DEPLOYMENT_SUCCESS=false" >> $GITHUB_ENV
          else
            sleep 30
          fi
        done

  # âœ… ë°°í¬ í›„ ê²€ì¦
  post-deployment-verification:
    name: âœ… ë°°í¬ í›„ ê²€ì¦
    runs-on: ubuntu-latest
    needs: [argocd-sync, versioning, build-and-push]
    if: always() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: ğŸ¯ í™˜ê²½ ì„¤ì •
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          ENVIRONMENT="${{ github.event.inputs.environment }}"
        else
          ENVIRONMENT="production"
        fi
        echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_ENV
        
        # í™˜ê²½ë³„ URL ì„¤ì •
        case "$ENVIRONMENT" in
          "production")
            APP_URL="https://blacklist.jclee.me"
            ;;
          "staging")
            APP_URL="https://staging-blacklist.jclee.me"
            ;;
          "development")
            APP_URL="https://dev-blacklist.jclee.me"
            ;;
          *)
            APP_URL="https://blacklist.jclee.me"
            ;;
        esac
        echo "APP_URL=$APP_URL" >> $GITHUB_ENV

    - name: ğŸ¥ í—¬ìŠ¤ì²´í¬ ê²€ì¦
      run: |
        echo "ğŸ” ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
        echo "ğŸŒ URL: ${{ env.APP_URL }}/health"
        
        for i in {1..10}; do
          echo "ğŸ“Š í—¬ìŠ¤ì²´í¬ ì‹œë„ $i/10..."
          
          HEALTH_CHECK=$(curl -s -w "%{http_code}" "${{ env.APP_URL }}/health" || echo "000")
          HTTP_CODE="${HEALTH_CHECK: -3}"
          RESPONSE_BODY="${HEALTH_CHECK%???}"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "::notice::âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ! (HTTP $HTTP_CODE)"
            echo "$RESPONSE_BODY" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    print(f\"ğŸ¥ ìƒíƒœ: {data.get('status', 'Unknown')}\")
    print(f\"ğŸ³ ë²„ì „: {data.get('version', 'Unknown')}\")
    print(f\"â° ì—…íƒ€ì„: {data.get('uptime', 'Unknown')}\")
except:
    print('âœ… í—¬ìŠ¤ì²´í¬ ì‘ë‹µ í™•ì¸ë¨')
" 2>/dev/null || echo "âœ… í—¬ìŠ¤ì²´í¬ ì‘ë‹µ í™•ì¸ë¨"
            break
          else
            echo "::warning::âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (HTTP $HTTP_CODE)"
            if [ $i -eq 10 ]; then
              echo "::error::ğŸš¨ í—¬ìŠ¤ì²´í¬ ìµœì¢… ì‹¤íŒ¨ - ë¡¤ë°±ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
              echo "HEALTH_CHECK_FAILED=true" >> $GITHUB_ENV
            else
              sleep 30
            fi
          fi
        done

    - name: ğŸ§ª ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
      if: env.HEALTH_CHECK_FAILED != 'true'
      run: |
        echo "ğŸ§ª ê¸°ë³¸ API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸..."
        
        # API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
        ENDPOINTS=(
          "/api/health"
          "/api/blacklist/active"
          "/api/collection/status"
        )
        
        for endpoint in "${ENDPOINTS[@]}"; do
          echo "ğŸ”— í…ŒìŠ¤íŠ¸: $endpoint"
          
          RESPONSE=$(curl -s -w "%{http_code}" "${{ env.APP_URL }}$endpoint" || echo "000")
          HTTP_CODE="${RESPONSE: -3}"
          
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
            echo "::notice::âœ… $endpoint ì •ìƒ ì‘ë‹µ (HTTP $HTTP_CODE)"
          else
            echo "::warning::âš ï¸ $endpoint ì‘ë‹µ ì´ìƒ (HTTP $HTTP_CODE)"
          fi
        done

    - name: ğŸ”„ ìë™ ë¡¤ë°± (ì‹¤íŒ¨ ì‹œ)
      if: env.HEALTH_CHECK_FAILED == 'true' && github.ref == 'refs/heads/main'
      run: |
        echo "ğŸš¨ ë°°í¬ ì‹¤íŒ¨ ê°ì§€ - ìë™ ë¡¤ë°± ì‹œì‘..."
        
        # ì´ì „ ì„±ê³µ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±
        echo "::error::ìë™ ë¡¤ë°± ê¸°ëŠ¥ì€ ìˆ˜ë™ìœ¼ë¡œ ArgoCDì—ì„œ ì²˜ë¦¬í•´ì£¼ì„¸ìš”."
        echo "::error::ArgoCD URL: https://${{ env.ARGOCD_SERVER }}/applications/${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}"

  # ğŸ“¢ ë°°í¬ ì•Œë¦¼
  notification:
    name: ğŸ“¢ ë°°í¬ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [post-deployment-verification, versioning, build-and-push]
    if: always() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: ğŸ“Š ë°°í¬ ê²°ê³¼ ìš”ì•½
      run: |
        echo "ğŸš€ Blacklist ë°°í¬ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ"
        echo "================================"
        echo "ğŸ“¦ í”„ë¡œì íŠ¸: ${{ env.PROJECT_NAME }}"
        echo "ğŸ·ï¸ ë²„ì „: ${{ needs.versioning.outputs.version }}"
        echo "ğŸ³ ì´ë¯¸ì§€: ${{ needs.build-and-push.outputs.image }}"
        echo "ğŸŒ í™˜ê²½: ${{ env.ENVIRONMENT }}"
        echo "ğŸ‘¤ ì‹¤í–‰ì: ${{ github.actor }}"
        echo "ğŸ”— ì»¤ë°‹: ${{ github.sha }}"
        
        # ì„±ê³µ/ì‹¤íŒ¨ ìƒíƒœ í™•ì¸
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… ìƒíƒœ: ì„±ê³µ"
        else
          echo "âŒ ìƒíƒœ: ì‹¤íŒ¨"
        fi
        
        echo "ğŸ”— ì›Œí¬í”Œë¡œìš°: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

    # Slack ì•Œë¦¼ (optional - secret ìˆì„ ë•Œë§Œ)
    - name: ğŸ“± Slack ì•Œë¦¼
      if: vars.SLACK_WEBHOOK_URL != ''
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        webhook_url: ${{ vars.SLACK_WEBHOOK_URL }}
        fields: repo,message,commit,author,action,eventName,ref,workflow
        custom_payload: |
          {
            "text": "${{ job.status == 'success' && 'âœ…' || 'âŒ' }} Blacklist ë°°í¬ ${{ job.status == 'success' && 'ì„±ê³µ' || 'ì‹¤íŒ¨' }}",
            "attachments": [{
              "color": "${{ job.status == 'success' && 'good' || 'danger' }}",
              "fields": [
                {"title": "í”„ë¡œì íŠ¸", "value": "${{ env.PROJECT_NAME }}", "short": true},
                {"title": "ë²„ì „", "value": "${{ needs.versioning.outputs.version }}", "short": true},
                {"title": "í™˜ê²½", "value": "${{ env.ENVIRONMENT }}", "short": true},
                {"title": "ì‹¤í–‰ì", "value": "${{ github.actor }}", "short": true}
              ]
            }]
          }

  # ğŸ§¹ ì •ë¦¬ ì‘ì—…
  cleanup:
    name: ğŸ§¹ ì •ë¦¬ ì‘ì—…
    runs-on: ubuntu-latest
    needs: [notification]
    if: always()
    
    steps:
    - name: ğŸ—‘ï¸ ì˜¤ë˜ëœ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì •ë¦¬
      run: |
        echo "ğŸ§¹ ì›Œí¬í”Œë¡œìš° ì •ë¦¬ ì‘ì—…ì€ GitHub ì„¤ì •ì—ì„œ ê´€ë¦¬ë©ë‹ˆë‹¤."
        echo "ğŸ’¡ GitHub Repository Settings > Actions > Generalì—ì„œ ì„¤ì • ê°€ëŠ¥"

    - name: ğŸ“Š íŒŒì´í”„ë¼ì¸ ë©”íŠ¸ë¦­ìŠ¤
      run: |
        END_TIME=$(date +%s)
        START_TIME=${{ github.event.head_commit.timestamp && 'date -d "${{ github.event.head_commit.timestamp }}" +%s' || 'echo $END_TIME' }}
        DURATION=$((END_TIME - START_TIME))
        
        echo "â±ï¸ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì‹œê°„: ${DURATION}ì´ˆ"
        echo "ğŸ”„ ì›Œí¬í”Œë¡œìš° ID: ${{ github.run_id }}"
        echo "ğŸ“ˆ ì‹¤í–‰ ë²ˆí˜¸: ${{ github.run_number }}"