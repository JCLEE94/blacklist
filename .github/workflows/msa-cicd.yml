name: MSA CI/CD Pipeline (jclee.me ì¸í”„ë¼)

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½ ì„ íƒ'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - staging
        - production
      skip_tests:
        description: 'í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸° (ê¸´ê¸‰ ë°°í¬ìš©)'
        required: false
        default: false
        type: boolean

# ë™ì¼ ë¸Œëœì¹˜ì—ì„œ ìƒˆ í‘¸ì‹œ ì‹œ ê¸°ì¡´ ì‹¤í–‰ ì·¨ì†Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # jclee.me ì¸í”„ë¼ ì„¤ì •
  REGISTRY: registry.jclee.me
  CHARTS_URL: https://charts.jclee.me
  ARGOCD_SERVER: argo.jclee.me
  K8S_CLUSTER: k8s.jclee.me
  
  # ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •
  APP_NAME: blacklist
  NAMESPACE: microservices
  
  # ì´ë¯¸ì§€ íƒœê·¸ ì „ëµ
  IMAGE_TAG: ${{ github.sha }}
  BRANCH_NAME: ${{ github.ref_name }}

jobs:
  # ğŸ” ì‚¬ì „ ê²€ì‚¬
  pre-check:
    name: "ì‚¬ì „ ê²€ì‚¬ ë° í™˜ê²½ ì„¤ì •"
    runs-on: self-hosted
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
      environment: ${{ steps.env.outputs.environment }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: í™˜ê²½ ì„¤ì •
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENV="production"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            ENV="staging" 
          else
            ENV="development"
          fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "ğŸ¯ ë°°í¬ í™˜ê²½: $ENV"

      - name: ë²„ì „ ìƒì„±
        id: version
        run: |
          VERSION=$(date +'%Y%m%d')-${GITHUB_SHA::8}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ë²„ì „: $VERSION"

      - name: ë°°í¬ í•„ìš”ì„± í™•ì¸
        id: check
        run: |
          # ë¬¸ì„œë§Œ ë³€ê²½ëœ ê²½ìš° ë°°í¬ ìƒëµ
          if git diff --name-only HEAD~1 | grep -E '\.md$|^docs/|\.gitignore$' && \
             ! git diff --name-only HEAD~1 | grep -v -E '\.md$|^docs/|\.gitignore$'; then
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            echo "ğŸ“ ë¬¸ì„œë§Œ ë³€ê²½ë¨ - ë°°í¬ ìƒëµ"
          else
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "ğŸš€ ì½”ë“œ ë³€ê²½ ê°ì§€ - ë°°í¬ ì§„í–‰"
          fi

  # ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (ë³‘ë ¬)
  code-quality:
    name: "ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬"
    runs-on: self-hosted
    needs: pre-check
    if: needs.pre-check.outputs.should-deploy == 'true'
    strategy:
      fail-fast: false
      matrix:
        check: [lint, security, format]
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install flake8 black isort bandit safety mypy

      - name: Lint ê²€ì‚¬
        if: matrix.check == 'lint'
        run: |
          echo "ğŸ” Python Lint ê²€ì‚¬"
          flake8 src/ --max-line-length=88 --extend-ignore=E203,W503 --statistics
          mypy src/ --ignore-missing-imports --no-error-summary

      - name: ë³´ì•ˆ ê²€ì‚¬
        if: matrix.check == 'security'
        run: |
          echo "ğŸ”’ ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬"
          bandit -r src/ -f json -o bandit-report.json -ll
          safety check --json --output safety-report.json

      - name: í¬ë§· ê²€ì‚¬
        if: matrix.check == 'format'
        run: |
          echo "âœ¨ ì½”ë“œ í¬ë§· ê²€ì‚¬"
          black --check src/ --diff --color
          isort src/ --check-only --diff --color

  # ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ë³‘ë ¬)
  tests:
    name: "í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
    runs-on: self-hosted
    needs: pre-check
    if: needs.pre-check.outputs.should-deploy == 'true' && github.event.inputs.skip_tests != 'true'
    strategy:
      fail-fast: false
      matrix:
        test-type: [unit, integration, performance]
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-xdist pytest-html

      - name: Unit Tests
        if: matrix.test-type == 'unit'
        run: |
          echo "ğŸ§ª Unit í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
          pytest tests/ -v --cov=src --cov-report=xml --junitxml=junit-unit.xml

      - name: Integration Tests
        if: matrix.test-type == 'integration'
        run: |
          echo "ğŸ”„ Integration í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
          python3 tests/integration/run_integration_tests.py

      - name: Performance Tests
        if: matrix.test-type == 'performance'
        run: |
          echo "âš¡ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
          python3 tests/integration/performance_benchmark.py

  # ğŸ—ï¸ ë¹Œë“œ ë° í‘¸ì‹œ
  build-and-push:
    name: "ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ"
    runs-on: self-hosted
    needs: [pre-check, code-quality, tests]
    if: |
      always() && 
      needs.pre-check.outputs.should-deploy == 'true' &&
      (needs.code-quality.result == 'success' || needs.code-quality.result == 'skipped') &&
      (needs.tests.result == 'success' || needs.tests.result == 'skipped')
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tags: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ìƒì„±
        id: meta
        run: |
          TAGS="$REGISTRY/$APP_NAME:latest"
          TAGS="$TAGS,$REGISTRY/$APP_NAME:${{ needs.pre-check.outputs.version }}"
          TAGS="$TAGS,$REGISTRY/$APP_NAME:$BRANCH_NAME"
          TAGS="$TAGS,$REGISTRY/$APP_NAME:sha-${GITHUB_SHA::8}"
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ ìƒì„±ëœ íƒœê·¸ë“¤: $TAGS"

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v2
        with:
          config-inline: |
            [registry."${{ env.REGISTRY }}"]
              http = true
              insecure = true

      - name: Registry ë¡œê·¸ì¸
        run: |
          echo "${{ secrets.JCLEE_REGISTRY_PASSWORD }}" | docker login $REGISTRY \
            --username "${{ secrets.JCLEE_REGISTRY_USERNAME }}" \
            --password-stdin

      - name: ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        id: build
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./deployment/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

      - name: ë¹Œë“œ ê²°ê³¼ í™•ì¸
        run: |
          echo "âœ… ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
          echo "ğŸ“¦ Digest: ${{ steps.build.outputs.digest }}"
          echo "ğŸ·ï¸ Tags: ${{ steps.meta.outputs.tags }}"

  # ğŸ“¦ Helm Chart íŒ¨í‚¤ì§•
  helm-package:
    name: "Helm Chart íŒ¨í‚¤ì§• ë° í‘¸ì‹œ"
    runs-on: self-hosted
    needs: [pre-check, build-and-push]
    if: needs.build-and-push.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Helm ì„¤ì¹˜
        run: |
          if ! command -v helm &> /dev/null; then
            curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          fi
          helm version

      - name: Chart ë²„ì „ ì—…ë°ì´íŠ¸
        run: |
          cd charts/blacklist
          sed -i "s/version: .*/version: ${{ needs.pre-check.outputs.version }}/" Chart.yaml
          sed -i "s/appVersion: .*/appVersion: \"${{ needs.pre-check.outputs.version }}\"/" Chart.yaml
          cat Chart.yaml

      - name: Chart ê²€ì¦
        run: |
          cd charts/blacklist
          helm lint .
          helm template blacklist . --debug --dry-run

      - name: Chart íŒ¨í‚¤ì§•
        run: |
          cd charts
          helm package blacklist/
          ls -la *.tgz

      - name: ChartMuseum ì¸ì¦ ë° í‘¸ì‹œ
        run: |
          # ChartMuseumì— ì°¨íŠ¸ í‘¸ì‹œ
          curl -u "${{ secrets.JCLEE_CHARTS_USERNAME }}:${{ secrets.JCLEE_CHARTS_PASSWORD }}" \
            --data-binary "@charts/blacklist-${{ needs.pre-check.outputs.version }}.tgz" \
            "$CHARTS_URL/api/charts"
          echo "ğŸ“¦ Helm Chart í‘¸ì‹œ ì™„ë£Œ"

  # ğŸš€ ArgoCD ë°°í¬
  argocd-deploy:
    name: "ArgoCD GitOps ë°°í¬"
    runs-on: self-hosted
    needs: [pre-check, build-and-push, helm-package]
    if: needs.build-and-push.result == 'success'
    environment: ${{ needs.pre-check.outputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: ArgoCD CLI ì„¤ì¹˜
        run: |
          if ! command -v argocd &> /dev/null; then
            curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
            sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
          fi
          argocd version --client

      - name: ArgoCD ë¡œê·¸ì¸
        run: |
          argocd login $ARGOCD_SERVER \
            --username "${{ secrets.JCLEE_ARGOCD_USERNAME }}" \
            --password "${{ secrets.JCLEE_ARGOCD_PASSWORD }}" \
            --grpc-web \
            --insecure

      - name: ArgoCD Application ì—…ë°ì´íŠ¸
        id: deploy
        run: |
          # ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ì–´ë…¸í…Œì´ì…˜ ì¶”ê°€
          argocd app set $APP_NAME \
            --parameter image.tag=${{ needs.pre-check.outputs.version }} \
            --grpc-web
          
          # ë™ê¸°í™” ì‹¤í–‰ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
          for i in {1..3}; do
            echo "ğŸ”„ ArgoCD ë™ê¸°í™” ì‹œë„ $i/3"
            if argocd app sync $APP_NAME --grpc-web --timeout 300; then
              echo "âœ… ArgoCD ë™ê¸°í™” ì„±ê³µ"
              break
            elif [ $i -eq 3 ]; then
              echo "âŒ ArgoCD ë™ê¸°í™” ì‹¤íŒ¨ (ìµœëŒ€ ì¬ì‹œë„ ì´ˆê³¼)"
              exit 1
            else
              echo "â³ 30ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 30
            fi
          done

      - name: ë°°í¬ ìƒíƒœ í™•ì¸
        run: |
          # í—¬ìŠ¤ ì²´í¬ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
          for i in {1..5}; do
            echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬ ì‹œë„ $i/5"
            if argocd app wait $APP_NAME --health --timeout 120 --grpc-web; then
              echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ ì²´í¬ ì„±ê³µ"
              break
            elif [ $i -eq 5 ]; then
              echo "âŒ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ (ìµœëŒ€ ì¬ì‹œë„ ì´ˆê³¼)"
              argocd app get $APP_NAME --grpc-web
              exit 1
            else
              echo "â³ 30ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 30
            fi
          done

      - name: ë°°í¬ ê²°ê³¼ í™•ì¸
        run: |
          echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
          argocd app get $APP_NAME --grpc-web
          
          # kubectlë¡œ pod ìƒíƒœ í™•ì¸
          if command -v kubectl &> /dev/null; then
            kubectl get pods -n $NAMESPACE -l app.kubernetes.io/name=$APP_NAME
            kubectl get svc -n $NAMESPACE -l app.kubernetes.io/name=$APP_NAME
          fi

  # ğŸ“Š ë°°í¬ í›„ ê²€ì¦
  post-deploy-verification:
    name: "ë°°í¬ í›„ ê²€ì¦"
    runs-on: self-hosted
    needs: [pre-check, argocd-deploy]
    if: needs.argocd-deploy.result == 'success'
    steps:
      - name: ì„œë¹„ìŠ¤ í—¬ìŠ¤ ì²´í¬
        run: |
          echo "ğŸ¥ ì„œë¹„ìŠ¤ í—¬ìŠ¤ ì²´í¬"
          
          # NodePortë¥¼ í†µí•œ í—¬ìŠ¤ ì²´í¬ (30080 í¬íŠ¸)
          for i in {1..10}; do
            if curl -f -s http://localhost:30080/health > /dev/null 2>&1; then
              echo "âœ… ì„œë¹„ìŠ¤ í—¬ìŠ¤ ì²´í¬ ì„±ê³µ"
              curl -s http://localhost:30080/health | jq .
              break
            elif [ $i -eq 10 ]; then
              echo "âŒ ì„œë¹„ìŠ¤ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨"
              exit 1
            else
              echo "â³ ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘... ($i/10)"
              sleep 15
            fi
          done

      - name: API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ”Œ API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸"
          
          # ì£¼ìš” ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
          endpoints=(
            "/health"
            "/api/blacklist/active"
            "/api/collection/status"
            "/api/stats"
          )
          
          for endpoint in "${endpoints[@]}"; do
            echo "Testing $endpoint..."
            if curl -f -s "http://localhost:30080$endpoint" > /dev/null; then
              echo "âœ… $endpoint ì‘ë‹µ ì •ìƒ"
            else
              echo "âŒ $endpoint ì‘ë‹µ ì‹¤íŒ¨"
              exit 1
            fi
          done

      - name: ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬
        run: |
          echo "âš¡ ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ì‹¤í–‰"
          
          # ê°„ë‹¨í•œ ë¶€í•˜ í…ŒìŠ¤íŠ¸ (10ì´ˆê°„ ì´ˆë‹¹ 10 ìš”ì²­)
          if command -v ab &> /dev/null; then
            ab -t 10 -c 5 -q http://localhost:30080/health
          else
            echo "ğŸ“Š Apache Bench ì—†ìŒ - ê¸°ë³¸ ì‘ë‹µ ì‹œê°„ í…ŒìŠ¤íŠ¸"
            time curl -s http://localhost:30080/health > /dev/null
          fi

  # ğŸ”” ì•Œë¦¼ ë° ì •ë¦¬
  notify:
    name: "ë°°í¬ ê²°ê³¼ ì•Œë¦¼"
    runs-on: self-hosted
    needs: [pre-check, build-and-push, argocd-deploy, post-deploy-verification]
    if: always()
    steps:
      - name: ë°°í¬ ê²°ê³¼ ì •ë¦¬
        run: |
          if [[ "${{ needs.argocd-deploy.result }}" == "success" && "${{ needs.post-deploy-verification.result }}" == "success" ]]; then
            echo "ğŸ‰ MSA ë°°í¬ ì„±ê³µ!"
            echo "ğŸ“¦ ë²„ì „: ${{ needs.pre-check.outputs.version }}"
            echo "ğŸŒ í™˜ê²½: ${{ needs.pre-check.outputs.environment }}"
            echo "ğŸ”— ì„œë¹„ìŠ¤ URL: https://blacklist.jclee.me"
            echo "ğŸ“Š ArgoCD: https://$ARGOCD_SERVER/applications/$APP_NAME"
          else
            echo "âŒ MSA ë°°í¬ ì‹¤íŒ¨"
            echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”"
          fi

      - name: Webhook ì•Œë¦¼ (ì„ íƒì‚¬í•­)
        if: env.DEPLOYMENT_WEBHOOK_URL
        run: |
          STATUS="${{ needs.argocd-deploy.result == 'success' && needs.post-deploy-verification.result == 'success' && 'ì„±ê³µ' || 'ì‹¤íŒ¨' }}"
          curl -X POST "${{ env.DEPLOYMENT_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"ğŸš€ Blacklist MSA ë°°í¬ $STATUS\",
              \"username\": \"GitHub Actions\",
              \"attachments\": [
                {
                  \"color\": \"${{ needs.argocd-deploy.result == 'success' && needs.post-deploy-verification.result == 'success' && 'good' || 'danger' }}\",
                  \"fields\": [
                    {\"title\": \"í™˜ê²½\", \"value\": \"${{ needs.pre-check.outputs.environment }}\", \"short\": true},
                    {\"title\": \"ë²„ì „\", \"value\": \"${{ needs.pre-check.outputs.version }}\", \"short\": true},
                    {\"title\": \"ë¸Œëœì¹˜\", \"value\": \"${{ github.ref_name }}\", \"short\": true},
                    {\"title\": \"ì»¤ë°‹\", \"value\": \"${{ github.sha }}\", \"short\": true}
                  ]
                }
              ]
            }"