# Watchtower Auto-Update Service for Blacklist
# Version: v1.0.37 최적화

version: '3.9'

services:
  watchtower:
    image: containrrr/watchtower:latest
    container_name: blacklist-watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/.docker/config.json:/config.json:ro
    environment:
      # 기본 설정
      WATCHTOWER_CLEANUP: "true"
      WATCHTOWER_POLL_INTERVAL: ${WATCHTOWER_INTERVAL:-300}
      WATCHTOWER_SCOPE: blacklist
      WATCHTOWER_INCLUDE_RESTARTING: "true"
      WATCHTOWER_ROLLING_RESTART: "true"
      WATCHTOWER_REMOVE_VOLUMES: "false"
      WATCHTOWER_REVIVE_STOPPED: "false"
      
      # 알림 설정 (Slack)
      WATCHTOWER_NOTIFICATIONS: ${WATCHTOWER_NOTIFICATIONS:-}
      WATCHTOWER_NOTIFICATION_SLACK_HOOK_URL: ${SLACK_WEBHOOK_URL:-}
      WATCHTOWER_NOTIFICATION_SLACK_IDENTIFIER: "Blacklist-Watchtower"
      WATCHTOWER_NOTIFICATION_SLACK_CHANNEL: ${SLACK_CHANNEL:-#alerts}
      
      # 디버그 및 로깅
      WATCHTOWER_DEBUG: ${WATCHTOWER_DEBUG:-false}
      WATCHTOWER_LOG_LEVEL: ${WATCHTOWER_LOG_LEVEL:-info}
      
      # 스케줄링 (Cron 형식 사용 시)
      WATCHTOWER_SCHEDULE: ${WATCHTOWER_SCHEDULE:-}
      
      # Registry 인증
      REPO_USER: ${REGISTRY_USERNAME:-}
      REPO_PASS: ${REGISTRY_PASSWORD:-}
    command: >
      --scope blacklist
      --cleanup
      --interval ${WATCHTOWER_INTERVAL:-300}
      ${WATCHTOWER_EXTRA_ARGS:-}
    networks:
      - blacklist-net
    labels:
      - "com.watchtower.scope=blacklist"
      - "com.watchtower.enable=false"  # Watchtower가 자기 자신을 업데이트하지 않도록
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  blacklist-net:
    external: true
    name: blacklist-network