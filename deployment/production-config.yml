# Production Deployment Configuration
# 프로덕션 환경 배포 설정

version: '3.9'

# 배포 환경 설정
deployment:
  environment: production
  registry: registry.jclee.me
  image: blacklist:latest
  
# 자동 업데이트 설정
auto_update:
  enabled: true
  provider: watchtower
  interval: 3600  # 1시간
  cleanup: true
  notifications: true

# 서비스 설정
services:
  blacklist:
    port: 32542
    replicas: 1
    health_check:
      enabled: true
      interval: 30s
      timeout: 10s
      retries: 3
    resources:
      limits:
        cpu: 0.5
        memory: 512M
      reservations:
        cpu: 0.05
        memory: 128M
        
  redis:
    maxmemory: 256mb
    policy: allkeys-lru
    persistence: true
    resources:
      limits:
        cpu: 0.2
        memory: 256M
      reservations:
        cpu: 0.05
        memory: 64M
        
  watchtower:
    monitor_only: blacklist
    remove_old_images: true
    debug: false
    resources:
      limits:
        cpu: 0.1
        memory: 128M
      reservations:
        cpu: 0.05
        memory: 64M

# 네트워크 설정
network:
  name: blacklist-network
  driver: bridge
  subnet: 172.20.0.0/16

# 볼륨 설정
volumes:
  - name: redis-data
    driver: local
    backup: true
  - name: blacklist-data
    driver: local
    backup: true
  - name: logs
    driver: local
    retention: 7d

# 보안 설정
security:
  jwt_enabled: true
  api_key_enabled: true
  max_auth_attempts: 5
  block_duration_hours: 1

# 백업 설정
backup:
  enabled: true
  schedule: "0 3 * * *"  # 매일 새벽 3시
  retention_days: 7
  destinations:
    - /volume1/docker/blacklist/backup
    - /volume1/backup/blacklist

# 모니터링 설정
monitoring:
  prometheus:
    enabled: true
    port: 9090
  health_check:
    endpoint: /health
    interval: 60s
  alerts:
    - name: service_down
      condition: "service.status != 'healthy'"
      action: restart
    - name: high_memory
      condition: "memory_usage > 80%"
      action: alert

# CI/CD 파이프라인 설정
pipeline:
  github_actions:
    enabled: true
    runner: self-hosted
  docker_registry:
    url: registry.jclee.me
    auto_push: true
  watchtower:
    auto_deploy: true
    rollback_on_failure: true

# 배포 타겟
targets:
  local:
    host: localhost
    port: 32542
  nas:
    host: 192.168.50.215
    port: 32542
    ssh_port: 1111
    user: docker
    path: /volume1/docker/blacklist
  production:
    host: jclee.me
    port: 32542