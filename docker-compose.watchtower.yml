version: '3.8'

services:
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower-blacklist
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/.docker/config.json:/config.json:ro
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_INCLUDE_RESTARTING=true
      - WATCHTOWER_POLL_INTERVAL=60   # Check every 60 seconds for faster deployment
      - WATCHTOWER_LABEL_ENABLE=true
      - WATCHTOWER_ROLLING_RESTART=true
      - WATCHTOWER_TIMEOUT=300s       # 5 minute timeout for pulls
      - WATCHTOWER_HTTP_API_TOKEN=blacklist-watchtower-2024
      - WATCHTOWER_HTTP_API_METRICS=true
      - WATCHTOWER_NOTIFICATIONS=slack,webhook
      - WATCHTOWER_NOTIFICATION_SLACK_HOOK_URL=${SLACK_WEBHOOK_URL:-}
      - WATCHTOWER_NOTIFICATION_URL=${WEBHOOK_URL:-}
      - DOCKER_CONFIG=/config.json
      - TZ=Asia/Seoul
      # Registry authentication
      - WATCHTOWER_NOTIFICATIONS_HOSTNAME=blacklist-production
      - WATCHTOWER_DEBUG=true
    command: >
      --interval 60 
      --cleanup 
      --include-restarting 
      --label-enable 
      --rolling-restart 
      --http-api-metrics 
      --http-api-token blacklist-watchtower-2024
    ports:
      - "8080:8080"  # Watchtower API for monitoring
    labels:
      - "com.centurylinklabs.watchtower.enable=false"  # Don't update watchtower itself
    networks:
      - blacklist-network

networks:
  blacklist-network:
    external: true