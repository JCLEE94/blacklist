apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-image-updater-config
  namespace: argocd
data:
  # ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì„¤ì •
  registries.conf: |
    registries:
    - name: custom-registry
      api_url: https://registry.jclee.me
      prefix: registry.jclee.me
      ping: yes
      insecure: no
      credentials: pullsecret:argocd/registry-credentials
      defaultns: library
      limit: 50
  
  # ë¡œê·¸ ë ˆë²¨ ì„¤ì •
  log.level: "info"
  
  # Git ì»¤ë°‹ ì„¤ì •
  git.commit-message-template: |
    build: automatic image update
    
    {{range .Images}}
    - {{.Image}}:{{.Tag}}
    {{end}}
    
    ğŸ¤– Updated by ArgoCD Image Updater
  
  # ì—…ë°ì´íŠ¸ ê°„ê²© (ì´ˆ)
  interval: "120"  # 2ë¶„ë§ˆë‹¤ ì²´í¬
  
---
apiVersion: v1
kind: Secret
metadata:
  name: registry-credentials
  namespace: argocd
type: kubernetes.io/dockerconfigjson
data:
  # base64ë¡œ ì¸ì½”ë”©ëœ docker config
  # ì‹¤ì œ ì‚¬ìš© ì‹œ ì•„ë˜ ëª…ë ¹ìœ¼ë¡œ ìƒì„±:
  # kubectl create secret docker-registry registry-credentials \
  #   --docker-server=registry.jclee.me \
  #   --docker-username=<username> \
  #   --docker-password=<password> \
  #   -n argocd --dry-run=client -o yaml
  .dockerconfigjson: <base64-encoded-docker-config>
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: argocd-image-updater
  namespace: argocd
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: argocd-image-updater
  namespace: argocd
rules:
- apiGroups:
  - argoproj.io
  resources:
  - applications
  verbs:
  - get
  - list
  - update
  - patch
- apiGroups:
  - ""
  resources:
  - secrets
  verbs:
  - get
  - list
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: argocd-image-updater
  namespace: argocd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: argocd-image-updater
subjects:
- kind: ServiceAccount
  name: argocd-image-updater
  namespace: argocd