apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-image-updater-config
  namespace: argocd
data:
  # Private Registry 설정 (인증 사용)
  registries.conf: |
    registries:
    - name: private-registry
      api_url: https://registry.jclee.me
      prefix: registry.jclee.me
      ping: yes
      insecure: no
      credentials: pullsecret:argocd/registry-credentials
      defaultns: library
      limit: 100
  
  # 로그 레벨 설정
  log.level: "info"
  
  # Git 커밋 설정
  git.commit-message-template: |
    build: automatic image update
    
    {{range .Images}}
    - {{.Image}}:{{.Tag}}
    {{end}}
    
    🤖 Updated by ArgoCD Image Updater
  
  # 업데이트 간격 (초)
  interval: "120"  # 2분마다 체크
  
---
# Private Registry Secret (인증 불필요하지만 ArgoCD Image Updater 호환성용)
apiVersion: v1
kind: Secret
metadata:
  name: registry-credentials
  namespace: argocd
type: kubernetes.io/dockerconfigjson
data:
  # registry.jclee.me 인증 정보 (admin:bingogo1)
  .dockerconfigjson: eyJhdXRocyI6eyJyZWdpc3RyeS5qY2xlZS1tZSI6eyJ1c2VybmFtZSI6ImFkbWluIiwicGFzc3dvcmQiOiJiaW5nb2dvMSIsImF1dGgiOiJZV1J0YVc0NlltbHVaMjluYnpFPSJ9fX0=
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: argocd-image-updater
  namespace: argocd
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: argocd-image-updater
  namespace: argocd
rules:
- apiGroups:
  - argoproj.io
  resources:
  - applications
  verbs:
  - get
  - list
  - update
  - patch
- apiGroups:
  - ""
  resources:
  - secrets
  verbs:
  - get
  - list
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: argocd-image-updater
  namespace: argocd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: argocd-image-updater
subjects:
- kind: ServiceAccount
  name: argocd-image-updater
  namespace: argocd