# Cloudflare Tunnel Deployment for Blacklist Service
# 이 파일은 Cloudflare Zero Trust를 통해 NodePort 서비스를 외부에 노출합니다
apiVersion: v1
kind: Secret
metadata:
  name: cloudflared-secret
  namespace: blacklist
type: Opaque
stringData:
  token: "eyJhIjoiYThkOWM2N2Y1ODZhY2RkMTVlZWJjYzY1Y2EzYWE1YmIiLCJ0IjoiOGVhNzg5MDYtMWEwNS00NGZiLWExYmItZTUxMjE3MmNiNWFiIiwicyI6Ill6RXlZVEUwWWpRdE1tVXlNUzAwWmpRMExXSTVaR0V0WkdNM09UY3pOV1ExT1RGbSJ9"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cloudflared-config
  namespace: blacklist
data:
  config.yaml: |
    tunnel: blacklist-tunnel
    credentials-file: /etc/cloudflared/creds/token
    
    ingress:
      # Blacklist 서비스로 라우팅
      - hostname: blacklist.jclee.me
        service: http://blacklist-nodeport:2541
      # 기본 404 응답
      - service: http_status:404
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cloudflared
  namespace: blacklist
  labels:
    app: cloudflared
spec:
  replicas: 2  # HA를 위해 2개 레플리카
  selector:
    matchLabels:
      app: cloudflared
  template:
    metadata:
      labels:
        app: cloudflared
    spec:
      containers:
      - name: cloudflared
        image: cloudflare/cloudflared:latest
        args:
        - tunnel
        - --no-autoupdate
        - run
        - --token
        - $(TUNNEL_TOKEN)
        env:
        - name: TUNNEL_TOKEN
          valueFrom:
            secretKeyRef:
              name: cloudflared-secret
              key: token
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /ready
            port: 2000
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 2000
          initialDelaySeconds: 5
          periodSeconds: 5
---
# 선택적: HPA for cloudflared
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: cloudflared-hpa
  namespace: blacklist
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: cloudflared
  minReplicas: 2
  maxReplicas: 4
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 80
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80