apiVersion: batch/v1
kind: CronJob
metadata:
  name: blacklist-daily-collection
  namespace: blacklist
spec:
  schedule: "0 2 * * *"  # 매일 새벽 2시 (KST 11시)
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: collector
            image: registry.jclee.me/blacklist:latest
            command:
            - /bin/sh
            - -c
            - |
              # Enable collection
              curl -X POST http://blacklist:2541/api/collection/enable
              sleep 5
              # Trigger REGTECH collection with 3-month range
              END_DATE=$(date +%Y%m%d)
              START_DATE=$(date -d "90 days ago" +%Y%m%d 2>/dev/null || date -v-90d +%Y%m%d)
              curl -X POST http://blacklist:2541/api/collection/regtech/trigger \
                -H "Content-Type: application/json" \
                -d "{\"start_date\": \"${START_DATE}\", \"end_date\": \"${END_DATE}\"}"
              sleep 5
              # Trigger SECUDIUM collection  
              curl -X POST http://blacklist:2541/api/collection/secudium/trigger
            envFrom:
            - configMapRef:
                name: blacklist-config
            - secretRef:
                name: blacklist-secret
          restartPolicy: OnFailure