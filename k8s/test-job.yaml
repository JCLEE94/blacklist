apiVersion: batch/v1
kind: Job
metadata:
  name: blacklist-integration-test
  namespace: blacklist
spec:
  template:
    spec:
      containers:
      - name: test
        image: curlimages/curl:latest
        command:
        - /bin/sh
        - -c
        - |
          echo "Starting integration tests..."
          
          # Wait for service to be ready
          sleep 30
          
          # Health check
          echo "1. Testing health endpoint..."
          curl -f http://blacklist:2541/health || exit 1
          echo "✓ Health check passed"
          
          # Stats API
          echo "2. Testing stats API..."
          curl -f http://blacklist:2541/api/stats || exit 1
          echo "✓ Stats API passed"
          
          # Collection status
          echo "3. Testing collection status..."
          curl -f http://blacklist:2541/api/collection/status || exit 1
          echo "✓ Collection status passed"
          
          # Enable collection
          echo "4. Testing collection enable..."
          curl -X POST http://blacklist:2541/api/collection/enable \
            -H "Content-Type: application/json" || exit 1
          echo "✓ Collection enable passed"
          
          # REGTECH trigger
          echo "5. Testing REGTECH trigger..."
          curl -X POST http://blacklist:2541/api/collection/regtech/trigger \
            -H "Content-Type: application/json" || exit 1
          echo "✓ REGTECH trigger passed"
          
          # SECUDIUM trigger
          echo "6. Testing SECUDIUM trigger..."
          curl -X POST http://blacklist:2541/api/collection/secudium/trigger \
            -H "Content-Type: application/json" || exit 1
          echo "✓ SECUDIUM trigger passed"
          
          # FortiGate API
          echo "7. Testing FortiGate API..."
          curl -f http://blacklist:2541/api/fortigate || exit 1
          echo "✓ FortiGate API passed"
          
          # Search API
          echo "8. Testing search API..."
          curl -f http://blacklist:2541/api/search/1.1.1.1 || exit 1
          echo "✓ Search API passed"
          
          echo "All integration tests passed!"
      restartPolicy: Never
  backoffLimit: 1