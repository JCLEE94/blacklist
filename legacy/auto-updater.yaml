apiVersion: v1
kind: ServiceAccount
metadata:
  name: image-updater
  namespace: blacklist
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: image-updater
rules:
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list", "patch", "update"]
- apiGroups: [""]
  resources: ["services", "nodes"]
  verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: image-updater
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: image-updater
subjects:
- kind: ServiceAccount
  name: image-updater
  namespace: blacklist
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: auto-update-script
  namespace: blacklist
data:
  auto-update.sh: |
    #!/bin/bash
    # ë‹¨ë°œì„± ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ì²´í¬ ìŠ¤í¬ë¦½íŠ¸ (CronJobìš©)
    
    echo "ğŸ”„ $(date '+%Y-%m-%d %H:%M:%S') - ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ì²´í¬ ì‹œì‘"
    
    # ì„¤ì •
    NAMESPACE="blacklist"
    REGISTRY="registry.jclee.me"
    IMAGE_NAME="blacklist"
    
    # í˜„ì¬ ë°°í¬ëœ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
    current_image=$(kubectl get deployment blacklist -n $NAMESPACE -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null)
    if [ -z "$current_image" ]; then
        echo "âŒ í˜„ì¬ ë°°í¬ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŒ"
        exit 1
    fi
    
    current_tag=$(echo "$current_image" | cut -d':' -f2)
    echo "ğŸ“‹ í˜„ì¬ ì´ë¯¸ì§€: $current_image"
    
    # Registry APIë¡œ ìµœì‹  íƒœê·¸ í™•ì¸ (GitHub Actionsê°€ í‘¸ì‹œí•œ ìµœì‹  SHA)
    echo "ğŸ” Registryì—ì„œ ìµœì‹  ì´ë¯¸ì§€ í™•ì¸ ì¤‘..."
    
    # Docker Registry API v2 ì‚¬ìš©í•˜ì—¬ ìµœì‹  SHA íƒœê·¸ ê°€ì ¸ì˜¤ê¸°
    auth_header=""
    if [ -n "$REGISTRY_USER" ] && [ -n "$REGISTRY_PASS" ]; then
        auth_string=$(echo -n "$REGISTRY_USER:$REGISTRY_PASS" | base64 -w 0)
        auth_header="-H \"Authorization: Basic $auth_string\""
        echo "ğŸ” Registry ì¸ì¦ ì„¤ì •ë¨"
    else
        echo "âš ï¸ Registry ì¸ì¦ ì •ë³´ ì—†ìŒ"
    fi
    
    # ë‹¤ì–‘í•œ íƒœê·¸ íŒ¨í„´ ì‹œë„í•˜ì—¬ ìµœì‹  ì´ë¯¸ì§€ ê°ì§€
    echo "ğŸ” Registry API ì‘ë‹µ í™•ì¸ ì¤‘..."
    if [ -n "$auth_header" ]; then
        registry_response=$(curl -s -H "Authorization: Basic $auth_string" "https://$REGISTRY/v2/$IMAGE_NAME/tags/list")
    else
        registry_response=$(curl -s "https://$REGISTRY/v2/$IMAGE_NAME/tags/list")
    fi
    echo "Registry ì‘ë‹µ: $(echo "$registry_response" | head -c 200)..."
    
    # 1ì°¨: SHA íƒœê·¸ ì°¾ê¸° (7-8ìë¦¬)
    latest_tag=$(echo "$registry_response" | \
        jq -r '.tags[]?' 2>/dev/null | \
        grep -E '^[a-f0-9]{7,8}$' | \
        sort -r | \
        head -1)
    
    # 2ì°¨: ë‚ ì§œ ê¸°ë°˜ íƒœê·¸ ì°¾ê¸° (YYYYMMDD-HHMM í˜•ì‹)
    if [ -z "$latest_tag" ]; then
        latest_tag=$(echo "$registry_response" | \
            jq -r '.tags[]?' 2>/dev/null | \
            grep -E '^[0-9]{8}-[0-9]{4}' | \
            sort -r | \
            head -1)
    fi
    
    # 3ì°¨: GitHub Actions ë¹Œë“œ íƒœê·¸ ì°¾ê¸°
    if [ -z "$latest_tag" ]; then
        latest_tag=$(echo "$registry_response" | \
            jq -r '.tags[]?' 2>/dev/null | \
            grep -E '^(main|build|deploy)-[a-f0-9]{7,}' | \
            sort -r | \
            head -1)
    fi
    
    # ìµœí›„: latest íƒœê·¸ ì‚¬ìš©
    if [ -z "$latest_tag" ] || [ "$latest_tag" = "null" ]; then
        echo "âš ï¸ Registryì—ì„œ ì ì ˆí•œ íƒœê·¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ - latest íƒœê·¸ ì‚¬ìš©"
        latest_tag="latest"
    fi
    
    echo "ğŸ·ï¸  ìµœì‹  íƒœê·¸: $latest_tag"
    
    # íƒœê·¸ ë¹„êµ ë° ì—…ë°ì´íŠ¸
    if [ "$current_tag" != "$latest_tag" ]; then
        echo "ğŸ†• ìƒˆë¡œìš´ ì´ë¯¸ì§€ ë°œê²¬! ì—…ë°ì´íŠ¸ ì‹œì‘..."
        echo "   í˜„ì¬: $current_tag â†’ ìƒˆë¡œìš´: $latest_tag"
        new_image="$REGISTRY/$IMAGE_NAME:$latest_tag"
        
        # ì—…ë°ì´íŠ¸ ì „ ë°±ì—… - í˜„ì¬ deployment ì •ë³´ ì €ì¥
        kubectl get deployment blacklist -n $NAMESPACE -o yaml > /tmp/blacklist-backup-$(date +%Y%m%d-%H%M%S).yaml
        
        # ì´ë¯¸ì§€ ì¡´ì¬ í™•ì¸
        echo "ğŸ” ìƒˆ ì´ë¯¸ì§€ ì¡´ì¬ í™•ì¸ ì¤‘..."
        if [ -n "$auth_header" ]; then
            manifest_response=$(curl -f -s -H "Authorization: Basic $auth_string" "https://$REGISTRY/v2/$IMAGE_NAME/manifests/$latest_tag" 2>/dev/null)
        else
            manifest_response=$(curl -f -s "https://$REGISTRY/v2/$IMAGE_NAME/manifests/$latest_tag" 2>/dev/null)
        fi
        
        if [ -z "$manifest_response" ]; then
            echo "âŒ ì´ë¯¸ì§€ $new_imageê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ"
            exit 1
        fi
        
        # ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ (ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ê°•ì œ ë¡¤ì•„ì›ƒ)
        kubectl set image deployment/blacklist \
            blacklist="$new_image" \
            -n $NAMESPACE
        
        kubectl annotate deployment blacklist \
            deployment.kubernetes.io/revision- \
            -n $NAMESPACE 2>/dev/null || true
            
        kubectl patch deployment blacklist \
            -p '{"spec":{"template":{"metadata":{"annotations":{"updated":"'$(date +%s)'"}}}}' \
            -n $NAMESPACE
        
        # ë¡¤ì•„ì›ƒ ìƒíƒœ í™•ì¸ (ë” ê¸´ íƒ€ì„ì•„ì›ƒ)
        echo "â³ ë¡¤ì•„ì›ƒ ìƒíƒœ í™•ì¸ ì¤‘..."
        if kubectl rollout status deployment/blacklist -n $NAMESPACE --timeout=600s; then
            echo "âœ… ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ì„±ê³µ: $new_image"
            
            # í—¬ìŠ¤ ì²´í¬ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
            echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬ ì‹œì‘..."
            for i in {1..5}; do
                sleep 15
                NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
                NODE_PORT=$(kubectl get svc blacklist-nodeport -n $NAMESPACE -o jsonpath='{.spec.ports[0].nodePort}' 2>/dev/null || echo "32541")
                
                if curl -f -s --connect-timeout 10 --max-time 15 "http://$NODE_IP:$NODE_PORT/health" > /dev/null 2>&1; then
                    echo "âœ… í—¬ìŠ¤ ì²´í¬ í†µê³¼ (ì‹œë„ $i/5)"
                    
                    # Pod ìƒíƒœ ìµœì¢… í™•ì¸
                    ready_pods=$(kubectl get deployment blacklist -n $NAMESPACE -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo "0")
                    total_pods=$(kubectl get deployment blacklist -n $NAMESPACE -o jsonpath='{.spec.replicas}' 2>/dev/null || echo "1")
                    
                    echo "ğŸ“Š Pod ìƒíƒœ: $ready_pods/$total_pods Ready"
                    echo "ğŸ‰ ìë™ ì—…ë°ì´íŠ¸ ì™„ë£Œ!"
                    
                    # ì„±ê³µ ë©”íŠ¸ë¦­ ê¸°ë¡
                    kubectl annotate deployment blacklist \
                        last-successful-update="$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                        last-updated-image="$new_image" \
                        -n $NAMESPACE
                    break
                else
                    echo "âš ï¸ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ (ì‹œë„ $i/5) - 15ì´ˆ í›„ ì¬ì‹œë„..."
                    if [ $i -eq 5 ]; then
                        echo "âŒ í—¬ìŠ¤ ì²´í¬ ìµœì¢… ì‹¤íŒ¨ - ë¡¤ë°± ê³ ë ¤ í•„ìš”"
                        
                        # ì‹¤íŒ¨ ì‹œ ì´ë²¤íŠ¸ ê¸°ë¡
                        kubectl annotate deployment blacklist \
                            last-failed-update="$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                            failed-image="$new_image" \
                            -n $NAMESPACE
                        exit 1
                    fi
                fi
            done
        else
            echo "âŒ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ - ë¡¤ì•„ì›ƒ íƒ€ì„ì•„ì›ƒ"
            exit 1
        fi
    else
        echo "âœ… ì´ë¯¸ì§€ê°€ ì´ë¯¸ ìµœì‹  ìƒíƒœ"
        
        # ìµœì‹  ìƒíƒœ í™•ì¸ ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸
        kubectl annotate deployment blacklist \
            last-check="$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            current-image="$current_image" \
            -n $NAMESPACE
    fi
    
    echo "ğŸ $(date '+%Y-%m-%d %H:%M:%S') - ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ì²´í¬ ì™„ë£Œ"
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: auto-image-updater
  namespace: blacklist
spec:
  # 2ë¶„ë§ˆë‹¤ ì‹¤í–‰
  schedule: "*/2 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: image-updater
          restartPolicy: OnFailure
          containers:
          - name: updater
            image: alpine/k8s:1.28.4
            env:
            - name: REGISTRY_USER
              value: "qws9411"
            - name: REGISTRY_PASS
              value: "bingogo1"
            command: ["/bin/bash"]
            args: ["/scripts/auto-update.sh"]
            volumeMounts:
            - name: update-script
              mountPath: /scripts
          volumes:
          - name: update-script
            configMap:
              name: auto-update-script
              defaultMode: 0755
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1