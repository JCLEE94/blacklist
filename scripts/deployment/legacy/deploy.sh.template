#!/bin/bash
# ArgoCD GitOps ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ - í™˜ê²½ë³„ ì„¤ì • ì§€ì›

# í™˜ê²½ ë³€ìˆ˜ ê¸°ë³¸ê°’ ì„¤ì •
ENVIRONMENT="${ENVIRONMENT:-production}"

# ì„¤ì • íŒŒì¼ ë¡œë“œ
CONFIG_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../config" && pwd)"
ENV_FILE="$CONFIG_DIR/environments/${ENVIRONMENT}.env"

if [[ -f "$ENV_FILE" ]]; then
    echo "ğŸ”§ í™˜ê²½ ì„¤ì • ë¡œë“œ: $ENVIRONMENT"
    set -a
    source "$ENV_FILE"
    set +a
else
    echo "âŒ í™˜ê²½ ì„¤ì • íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $ENV_FILE"
    exit 1
fi

echo "ğŸš€ ${PROJECT_NAME:-blacklist} GitOps ë°°í¬ ì‹œì‘..."

echo "ğŸ“ GitOps ë°°í¬ ì„¤ì •:"
echo "   - í™˜ê²½: ${ENVIRONMENT}"
echo "   - í”„ë¡œì íŠ¸: ${PROJECT_NAME:-blacklist}"
echo "   - ë„¤ì„ìŠ¤í˜ì´ìŠ¤: ${K8S_NAMESPACE:-blacklist}"
echo "   - ë ˆì§€ìŠ¤íŠ¸ë¦¬: ${REGISTRY_URL}"
echo "   - ì´ë¯¸ì§€ íƒœê·¸: ${IMAGE_TAG:-latest}"
echo "   - ArgoCD ì„œë²„: ${ARGOCD_SERVER}"
echo "   - ë„ë©”ì¸: ${BASE_DOMAIN}"

# 1. ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸ ë° ìƒì„±
echo "ğŸ“¦ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸..."
if kubectl get namespace ${K8S_NAMESPACE:-blacklist} &>/dev/null; then
    echo "   - ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ${K8S_NAMESPACE:-blacklist} ì´ë¯¸ ì¡´ì¬"
else
    echo "   - ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ${K8S_NAMESPACE:-blacklist} ìƒì„± ì¤‘..."
    envsubst < k8s/namespace.yaml.template | kubectl apply -f -
fi

# 2. Registry Secret ìƒì„± (í•„ìš”í•œ ê²½ìš°)
echo "ğŸ” Registry Secret ìƒì„±..."
if [[ -n "${REGISTRY_USERNAME:-}" && -n "${REGISTRY_PASSWORD:-}" ]]; then
    kubectl create secret docker-registry regcred \
        --docker-server="${REGISTRY_URL}" \
        --docker-username="${REGISTRY_USERNAME}" \
        --docker-password="${REGISTRY_PASSWORD}" \
        --namespace="${K8S_NAMESPACE:-blacklist}" \
        --dry-run=client -o yaml | kubectl apply -f -
    echo "   - Registry secret ìƒì„±/ì—…ë°ì´íŠ¸ ì™„ë£Œ"
else
    echo "   - Registry ì¸ì¦ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. Public registryë¡œ ê°€ì •í•©ë‹ˆë‹¤."
fi

# 3. ì• í”Œë¦¬ì¼€ì´ì…˜ Secret ìƒì„±
echo "ğŸ”‘ ì• í”Œë¦¬ì¼€ì´ì…˜ Secret ìƒì„±..."
# í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ ì²´í¬
missing_vars=()
required_vars=("REGTECH_USERNAME" "REGTECH_PASSWORD" "SECUDIUM_USERNAME" "SECUDIUM_PASSWORD" "JWT_SECRET_KEY" "API_SECRET_KEY")

for var in "${required_vars[@]}"; do
    if [[ -z "${!var:-}" ]]; then
        missing_vars+=("$var")
    fi
done

if [[ ${#missing_vars[@]} -gt 0 ]]; then
    echo "   - âš ï¸  í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤:"
    for var in "${missing_vars[@]}"; do
        echo "     - $var"
    done
    echo "   - í™˜ê²½ ì„¤ì • íŒŒì¼ì—ì„œ ì´ ê°’ë“¤ì„ ì„¤ì •í•˜ì„¸ìš”: $ENV_FILE"
else
    kubectl create secret generic ${PROJECT_NAME:-blacklist}-secret \
        --from-literal=REGTECH_USERNAME="${REGTECH_USERNAME}" \
        --from-literal=REGTECH_PASSWORD="${REGTECH_PASSWORD}" \
        --from-literal=SECUDIUM_USERNAME="${SECUDIUM_USERNAME}" \
        --from-literal=SECUDIUM_PASSWORD="${SECUDIUM_PASSWORD}" \
        --from-literal=JWT_SECRET_KEY="${JWT_SECRET_KEY}" \
        --from-literal=API_SECRET_KEY="${API_SECRET_KEY}" \
        --namespace="${K8S_NAMESPACE:-blacklist}" \
        --dry-run=client -o yaml | kubectl apply -f -
    echo "   - ì• í”Œë¦¬ì¼€ì´ì…˜ secret ìƒì„±/ì—…ë°ì´íŠ¸ ì™„ë£Œ"
fi

# 4. Kubernetes ë¦¬ì†ŒìŠ¤ ë°°í¬ (í…œí”Œë¦¿ ë Œë”ë§)
echo "â˜¸ï¸  Kubernetes ë¦¬ì†ŒìŠ¤ ë°°í¬..."

# í…œí”Œë¦¿ ë Œë”ë§ ë””ë ‰í† ë¦¬ ìƒì„±
RENDERED_DIR="k8s/rendered/${ENVIRONMENT}"
mkdir -p "$RENDERED_DIR"

# ê¸°ë³¸ ë¦¬ì†ŒìŠ¤ í…œí”Œë¦¿ ë Œë”ë§
templates=(
    "k8s/namespace.yaml.template"
    "k8s/service.yaml.template"
    "k8s/ingress.yaml.template"
)

for template in "${templates[@]}"; do
    if [[ -f "$template" ]]; then
        output_file="$RENDERED_DIR/$(basename "$template" .template)"
        echo "   - ë Œë”ë§: $template â†’ $output_file"
        envsubst < "$template" > "$output_file"
        kubectl apply -f "$output_file"
    fi
done

# 5. ArgoCD Application ë°°í¬
echo "ğŸ”„ ArgoCD Application ë°°í¬..."
if [[ -f "argocd/application.yaml.template" ]]; then
    argocd_output="argocd/rendered/${ENVIRONMENT}/application.yaml"
    mkdir -p "$(dirname "$argocd_output")"
    
    echo "   - ArgoCD ì„¤ì • ë Œë”ë§: $argocd_output"
    envsubst < "argocd/application.yaml.template" > "$argocd_output"
    
    # ArgoCD ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸
    if kubectl get namespace argocd &>/dev/null; then
        kubectl apply -f "$argocd_output"
        echo "   - ArgoCD Application ë°°í¬ ì™„ë£Œ"
    else
        echo "   - âš ï¸  ArgoCD ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ArgoCDë¥¼ ë¨¼ì € ì„¤ì¹˜í•˜ì„¸ìš”."
    fi
else
    echo "   - ArgoCD í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
fi

# 6. ë°°í¬ ìƒíƒœ í™•ì¸
echo "âœ… ë°°í¬ ìƒíƒœ í™•ì¸..."
echo "   - ë„¤ì„ìŠ¤í˜ì´ìŠ¤: ${K8S_NAMESPACE:-blacklist}"
kubectl get pods -n "${K8S_NAMESPACE:-blacklist}" 2>/dev/null || echo "   - ì•„ì§ Podê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."

# 7. ArgoCD ë™ê¸°í™” (ArgoCD CLIê°€ ìˆëŠ” ê²½ìš°)
if command -v argocd &> /dev/null; then
    echo "ğŸ”„ ArgoCD ë™ê¸°í™”..."
    argocd app sync ${PROJECT_NAME:-blacklist} --grpc-web 2>/dev/null || echo "   - ArgoCD ë™ê¸°í™” ì‹¤íŒ¨ (ìˆ˜ë™ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”)"
fi

echo ""
echo "ğŸ‰ ${PROJECT_NAME:-blacklist} GitOps ë°°í¬ ì™„ë£Œ!"
echo ""
echo "ğŸ“ ë°°í¬ ì •ë³´:"
echo "   - í™˜ê²½: ${ENVIRONMENT}"
echo "   - ë„¤ì„ìŠ¤í˜ì´ìŠ¤: ${K8S_NAMESPACE:-blacklist}"
echo "   - ë„ë©”ì¸: ${BASE_DOMAIN}"
echo "   - ArgoCD: ${ARGOCD_SERVER}"
echo ""
echo "ğŸ” ìƒíƒœ í™•ì¸ ëª…ë ¹:"
echo "   kubectl get pods -n ${K8S_NAMESPACE:-blacklist}"
echo "   kubectl get svc -n ${K8S_NAMESPACE:-blacklist}"
echo "   kubectl get ingress -n ${K8S_NAMESPACE:-blacklist}"
echo ""
if command -v argocd &> /dev/null; then
    echo "ğŸ”„ ArgoCD ê´€ë¦¬ ëª…ë ¹:"
    echo "   argocd app get ${PROJECT_NAME:-blacklist} --grpc-web"
    echo "   argocd app sync ${PROJECT_NAME:-blacklist} --grpc-web"
fi
echo ""