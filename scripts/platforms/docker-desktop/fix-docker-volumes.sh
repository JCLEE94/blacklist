#!/bin/bash
# ë„ì»¤ ë³¼ë¥¨ ë¬¸ì œ í•´ê²° ìŠ¤í¬ë¦½íŠ¸

echo "ğŸ”§ ë„ì»¤ ë³¼ë¥¨ ë¬¸ì œ í•´ê²° ê°€ì´ë“œ"
echo "================================"
echo ""

echo "# ë¬¸ì œ ìœ í˜•ë³„ í•´ê²° ë°©ë²•"
echo ""

echo "## 1. ë³¼ë¥¨ ë””ë ‰í† ë¦¬ê°€ ì—†ëŠ” ê²½ìš°"
echo "sudo mkdir -p /opt/blacklist/instance"
echo "sudo mkdir -p /opt/blacklist/data"
echo "sudo mkdir -p /opt/blacklist/logs"
echo ""

echo "## 2. ê¶Œí•œ ë¬¸ì œ"
echo "sudo chown -R 1000:1000 /opt/blacklist/"
echo "sudo chmod -R 755 /opt/blacklist/"
echo ""

echo "## 3. ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ì´ ì—†ëŠ” ê²½ìš°"
echo "# ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”"
echo "docker exec blacklist-app python setup_database.py"
echo ""

echo "## 4. ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ìœ¼ë¡œ ë³¼ë¥¨ ë‹¤ì‹œ ë§ˆìš´íŠ¸"
echo "docker restart blacklist-app"
echo ""

echo "## 5. ë³¼ë¥¨ ë§ˆìš´íŠ¸ í™•ì¸"
echo "docker exec blacklist-app df -h"
echo "docker exec blacklist-app mount | grep /app"
echo ""

echo "## 6. ë°ì´í„° ë°±ì—…"
echo "# í˜¸ìŠ¤íŠ¸ì—ì„œ ë°±ì—…"
echo "sudo tar -czf /tmp/blacklist-backup-\$(date +%Y%m%d).tar.gz /opt/blacklist/"
echo ""

echo "## 7. ì»¨í…Œì´ë„ˆ ë¡œê·¸ì—ì„œ ë³¼ë¥¨ ê´€ë ¨ ì—ëŸ¬ í™•ì¸"
echo "docker logs blacklist-app | grep -E '(Permission|No such file|volume|mount)'"
echo ""

echo "## 8. ì™„ì „ ì¬ìƒì„± (ë°ì´í„° ì†ì‹¤ ì£¼ì˜!)"
echo "# ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì œê±°"
echo "docker stop blacklist-app"
echo "docker rm blacklist-app"
echo ""
echo "# ë””ë ‰í† ë¦¬ ì¬ìƒì„±"
echo "sudo rm -rf /opt/blacklist/"
echo "sudo mkdir -p /opt/blacklist/{instance,data,logs}"
echo "sudo chown -R 1000:1000 /opt/blacklist/"
echo ""
echo "# ì»¨í…Œì´ë„ˆ ì¬ì‹¤í–‰"
echo "docker run -d \\"
echo "  --name blacklist-app \\"
echo "  --restart unless-stopped \\"
echo "  -p 2541:2541 \\"
echo "  -v /opt/blacklist/instance:/app/instance \\"
echo "  -v /opt/blacklist/data:/app/data \\"
echo "  -v /opt/blacklist/logs:/app/logs \\"
echo "  -e FLASK_ENV=production \\"
echo "  -e PORT=2541 \\"
echo "  -e REDIS_URL=redis://blacklist-redis:6379/0 \\"
echo "  -e REGTECH_USERNAME=nextrade \\"
echo "  -e REGTECH_PASSWORD='Sprtmxm1@3' \\"
echo "  -e SECUDIUM_USERNAME=nextrade \\"
echo "  -e SECUDIUM_PASSWORD='Sprtmxm1@3' \\"
echo "  --network blacklist_blacklist-network \\"
echo "  registry.jclee.me/blacklist:latest"