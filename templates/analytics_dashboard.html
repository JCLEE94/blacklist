<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>고급 분석 대시보드 - Blacklist Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css" rel="stylesheet">
    <style>
        .analytics-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            transition: transform 0.3s ease;
            margin-bottom: 20px;
        }
        .analytics-card:hover {
            transform: translateY(-5px);
        }
        .threat-widget {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
        }
        .network-widget {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 15px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
        }
        .prediction-widget {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 15px;
            padding: 20px;
            color: #333;
            margin-bottom: 20px;
        }
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .metric-card {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .metric-high { background: rgba(244, 67, 54, 0.1); border-left: 4px solid #f44336; }
        .metric-medium { background: rgba(255, 152, 0, 0.1); border-left: 4px solid #ff9800; }
        .metric-low { background: rgba(76, 175, 80, 0.1); border-left: 4px solid #4caf50; }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 15px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .recommendation-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            border-left: 3px solid #ffd700;
        }
        .country-risk-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            margin: 5px 0;
        }
        .risk-level-high { border-left: 3px solid #f44336; }
        .risk-level-medium { border-left: 3px solid #ff9800; }
        .risk-level-low { border-left: 3px solid #4caf50; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-shield-alt"></i> Blacklist Management
            </a>
            <span class="navbar-text">
                고급 분석 대시보드
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 요약 메트릭 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card analytics-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <h3 id="total-threats">0</h3>
                        <p class="mb-0">총 위협</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card analytics-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-fire fa-2x mb-2"></i>
                        <h3 id="critical-threats">0</h3>
                        <p class="mb-0">심각 위협</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card analytics-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-globe fa-2x mb-2"></i>
                        <h3 id="risk-countries">0</h3>
                        <p class="mb-0">위험 국가</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card analytics-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-network-wired fa-2x mb-2"></i>
                        <h3 id="risk-subnets">0</h3>
                        <p class="mb-0">위험 서브넷</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 위협 인텔리전스 -->
            <div class="col-lg-8">
                <div class="threat-widget position-relative" id="threat-intelligence-widget">
                    <h5><i class="fas fa-brain"></i> 위협 인텔리전스</h5>
                    <div id="threat-intelligence-content">
                        <!-- 동적 로딩 -->
                    </div>
                    <div class="loading-overlay d-none" id="threat-loading">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- 공격 패턴 차트 -->
                <div class="chart-container">
                    <h5><i class="fas fa-chart-pie"></i> 공격 패턴 분포</h5>
                    <canvas id="attack-patterns-chart" height="300"></canvas>
                </div>

                <!-- 지리적 분석 차트 -->
                <div class="chart-container">
                    <h5><i class="fas fa-map-marked-alt"></i> 지리적 위협 분포</h5>
                    <canvas id="geographic-chart" height="300"></canvas>
                </div>
            </div>

            <!-- 사이드바 분석 -->
            <div class="col-lg-4">
                <!-- 네트워크 분석 -->
                <div class="network-widget position-relative" id="network-widget">
                    <h5><i class="fas fa-sitemap"></i> 네트워크 분석</h5>
                    <div id="network-content">
                        <!-- 동적 로딩 -->
                    </div>
                    <div class="loading-overlay d-none" id="network-loading">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- 예측 인사이트 -->
                <div class="prediction-widget position-relative" id="prediction-widget">
                    <h5><i class="fas fa-crystal-ball"></i> 예측 인사이트</h5>
                    <div id="prediction-content">
                        <!-- 동적 로딩 -->
                    </div>
                    <div class="loading-overlay d-none" id="prediction-loading">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- 보안 권장사항 -->
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-lightbulb"></i> 보안 권장사항
                        </h5>
                    </div>
                    <div class="card-body" id="recommendations-content">
                        <!-- 동적 로딩 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 상관관계 분석 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="chart-container">
                    <h5><i class="fas fa-project-diagram"></i> 공격 상관관계 분석</h5>
                    <canvas id="correlation-chart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <script>
        let attackPatternsChart = null;
        let geographicChart = null;
        let correlationChart = null;

        // 대시보드 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadAnalyticsDashboard();
            setInterval(loadAnalyticsDashboard, 300000); // 5분마다 갱신
        });

        // 분석 데이터 로딩
        async function loadAnalyticsDashboard() {
            await Promise.all([
                loadThreatIntelligence(),
                loadNetworkAnalysis(),
                loadPredictiveInsights(),
                loadAttackCorrelations()
            ]);
        }

        // 위협 인텔리전스 로딩
        async function loadThreatIntelligence() {
            const loadingEl = document.getElementById('threat-loading');
            const contentEl = document.getElementById('threat-intelligence-content');
            
            loadingEl.classList.remove('d-none');
            
            try {
                const response = await fetch('/api/analytics/threat-intelligence');
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    const summary = data.summary || {};
                    
                    // 요약 메트릭 업데이트
                    document.getElementById('total-threats').textContent = 
                        (summary.total_threats || 0).toLocaleString();
                    
                    const distribution = summary.threat_distribution || {};
                    document.getElementById('critical-threats').textContent = 
                        (distribution.CRITICAL || 0).toLocaleString();
                    
                    const geoAnalysis = data.geographic_analysis || [];
                    document.getElementById('risk-countries').textContent = geoAnalysis.length;
                    
                    // 위협 분포 차트 생성
                    createAttackPatternsChart(data.attack_patterns || []);
                    createGeographicChart(geoAnalysis);
                    
                    // 위협 인텔리전스 콘텐츠
                    contentEl.innerHTML = createThreatIntelligenceContent(data);
                } else {
                    contentEl.innerHTML = '<p class="text-center">위협 인텔리전스 데이터를 불러올 수 없습니다.</p>';
                }
            } catch (error) {
                console.error('위협 인텔리전스 로딩 오류:', error);
                contentEl.innerHTML = '<p class="text-center">데이터 로딩 중 오류가 발생했습니다.</p>';
            } finally {
                loadingEl.classList.add('d-none');
            }
        }

        // 네트워크 분석 로딩
        async function loadNetworkAnalysis() {
            const loadingEl = document.getElementById('network-loading');
            const contentEl = document.getElementById('network-content');
            
            loadingEl.classList.remove('d-none');
            
            try {
                const response = await fetch('/api/analytics/network-analysis');
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    const summary = data.network_summary || {};
                    
                    document.getElementById('risk-subnets').textContent = 
                        summary.unique_subnets || 0;
                    
                    contentEl.innerHTML = createNetworkAnalysisContent(data);
                } else {
                    contentEl.innerHTML = '<p class="text-center">네트워크 분석 데이터를 불러올 수 없습니다.</p>';
                }
            } catch (error) {
                console.error('네트워크 분석 로딩 오류:', error);
                contentEl.innerHTML = '<p class="text-center">데이터 로딩 중 오류가 발생했습니다.</p>';
            } finally {
                loadingEl.classList.add('d-none');
            }
        }

        // 예측 인사이트 로딩
        async function loadPredictiveInsights() {
            const loadingEl = document.getElementById('prediction-loading');
            const contentEl = document.getElementById('prediction-content');
            
            loadingEl.classList.remove('d-none');
            
            try {
                const response = await fetch('/api/analytics/predictions');
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    contentEl.innerHTML = createPredictiveInsightsContent(data);
                    
                    // 권장사항 업데이트
                    const recommendationsEl = document.getElementById('recommendations-content');
                    const recommendations = data.recommendations || [];
                    recommendationsEl.innerHTML = recommendations.map(rec => 
                        `<div class="recommendation-item">${rec}</div>`
                    ).join('');
                } else {
                    contentEl.innerHTML = '<p class="text-center">예측 데이터를 불러올 수 없습니다.</p>';
                }
            } catch (error) {
                console.error('예측 인사이트 로딩 오류:', error);
                contentEl.innerHTML = '<p class="text-center">데이터 로딩 중 오류가 발생했습니다.</p>';
            } finally {
                loadingEl.classList.add('d-none');
            }
        }

        // 공격 상관관계 로딩
        async function loadAttackCorrelations() {
            try {
                const response = await fetch('/api/analytics/attack-correlations');
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    createCorrelationChart(data.attack_correlations || []);
                }
            } catch (error) {
                console.error('상관관계 분석 로딩 오류:', error);
            }
        }

        // 위협 인텔리전스 콘텐츠 생성
        function createThreatIntelligenceContent(data) {
            const summary = data.summary || {};
            const distribution = summary.threat_distribution || {};
            
            return `
                <div class="row">
                    <div class="col-md-6">
                        <h6>위험도 분포</h6>
                        <div class="metric-card metric-high">
                            <strong>CRITICAL: ${distribution.CRITICAL || 0}</strong>
                        </div>
                        <div class="metric-card metric-medium">
                            <strong>HIGH: ${distribution.HIGH || 0}</strong>
                        </div>
                        <div class="metric-card metric-low">
                            <strong>MEDIUM: ${distribution.MEDIUM || 0}</strong>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>위험 평가</h6>
                        <div class="text-center">
                            <div class="h4">${data.risk_assessment?.overall_risk_level || 'UNKNOWN'}</div>
                            <small>${data.risk_assessment?.recommendation || '분석 중...'}</small>
                        </div>
                    </div>
                </div>
            `;
        }

        // 네트워크 분석 콘텐츠 생성
        function createNetworkAnalysisContent(data) {
            const summary = data.network_summary || {};
            const subnets = data.subnet_analysis?.high_risk_subnets || [];
            
            return `
                <div class="mb-3">
                    <h6>네트워크 요약</h6>
                    <p><strong>총 IP:</strong> ${summary.total_ips || 0}</p>
                    <p><strong>고위험 서브넷:</strong> ${summary.unique_subnets || 0}</p>
                </div>
                <div>
                    <h6>상위 위험 서브넷</h6>
                    ${subnets.slice(0, 5).map(subnet => `
                        <div class="country-risk-item">
                            <span>${subnet.subnet}</span>
                            <span class="badge bg-danger">${subnet.threat_count}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // 예측 인사이트 콘텐츠 생성
        function createPredictiveInsightsContent(data) {
            const trend = data.trend_predictions || {};
            const riskRegions = data.risk_regions || [];
            
            return `
                <div class="mb-3">
                    <h6>트렌드 예측</h6>
                    <p><strong>방향:</strong> ${trend.trend_direction || 'unknown'}</p>
                    <p><strong>변화율:</strong> ${(trend.change_rate * 100 || 0).toFixed(1)}%</p>
                </div>
                <div>
                    <h6>위험 지역</h6>
                    ${riskRegions.slice(0, 5).map(region => `
                        <div class="country-risk-item risk-level-${region.risk_prediction?.toLowerCase() || 'low'}">
                            <span>${region.country}</span>
                            <span class="badge bg-warning">${region.threat_count}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // 공격 패턴 차트 생성
        function createAttackPatternsChart(patterns) {
            const ctx = document.getElementById('attack-patterns-chart').getContext('2d');
            
            if (attackPatternsChart) {
                attackPatternsChart.destroy();
            }
            
            const top10Patterns = patterns.slice(0, 10);
            const labels = top10Patterns.map(p => p.attack_type.substring(0, 30) + '...');
            const frequencies = top10Patterns.map(p => p.frequency);
            
            attackPatternsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: frequencies,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#36A2EB',
                            '#FFCE56', '#4BC0C0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // 지리적 차트 생성
        function createGeographicChart(geoData) {
            const ctx = document.getElementById('geographic-chart').getContext('2d');
            
            if (geographicChart) {
                geographicChart.destroy();
            }
            
            const top10Countries = geoData.slice(0, 10);
            const labels = top10Countries.map(g => g.country);
            const counts = top10Countries.map(g => g.threat_count);
            
            geographicChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '위협 수',
                        data: counts,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // 상관관계 차트 생성
        function createCorrelationChart(correlations) {
            const ctx = document.getElementById('correlation-chart').getContext('2d');
            
            if (correlationChart) {
                correlationChart.destroy();
            }
            
            const top15Correlations = correlations.slice(0, 15);
            const labels = top15Correlations.map(c => `${c.attack_type} (${c.country})`);
            const scores = top15Correlations.map(c => c.correlation_score);
            
            correlationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '상관관계 점수',
                        data: scores,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { 
                            beginAtZero: true,
                            max: 1.0
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>