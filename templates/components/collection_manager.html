<!-- 통합 수집 관리 컴포넌트 -->
<div id="collection-manager" class="collection-manager-container">
    <!-- 수집 상태 섹션 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0 fw-semibold">
                        <i class="bi bi-gear-wide-connected text-primary"></i> 수집 설정 관리
                    </h5>
                </div>
                <div class="card-body">
                    <!-- 전체 수집 제어 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <h6 class="mb-0 me-3">수집 상태:</h6>
                                <span id="unified-collection-status-badge" class="badge bg-secondary">
                                    <i class="bi bi-circle-fill"></i> 확인 중...
                                </span>
                            </div>
                            <div class="btn-group" role="group">
                                <button class="btn btn-success btn-sm" onclick="enableUnifiedCollection()">
                                    <i class="bi bi-play-fill"></i> 수집 활성화
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="disableUnifiedCollection()">
                                    <i class="bi bi-stop-fill"></i> 수집 비활성화
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-info py-2 mb-0">
                                <i class="bi bi-info-circle"></i> 
                                수집 활성화 시 기존 데이터가 삭제되고 새로운 데이터로 교체됩니다.
                            </div>
                        </div>
                    </div>

                    <!-- 소스별 수집 관리 -->
                    <div class="row g-3 mb-4">
                        <!-- REGTECH 소스 -->
                        <div class="col-md-6">
                            <div class="source-control-card border rounded p-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h6 class="mb-1">
                                            <i class="bi bi-bank text-primary"></i> REGTECH
                                        </h6>
                                        <p class="text-muted small mb-2">금융보안원 위협 정보</p>
                                    </div>
                                    <span id="unified-regtech-status" class="badge bg-secondary">대기</span>
                                </div>
                                
                                <!-- REGTECH 날짜 설정 -->
                                <div class="mb-3">
                                    <div class="row g-1">
                                        <div class="col-6">
                                            <input type="date" class="form-control form-control-sm" 
                                                   id="unified-regtech-start-date" 
                                                   title="시작일">
                                        </div>
                                        <div class="col-6">
                                            <input type="date" class="form-control form-control-sm" 
                                                   id="unified-regtech-end-date" 
                                                   title="종료일">
                                        </div>
                                    </div>
                                    <small class="text-muted">기간 미지정 시 오늘 날짜로 수집</small>
                                </div>
                                
                                <!-- REGTECH 상태 정보 -->
                                <div class="mb-3 bg-light rounded p-2">
                                    <div id="unified-regtech-status-info">
                                        <small class="text-muted d-block">
                                            <i class="bi bi-info-circle"></i> 준비 상태
                                        </small>
                                    </div>
                                </div>

                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary btn-sm flex-fill" 
                                            onclick="triggerUnifiedCollection('regtech')"
                                            id="unified-regtech-trigger-btn">
                                        <i class="bi bi-arrow-clockwise"></i> 수동 수집
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" 
                                            onclick="showRegtechSettings()" title="설정">
                                        <i class="bi bi-gear"></i>
                                    </button>
                                </div>
                                <div id="unified-regtech-last-collect" class="mt-2">
                                    <small class="text-muted">마지막 수집: -</small>
                                </div>
                            </div>
                        </div>

                        <!-- SECUDIUM 소스 -->
                        <div class="col-md-6">
                            <div class="source-control-card border rounded p-3 opacity-75">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h6 class="mb-1">
                                            <i class="bi bi-shield-x text-danger"></i> SECUDIUM
                                        </h6>
                                        <p class="text-muted small mb-2">보안 위협 정보 (현재 비활성화)</p>
                                    </div>
                                    <span class="badge bg-danger">비활성</span>
                                </div>
                                
                                <!-- SECUDIUM 날짜 설정 -->
                                <div class="mb-3">
                                    <div class="row g-1">
                                        <div class="col-6">
                                            <input type="date" class="form-control form-control-sm" 
                                                   id="unified-secudium-start-date" 
                                                   title="시작일" disabled>
                                        </div>
                                        <div class="col-6">
                                            <input type="date" class="form-control form-control-sm" 
                                                   id="unified-secudium-end-date" 
                                                   title="종료일" disabled>
                                        </div>
                                    </div>
                                    <small class="text-muted">기간 미지정 시 오늘 날짜로 수집</small>
                                </div>
                                
                                <!-- SECUDIUM 상태 정보 -->
                                <div class="mb-3 bg-light rounded p-2">
                                    <small class="text-muted d-block">
                                        <i class="bi bi-x-circle"></i> 현재 비활성화됨
                                    </small>
                                </div>

                                <button class="btn btn-secondary btn-sm w-100" disabled>
                                    <i class="bi bi-x-circle"></i> 수집 불가
                                </button>
                                <div class="mt-2">
                                    <small class="text-muted">마지막 수집: -</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 수집 로그 -->
                    <div class="row">
                        <div class="col-12">
                            <h6 class="mb-2">
                                <i class="bi bi-terminal"></i> 수집 로그
                            </h6>
                            <div id="unified-collection-logs" class="bg-dark text-light p-3 rounded" 
                                 style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.85rem;">
                                <div class="text-muted">로그를 불러오는 중...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 통합 수집 관리자 JavaScript
class UnifiedCollectionManager {
    constructor() {
        this.initializeStatus();
        this.setupEventListeners();
        this.startStatusPolling();
    }

    async initializeStatus() {
        await this.updateCollectionStatus();
        await this.updateSourceStatuses();
        await this.loadCollectionLogs();
    }

    setupEventListeners() {
        // 날짜 입력 기본값 설정
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('unified-regtech-start-date').value = today;
        document.getElementById('unified-regtech-end-date').value = today;
    }

    startStatusPolling() {
        // 5초마다 상태 업데이트
        setInterval(() => {
            this.updateCollectionStatus();
            this.updateSourceStatuses();
            this.loadCollectionLogs();
        }, 5000);
    }

    async updateCollectionStatus() {
        try {
            const response = await fetch('/api/collection/status');
            const data = await response.json();
            
            const statusBadge = document.getElementById('unified-collection-status-badge');
            if (data.enabled) {
                statusBadge.className = 'badge bg-success';
                statusBadge.innerHTML = '<i class="bi bi-check-circle"></i> 활성화됨';
            } else {
                statusBadge.className = 'badge bg-danger';
                statusBadge.innerHTML = '<i class="bi bi-x-circle"></i> 비활성화됨';
            }
        } catch (error) {
            console.error('Status update failed:', error);
        }
    }

    async updateSourceStatuses() {
        try {
            const response = await fetch('/api/collection/status');
            const data = await response.json();
            
            // REGTECH 상태 업데이트
            const regtechStatus = document.getElementById('unified-regtech-status');
            const regtechBtn = document.getElementById('unified-regtech-trigger-btn');
            
            if (data.enabled) {
                regtechStatus.className = 'badge bg-success';
                regtechStatus.textContent = '준비됨';
                regtechBtn.disabled = false;
            } else {
                regtechStatus.className = 'badge bg-secondary';
                regtechStatus.textContent = '대기';
                regtechBtn.disabled = true;
            }
        } catch (error) {
            console.error('Source status update failed:', error);
        }
    }

    async loadCollectionLogs() {
        try {
            const response = await fetch('/api/collection/logs');
            const data = await response.json();
            
            const logsContainer = document.getElementById('unified-collection-logs');
            if (data.logs && data.logs.length > 0) {
                logsContainer.innerHTML = data.logs.slice(-20).map(log => 
                    `<div class="log-entry">[${log.timestamp}] ${log.message}</div>`
                ).join('');
            } else {
                logsContainer.innerHTML = '<div class="text-muted">수집 로그가 없습니다.</div>';
            }
            
            // 자동 스크롤
            logsContainer.scrollTop = logsContainer.scrollHeight;
        } catch (error) {
            console.error('Log loading failed:', error);
        }
    }
}

// 전역 함수들
async function enableUnifiedCollection() {
    if (!confirm('수집을 활성화하면 기존 데이터가 삭제됩니다. 계속하시겠습니까?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/collection/enable', { method: 'POST' });
        const data = await response.json();
        
        if (response.ok) {
            showNotification('수집이 활성화되었습니다.', 'success');
            window.unifiedCollectionManager.updateCollectionStatus();
        } else {
            showNotification('수집 활성화 실패: ' + data.error, 'error');
        }
    } catch (error) {
        showNotification('수집 활성화 중 오류가 발생했습니다.', 'error');
    }
}

async function disableUnifiedCollection() {
    try {
        const response = await fetch('/api/collection/disable', { method: 'POST' });
        const data = await response.json();
        
        if (response.ok) {
            showNotification('수집이 비활성화되었습니다.', 'success');
            window.unifiedCollectionManager.updateCollectionStatus();
        } else {
            showNotification('수집 비활성화 실패: ' + data.error, 'error');
        }
    } catch (error) {
        showNotification('수집 비활성화 중 오류가 발생했습니다.', 'error');
    }
}

async function triggerUnifiedCollection(source) {
    const startDateId = `unified-${source}-start-date`;
    const endDateId = `unified-${source}-end-date`;
    const buttonId = `unified-${source}-trigger-btn`;
    
    const startDate = document.getElementById(startDateId).value;
    const endDate = document.getElementById(endDateId).value;
    const button = document.getElementById(buttonId);
    
    // 버튼 상태 변경
    button.disabled = true;
    button.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> 수집 중...';
    
    try {
        const response = await fetch(`/api/collection/${source}/trigger`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                start_date: startDate || undefined,
                end_date: endDate || undefined
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification(`${source.toUpperCase()} 수집이 시작되었습니다.`, 'success');
            window.unifiedCollectionManager.loadCollectionLogs();
        } else {
            showNotification(`${source.toUpperCase()} 수집 실패: ${data.error}`, 'error');
        }
    } catch (error) {
        showNotification(`${source.toUpperCase()} 수집 중 오류가 발생했습니다.`, 'error');
    } finally {
        // 버튼 상태 복원
        setTimeout(() => {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 수동 수집';
        }, 3000);
    }
}

function showRegtechSettings() {
    window.location.href = '/settings';
}

function showNotification(message, type = 'info') {
    // 기존 알림 제거
    const existingAlert = document.querySelector('.notification-alert');
    if (existingAlert) {
        existingAlert.remove();
    }
    
    // 새 알림 생성
    const alertClass = type === 'success' ? 'alert-success' : 
                     type === 'error' ? 'alert-danger' : 'alert-info';
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert ${alertClass} notification-alert position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    alertDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <span>${message}</span>
            <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    document.body.appendChild(alertDiv);
    
    // 5초 후 자동 제거
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.remove();
        }
    }, 5000);
}

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    window.unifiedCollectionManager = new UnifiedCollectionManager();
});
</script>

<style>
.collection-manager-container {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.source-control-card {
    transition: all 0.3s ease;
    position: relative;
}

.source-control-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.log-entry {
    margin-bottom: 2px;
    font-size: 0.8rem;
    line-height: 1.2;
}

.spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.modern-card {
    background: white;
    border-radius: 1rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    border: 1px solid rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
}

.modern-card:hover {
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
}
</style>