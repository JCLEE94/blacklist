{% extends "base.html" %}

{% block title %}위협 인텔리전스 대시보드{% endblock %}

{% block extra_css %}
<style>
    /* Premium Dark Theme - Consistent with Navigation */
    body {
        background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
        min-height: 100vh;
    }
    
    .dashboard-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 100px 20px 40px;
    }
    
    /* Glass Morphism Cards */
    .card {
        background: rgba(26, 31, 58, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(74, 95, 138, 0.3);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        margin-bottom: 24px;
        transition: all 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.4);
        border-color: rgba(74, 95, 138, 0.5);
    }
    
    .card-header {
        background: linear-gradient(135deg, rgba(74, 95, 138, 0.2), rgba(45, 53, 97, 0.2));
        border-bottom: 1px solid rgba(74, 95, 138, 0.2);
        padding: 1.25rem 1.5rem;
        border-radius: 16px 16px 0 0;
        color: #e0e0e0;
    }
    
    .card-body {
        padding: 1.5rem;
        color: #b0b0b0;
    }
    
    /* Stat Cards with Gradient Borders */
    .stat-card {
        background: linear-gradient(135deg, rgba(26, 31, 58, 0.95), rgba(37, 43, 72, 0.95));
        border: 2px solid transparent;
        background-clip: padding-box;
        position: relative;
        overflow: hidden;
        border-radius: 20px;
        transition: all 0.3s ease;
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
        border-radius: 20px;
        opacity: 0.1;
        transition: opacity 0.3s ease;
    }
    
    .stat-card:hover::before {
        opacity: 0.2;
    }
    
    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 40px rgba(102, 126, 234, 0.2);
    }
    
    .stat-card .card-body {
        position: relative;
        z-index: 1;
    }
    
    /* Typography */
    h2, h3, h5, h6 {
        color: #e0e0e0;
    }
    
    .text-gradient {
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 700;
    }
    
    /* Premium Table Design */
    .table {
        margin-bottom: 0;
        color: #b0b0b0;
    }
    
    .table thead th {
        background: rgba(74, 95, 138, 0.1);
        border-bottom: 2px solid rgba(74, 95, 138, 0.3);
        color: #a0a0a0;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 1px;
        padding: 1rem;
    }
    
    .table tbody tr {
        border-bottom: 1px solid rgba(74, 95, 138, 0.1);
        transition: all 0.2s ease;
    }
    
    .table tbody tr:hover {
        background: rgba(74, 95, 138, 0.1);
        transform: translateX(4px);
    }
    
    .table td {
        padding: 1rem;
        vertical-align: middle;
        border: none;
    }
    
    /* Premium Buttons */
    .btn-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        font-weight: 600;
        padding: 0.5rem 1.25rem;
        border-radius: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-gradient:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        color: white;
    }
    
    .btn-glass {
        background: rgba(74, 95, 138, 0.2);
        border: 1px solid rgba(74, 95, 138, 0.3);
        color: #a0a0a0;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        border-radius: 8px;
        padding: 0.4rem 0.9rem;
    }
    
    .btn-glass:hover {
        background: rgba(74, 95, 138, 0.3);
        border-color: rgba(74, 95, 138, 0.5);
        color: #e0e0e0;
        transform: translateY(-1px);
    }
    
    /* Status Indicators */
    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
        animation: pulse 2s infinite;
    }
    
    .status-dot.active {
        background: #4ade80;
        box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
    }
    
    .status-dot.inactive {
        background: #6b7280;
    }
    
    .status-dot.warning {
        background: #fbbf24;
        box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.6; }
        100% { opacity: 1; }
    }
    
    /* Badge Styles */
    .badge {
        padding: 0.35rem 0.75rem;
        font-weight: 600;
        border-radius: 6px;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
    }
    
    .badge.bg-danger {
        background: linear-gradient(135deg, #ef4444, #dc2626) !important;
    }
    
    .badge.bg-warning {
        background: linear-gradient(135deg, #f59e0b, #d97706) !important;
    }
    
    .badge.bg-success {
        background: linear-gradient(135deg, #10b981, #059669) !important;
    }
    
    .badge.bg-info {
        background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
    }
    
    /* Icon Styling */
    .icon-box {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
    }
    
    .icon-box.danger {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
        color: #ef4444;
    }
    
    .icon-box.primary {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
        color: #667eea;
    }
    
    .icon-box.success {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
        color: #10b981;
    }
    
    .icon-box.warning {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.2));
        color: #f59e0b;
    }
    
    /* Section Headers */
    .section-header {
        border-bottom: 2px solid rgba(74, 95, 138, 0.2);
        padding-bottom: 0.75rem;
        margin-bottom: 1.5rem;
    }
    
    .section-header h5 {
        margin: 0;
        font-weight: 600;
        font-size: 1.1rem;
        letter-spacing: 0.5px;
    }
    
    /* Source Cards */
    .source-card {
        background: rgba(37, 43, 72, 0.5);
        border: 1px solid rgba(74, 95, 138, 0.2);
        border-radius: 12px;
        padding: 1.25rem;
        transition: all 0.3s ease;
    }
    
    .source-card:hover {
        background: rgba(74, 95, 138, 0.2);
        border-color: rgba(74, 95, 138, 0.4);
        transform: translateY(-2px);
    }
    
    /* Loading Animation */
    .loading-shimmer {
        background: linear-gradient(90deg, rgba(74, 95, 138, 0.1) 25%, rgba(74, 95, 138, 0.2) 50%, rgba(74, 95, 138, 0.1) 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    
    /* Code Style */
    code {
        background: rgba(74, 95, 138, 0.2);
        color: #93c5fd;
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
        font-family: 'Fira Code', monospace;
        font-size: 0.875rem;
    }
    
    /* Scrollbar Styling */
    ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
    }
    
    ::-webkit-scrollbar-track {
        background: rgba(26, 31, 58, 0.5);
        border-radius: 5px;
    }
    
    ::-webkit-scrollbar-thumb {
        background: rgba(74, 95, 138, 0.5);
        border-radius: 5px;
        transition: background 0.3s ease;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: rgba(102, 126, 234, 0.5);
    }
    
    /* 통합 제어 패널 스타일링 */
    #unified-control-panel {
        animation: slideIn 0.3s ease-out;
        border-left: 4px solid rgba(102, 126, 234, 0.5);
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* 버튼 그룹 스타일 개선 */
    .btn-group .btn {
        border-color: rgba(74, 95, 138, 0.3);
        transition: all 0.2s ease;
    }
    
    .btn-group .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    /* 폼 컨트롤 다크 테마 */
    .form-control, .form-select {
        background-color: rgba(26, 31, 58, 0.8);
        border: 1px solid rgba(74, 95, 138, 0.3);
        color: #e0e0e0;
    }
    
    .form-control:focus, .form-select:focus {
        background-color: rgba(26, 31, 58, 0.9);
        border-color: rgba(102, 126, 234, 0.5);
        color: #e0e0e0;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .form-label {
        color: #b0b0b0;
        font-weight: 500;
    }
    
    /* 알림 스타일 */
    .alert {
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .dashboard-container {
            padding: 90px 15px 30px;
        }
        
        .stat-card {
            margin-bottom: 1rem;
        }
        
        .icon-box {
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
        }
        
        .btn-group {
            flex-direction: column;
        }
        
        .btn-group .btn {
            border-radius: 0.375rem !important;
            margin-bottom: 0.25rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Premium Dashboard Header with Unified Control -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <h2 class="fw-bold mb-0">
            <span class="text-gradient">통합 관리</span>
            <span style="color: #e0e0e0;">대시보드</span>
        </h2>
        <div class="d-flex align-items-center gap-3">
            <div style="color: #a0a0a0;">
                <i class="bi bi-clock"></i> <span id="current-time"></span>
            </div>
            <!-- 통합 제어 버튼 그룹 -->
            <div class="btn-group" role="group">
                <button class="btn btn-sm btn-outline-light" onclick="toggleUnifiedControl()" title="통합 제어 패널">
                    <i class="bi bi-gear"></i> 제어
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="triggerCollection()" title="수동 수집 실행">
                    <i class="bi bi-download"></i> 수집
                </button>
            </div>
        </div>
    </div>
    
    <!-- 통합 제어 패널 (토글) -->
    <div id="unified-control-panel" class="card mb-4" style="display: none;">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-sliders"></i> 통합 제어 패널</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <!-- 수집 기간 설정 -->
                <div class="col-md-4">
                    <label class="form-label">시작일</label>
                    <input type="date" class="form-control" id="collection-start-date">
                </div>
                <div class="col-md-4">
                    <label class="form-label">종료일</label>
                    <input type="date" class="form-control" id="collection-end-date">
                </div>
                <div class="col-md-4">
                    <label class="form-label">소스 선택</label>
                    <select class="form-select" id="collection-source">
                        <option value="all">전체 소스</option>
                        <option value="regtech">REGTECH만</option>
                        <option value="secudium">SECUDIUM만</option>
                    </select>
                </div>
                <!-- 제어 버튼들 -->
                <div class="col-12">
                    <div class="btn-group w-100" role="group">
                        <button class="btn btn-success" onclick="startCollection()">
                            <i class="bi bi-play"></i> 수집 시작
                        </button>
                        <button class="btn btn-warning" onclick="stopCollection()">
                            <i class="bi bi-pause"></i> 수집 중지
                        </button>
                        <button class="btn btn-info" onclick="resetCollection()">
                            <i class="bi bi-arrow-clockwise"></i> 초기화
                        </button>
                        <button class="btn btn-danger" onclick="clearData()">
                            <i class="bi bi-trash"></i> 데이터 삭제
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Premium Statistics Cards -->
    <div class="row g-4 mb-5">
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-2" style="font-size: 0.875rem;">차단된 IP</p>
                            <h2 class="fw-bold mb-0 text-gradient" id="active-blacklist">0</h2>
                            <small style="color: #6b7280;">활성 블랙리스트</small>
                        </div>
                        <div class="icon-box danger">
                            <i class="bi bi-shield-fill"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-2" style="font-size: 0.875rem;">수집 상태</p>
                            <h2 class="fw-bold mb-0" id="collection-status">-</h2>
                            <small style="color: #6b7280;">실시간 모니터링</small>
                        </div>
                        <div class="icon-box primary">
                            <i class="bi bi-arrow-repeat"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-2" style="font-size: 0.875rem;">오늘 추가</p>
                            <h2 class="fw-bold mb-0 text-gradient" id="today-added">0</h2>
                            <small style="color: #6b7280;">24시간 이내</small>
                        </div>
                        <div class="icon-box success">
                            <i class="bi bi-plus-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-2" style="font-size: 0.875rem;">시스템 상태</p>
                            <h2 class="fw-bold mb-0" style="color: #4ade80;">정상</h2>
                            <small style="color: #6b7280;">모든 서비스 작동중</small>
                        </div>
                        <div class="icon-box success">
                            <i class="bi bi-check-circle-fill"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="row g-4 mb-5">
        <div class="col-lg-8">
            <!-- Collection Management -->
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="section-header w-100 mb-0 border-0 pb-0">
                            <h5><i class="bi bi-gear-fill"></i> 수집 시스템 제어</h5>
                        </div>
                        <div id="collection-toggle">
                            <!-- Dynamically rendered -->
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="source-card">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-2" style="color: #e0e0e0;">
                                            <span class="status-dot active"></span>REGTECH
                                        </h6>
                                        <small style="color: #6b7280;" id="regtech-status">대기중</small>
                                    </div>
                                    <button class="btn btn-sm btn-gradient" onclick="triggerRegtech()">
                                        <i class="bi bi-arrow-clockwise"></i> 수집
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="source-card">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-2" style="color: #e0e0e0;">
                                            <span class="status-dot warning"></span>SECUDIUM
                                        </h6>
                                        <small style="color: #6b7280;" id="secudium-status">대기중</small>
                                    </div>
                                    <button class="btn btn-sm btn-gradient" onclick="triggerSecudium()">
                                        <i class="bi bi-arrow-clockwise"></i> 수집
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <div class="section-header w-100 mb-0 border-0 pb-0">
                        <h5><i class="bi bi-lightning-fill"></i> 빠른 실행</h5>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-3">
                        <button class="btn btn-glass" onclick="window.location.href='/settings'">
                            <i class="bi bi-key-fill me-2"></i>인증 설정
                        </button>
                        <button class="btn btn-glass" onclick="exportData()">
                            <i class="bi bi-download me-2"></i>데이터 내보내기
                        </button>
                        <button class="btn btn-glass" onclick="clearCache()">
                            <i class="bi bi-trash-fill me-2"></i>캐시 정리
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Detections -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <div class="section-header w-100 mb-0 border-0 pb-0">
                    <h5><i class="bi bi-activity"></i> 실시간 위협 탐지</h5>
                </div>
                <button class="btn btn-sm btn-glass" onclick="loadRecentDetections()">
                    <i class="bi bi-arrow-clockwise"></i> 새로고침
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table mb-0">
                    <thead>
                        <tr>
                            <th>IP 주소</th>
                            <th>위협 수준</th>
                            <th>소스</th>
                            <th>탐지 시간</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody id="live-data-table">
                        <tr>
                            <td colspan="5" class="text-center py-4">
                                <div class="loading-shimmer" style="height: 40px; border-radius: 8px;"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- 테스트 결과 모달 (제거) -->
<!--
<div class="modal fade" id="testResultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient text-white">
                <h5 class="modal-title">테스트 결과</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="test-results">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3">테스트 실행중...</p>
                </div>
            </div>
        </div>
    </div>
-->
</div>

<script>
// 현재 시간 표시
function updateCurrentTime() {
    const now = new Date();
    const timeStr = now.toLocaleString('ko-KR', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit' 
    });
    document.getElementById('current-time').textContent = timeStr;
}

// 수집 상태 토글 렌더링
function renderCollectionToggle(enabled) {
    const toggleDiv = document.getElementById('collection-toggle');
    if (enabled) {
        toggleDiv.innerHTML = `
            <button class="btn btn-gradient btn-sm" onclick="disableCollection()">
                <i class="bi bi-toggle-on"></i> 활성
            </button>
        `;
        document.getElementById('collection-status').innerHTML = '<span style="color: #4ade80;">활성</span>';
    } else {
        toggleDiv.innerHTML = `
            <button class="btn btn-glass btn-sm" onclick="enableCollection()">
                <i class="bi bi-toggle-off"></i> 비활성
            </button>
        `;
        document.getElementById('collection-status').innerHTML = '<span style="color: #6b7280;">비활성</span>';
    }
}

// API 함수들

// 시스템 상태 로드
async function loadSystemStatus() {
    try {
        const response = await fetch('/health');
        if (response.ok) {
            const data = await response.json();
            if (data.status === 'healthy') {
                document.getElementById('system-status').innerHTML = 
                    '<span class="status-indicator status-healthy"></span>정상';
            } else {
                document.getElementById('system-status').innerHTML = 
                    '<span class="status-indicator status-warning"></span>점검';
            }
        }
    } catch (error) {
        document.getElementById('system-status').innerHTML = 
            '<span class="status-indicator status-error"></span>오류';
    }
}

// 통계 데이터 로드
async function loadStatistics() {
    try {
        // 활성 블랙리스트 개수
        const blacklistResponse = await fetch('/api/blacklist/active');
        if (blacklistResponse.ok) {
            const text = await blacklistResponse.text();
            const ips = text.trim().split('\n').filter(ip => ip && ip.match(/^\d+\.\d+\.\d+\.\d+$/));
            document.getElementById('active-blacklist').textContent = ips.length.toLocaleString();
        }
        
        // 수집 상태
        const collectionResponse = await fetch('/api/collection/status');
        if (collectionResponse.ok) {
            const data = await collectionResponse.json();
            renderCollectionToggle(data.enabled);
            
            // 소스 상태 업데이트
            if (data.sources) {
                if (data.sources.regtech) {
                    document.getElementById('regtech-status').textContent = 
                        data.sources.regtech.last_collection || '대기중';
                }
                if (data.sources.secudium) {
                    document.getElementById('secudium-status').textContent = 
                        data.sources.secudium.last_collection || '대기중';
                }
            }
        }
        
        // 오늘 추가된 IP 수
        const today = new Date().toISOString().split('T')[0];
        // TODO: API에서 오늘 추가된 IP 수 가져오기
        document.getElementById('today-added').textContent = '0';
            
    } catch (error) {
        console.error('Failed to load statistics:', error);
    }
}

// 실시간 데이터 표시
function displayLiveData(data) {
    const tableBody = document.getElementById('live-data-table');
    
    if (!data || data.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center py-4" style="color: #6b7280;">
                    <i class="bi bi-inbox" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                    <br>탐지된 위협이 없습니다
                </td>
            </tr>
        `;
        return;
    }
    
    tableBody.innerHTML = data.map(item => {
        const threatClass = item.threat_level.toLowerCase();
        const threatBadge = threatClass === 'critical' ? 'danger' :
                          threatClass === 'high' ? 'warning' :
                          threatClass === 'medium' ? 'info' : 'success';
        
        const timeAgo = getTimeAgo(item.detected_at);
        
        return `
            <tr>
                <td><code>${item.ip_address}</code></td>
                <td>
                    <span class="badge bg-${threatBadge}">
                        ${item.threat_level}
                    </span>
                </td>
                <td style="color: #a0a0a0;">${item.source}</td>
                <td style="color: #6b7280;"><small>${timeAgo}</small></td>
                <td>
                    <button class="btn btn-sm btn-glass" onclick="blockIP('${item.ip_address}')">
                        <i class="bi bi-shield-x"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// 시간 계산 함수
function getTimeAgo(date) {
    const now = new Date();
    const past = new Date(date);
    const diffMs = now - past;
    const diffMins = Math.floor(diffMs / 60000);
    
    if (diffMins < 1) return '방금 전';
    if (diffMins < 60) return `${diffMins}분 전`;
    
    const diffHours = Math.floor(diffMins / 60);
    if (diffHours < 24) return `${diffHours}시간 전`;
    
    const diffDays = Math.floor(diffHours / 24);
    return `${diffDays}일 전`;
}

// 실제 데이터 로드
async function loadRecentDetections() {
    try {
        // V2 API 먼저 시도
        let response = await fetch('/api/v2/blacklist/enhanced');
        if (response.ok) {
            const data = await response.json();
            if (data && data.ips && data.ips.length > 0) {
                const recentData = data.ips.slice(0, 10).map(item => ({
                    ip_address: item.ip,
                    threat_level: item.category ? item.category.toUpperCase() : 'HIGH',
                    source: item.source || 'SYSTEM',
                    detected_at: new Date(item.last_seen || item.created_at || Date.now())
                }));
                displayLiveData(recentData);
                return;
            }
        }
        
        // Fallback: 활성 IP 목록
        response = await fetch('/api/blacklist/active');
        if (response.ok) {
            const text = await response.text();
            const ips = text.trim().split('\n')
                .filter(ip => ip && ip.match(/^\d+\.\d+\.\d+\.\d+$/))
                .slice(0, 10);
            
            if (ips.length > 0) {
                const recentData = ips.map((ip, index) => ({
                    ip_address: ip,
                    threat_level: 'HIGH',
                    source: 'BLACKLIST',
                    detected_at: new Date(Date.now() - (index * 3600000))
                }));
                displayLiveData(recentData);
            } else {
                displayLiveData([]);
            }
        }
    } catch (error) {
        console.error('Failed to load recent detections:', error);
        displayLiveData([]);
    }
}

// 수집 제어 함수
async function enableCollection() {
    try {
        const response = await fetch('/api/collection/enable', { method: 'POST' });
        if (response.ok) {
            loadStatistics();
        }
    } catch (error) {
        console.error('수집 활성화 실패:', error);
    }
}

async function disableCollection() {
    try {
        const response = await fetch('/api/collection/disable', { method: 'POST' });
        if (response.ok) {
            loadStatistics();
        }
    } catch (error) {
        console.error('수집 비활성화 실패:', error);
    }
}

// 수동 수집 트리거
async function triggerRegtech() {
    try {
        const response = await fetch('/api/collection/regtech/trigger', { method: 'POST' });
        if (response.ok) {
            document.getElementById('regtech-status').textContent = '수집중...';
            setTimeout(loadStatistics, 3000);
        }
    } catch (error) {
        console.error('REGTECH 수집 실패:', error);
    }
}

async function triggerSecudium() {
    try {
        const response = await fetch('/api/collection/secudium/trigger', { method: 'POST' });
        if (response.ok) {
            document.getElementById('secudium-status').textContent = '수집중...';
            setTimeout(loadStatistics, 3000);
        }
    } catch (error) {
        console.error('SECUDIUM 수집 실패:', error);
    }
}

// 빠른 작업 함수
function exportData() {
    window.location.href = '/api/blacklist/export';
}

async function clearCache() {
    if (confirm('캐시를 정리하시겠습니까?')) {
        try {
            const response = await fetch('/api/cache/clear', { method: 'POST' });
            if (response.ok) {
                location.reload();
            }
        } catch (error) {
            console.error('Cache clear failed:', error);
        }
    }
}

// IP 차단 함수
function blockIP(ip) {
    // 간단한 확인 없이 바로 처리
    console.log('Blocking IP:', ip);
}

// 통합 제어 함수들
function toggleUnifiedControl() {
    const panel = document.getElementById('unified-control-panel');
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        // 기본 날짜 설정 (오늘)
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('collection-start-date').value = today;
        document.getElementById('collection-end-date').value = today;
    } else {
        panel.style.display = 'none';
    }
}

async function triggerCollection() {
    const source = document.getElementById('collection-source')?.value || 'all';
    const startDate = document.getElementById('collection-start-date')?.value;
    const endDate = document.getElementById('collection-end-date')?.value;
    
    // 빠른 수집 실행 (기간 미지정시 오늘)
    try {
        const response = await fetch('/api/collection/regtech/trigger', { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                start_date: startDate, 
                end_date: endDate,
                source: source 
            })
        });
        
        if (response.ok) {
            showNotification('수집이 시작되었습니다', 'success');
            setTimeout(loadStatistics, 3000);
        }
    } catch (error) {
        console.error('Collection trigger failed:', error);
        showNotification('수집 실행에 실패했습니다', 'error');
    }
}

async function startCollection() {
    try {
        const response = await fetch('/api/collection/enable', { method: 'POST' });
        if (response.ok) {
            showNotification('수집이 활성화되었습니다', 'success');
            loadStatistics();
        }
    } catch (error) {
        console.error('Collection start failed:', error);
        showNotification('수집 시작에 실패했습니다', 'error');
    }
}

async function stopCollection() {
    try {
        const response = await fetch('/api/collection/disable', { method: 'POST' });
        if (response.ok) {
            showNotification('수집이 중지되었습니다', 'warning');
            loadStatistics();
        }
    } catch (error) {
        console.error('Collection stop failed:', error);
        showNotification('수집 중지에 실패했습니다', 'error');
    }
}

async function resetCollection() {
    if (confirm('수집 시스템을 초기화하시겠습니까?')) {
        try {
            await fetch('/api/collection/disable', { method: 'POST' });
            await fetch('/api/collection/enable', { method: 'POST' });
            showNotification('수집 시스템이 초기화되었습니다', 'info');
            loadStatistics();
        } catch (error) {
            console.error('Collection reset failed:', error);
            showNotification('초기화에 실패했습니다', 'error');
        }
    }
}

async function clearData() {
    if (confirm('모든 수집 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
        try {
            const response = await fetch('/api/admin/clear-data', { method: 'POST' });
            if (response.ok) {
                showNotification('데이터가 삭제되었습니다', 'warning');
                loadStatistics();
            }
        } catch (error) {
            console.error('Data clear failed:', error);
            showNotification('데이터 삭제에 실패했습니다', 'error');
        }
    }
}

// 알림 표시 함수
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 100px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // 3초 후 자동 제거
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// 페이지 로드시 실행
document.addEventListener('DOMContentLoaded', function() {
    // 현재 시간 업데이트
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);
    
    // 데이터 로드
    loadSystemStatus();
    loadStatistics();
    loadRecentDetections();
    
    // 30초마다 자동 새로고침
    setInterval(() => {
        loadStatistics();
        loadRecentDetections();
    }, 30000);
});
</script>
{% endblock %}