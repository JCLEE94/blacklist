{% extends "base.html" %}

{% block title %}위협 인텔리전스 대시보드{% endblock %}

{% block extra_css %}
<style>
    /* 깨끗하고 일관된 UI 스타일 */
    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding-top: 80px;
    }
    
    .card {
        border: 1px solid #e3e6f0;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        margin-bottom: 20px;
    }
    
    .card-header {
        background: white;
        border-bottom: 1px solid #e3e6f0;
        padding: 1rem 1.25rem;
        font-weight: 600;
    }
    
    .table {
        margin-bottom: 0;
    }
    
    .table thead th {
        background: #f8f9fc;
        border-bottom: 2px solid #e3e6f0;
        color: #5a5c69;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.875rem;
    }
    
    .badge {
        padding: 0.35rem 0.65rem;
        font-weight: 600;
    }
    
    .btn-outline-primary {
        border-color: #4e73df;
        color: #4e73df;
    }
    
    .btn-outline-primary:hover {
        background-color: #4e73df;
        border-color: #4e73df;
    }
    
    .bg-light {
        background-color: #f8f9fc!important;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- 심플한 대시보드 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">
            <i class="bi bi-shield-check"></i> 블랙리스트 대시보드
        </h2>
        <div class="text-muted">
            <i class="bi bi-clock"></i> <span id="current-time"></span>
        </div>
    </div>

    <!-- 간결한 통계 카드 -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">차단 IP</h6>
                            <h3 class="fw-bold mb-0" id="active-blacklist">0</h3>
                        </div>
                        <i class="bi bi-shield-fill text-danger fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">수집 상태</h6>
                            <h3 class="fw-bold mb-0" id="collection-status">-</h3>
                        </div>
                        <i class="bi bi-arrow-repeat text-primary fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">오늘 추가</h6>
                            <h3 class="fw-bold mb-0" id="today-added">0</h3>
                        </div>
                        <i class="bi bi-plus-circle text-success fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">시스템</h6>
                            <h3 class="fw-bold mb-0 text-success">정상</h3>
                        </div>
                        <i class="bi bi-check-circle-fill text-success fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 통합 관리 패널 -->
    <div class="row g-3 mb-4">
        <div class="col-md-8">
            <!-- 수집 관리 -->
            <div class="card">
                <div class="card-header bg-white border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-gear"></i> 수집 관리</h5>
                        <div id="collection-toggle">
                            <!-- 동적으로 렌더링 -->
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                                <div>
                                    <h6 class="mb-1">REGTECH</h6>
                                    <small class="text-muted" id="regtech-status">대기중</small>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="triggerRegtech()">
                                    <i class="bi bi-arrow-clockwise"></i> 수동 수집
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                                <div>
                                    <h6 class="mb-1">SECUDIUM</h6>
                                    <small class="text-muted" id="secudium-status">대기중</small>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="triggerSecudium()">
                                    <i class="bi bi-arrow-clockwise"></i> 수동 수집
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- 빠른 작업 -->
            <div class="card">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="bi bi-lightning"></i> 빠른 작업</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="window.location.href='/settings'">
                            <i class="bi bi-key"></i> 인증 설정
                        </button>
                        <button class="btn btn-outline-success" onclick="exportData()">
                            <i class="bi bi-download"></i> 데이터 내보내기
                        </button>
                        <button class="btn btn-outline-danger" onclick="clearCache()">
                            <i class="bi bi-trash"></i> 캐시 정리
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 최근 탐지 목록 -->
    <div class="card">
        <div class="card-header bg-white border-bottom">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-list-ul"></i> 최근 탐지</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadRecentDetections()">
                    <i class="bi bi-arrow-clockwise"></i> 새로고침
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>IP 주소</th>
                            <th>위협 수준</th>
                            <th>소스</th>
                            <th>탐지 시간</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody id="live-data-table">
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">
                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                실시간 데이터 로딩중...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- 테스트 결과 모달 (제거) -->
<!--
<div class="modal fade" id="testResultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient text-white">
                <h5 class="modal-title">테스트 결과</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="test-results">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3">테스트 실행중...</p>
                </div>
            </div>
        </div>
    </div>
-->
</div>

<script>
// 현재 시간 표시
function updateCurrentTime() {
    const now = new Date();
    const timeStr = now.toLocaleString('ko-KR', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit' 
    });
    document.getElementById('current-time').textContent = timeStr;
}

// 수집 상태 토글 렌더링
function renderCollectionToggle(enabled) {
    const toggleDiv = document.getElementById('collection-toggle');
    if (enabled) {
        toggleDiv.innerHTML = `
            <button class="btn btn-success btn-sm" onclick="disableCollection()">
                <i class="bi bi-toggle-on"></i> 활성화
            </button>
        `;
        document.getElementById('collection-status').textContent = '활성';
        document.getElementById('collection-status').className = 'fw-bold mb-0 text-success';
    } else {
        toggleDiv.innerHTML = `
            <button class="btn btn-outline-secondary btn-sm" onclick="enableCollection()">
                <i class="bi bi-toggle-off"></i> 비활성화
            </button>
        `;
        document.getElementById('collection-status').textContent = '비활성';
        document.getElementById('collection-status').className = 'fw-bold mb-0 text-muted';
    }
}

// API 함수들

// 시스템 상태 로드
async function loadSystemStatus() {
    try {
        const response = await fetch('/health');
        if (response.ok) {
            const data = await response.json();
            if (data.status === 'healthy') {
                document.getElementById('system-status').innerHTML = 
                    '<span class="status-indicator status-healthy"></span>정상';
            } else {
                document.getElementById('system-status').innerHTML = 
                    '<span class="status-indicator status-warning"></span>점검';
            }
        }
    } catch (error) {
        document.getElementById('system-status').innerHTML = 
            '<span class="status-indicator status-error"></span>오류';
    }
}

// 통계 데이터 로드
async function loadStatistics() {
    try {
        // 활성 블랙리스트 개수
        const blacklistResponse = await fetch('/api/blacklist/active');
        if (blacklistResponse.ok) {
            const text = await blacklistResponse.text();
            const ips = text.trim().split('\n').filter(ip => ip && ip.match(/^\d+\.\d+\.\d+\.\d+$/));
            document.getElementById('active-blacklist').textContent = ips.length.toLocaleString();
        }
        
        // 수집 상태
        const collectionResponse = await fetch('/api/collection/status');
        if (collectionResponse.ok) {
            const data = await collectionResponse.json();
            renderCollectionToggle(data.enabled);
            
            // 소스 상태 업데이트
            if (data.sources) {
                if (data.sources.regtech) {
                    document.getElementById('regtech-status').textContent = 
                        data.sources.regtech.last_collection || '대기중';
                }
                if (data.sources.secudium) {
                    document.getElementById('secudium-status').textContent = 
                        data.sources.secudium.last_collection || '대기중';
                }
            }
        }
        
        // 오늘 추가된 IP 수
        const today = new Date().toISOString().split('T')[0];
        // TODO: API에서 오늘 추가된 IP 수 가져오기
        document.getElementById('today-added').textContent = '0';
            
    } catch (error) {
        console.error('Failed to load statistics:', error);
    }
}

// 실시간 데이터 표시
function displayLiveData(data) {
    const tableBody = document.getElementById('live-data-table');
    
    if (!data || data.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center py-4 text-muted">
                    <i class="bi bi-inbox"></i> 탐지된 위협이 없습니다
                </td>
            </tr>
        `;
        return;
    }
    
    tableBody.innerHTML = data.map(item => {
        const threatClass = item.threat_level.toLowerCase();
        const threatBadge = threatClass === 'critical' ? 'danger' :
                          threatClass === 'high' ? 'warning' :
                          threatClass === 'medium' ? 'info' : 'success';
        
        const timeAgo = getTimeAgo(item.detected_at);
        
        return `
            <tr>
                <td><code>${item.ip_address}</code></td>
                <td>
                    <span class="badge bg-${threatBadge}">
                        ${item.threat_level}
                    </span>
                </td>
                <td>${item.source}</td>
                <td>${timeAgo}</td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="blockIP('${item.ip_address}')">
                        <i class="bi bi-shield-x"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// 시간 계산 함수
function getTimeAgo(date) {
    const now = new Date();
    const past = new Date(date);
    const diffMs = now - past;
    const diffMins = Math.floor(diffMs / 60000);
    
    if (diffMins < 1) return '방금 전';
    if (diffMins < 60) return `${diffMins}분 전`;
    
    const diffHours = Math.floor(diffMins / 60);
    if (diffHours < 24) return `${diffHours}시간 전`;
    
    const diffDays = Math.floor(diffHours / 24);
    return `${diffDays}일 전`;
}

// 실제 데이터 로드
async function loadRecentDetections() {
    try {
        // V2 API 먼저 시도
        let response = await fetch('/api/v2/blacklist/enhanced');
        if (response.ok) {
            const data = await response.json();
            if (data && data.ips && data.ips.length > 0) {
                const recentData = data.ips.slice(0, 10).map(item => ({
                    ip_address: item.ip,
                    threat_level: item.category ? item.category.toUpperCase() : 'HIGH',
                    source: item.source || 'SYSTEM',
                    detected_at: new Date(item.last_seen || item.created_at || Date.now())
                }));
                displayLiveData(recentData);
                return;
            }
        }
        
        // Fallback: 활성 IP 목록
        response = await fetch('/api/blacklist/active');
        if (response.ok) {
            const text = await response.text();
            const ips = text.trim().split('\n')
                .filter(ip => ip && ip.match(/^\d+\.\d+\.\d+\.\d+$/))
                .slice(0, 10);
            
            if (ips.length > 0) {
                const recentData = ips.map((ip, index) => ({
                    ip_address: ip,
                    threat_level: 'HIGH',
                    source: 'BLACKLIST',
                    detected_at: new Date(Date.now() - (index * 3600000))
                }));
                displayLiveData(recentData);
            } else {
                displayLiveData([]);
            }
        }
    } catch (error) {
        console.error('Failed to load recent detections:', error);
        displayLiveData([]);
    }
}

// 수집 제어 함수
async function enableCollection() {
    try {
        const response = await fetch('/api/collection/enable', { method: 'POST' });
        if (response.ok) {
            loadStatistics();
        }
    } catch (error) {
        console.error('수집 활성화 실패:', error);
    }
}

async function disableCollection() {
    try {
        const response = await fetch('/api/collection/disable', { method: 'POST' });
        if (response.ok) {
            loadStatistics();
        }
    } catch (error) {
        console.error('수집 비활성화 실패:', error);
    }
}

// 수동 수집 트리거
async function triggerRegtech() {
    try {
        const response = await fetch('/api/collection/regtech/trigger', { method: 'POST' });
        if (response.ok) {
            document.getElementById('regtech-status').textContent = '수집중...';
            setTimeout(loadStatistics, 3000);
        }
    } catch (error) {
        console.error('REGTECH 수집 실패:', error);
    }
}

async function triggerSecudium() {
    try {
        const response = await fetch('/api/collection/secudium/trigger', { method: 'POST' });
        if (response.ok) {
            document.getElementById('secudium-status').textContent = '수집중...';
            setTimeout(loadStatistics, 3000);
        }
    } catch (error) {
        console.error('SECUDIUM 수집 실패:', error);
    }
}

// 빠른 작업 함수
function exportData() {
    window.location.href = '/api/blacklist/export';
}

async function clearCache() {
    if (confirm('캐시를 정리하시겠습니까?')) {
        try {
            const response = await fetch('/api/cache/clear', { method: 'POST' });
            if (response.ok) {
                location.reload();
            }
        } catch (error) {
            console.error('Cache clear failed:', error);
        }
    }
}

// IP 차단 함수
function blockIP(ip) {
    // 간단한 확인 없이 바로 처리
    console.log('Blocking IP:', ip);
}

// 페이지 로드시 실행
document.addEventListener('DOMContentLoaded', function() {
    // 현재 시간 업데이트
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);
    
    // 데이터 로드
    loadSystemStatus();
    loadStatistics();
    loadRecentDetections();
    
    // 30초마다 자동 새로고침
    setInterval(() => {
        loadStatistics();
        loadRecentDetections();
    }, 30000);
});
</script>
{% endblock %}