{% extends "base.html" %}

{% block title %}Blacklist System{% endblock %}

{% block extra_css %}
<style>
    body { background: #f8f9fa; }
    
    .main-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    
    .stats-row {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-number {
        font-size: 1.5rem;
        font-weight: bold;
        display: block;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .action-bar {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border-left: 4px solid #007bff;
    }
    
    .btn-group .btn {
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .ip-table {
        background: white;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .table th {
        background: #f8f9fa;
        border-top: none;
        font-size: 0.9rem;
        padding: 0.7rem;
    }
    
    .table td {
        padding: 0.7rem;
        font-size: 0.85rem;
        vertical-align: middle;
    }
    
    .ip-code {
        font-family: 'Courier New', monospace;
        background: #f8f9fa;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        font-size: 0.8rem;
    }
    
    .badge {
        font-size: 0.7rem;
    }
    
    .search-box {
        max-width: 400px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 간단한 통계 -->
    <div class="stats-row">
        <div class="row">
            <div class="col-md-3 stat-item">
                <span class="stat-number" id="totalCount">{{ total_ips|default('48,132') }}</span>
                <span class="stat-label">Total IPs</span>
            </div>
            <div class="col-md-3 stat-item">
                <span class="stat-number text-light">{{ regtech_count|default('20,595') }}</span>
                <span class="stat-label">REGTECH</span>
            </div>
            <div class="col-md-3 stat-item">
                <span class="stat-number text-warning">{{ secudium_count|default('27,537') }}</span>
                <span class="stat-label">SECUDIUM</span>
            </div>
            <div class="col-md-3 stat-item">
                <span class="stat-number">{{ "{:.1f}h".format(uptime_hours|default(2.1)) }}</span>
                <span class="stat-label">Uptime</span>
            </div>
        </div>
    </div>

    <!-- 액션 바 -->
    <div class="action-bar">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="input-group search-box">
                    <input type="text" class="form-control" id="searchIP" placeholder="Search IP..." 
                           onkeypress="if(event.key==='Enter') searchIP()">
                    <button class="btn btn-primary" onclick="searchIP()">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <div class="btn-group" role="group">
                    <a href="/api/blacklist/active" target="_blank" class="btn btn-success btn-sm">
                        <i class="bi bi-download"></i> Download
                    </a>
                    <a href="/api/export/json" target="_blank" class="btn btn-info btn-sm">
                        <i class="bi bi-file-code"></i> JSON
                    </a>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshData()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- IP 목록 -->
    <div class="main-card">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 150px;">IP Address</th>
                        <th style="width: 100px;">Source</th>
                        <th style="width: 100px;">Type</th>
                        <th style="width: 80px;">Country</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="ipTableBody">
                    <tr>
                        <td colspan="5" class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-primary"></div>
                            <span class="ms-2">Loading IPs...</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- 페이지네이션 -->
        <div class="d-flex justify-content-between align-items-center p-3 border-top">
            <div>
                <small class="text-muted">Showing <span id="showingCount">0</span> of <span id="totalEntries">0</span> entries</small>
            </div>
            <div>
                <button class="btn btn-sm btn-outline-secondary" id="prevBtn" onclick="previousPage()" disabled>
                    <i class="bi bi-chevron-left"></i> Previous
                </button>
                <span class="mx-2">Page <span id="currentPage">1</span></span>
                <button class="btn btn-sm btn-outline-secondary" id="nextBtn" onclick="nextPage()">
                    Next <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 검색 결과 모달 -->
<div class="modal fade" id="searchModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Search Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="searchResult">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let totalPages = 1;
const pageSize = 50;

document.addEventListener('DOMContentLoaded', function() {
    loadIPList(1);
    
    // Auto refresh every 60 seconds
    setInterval(() => loadIPList(currentPage), 60000);
});

function loadIPList(page = 1) {
    fetch(`/api/ips/recent?page=${page}&limit=${pageSize}`)
        .then(response => response.json())
        .then(data => {
            const ips = data.data || [];
            const total = data.total || 0;
            
            updateTable(ips);
            updatePagination(page, total);
            updateStats(total);
        })
        .catch(error => {
            console.error('Failed to load IPs:', error);
            document.getElementById('ipTableBody').innerHTML = `
                <tr><td colspan="5" class="text-center text-danger py-4">
                    <i class="bi bi-exclamation-triangle"></i> Failed to load data
                </td></tr>
            `;
        });
}

function updateTable(ips) {
    const tbody = document.getElementById('ipTableBody');
    
    if (ips.length === 0) {
        tbody.innerHTML = `
            <tr><td colspan="5" class="text-center text-muted py-4">
                <i class="bi bi-info-circle"></i> No IPs found
            </td></tr>
        `;
        return;
    }
    
    tbody.innerHTML = ips.map(ip => `
        <tr>
            <td><code class="ip-code">${ip.ip}</code></td>
            <td><span class="badge bg-info">${ip.source || 'N/A'}</span></td>
            <td><span class="badge bg-secondary">${ip.attack_type || 'Unknown'}</span></td>
            <td>${ip.country || 'N/A'}</td>
            <td><small>${formatTime(ip.created_at)}</small></td>
        </tr>
    `).join('');
}

function updatePagination(page, total) {
    currentPage = page;
    totalPages = Math.ceil(total / pageSize);
    
    document.getElementById('currentPage').textContent = page;
    document.getElementById('showingCount').textContent = Math.min(page * pageSize, total);
    document.getElementById('totalEntries').textContent = total.toLocaleString();
    
    document.getElementById('prevBtn').disabled = page <= 1;
    document.getElementById('nextBtn').disabled = page >= totalPages;
}

function updateStats(total) {
    document.getElementById('totalCount').textContent = total.toLocaleString();
}

function previousPage() {
    if (currentPage > 1) {
        loadIPList(currentPage - 1);
    }
}

function nextPage() {
    if (currentPage < totalPages) {
        loadIPList(currentPage + 1);
    }
}

function searchIP() {
    const ip = document.getElementById('searchIP').value.trim();
    if (!ip) return;
    
    fetch('/api/search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ip: ip })
    })
    .then(response => response.json())
    .then(data => {
        const modal = new bootstrap.Modal(document.getElementById('searchModal'));
        const resultDiv = document.getElementById('searchResult');
        
        if (data.found) {
            resultDiv.innerHTML = `
                <div class="alert alert-warning">
                    <h6><i class="bi bi-shield-exclamation"></i> IP Found in Blacklist</h6>
                    <hr>
                    <strong>IP:</strong> <code>${data.ip}</code><br>
                    <strong>Source:</strong> <span class="badge bg-info">${data.source}</span><br>
                    <strong>Type:</strong> <span class="badge bg-secondary">${data.attack_type || 'Unknown'}</span><br>
                    <strong>Country:</strong> ${data.country || 'N/A'}<br>
                    <strong>Detected:</strong> ${data.detection_date || 'N/A'}
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="bi bi-shield-check"></i> IP Not Found</h6>
                    <p>IP <code>${data.ip}</code> is not in the blacklist.</p>
                </div>
            `;
        }
        
        modal.show();
    })
    .catch(error => {
        console.error('Search failed:', error);
        alert('Search failed. Please try again.');
    });
}

function refreshData() {
    const btn = event.target;
    const original = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Refreshing...';
    btn.disabled = true;
    
    loadIPList(currentPage);
    
    setTimeout(() => {
        btn.innerHTML = original;
        btn.disabled = false;
    }, 2000);
}

function formatTime(timeStr) {
    if (!timeStr) return 'N/A';
    try {
        const date = new Date(timeStr);
        return date.toLocaleString('ko-KR', {
            timeZone: 'Asia/Seoul',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch {
        return timeStr;
    }
}

// CSS for spin animation
const style = document.createElement('style');
style.textContent = `
    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
`;
document.head.appendChild(style);
</script>
{% endblock %}