{% extends "base.html" %}

{% block title %}Raw Data - Nextrade Black List Deny System{% endblock %}

{% block extra_css %}
<style>
    /* Match dashboard modern style */
    .raw-data-container {
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .raw-data-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 1rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    .raw-data-header h1 {
        margin: 0;
        font-size: 2rem;
        font-weight: 600;
    }
    
    .raw-data-header p {
        margin: 0.5rem 0 0 0;
        opacity: 0.9;
    }
    
    /* Stats Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-mini-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        text-align: center;
        border: 1px solid rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .stat-mini-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
    }
    
    .stat-mini-card.primary::before { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-mini-card.success::before { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .stat-mini-card.info::before { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
    .stat-mini-card.warning::before { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    
    .stat-mini-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .stat-label {
        font-size: 0.875rem;
        color: #6b7280;
        margin: 0;
    }
    
    /* Filter Section */
    .filter-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .filter-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #1f2937;
    }
    
    .filter-row {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: end;
    }
    
    .filter-group {
        flex: 1;
        min-width: 200px;
    }
    
    .filter-group label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #4b5563;
        margin-bottom: 0.5rem;
    }
    
    .filter-group .form-control,
    .filter-group .form-select {
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
        font-size: 0.875rem;
        padding: 0.625rem 0.875rem;
    }
    
    .filter-group .form-control:focus,
    .filter-group .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .filter-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-filter {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.625rem 1.25rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-filter:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        color: white;
    }
    
    .btn-reset {
        background: white;
        color: #6b7280;
        border: 1px solid #e5e7eb;
        padding: 0.625rem 1.25rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-reset:hover {
        background: #f9fafb;
        color: #4b5563;
    }
    
    /* Data Table */
    .data-card {
        background: white;
        border-radius: 1rem;
        padding: 0;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        border: 1px solid rgba(0, 0, 0, 0.05);
        overflow: hidden;
    }
    
    .data-card-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: between;
        align-items: center;
    }
    
    .data-card-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
    }
    
    .export-buttons {
        display: flex;
        gap: 0.5rem;
        margin-left: auto;
    }
    
    .btn-export {
        background: white;
        color: #6b7280;
        border: 1px solid #e5e7eb;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.813rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-export:hover {
        background: #f9fafb;
        color: #4b5563;
        border-color: #d1d5db;
    }
    
    .table-container {
        overflow-x: auto;
    }
    
    .data-table {
        width: 100%;
        font-size: 0.875rem;
    }
    
    .data-table thead {
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .data-table th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: #4b5563;
        white-space: nowrap;
    }
    
    .data-table td {
        padding: 1rem;
        border-bottom: 1px solid #f3f4f6;
        color: #1f2937;
    }
    
    .data-table tbody tr:hover {
        background: #f9fafb;
    }
    
    .ip-badge {
        font-family: 'Courier New', monospace;
        background: #f3f4f6;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.813rem;
        font-weight: 500;
    }
    
    .source-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
    }
    
    .source-badge.regtech {
        background: rgba(102, 126, 234, 0.1);
        color: #5046e5;
    }
    
    .source-badge.secudium {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }
    
    .source-badge.public {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
    }
    
    .attack-type-badge {
        background: #f3f4f6;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        color: #6b7280;
    }
    
    .country-code {
        background: #e5e7eb;
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .date-text {
        font-size: 0.813rem;
        color: #6b7280;
    }
    
    /* Pagination */
    .pagination-container {
        padding: 1.5rem;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: between;
        align-items: center;
        background: #f9fafb;
    }
    
    .pagination-info {
        font-size: 0.875rem;
        color: #6b7280;
    }
    
    .pagination-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    .btn-page {
        background: white;
        color: #4b5563;
        border: 1px solid #e5e7eb;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.813rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-page:hover:not(:disabled) {
        background: #f9fafb;
        border-color: #d1d5db;
    }
    
    .btn-page:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .page-info {
        font-size: 0.875rem;
        color: #4b5563;
        margin: 0 1rem;
    }
    
    /* Loading State */
    .loading-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #6b7280;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 2rem;
        height: 2rem;
        border: 3px solid #f3f4f6;
        border-radius: 50%;
        border-top-color: #667eea;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #9ca3af;
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    /* Action Buttons */
    .action-btn {
        background: transparent;
        border: 1px solid #e5e7eb;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.813rem;
        color: #6b7280;
        transition: all 0.3s ease;
    }
    
    .action-btn:hover {
        background: #f9fafb;
        color: #4b5563;
        border-color: #d1d5db;
    }
</style>
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
{% endblock %}

{% block content %}
<div class="raw-data-container">
    <!-- Header -->
    <div class="raw-data-header">
        <h1><i class="bi bi-database"></i> 전체 블랙리스트 데이터</h1>
        <p>블랙리스트 IP 데이터베이스 전체 정보</p>
    </div>
    
    <!-- Statistics -->
    <div class="stats-grid">
        <div class="stat-mini-card primary">
            <h3 class="stat-value" id="totalCount">0</h3>
            <p class="stat-label">전체 IP</p>
        </div>
        <div class="stat-mini-card success">
            <h3 class="stat-value" id="regtechCount">0</h3>
            <p class="stat-label">REGTECH</p>
        </div>
        <div class="stat-mini-card info">
            <h3 class="stat-value" id="secudiumCount">0</h3>
            <p class="stat-label">SECUDIUM</p>
        </div>
        <div class="stat-mini-card warning">
            <h3 class="stat-value" id="todayCount">0</h3>
            <p class="stat-label">오늘 추가</p>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="filter-card">
        <h3 class="filter-title"><i class="bi bi-funnel"></i> 데이터 필터</h3>
        <div class="filter-row">
            <div class="filter-group">
                <label>소스</label>
                <select class="form-select" id="sourceFilter">
                    <option value="">전체 소스</option>
                    <option value="REGTECH">REGTECH</option>
                    <option value="SECUDIUM">SECUDIUM</option>
                    <option value="PUBLIC">PUBLIC</option>
                </select>
            </div>
            <div class="filter-group">
                <label>국가</label>
                <select class="form-select" id="countryFilter">
                    <option value="">전체 국가</option>
                </select>
            </div>
            <div class="filter-group">
                <label>공격 유형</label>
                <input type="text" class="form-control" id="attackTypeFilter" placeholder="공격 유형 검색...">
            </div>
            <div class="filter-group">
                <label>기간</label>
                <select class="form-select" id="dateFilter">
                    <option value="">전체 기간</option>
                    <option value="today">오늘</option>
                    <option value="week">최근 7일</option>
                    <option value="month">최근 30일</option>
                </select>
            </div>
            <div class="filter-group">
                <label>IP 검색</label>
                <input type="text" class="form-control" id="ipSearch" placeholder="IP 주소 검색...">
            </div>
            <div class="filter-actions">
                <button class="btn btn-filter" onclick="applyFilters()">
                    <i class="bi bi-search"></i> 적용
                </button>
                <button class="btn btn-reset" onclick="resetFilters()">
                    <i class="bi bi-arrow-clockwise"></i> 초기화
                </button>
            </div>
        </div>
    </div>
    
    <!-- Data Table -->
    <div class="data-card">
        <div class="data-card-header">
            <h3 class="data-card-title"><i class="bi bi-table"></i> 블랙리스트 목록</h3>
            <div class="export-buttons">
                <button class="btn btn-export" onclick="exportData('csv')">
                    <i class="bi bi-file-earmark-csv"></i> CSV
                </button>
                <button class="btn btn-export" onclick="exportData('json')">
                    <i class="bi bi-file-earmark-code"></i> JSON
                </button>
                <button class="btn btn-export" onclick="refreshData()">
                    <i class="bi bi-arrow-clockwise"></i> 새로고침
                </button>
            </div>
        </div>
        
        <div class="table-container">
            <table class="data-table" id="rawDataTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>IP 주소</th>
                        <th>소스</th>
                        <th>국가</th>
                        <th>공격 유형</th>
                        <th>등록일</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="7" class="loading-state">
                            <div class="loading-spinner"></div>
                            <p>데이터 로딩 중...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="pagination-container">
            <div class="pagination-info">
                총 <span id="totalFiltered">0</span>개 중 <span id="showingStart">0</span> ~ <span id="showingEnd">0</span> 표시
            </div>
            <div class="pagination-controls">
                <button class="btn btn-page" id="prevBtn" onclick="previousPage()" disabled>
                    <i class="bi bi-chevron-left"></i> 이전
                </button>
                <span class="page-info">
                    <span id="currentPage">1</span> / <span id="totalPages">1</span> 페이지
                </span>
                <button class="btn btn-page" id="nextBtn" onclick="nextPage()">
                    다음 <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script>
let allData = [];
let filteredData = [];
let currentPage = 1;
let pageSize = 50;
let totalPages = 1;

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    loadData();
});

async function loadData() {
    showLoading();
    try {
        const response = await fetch('/api/raw-data');
        const result = await response.json();
        
        if (result.success) {
            allData = result.data;
            filteredData = allData;
            updateStatistics(allData);
            populateCountryFilter(allData);
            renderPage(1);
        } else {
            showError('데이터 로드 실패');
        }
    } catch (error) {
        console.error('Error loading data:', error);
        showError('네트워크 오류가 발생했습니다');
    }
}

function updateStatistics(data) {
    const today = new Date().toISOString().split('T')[0];
    const sourceCounts = { REGTECH: 0, SECUDIUM: 0 };
    let todayCount = 0;
    
    data.forEach(item => {
        if (item.source in sourceCounts) {
            sourceCounts[item.source]++;
        }
        if (item.created_at && item.created_at.startsWith(today)) {
            todayCount++;
        }
    });
    
    document.getElementById('totalCount').textContent = data.length.toLocaleString();
    document.getElementById('regtechCount').textContent = sourceCounts.REGTECH.toLocaleString();
    document.getElementById('secudiumCount').textContent = sourceCounts.SECUDIUM.toLocaleString();
    document.getElementById('todayCount').textContent = todayCount.toLocaleString();
}

function populateCountryFilter(data) {
    const countries = new Set();
    data.forEach(item => {
        if (item.country && item.country !== 'None') {
            countries.add(item.country);
        }
    });
    
    const select = document.getElementById('countryFilter');
    select.innerHTML = '<option value="">All Countries</option>';
    
    Array.from(countries).sort().forEach(country => {
        const option = document.createElement('option');
        option.value = country;
        option.textContent = country;
        select.appendChild(option);
    });
}

function applyFilters() {
    const source = document.getElementById('sourceFilter').value;
    const country = document.getElementById('countryFilter').value;
    const attackType = document.getElementById('attackTypeFilter').value.toLowerCase();
    const dateRange = document.getElementById('dateFilter').value;
    const ipSearch = document.getElementById('ipSearch').value;
    
    filteredData = allData.filter(item => {
        // Source filter
        if (source && item.source !== source) return false;
        
        // Country filter
        if (country && item.country !== country) return false;
        
        // Attack type filter
        if (attackType && (!item.attack_type || !item.attack_type.toLowerCase().includes(attackType))) return false;
        
        // IP search
        if (ipSearch && !item.ip.includes(ipSearch)) return false;
        
        // Date filter
        if (dateRange && item.created_at) {
            const itemDate = new Date(item.created_at);
            const now = new Date();
            
            switch(dateRange) {
                case 'today':
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    if (itemDate < today) return false;
                    break;
                case 'week':
                    const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                    if (itemDate < weekAgo) return false;
                    break;
                case 'month':
                    const monthAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
                    if (itemDate < monthAgo) return false;
                    break;
            }
        }
        
        return true;
    });
    
    updateStatistics(filteredData);
    renderPage(1);
}

function renderPage(page) {
    currentPage = page;
    totalPages = Math.ceil(filteredData.length / pageSize);
    
    const start = (page - 1) * pageSize;
    const end = Math.min(start + pageSize, filteredData.length);
    const pageData = filteredData.slice(start, end);
    
    const tbody = document.getElementById('tableBody');
    
    if (pageData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <p>데이터가 없습니다</p>
                </td>
            </tr>
        `;
    } else {
        tbody.innerHTML = pageData.map(item => `
            <tr>
                <td>${item.id}</td>
                <td><span class="ip-badge">${item.ip}</span></td>
                <td><span class="source-badge ${item.source.toLowerCase()}">${item.source}</span></td>
                <td>${item.country ? `<span class="country-code">${item.country}</span>` : '-'}</td>
                <td>${item.attack_type ? `<span class="attack-type-badge">${item.attack_type}</span>` : '-'}</td>
                <td class="date-text">${formatDate(item.created_at)}</td>
                <td>
                    <button class="action-btn" onclick="viewDetails(${item.id})" title="상세 보기">
                        <i class="bi bi-eye"></i>
                    </button>
                    <button class="action-btn" onclick="searchIP('${item.ip}')" title="IP 검색">
                        <i class="bi bi-search"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    // Update pagination
    document.getElementById('showingStart').textContent = filteredData.length > 0 ? start + 1 : 0;
    document.getElementById('showingEnd').textContent = end;
    document.getElementById('totalFiltered').textContent = filteredData.length.toLocaleString();
    document.getElementById('currentPage').textContent = currentPage;
    document.getElementById('totalPages').textContent = totalPages;
    
    document.getElementById('prevBtn').disabled = currentPage <= 1;
    document.getElementById('nextBtn').disabled = currentPage >= totalPages;
}

function showLoading() {
    document.getElementById('tableBody').innerHTML = `
        <tr>
            <td colspan="7" class="loading-state">
                <div class="loading-spinner"></div>
                <p>Loading data...</p>
            </td>
        </tr>
    `;
}

function showError(message) {
    document.getElementById('tableBody').innerHTML = `
        <tr>
            <td colspan="7" class="empty-state">
                <i class="bi bi-exclamation-circle"></i>
                <p>${message}</p>
            </td>
        </tr>
    `;
}

function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function resetFilters() {
    document.getElementById('sourceFilter').value = '';
    document.getElementById('countryFilter').value = '';
    document.getElementById('attackTypeFilter').value = '';
    document.getElementById('dateFilter').value = '';
    document.getElementById('ipSearch').value = '';
    applyFilters();
}

function previousPage() {
    if (currentPage > 1) {
        renderPage(currentPage - 1);
    }
}

function nextPage() {
    if (currentPage < totalPages) {
        renderPage(currentPage + 1);
    }
}

async function exportData(format) {
    const dataToExport = filteredData.length > 0 ? filteredData : allData;
    
    if (format === 'csv') {
        const headers = ['ID', 'IP', 'Source', 'Country', 'Attack Type', 'Created At'];
        const csvContent = [
            headers.join(','),
            ...dataToExport.map(item => [
                item.id,
                item.ip,
                item.source || '',
                item.country || '',
                `"${(item.attack_type || '').replace(/"/g, '""')}"`,
                item.created_at || ''
            ].join(','))
        ].join('\n');
        
        downloadFile(csvContent, 'blacklist_data.csv', 'text/csv');
    } else if (format === 'json') {
        const jsonContent = JSON.stringify(dataToExport, null, 2);
        downloadFile(jsonContent, 'blacklist_data.json', 'application/json');
    }
}

function downloadFile(content, filename, contentType) {
    const blob = new Blob([content], { type: contentType });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}

function refreshData() {
    loadData();
}

function viewDetails(id) {
    const item = allData.find(d => d.id === id);
    if (item) {
        // You can create a modal here instead of alert
        alert(`IP 상세 정보:\n\nID: ${item.id}\nIP: ${item.ip}\n소스: ${item.source}\n국가: ${item.country || '없음'}\n공격 유형: ${item.attack_type || '없음'}\n등록일: ${item.created_at}`);
    }
}

function searchIP(ip) {
    window.open(`/api/search/${ip}`, '_blank');
}

// Enter key support
document.getElementById('ipSearch').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        applyFilters();
    }
});

document.getElementById('attackTypeFilter').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        applyFilters();
    }
});
</script>
{% endblock %}