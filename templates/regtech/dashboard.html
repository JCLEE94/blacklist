{% extends "base.html" %}

{% block title %}REGTECH 데이터 분석 대시보드{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .stats-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .stats-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .chart-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .risk-badge {
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .risk-high { background-color: #dc3545; color: white; }
    .risk-medium { background-color: #ffc107; color: black; }
    .risk-low { background-color: #28a745; color: white; }
    
    .progress {
        height: 20px;
        margin-bottom: 10px;
    }
    
    .nav-tabs .nav-link.active {
        background-color: #667eea;
        border-color: #667eea;
        color: white;
    }
    
    .table-responsive {
        max-height: 400px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 헤더 -->
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="bi bi-shield-shaded text-primary"></i> REGTECH 데이터 분석</h1>
            <p class="lead">금융보안원 REGTECH 포털에서 수집된 위협 IP 데이터 분석</p>
        </div>
    </div>
    
    <!-- 통계 카드 -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="stats-card">
                <div class="stats-number" id="total-ips">{{ stats.total_ips | default(0) | comma }}</div>
                <div class="stats-label">총 위협 IP</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="stats-number" id="high-risk-count">-</div>
                <div class="stats-label">고위험 IP</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="stats-number" id="new-today">-</div>
                <div class="stats-label">오늘 신규</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <div class="stats-number" id="regions-count">-</div>
                <div class="stats-label">탐지 지역</div>
            </div>
        </div>
    </div>
    
    <!-- 메인 대시보드 -->
    <div class="row">
        <!-- 좌측: 차트 영역 -->
        <div class="col-lg-8">
            <!-- 탭 메뉴 -->
            <ul class="nav nav-tabs" id="chartTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="trends-tab" data-bs-toggle="tab" data-bs-target="#trends" type="button">
                        <i class="bi bi-graph-up"></i> 일자별 추이
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="regions-tab" data-bs-toggle="tab" data-bs-target="#regions" type="button">
                        <i class="bi bi-globe"></i> 지역별 분포
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="ranges-tab" data-bs-toggle="tab" data-bs-target="#ranges" type="button">
                        <i class="bi bi-diagram-3"></i> IP 대역 분석
                    </button>
                </li>
            </ul>
            
            <!-- 탭 콘텐츠 -->
            <div class="tab-content" id="chartTabContent">
                <!-- 일자별 추이 -->
                <div class="tab-pane fade show active" id="trends" role="tabpanel">
                    <div class="chart-container">
                        <h5>일자별 IP 탐지 추이 (최근 30일)</h5>
                        <canvas id="trendsChart" height="100"></canvas>
                    </div>
                </div>
                
                <!-- 지역별 분포 -->
                <div class="tab-pane fade" id="regions" role="tabpanel">
                    <div class="chart-container">
                        <h5>지역별 위협 IP 분포</h5>
                        <canvas id="regionsChart" height="100"></canvas>
                    </div>
                </div>
                
                <!-- IP 대역 분석 -->
                <div class="tab-pane fade" id="ranges" role="tabpanel">
                    <div class="chart-container">
                        <h5>상위 IP 대역 (Top 20)</h5>
                        <canvas id="rangesChart" height="100"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 우측: 위험도 및 최근 활동 -->
        <div class="col-lg-4">
            <!-- 위험도 분포 -->
            <div class="chart-container">
                <h5><i class="bi bi-exclamation-triangle text-warning"></i> 위험도 분포</h5>
                <div id="risk-distribution">
                    <div class="mb-2">
                        <small>고위험 (High)</small>
                        <div class="progress">
                            <div class="progress-bar bg-danger" id="high-risk-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="mb-2">
                        <small>중위험 (Medium)</small>
                        <div class="progress">
                            <div class="progress-bar bg-warning" id="medium-risk-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="mb-2">
                        <small>저위험 (Low)</small>
                        <div class="progress">
                            <div class="progress-bar bg-success" id="low-risk-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 빠른 검색 -->
            <div class="chart-container">
                <h5><i class="bi bi-search text-info"></i> 빠른 IP 검색</h5>
                <form id="quick-search-form">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="search-input" placeholder="IP 주소 입력...">
                        <button class="btn btn-primary" type="submit">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </form>
                
                <div class="table-responsive" id="search-results" style="display: none;">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>IP</th>
                                <th>위험도</th>
                                <th>지역</th>
                            </tr>
                        </thead>
                        <tbody id="search-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 최근 업데이트 정보 -->
            <div class="chart-container">
                <h5><i class="bi bi-clock text-success"></i> 최근 업데이트</h5>
                <p class="mb-1"><strong>마지막 수집:</strong></p>
                <p class="text-muted" id="last-updated">{{ stats.last_updated | default('정보 없음') }}</p>
                
                <p class="mb-1"><strong>수집 방법:</strong></p>
                <p class="text-muted">대량 수집 (검증된 파라미터)</p>
                
                <hr>
                <div class="d-grid gap-2">
                    <a href="/regtech/analysis" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-bar-chart"></i> 상세 분석
                    </a>
                    <a href="/regtech/search" class="btn btn-outline-info btn-sm">
                        <i class="bi bi-search"></i> 고급 검색
                    </a>
                    <a href="/regtech/trends" class="btn btn-outline-success btn-sm">
                        <i class="bi bi-graph-up-arrow"></i> 추이 분석
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// 전역 변수
let trendsChart, regionsChart, rangesChart;

// 페이지 로드 시 실행
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadTrends();
    loadRegions();
    loadTopRanges();
    
    // 검색 폼 이벤트
    document.getElementById('quick-search-form').addEventListener('submit', function(e) {
        e.preventDefault();
        quickSearch();
    });
    
    // 탭 변경 이벤트
    document.getElementById('regions-tab').addEventListener('shown.bs.tab', function() {
        if (!regionsChart) loadRegions();
    });
    
    document.getElementById('ranges-tab').addEventListener('shown.bs.tab', function() {
        if (!rangesChart) loadTopRanges();
    });
});

// 통계 로드
function loadStats() {
    fetch('/regtech/api/stats')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Stats error:', data.error);
                return;
            }
            
            // 위험도 분포 업데이트
            const riskDist = data.risk_distribution || {};
            const total = Object.values(riskDist).reduce((a, b) => a + b, 0);
            
            if (total > 0) {
                document.getElementById('high-risk-count').textContent = (riskDist.high || 0).toLocaleString();
                
                // 진행률 바 업데이트
                document.getElementById('high-risk-bar').style.width = ((riskDist.high || 0) / total * 100) + '%';
                document.getElementById('medium-risk-bar').style.width = ((riskDist.medium || 0) / total * 100) + '%';
                document.getElementById('low-risk-bar').style.width = ((riskDist.low || 0) / total * 100) + '%';
            }
            
            // 지역 수 업데이트
            const regionCount = Object.keys(data.region_distribution || {}).length;
            document.getElementById('regions-count').textContent = regionCount;
            
            // 마지막 업데이트 시간 포맷팅
            if (data.last_updated) {
                const date = new Date(data.last_updated);
                document.getElementById('last-updated').textContent = date.toLocaleString('ko-KR');
            }
        })
        .catch(error => console.error('Stats loading error:', error));
}

// 추이 차트 로드
function loadTrends() {
    fetch('/regtech/api/trends?days=30')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            const dates = data.map(item => item.date);
            const counts = data.map(item => item.count);
            
            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'IP 탐지 수',
                        data: counts,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // 오늘 신규 수 업데이트
            if (data.length > 0) {
                const todayCount = data[data.length - 1].count || 0;
                document.getElementById('new-today').textContent = todayCount.toLocaleString();
            }
        })
        .catch(error => console.error('Trends loading error:', error));
}

// 지역별 분포 차트 로드
function loadRegions() {
    fetch('/regtech/api/stats')
        .then(response => response.json())
        .then(data => {
            if (!data.region_distribution) return;
            
            const ctx = document.getElementById('regionsChart').getContext('2d');
            
            const regions = Object.keys(data.region_distribution);
            const counts = Object.values(data.region_distribution);
            
            regionsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: regions,
                    datasets: [{
                        data: counts,
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#f5576c',
                            '#4facfe',
                            '#00f2fe'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Regions loading error:', error));
}

// 상위 IP 대역 차트 로드
function loadTopRanges() {
    fetch('/regtech/api/top-ranges?limit=10')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('rangesChart').getContext('2d');
            
            const ranges = data.map(item => item.range);
            const counts = data.map(item => item.count);
            
            rangesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ranges,
                    datasets: [{
                        label: 'IP 수',
                        data: counts,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: '#667eea',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Top ranges loading error:', error));
}

// 빠른 검색
function quickSearch() {
    const searchTerm = document.getElementById('search-input').value.trim();
    if (!searchTerm) return;
    
    fetch(`/regtech/api/search?q=${encodeURIComponent(searchTerm)}&limit=10`)
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('search-tbody');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center">검색 결과가 없습니다.</td></tr>';
            } else {
                data.forEach(item => {
                    const riskClass = `risk-${item.risk_level}`;
                    tbody.innerHTML += `
                        <tr>
                            <td><code>${item.ip}</code></td>
                            <td><span class="risk-badge ${riskClass}">${item.risk_level}</span></td>
                            <td><small>${item.region}</small></td>
                        </tr>
                    `;
                });
            }
            
            document.getElementById('search-results').style.display = 'block';
        })
        .catch(error => console.error('Search error:', error));
}

// 숫자 포맷팅 (천 단위 콤마)
function formatNumber(num) {
    return num.toLocaleString();
}
</script>
{% endblock %}