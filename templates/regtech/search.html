{% extends "base.html" %}

{% block title %}REGTECH IP 검색{% endblock %}

{% block extra_css %}
<style>
    .search-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .search-form {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .result-item {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
    }
    
    .result-item:hover {
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .ip-address {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        font-size: 1.1rem;
    }
    
    .risk-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .risk-high { background-color: #dc3545; color: white; }
    .risk-medium { background-color: #ffc107; color: black; }
    .risk-low { background-color: #28a745; color: white; }
    .risk-unknown { background-color: #6c757d; color: white; }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 40px;
    }
    
    .advanced-filters {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 헤더 -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('regtech.dashboard') }}">REGTECH</a></li>
                    <li class="breadcrumb-item active">IP 검색</li>
                </ol>
            </nav>
            <h1><i class="bi bi-search text-primary"></i> REGTECH IP 검색</h1>
            <p class="lead">수집된 위협 IP 데이터 검색 및 상세 정보 조회</p>
        </div>
    </div>
    
    <!-- 검색 폼 -->
    <div class="row">
        <div class="col-12">
            <div class="search-form">
                <form id="search-form">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="search-query" class="form-label">
                                    <i class="bi bi-search"></i> IP 주소 또는 대역 검색
                                </label>
                                <input type="text" class="form-control form-control-lg" id="search-query" 
                                       placeholder="예: 192.168.1.1, 192.168.*, 192.168.1.0/24" 
                                       autocomplete="off">
                                <div class="form-text" style="color: rgba(255,255,255,0.8);">
                                    정확한 IP, 와일드카드(*), CIDR 표기법 지원
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="search-limit" class="form-label">결과 수</label>
                                <select class="form-select" id="search-limit">
                                    <option value="50">50개</option>
                                    <option value="100" selected>100개</option>
                                    <option value="200">200개</option>
                                    <option value="500">500개</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <button type="submit" class="btn btn-light btn-lg me-2">
                                <i class="bi bi-search"></i> 검색
                            </button>
                            <button type="button" class="btn btn-outline-light" onclick="toggleAdvancedFilters()">
                                <i class="bi bi-funnel"></i> 고급 필터
                            </button>
                        </div>
                        <div class="col-md-6 text-end">
                            <button type="button" class="btn btn-outline-light" onclick="exportResults()">
                                <i class="bi bi-download"></i> 결과 내보내기
                            </button>
                        </div>
                    </div>
                    
                    <!-- 고급 필터 -->
                    <div class="advanced-filters" id="advanced-filters" style="display: none;">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="filter-risk" class="form-label">위험도</label>
                                <select class="form-select" id="filter-risk">
                                    <option value="">전체</option>
                                    <option value="high">고위험</option>
                                    <option value="medium">중위험</option>
                                    <option value="low">저위험</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="filter-region" class="form-label">지역</label>
                                <select class="form-select" id="filter-region">
                                    <option value="">전체</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="filter-date" class="form-label">탐지 기간</label>
                                <select class="form-select" id="filter-date">
                                    <option value="">전체</option>
                                    <option value="1">최근 1일</option>
                                    <option value="7">최근 7일</option>
                                    <option value="30">최근 30일</option>
                                    <option value="90">최근 90일</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 검색 결과 -->
    <div class="row">
        <div class="col-12">
            <div class="search-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="bi bi-list-ul"></i> 검색 결과</h5>
                    <div id="result-count" class="text-muted"></div>
                </div>
                
                <!-- 로딩 스피너 -->
                <div class="loading-spinner" id="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">검색 중...</span>
                    </div>
                    <p class="mt-2">검색 중입니다...</p>
                </div>
                
                <!-- 결과 없음 -->
                <div id="no-results" style="display: none;">
                    <div class="text-center py-5">
                        <i class="bi bi-search" style="font-size: 3rem; color: #ccc;"></i>
                        <h5 class="mt-3 text-muted">검색 결과가 없습니다</h5>
                        <p class="text-muted">다른 검색어를 시도해보세요.</p>
                    </div>
                </div>
                
                <!-- 검색 결과 목록 -->
                <div id="search-results"></div>
                
                <!-- 페이지네이션 -->
                <nav aria-label="검색 결과 페이지네이션" id="pagination-container" style="display: none;">
                    <ul class="pagination justify-content-center" id="pagination">
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- IP 상세 정보 모달 -->
<div class="modal fade" id="ipDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle"></i> IP 상세 정보
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="ip-detail-content">
                <!-- 상세 정보가 여기에 로드됩니다 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentResults = [];
let currentPage = 1;
const resultsPerPage = 20;

document.addEventListener('DOMContentLoaded', function() {
    loadRegionFilter();
    
    // 검색 폼 이벤트
    document.getElementById('search-form').addEventListener('submit', function(e) {
        e.preventDefault();
        performSearch();
    });
    
    // 실시간 검색 (3글자 이상)
    document.getElementById('search-query').addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length >= 3) {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => performSearch(), 1000);
        }
    });
});

function loadRegionFilter() {
    fetch('/regtech/api/stats')
        .then(response => response.json())
        .then(data => {
            if (data.region_distribution) {
                const regionSelect = document.getElementById('filter-region');
                Object.keys(data.region_distribution).forEach(region => {
                    const option = document.createElement('option');
                    option.value = region;
                    option.textContent = region;
                    regionSelect.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Region filter loading error:', error));
}

function toggleAdvancedFilters() {
    const filters = document.getElementById('advanced-filters');
    if (filters.style.display === 'none') {
        filters.style.display = 'block';
    } else {
        filters.style.display = 'none';
    }
}

function performSearch() {
    const query = document.getElementById('search-query').value.trim();
    const limit = document.getElementById('search-limit').value;
    const riskFilter = document.getElementById('filter-risk').value;
    const regionFilter = document.getElementById('filter-region').value;
    const dateFilter = document.getElementById('filter-date').value;
    
    if (!query) {
        showMessage('검색어를 입력해주세요.', 'warning');
        return;
    }
    
    showLoading(true);
    
    let url = `/regtech/api/search?q=${encodeURIComponent(query)}&limit=${limit}`;
    if (riskFilter) url += `&risk=${riskFilter}`;
    if (regionFilter) url += `&region=${encodeURIComponent(regionFilter)}`;
    if (dateFilter) url += `&days=${dateFilter}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            currentResults = data;
            currentPage = 1;
            displayResults();
            showLoading(false);
        })
        .catch(error => {
            console.error('Search error:', error);
            showMessage('검색 중 오류가 발생했습니다.', 'danger');
            showLoading(false);
        });
}

function displayResults() {
    const resultsContainer = document.getElementById('search-results');
    const resultCount = document.getElementById('result-count');
    const noResults = document.getElementById('no-results');
    
    if (currentResults.length === 0) {
        resultsContainer.innerHTML = '';
        resultCount.textContent = '';
        noResults.style.display = 'block';
        return;
    }
    
    noResults.style.display = 'none';
    resultCount.textContent = `총 ${currentResults.length.toLocaleString()}개 결과`;
    
    // 페이지네이션 계산
    const startIndex = (currentPage - 1) * resultsPerPage;
    const endIndex = Math.min(startIndex + resultsPerPage, currentResults.length);
    const pageResults = currentResults.slice(startIndex, endIndex);
    
    // 결과 렌더링
    resultsContainer.innerHTML = pageResults.map(item => `
        <div class="result-item" onclick="showIPDetail('${item.ip}')">
            <div class="row">
                <div class="col-md-3">
                    <div class="ip-address">${item.ip}</div>
                    <small class="text-muted">IP 주소</small>
                </div>
                <div class="col-md-2">
                    <span class="risk-badge risk-${item.risk_level || 'unknown'}">
                        ${getRiskLabel(item.risk_level)}
                    </span>
                </div>
                <div class="col-md-3">
                    <div class="text-muted">
                        <i class="bi bi-geo-alt"></i> ${item.region || 'Unknown'}
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="text-muted">
                        <i class="bi bi-diagram-3"></i> ${item.first_octet || '-'}.x.x.x
                    </div>
                </div>
                <div class="col-md-2">
                    <small class="text-muted">
                        <i class="bi bi-calendar"></i> ${formatDate(item.detection_date)}
                    </small>
                </div>
            </div>
        </div>
    `).join('');
    
    // 페이지네이션 업데이트
    updatePagination();
}

function updatePagination() {
    const totalPages = Math.ceil(currentResults.length / resultsPerPage);
    const paginationContainer = document.getElementById('pagination-container');
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        paginationContainer.style.display = 'none';
        return;
    }
    
    paginationContainer.style.display = 'block';
    pagination.innerHTML = '';
    
    // 이전 버튼
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">&laquo;</a>`;
    pagination.appendChild(prevLi);
    
    // 페이지 번호들
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        pagination.appendChild(li);
    }
    
    // 다음 버튼
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">&raquo;</a>`;
    pagination.appendChild(nextLi);
}

function changePage(page) {
    if (page < 1 || page > Math.ceil(currentResults.length / resultsPerPage)) return;
    currentPage = page;
    displayResults();
    
    // 스크롤을 결과 상단으로 이동
    document.getElementById('search-results').scrollIntoView({ behavior: 'smooth' });
}

function showIPDetail(ip) {
    // IP 상세 정보 모달 표시
    const modal = new bootstrap.Modal(document.getElementById('ipDetailModal'));
    const content = document.getElementById('ip-detail-content');
    
    content.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">로딩 중...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    // 상세 정보 로드
    fetch(`/regtech/api/search?q=${encodeURIComponent(ip)}&limit=1`)
        .then(response => response.json())
        .then(data => {
            if (data.length > 0) {
                const item = data[0];
                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>기본 정보</h6>
                            <table class="table table-sm">
                                <tr><td><strong>IP 주소:</strong></td><td><code>${item.ip}</code></td></tr>
                                <tr><td><strong>위험도:</strong></td><td><span class="risk-badge risk-${item.risk_level || 'unknown'}">${getRiskLabel(item.risk_level)}</span></td></tr>
                                <tr><td><strong>지역:</strong></td><td>${item.region || 'Unknown'}</td></tr>
                                <tr><td><strong>네트워크 대역:</strong></td><td>${item.first_octet || '-'}.x.x.x</td></tr>
                                <tr><td><strong>공격 유형:</strong></td><td>${item.attack_type || '-'}</td></tr>
                                <tr><td><strong>탐지일:</strong></td><td>${formatDate(item.detection_date)}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>추가 분석</h6>
                            <div class="alert alert-info">
                                <small>
                                    <i class="bi bi-info-circle"></i>
                                    이 IP는 REGTECH 포털에서 수집된 위협 정보입니다.
                                    실제 위험도는 추가 검증이 필요할 수 있습니다.
                                </small>
                            </div>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary btn-sm" onclick="searchSimilar('${item.ip}')">
                                    <i class="bi bi-search"></i> 유사 IP 검색
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="analyzeNetwork('${item.first_octet}')">
                                    <i class="bi bi-diagram-3"></i> 네트워크 분석
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                content.innerHTML = '<div class="alert alert-warning">상세 정보를 찾을 수 없습니다.</div>';
            }
        })
        .catch(error => {
            console.error('Detail loading error:', error);
            content.innerHTML = '<div class="alert alert-danger">정보 로드 중 오류가 발생했습니다.</div>';
        });
}

function searchSimilar(ip) {
    const ipParts = ip.split('.');
    const networkQuery = `${ipParts[0]}.${ipParts[1]}.*`;
    document.getElementById('search-query').value = networkQuery;
    bootstrap.Modal.getInstance(document.getElementById('ipDetailModal')).hide();
    performSearch();
}

function analyzeNetwork(firstOctet) {
    const networkQuery = `${firstOctet}.*`;
    document.getElementById('search-query').value = networkQuery;
    bootstrap.Modal.getInstance(document.getElementById('ipDetailModal')).hide();
    performSearch();
}

function exportResults() {
    if (currentResults.length === 0) {
        showMessage('내보낼 결과가 없습니다.', 'warning');
        return;
    }
    
    const csvContent = [
        ['IP 주소', '위험도', '지역', '공격 유형', '탐지일'],
        ...currentResults.map(item => [
            item.ip,
            getRiskLabel(item.risk_level),
            item.region || '',
            item.attack_type || '',
            formatDate(item.detection_date)
        ])
    ].map(row => row.join(',')).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `regtech_search_results_${new Date().getTime()}.csv`;
    link.click();
}

function showLoading(show) {
    document.getElementById('loading-spinner').style.display = show ? 'block' : 'none';
}

function showMessage(message, type) {
    // 간단한 알림 표시
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.container-fluid').firstChild);
    
    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 5000);
}

function getRiskLabel(risk) {
    const labels = {
        'high': '고위험',
        'medium': '중위험',
        'low': '저위험',
        'unknown': '알 수 없음'
    };
    return labels[risk] || '알 수 없음';
}

function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('ko-KR');
}
</script>
{% endblock %}