{% extends "base.html" %}

{% block title %}REGTECH 추이 분석{% endblock %}

{% block extra_css %}
<style>
    .trends-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .control-panel {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .metric-box {
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        margin-bottom: 15px;
    }
    
    .metric-number {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .metric-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .chart-wrapper {
        position: relative;
        height: 400px;
        margin-bottom: 20px;
    }
    
    .trend-indicator {
        display: inline-flex;
        align-items: center;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: bold;
    }
    
    .trend-up { background-color: #d4edda; color: #155724; }
    .trend-down { background-color: #f8d7da; color: #721c24; }
    .trend-stable { background-color: #d1ecf1; color: #0c5460; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 헤더 -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('regtech.dashboard') }}">REGTECH</a></li>
                    <li class="breadcrumb-item active">추이 분석</li>
                </ol>
            </nav>
            <h1><i class="bi bi-graph-up-arrow text-primary"></i> REGTECH 추이 분석</h1>
            <p class="lead">시간에 따른 위협 IP 탐지 패턴 및 트렌드 분석</p>
        </div>
    </div>
    
    <!-- 컨트롤 패널 -->
    <div class="row">
        <div class="col-12">
            <div class="control-panel">
                <div class="row">
                    <div class="col-md-3">
                        <div class="metric-box">
                            <div class="metric-number" id="total-period-ips">-</div>
                            <div class="metric-label">기간 내 탐지</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-box">
                            <div class="metric-number" id="daily-average">-</div>
                            <div class="metric-label">일평균 탐지</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-box">
                            <div class="metric-number" id="peak-day">-</div>
                            <div class="metric-label">최대 탐지일</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-box">
                            <div class="metric-number" id="trend-direction">-</div>
                            <div class="metric-label">전체 추세</div>
                        </div>
                    </div>
                </div>
                
                <hr style="border-color: rgba(255,255,255,0.3);">
                
                <div class="row">
                    <div class="col-md-4">
                        <label for="analysis-period" class="form-label">분석 기간</label>
                        <select class="form-select" id="analysis-period">
                            <option value="7">최근 7일</option>
                            <option value="30" selected>최근 30일</option>
                            <option value="90">최근 90일</option>
                            <option value="180">최근 6개월</option>
                            <option value="365">최근 1년</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="chart-type" class="form-label">차트 유형</label>
                        <select class="form-select" id="chart-type">
                            <option value="line" selected>선형 차트</option>
                            <option value="bar">막대 차트</option>
                            <option value="area">영역 차트</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="grouping-method" class="form-label">그룹화</label>
                        <select class="form-select" id="grouping-method">
                            <option value="day" selected>일별</option>
                            <option value="week">주별</option>
                            <option value="month">월별</option>
                        </select>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-12">
                        <button class="btn btn-light me-2" onclick="updateAnalysis()">
                            <i class="bi bi-arrow-clockwise"></i> 분석 업데이트
                        </button>
                        <button class="btn btn-outline-light me-2" onclick="exportTrendData()">
                            <i class="bi bi-download"></i> 데이터 내보내기
                        </button>
                        <button class="btn btn-outline-light" onclick="generateReport()">
                            <i class="bi bi-file-earmark-text"></i> 리포트 생성
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 메인 추이 차트 -->
    <div class="row">
        <div class="col-12">
            <div class="trends-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="bi bi-graph-up"></i> 탐지 추이</h5>
                    <div id="chart-legend"></div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="mainTrendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 상세 분석 섹션 -->
    <div class="row">
        <!-- 패턴 분석 -->
        <div class="col-lg-6">
            <div class="trends-card">
                <h5><i class="bi bi-pattern"></i> 패턴 분석</h5>
                <div class="chart-wrapper" style="height: 300px;">
                    <canvas id="patternChart"></canvas>
                </div>
                <div class="mt-3">
                    <h6>주요 패턴</h6>
                    <div id="pattern-insights">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>주말 vs 평일:</span>
                            <span id="weekend-pattern" class="trend-indicator">분석 중...</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>시간대별 패턴:</span>
                            <span id="hourly-pattern" class="trend-indicator">분석 중...</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>계절성:</span>
                            <span id="seasonal-pattern" class="trend-indicator">분석 중...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 위험도별 추이 -->
        <div class="col-lg-6">
            <div class="trends-card">
                <h5><i class="bi bi-shield-exclamation"></i> 위험도별 추이</h5>
                <div class="chart-wrapper" style="height: 300px;">
                    <canvas id="riskTrendChart"></canvas>
                </div>
                <div class="mt-3">
                    <h6>위험도 통계</h6>
                    <div class="row text-center">
                        <div class="col-4">
                            <div style="color: #dc3545;">
                                <strong id="high-risk-trend">-</strong>
                                <small class="d-block">고위험</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div style="color: #ffc107;">
                                <strong id="medium-risk-trend">-</strong>
                                <small class="d-block">중위험</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div style="color: #28a745;">
                                <strong id="low-risk-trend">-</strong>
                                <small class="d-block">저위험</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 예측 및 알림 -->
    <div class="row">
        <div class="col-lg-8">
            <div class="trends-card">
                <h5><i class="bi bi-graph-up-arrow"></i> 예측 분석</h5>
                <div class="chart-wrapper" style="height: 300px;">
                    <canvas id="forecastChart"></canvas>
                </div>
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i>
                    <strong>예측 정보:</strong> 현재 추세를 바탕으로 한 단순 예측입니다. 실제 값과 차이가 있을 수 있습니다.
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="trends-card">
                <h5><i class="bi bi-bell"></i> 트렌드 알림</h5>
                <div id="trend-alerts">
                    <!-- 알림 항목들이 여기에 표시됩니다 -->
                </div>
                
                <hr>
                
                <h6>통계 요약</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <tr>
                            <td>분석 기간:</td>
                            <td id="summary-period">-</td>
                        </tr>
                        <tr>
                            <td>데이터 포인트:</td>
                            <td id="summary-points">-</td>
                        </tr>
                        <tr>
                            <td>변동성:</td>
                            <td id="summary-volatility">-</td>
                        </tr>
                        <tr>
                            <td>상관계수:</td>
                            <td id="summary-correlation">-</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let mainChart, patternChart, riskChart, forecastChart;
let currentTrendData = [];

document.addEventListener('DOMContentLoaded', function() {
    updateAnalysis();
});

function updateAnalysis() {
    const period = document.getElementById('analysis-period').value;
    const chartType = document.getElementById('chart-type').value;
    const grouping = document.getElementById('grouping-method').value;
    
    // 기간별 통계 업데이트
    updatePeriodStats(period);
    
    // 메인 차트 로드
    loadMainTrendChart(period, chartType, grouping);
    
    // 패턴 분석 로드
    loadPatternAnalysis(period);
    
    // 위험도별 추이 로드
    loadRiskTrends(period);
    
    // 예측 차트 로드
    loadForecastChart(period);
    
    // 트렌드 알림 업데이트
    updateTrendAlerts();
}

function updatePeriodStats(period) {
    fetch(`/regtech/api/trends?days=${period}`)
        .then(response => response.json())
        .then(data => {
            currentTrendData = data;
            
            // 기본 통계 계산
            const totalIPs = data.reduce((sum, item) => sum + item.count, 0);
            const dailyAverage = Math.round(totalIPs / data.length);
            const peakDay = data.reduce((max, item) => item.count > max.count ? item : max, {count: 0});
            
            // 추세 방향 계산
            const trendDirection = calculateTrend(data);
            
            document.getElementById('total-period-ips').textContent = totalIPs.toLocaleString();
            document.getElementById('daily-average').textContent = dailyAverage.toLocaleString();
            document.getElementById('peak-day').textContent = peakDay.count ? peakDay.count.toLocaleString() : '-';
            
            const trendElement = document.getElementById('trend-direction');
            trendElement.innerHTML = getTrendIcon(trendDirection) + ' ' + getTrendLabel(trendDirection);
            
            // 요약 통계 업데이트
            updateSummaryStats(data, period);
        })
        .catch(error => console.error('Period stats error:', error));
}

function loadMainTrendChart(period, chartType, grouping) {
    fetch(`/regtech/api/trends?days=${period}&group=${grouping}`)
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('mainTrendChart').getContext('2d');
            
            if (mainChart) {
                mainChart.destroy();
            }
            
            const chartConfig = {
                type: chartType,
                data: {
                    labels: data.map(item => formatDateLabel(item.date, grouping)),
                    datasets: [{
                        label: 'IP 탐지 수',
                        data: data.map(item => item.count),
                        borderColor: '#667eea',
                        backgroundColor: chartType === 'area' ? 'rgba(102, 126, 234, 0.2)' : 'rgba(102, 126, 234, 0.6)',
                        fill: chartType === 'area',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'IP 탐지 수'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: getXAxisLabel(grouping)
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            };
            
            mainChart = new Chart(ctx, chartConfig);
        })
        .catch(error => console.error('Main chart error:', error));
}

function loadPatternAnalysis(period) {
    // 시뮬레이션된 패턴 데이터 (실제로는 서버에서 계산)
    const dayOfWeek = ['일', '월', '화', '수', '목', '금', '토'];
    const patternData = dayOfWeek.map(() => Math.floor(Math.random() * 1000) + 500);
    
    const ctx = document.getElementById('patternChart').getContext('2d');
    
    if (patternChart) {
        patternChart.destroy();
    }
    
    patternChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: dayOfWeek,
            datasets: [{
                label: '요일별 탐지 패턴',
                data: patternData,
                borderColor: '#f093fb',
                backgroundColor: 'rgba(240, 147, 251, 0.2)',
                pointBackgroundColor: '#f093fb',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: '#f093fb'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                r: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // 패턴 인사이트 업데이트
    updatePatternInsights(patternData);
}

function loadRiskTrends(period) {
    // 위험도별 시뮬레이션 데이터
    const labels = Array.from({length: 7}, (_, i) => {
        const date = new Date();
        date.setDate(date.getDate() - (6 - i));
        return date.toLocaleDateString('ko-KR', {month: 'short', day: 'numeric'});
    });
    
    const ctx = document.getElementById('riskTrendChart').getContext('2d');
    
    if (riskChart) {
        riskChart.destroy();
    }
    
    riskChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '고위험',
                    data: Array.from({length: 7}, () => Math.floor(Math.random() * 100) + 50),
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4
                },
                {
                    label: '중위험',
                    data: Array.from({length: 7}, () => Math.floor(Math.random() * 200) + 100),
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    tension: 0.4
                },
                {
                    label: '저위험',
                    data: Array.from({length: 7}, () => Math.floor(Math.random() * 500) + 300),
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    stacked: true
                }
            }
        }
    });
    
    // 위험도 통계 업데이트
    updateRiskStats();
}

function loadForecastChart(period) {
    // 예측 데이터 시뮬레이션
    const historical = currentTrendData.slice(-7); // 최근 7일
    const forecast = Array.from({length: 7}, (_, i) => {
        const lastValue = historical[historical.length - 1]?.count || 1000;
        const trend = Math.random() * 0.2 - 0.1; // ±10% 변동
        return Math.floor(lastValue * (1 + trend));
    });
    
    const allLabels = [
        ...historical.map(item => item.date),
        ...Array.from({length: 7}, (_, i) => {
            const date = new Date();
            date.setDate(date.getDate() + i + 1);
            return date.toISOString().split('T')[0];
        })
    ];
    
    const ctx = document.getElementById('forecastChart').getContext('2d');
    
    if (forecastChart) {
        forecastChart.destroy();
    }
    
    forecastChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: allLabels.map(date => formatDateLabel(date, 'day')),
            datasets: [
                {
                    label: '실제 데이터',
                    data: [...historical.map(item => item.count), ...Array(7).fill(null)],
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4
                },
                {
                    label: '예측',
                    data: [...Array(historical.length).fill(null), ...forecast],
                    borderColor: '#f093fb',
                    backgroundColor: 'rgba(240, 147, 251, 0.1)',
                    borderDash: [5, 5],
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function updateTrendAlerts() {
    const alertsContainer = document.getElementById('trend-alerts');
    
    // 시뮬레이션된 알림들
    const alerts = [
        { type: 'warning', message: '고위험 IP 탐지가 평소보다 20% 증가했습니다.', time: '2시간 전' },
        { type: 'info', message: '새로운 IP 대역에서 활동이 감지되었습니다.', time: '5시간 전' },
        { type: 'success', message: '전체적인 위협 수준이 안정적입니다.', time: '1일 전' }
    ];
    
    alertsContainer.innerHTML = alerts.map(alert => `
        <div class="alert alert-${alert.type} p-2 mb-2">
            <small>
                <i class="bi bi-${getAlertIcon(alert.type)}"></i>
                ${alert.message}
                <div class="text-muted mt-1">${alert.time}</div>
            </small>
        </div>
    `).join('');
}

function updatePatternInsights(patternData) {
    // 주말 vs 평일 패턴 (일요일=0, 토요일=6)
    const weekendAvg = (patternData[0] + patternData[6]) / 2;
    const weekdayAvg = patternData.slice(1, 6).reduce((a, b) => a + b) / 5;
    const weekendPattern = weekendAvg > weekdayAvg ? 'weekend-high' : 'weekday-high';
    
    document.getElementById('weekend-pattern').textContent = 
        weekendPattern === 'weekend-high' ? '주말 증가' : '평일 증가';
    document.getElementById('weekend-pattern').className = 
        `trend-indicator ${weekendPattern === 'weekend-high' ? 'trend-up' : 'trend-down'}`;
    
    // 시간대별 패턴 (시뮬레이션)
    document.getElementById('hourly-pattern').textContent = '오후 활발';
    document.getElementById('hourly-pattern').className = 'trend-indicator trend-stable';
    
    // 계절성 패턴 (시뮬레이션)
    document.getElementById('seasonal-pattern').textContent = '계절성 없음';
    document.getElementById('seasonal-pattern').className = 'trend-indicator trend-stable';
}

function updateRiskStats() {
    // 시뮬레이션된 위험도 통계
    document.getElementById('high-risk-trend').textContent = '↑ 15%';
    document.getElementById('medium-risk-trend').textContent = '↓ 8%';
    document.getElementById('low-risk-trend').textContent = '→ 2%';
}

function updateSummaryStats(data, period) {
    const points = data.length;
    const values = data.map(item => item.count);
    const variance = calculateVariance(values);
    const volatility = Math.sqrt(variance);
    
    document.getElementById('summary-period').textContent = `${period}일`;
    document.getElementById('summary-points').textContent = points;
    document.getElementById('summary-volatility').textContent = `${Math.round(volatility)}`;
    document.getElementById('summary-correlation').textContent = '0.75'; // 시뮬레이션
}

// 유틸리티 함수들
function calculateTrend(data) {
    if (data.length < 2) return 'stable';
    
    const first = data.slice(0, Math.floor(data.length / 3)).reduce((sum, item) => sum + item.count, 0);
    const last = data.slice(-Math.floor(data.length / 3)).reduce((sum, item) => sum + item.count, 0);
    
    const ratio = last / first;
    if (ratio > 1.1) return 'up';
    if (ratio < 0.9) return 'down';
    return 'stable';
}

function getTrendIcon(trend) {
    const icons = {
        'up': '<i class="bi bi-arrow-up"></i>',
        'down': '<i class="bi bi-arrow-down"></i>',
        'stable': '<i class="bi bi-arrow-right"></i>'
    };
    return icons[trend] || icons['stable'];
}

function getTrendLabel(trend) {
    const labels = {
        'up': '상승세',
        'down': '하락세',
        'stable': '안정'
    };
    return labels[trend] || labels['stable'];
}

function formatDateLabel(date, grouping) {
    const d = new Date(date);
    switch (grouping) {
        case 'week':
            return `${d.getMonth() + 1}/${d.getDate()}`;
        case 'month':
            return d.toLocaleDateString('ko-KR', {month: 'short'});
        default:
            return d.toLocaleDateString('ko-KR', {month: 'short', day: 'numeric'});
    }
}

function getXAxisLabel(grouping) {
    const labels = {
        'day': '일자',
        'week': '주',
        'month': '월'
    };
    return labels[grouping] || '기간';
}

function getAlertIcon(type) {
    const icons = {
        'warning': 'exclamation-triangle',
        'info': 'info-circle',
        'success': 'check-circle'
    };
    return icons[type] || 'info-circle';
}

function calculateVariance(values) {
    const mean = values.reduce((a, b) => a + b) / values.length;
    return values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
}

function exportTrendData() {
    if (currentTrendData.length === 0) {
        alert('내보낼 데이터가 없습니다.');
        return;
    }
    
    const csvContent = [
        ['날짜', 'IP 탐지 수'],
        ...currentTrendData.map(item => [item.date, item.count])
    ].map(row => row.join(',')).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `regtech_trends_${new Date().getTime()}.csv`;
    link.click();
}

function generateReport() {
    alert('리포트 생성 기능은 개발 중입니다.');
}
</script>
{% endblock %}