{% extends "base.html" %}

{% block title %}REGTECH ìˆ˜ì§‘ê¸°{% endblock %}

{% block extra_css %}
<style>
    .collector-card {
        background: white;
        border-radius: 10px;
        padding: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .date-input-group {
        display: flex;
        gap: 1rem;
        align-items: end;
        margin-bottom: 1.5rem;
    }
    
    .date-input-group > div {
        flex: 1;
    }
    
    .preset-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
    }
    
    .collection-log {
        background: #f8f9fa;
        border-radius: 5px;
        padding: 1rem;
        height: 400px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 0.875rem;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .loading-spinner {
        display: none;
    }
    
    .collecting {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">
        <i class="bi bi-collection"></i> REGTECH ë°ì´í„° ìˆ˜ì§‘ê¸°
    </h1>
    
    <!-- í˜„ì¬ ìƒíƒœ -->
    <div class="stats-card">
        <div class="row">
            <div class="col-md-3">
                <h3 id="totalCount">{{ total_ips|default('0') }}</h3>
                <small>ì „ì²´ REGTECH IP</small>
            </div>
            <div class="col-md-3">
                <h3 id="todayCount">{{ today_count|default('0') }}</h3>
                <small>ì˜¤ëŠ˜ ìˆ˜ì§‘ëœ IP</small>
            </div>
            <div class="col-md-3">
                <h3 id="lastUpdate">{{ last_update|default('ì—†ìŒ') }}</h3>
                <small>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</small>
            </div>
            <div class="col-md-3">
                <h3 id="collectionStatus">ëŒ€ê¸°ì¤‘</h3>
                <small>ìˆ˜ì§‘ ìƒíƒœ</small>
            </div>
        </div>
    </div>
    
    <!-- ë‚ ì§œ ë²”ìœ„ ì„ íƒ -->
    <div class="collector-card">
        <h4 class="mb-3">
            <i class="bi bi-calendar-range"></i> ìˆ˜ì§‘ ë‚ ì§œ ë²”ìœ„ ì„¤ì •
        </h4>
        
        <!-- ë¹ ë¥¸ ì„ íƒ ë²„íŠ¼ -->
        <div class="preset-buttons">
            <button class="btn btn-sm btn-outline-primary" onclick="setDateRange('today')">ì˜¤ëŠ˜</button>
            <button class="btn btn-sm btn-outline-primary" onclick="setDateRange('yesterday')">ì–´ì œ</button>
            <button class="btn btn-sm btn-outline-primary" onclick="setDateRange('week')">ìµœê·¼ 1ì£¼ì¼</button>
            <button class="btn btn-sm btn-outline-primary" onclick="setDateRange('month')">ìµœê·¼ 1ê°œì›”</button>
            <button class="btn btn-sm btn-outline-primary" onclick="setDateRange('3months')">ìµœê·¼ 3ê°œì›”</button>
            <button class="btn btn-sm btn-outline-primary" onclick="setDateRange('6months')">ìµœê·¼ 6ê°œì›”</button>
        </div>
        
        <!-- ë‚ ì§œ ì…ë ¥ -->
        <div class="date-input-group">
            <div>
                <label for="startDate" class="form-label">ì‹œì‘ì¼</label>
                <input type="date" class="form-control" id="startDate" 
                       value="{{ default_start_date }}" max="{{ today }}">
            </div>
            <div>
                <label for="endDate" class="form-label">ì¢…ë£Œì¼</label>
                <input type="date" class="form-control" id="endDate" 
                       value="{{ today }}" max="{{ today }}">
            </div>
            <div>
                <label class="form-label">&nbsp;</label>
                <button class="btn btn-primary w-100" onclick="startCollection()" id="collectBtn">
                    <i class="bi bi-play-circle"></i> ìˆ˜ì§‘ ì‹œì‘
                </button>
            </div>
        </div>
        
        <!-- ê³ ê¸‰ ì˜µì…˜ -->
        <details>
            <summary class="text-muted mb-2" style="cursor: pointer;">ê³ ê¸‰ ì˜µì…˜</summary>
            <div class="row mt-2">
                <div class="col-md-4">
                    <label for="pageSize" class="form-label">í˜ì´ì§€ í¬ê¸°</label>
                    <input type="number" class="form-control" id="pageSize" value="200" min="50" max="1000">
                </div>
                <div class="col-md-4">
                    <label class="form-label">ìˆ˜ì§‘ ëª¨ë“œ</label>
                    <select class="form-select" id="collectionMode">
                        <option value="update">ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ë°ì´í„° ìœ ì§€)</option>
                        <option value="replace">êµì²´ (ê¸°ê°„ ë‚´ ë°ì´í„° êµì²´)</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">ìë™ DB ì €ì¥</label>
                    <div class="form-check form-switch mt-2">
                        <input class="form-check-input" type="checkbox" id="autoSave" checked>
                        <label class="form-check-label" for="autoSave">
                            ìˆ˜ì§‘ í›„ ìë™ìœ¼ë¡œ DBì— ì €ì¥
                        </label>
                    </div>
                </div>
            </div>
        </details>
    </div>
    
    <!-- ìˆ˜ì§‘ ë¡œê·¸ -->
    <div class="collector-card">
        <h4 class="mb-3">
            <i class="bi bi-terminal"></i> ìˆ˜ì§‘ ë¡œê·¸
            <button class="btn btn-sm btn-outline-secondary float-end" onclick="clearLog()">
                <i class="bi bi-trash"></i> ë¡œê·¸ ì§€ìš°ê¸°
            </button>
        </h4>
        <div class="collection-log" id="collectionLog">
            <div class="text-muted">ìˆ˜ì§‘ì„ ì‹œì‘í•˜ë©´ ì—¬ê¸°ì— ë¡œê·¸ê°€ í‘œì‹œë©ë‹ˆë‹¤...</div>
        </div>
    </div>
    
    <!-- ìˆ˜ì§‘ ê²°ê³¼ -->
    <div class="collector-card" id="resultsCard" style="display: none;">
        <h4 class="mb-3">
            <i class="bi bi-graph-up"></i> ìˆ˜ì§‘ ê²°ê³¼
        </h4>
        <div id="collectionResults">
            <!-- ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë¨ -->
        </div>
    </div>
</div>

<!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
<div class="loading-spinner position-fixed top-50 start-50 translate-middle" id="loadingSpinner">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ë‚ ì§œ ë²”ìœ„ í”„ë¦¬ì…‹
function setDateRange(preset) {
    const today = new Date();
    const endDate = document.getElementById('endDate');
    const startDate = document.getElementById('startDate');
    
    endDate.value = formatDate(today);
    
    let start = new Date(today);
    switch(preset) {
        case 'today':
            start = new Date(today);
            break;
        case 'yesterday':
            start.setDate(start.getDate() - 1);
            endDate.value = formatDate(start);
            break;
        case 'week':
            start.setDate(start.getDate() - 7);
            break;
        case 'month':
            start.setDate(start.getDate() - 30);
            break;
        case '3months':
            start.setDate(start.getDate() - 90);
            break;
        case '6months':
            start.setDate(start.getDate() - 180);
            break;
    }
    
    startDate.value = formatDate(start);
}

function formatDate(date) {
    return date.toISOString().split('T')[0];
}

// ë¡œê·¸ ì¶”ê°€
function addLog(message, type = 'info') {
    const log = document.getElementById('collectionLog');
    const timestamp = new Date().toLocaleTimeString('ko-KR');
    const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'ğŸ“';
    
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry text-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'dark'}`;
    logEntry.innerHTML = `[${timestamp}] ${icon} ${message}`;
    
    log.appendChild(logEntry);
    log.scrollTop = log.scrollHeight;
}

// ë¡œê·¸ ì§€ìš°ê¸°
function clearLog() {
    document.getElementById('collectionLog').innerHTML = '<div class="text-muted">ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.</div>';
}

// ìˆ˜ì§‘ ì‹œì‘
function startCollection() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const pageSize = document.getElementById('pageSize').value;
    const mode = document.getElementById('collectionMode').value;
    const autoSave = document.getElementById('autoSave').checked;
    
    if (!startDate || !endDate) {
        alert('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
        return;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
        alert('ì‹œì‘ì¼ì´ ì¢…ë£Œì¼ë³´ë‹¤ ëŠ¦ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // UI ìƒíƒœ ë³€ê²½
    const collectBtn = document.getElementById('collectBtn');
    collectBtn.disabled = true;
    collectBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ìˆ˜ì§‘ ì¤‘...';
    document.getElementById('collectionStatus').textContent = 'ìˆ˜ì§‘ ì¤‘';
    document.getElementById('collectionStatus').parentElement.parentElement.classList.add('collecting');
    
    clearLog();
    addLog(`ìˆ˜ì§‘ ì‹œì‘: ${startDate} ~ ${endDate}`);
    addLog(`ì˜µì…˜: í˜ì´ì§€í¬ê¸°=${pageSize}, ëª¨ë“œ=${mode}, ìë™ì €ì¥=${autoSave}`);
    
    // API í˜¸ì¶œ
    fetch('/api/regtech/collect', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            start_date: startDate.replace(/-/g, ''),
            end_date: endDate.replace(/-/g, ''),
            page_size: parseInt(pageSize),
            mode: mode,
            auto_save: autoSave
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addLog(`ìˆ˜ì§‘ ì™„ë£Œ! ì´ ${data.total_collected}ê°œ IP ìˆ˜ì§‘ë¨`, 'success');
            
            // ê²°ê³¼ í‘œì‹œ
            showResults(data);
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            updateStats();
        } else {
            addLog(`ìˆ˜ì§‘ ì‹¤íŒ¨: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        addLog(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error}`, 'error');
    })
    .finally(() => {
        collectBtn.disabled = false;
        collectBtn.innerHTML = '<i class="bi bi-play-circle"></i> ìˆ˜ì§‘ ì‹œì‘';
        document.getElementById('collectionStatus').textContent = 'ëŒ€ê¸°ì¤‘';
        document.getElementById('collectionStatus').parentElement.parentElement.classList.remove('collecting');
    });
}

// ê²°ê³¼ í‘œì‹œ
function showResults(data) {
    const resultsCard = document.getElementById('resultsCard');
    const resultsDiv = document.getElementById('collectionResults');
    
    resultsCard.style.display = 'block';
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <h5>ìˆ˜ì§‘ ìš”ì•½</h5>
                <ul>
                    <li>ì´ ìˆ˜ì§‘ëœ IP: <strong>${data.total_collected}</strong>ê°œ</li>
                    <li>ì‹ ê·œ IP: <strong>${data.new_ips || 0}</strong>ê°œ</li>
                    <li>ì—…ë°ì´íŠ¸ëœ IP: <strong>${data.updated_ips || 0}</strong>ê°œ</li>
                    <li>ìˆ˜ì§‘ ì‹œê°„: <strong>${data.collection_time || 'N/A'}</strong></li>
                </ul>
            </div>
            <div class="col-md-6">
                <h5>ë‚ ì§œë³„ ë¶„í¬</h5>
                <div style="max-height: 200px; overflow-y: auto;">
    `;
    
    if (data.date_distribution) {
        for (const [date, count] of Object.entries(data.date_distribution)) {
            html += `<div>${date}: ${count}ê°œ</div>`;
        }
    }
    
    html += `
                </div>
            </div>
        </div>
    `;
    
    resultsDiv.innerHTML = html;
}

// í†µê³„ ì—…ë°ì´íŠ¸
function updateStats() {
    fetch('/api/regtech/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalCount').textContent = data.total_ips.toLocaleString();
            document.getElementById('todayCount').textContent = data.today_count.toLocaleString();
            document.getElementById('lastUpdate').textContent = data.last_update || 'ì—†ìŒ';
        });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ í†µê³„ ì—…ë°ì´íŠ¸
document.addEventListener('DOMContentLoaded', updateStats);
</script>
{% endblock %}