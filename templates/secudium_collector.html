{% extends "base.html" %}

{% block title %}SECUDIUM 수집기 - Nextrade Black List{% endblock %}

{% block extra_css %}
<style>
    .collector-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .status-card {
        transition: all 0.3s ease;
    }
    
    .status-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .log-viewer {
        background-color: #1a1a1a;
        color: #0f0;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        padding: 15px;
        border-radius: 5px;
        height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
    }
    
    .collection-settings {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .date-input-group {
        display: flex;
        gap: 20px;
        align-items: flex-end;
    }
    
    .collection-status {
        display: none;
    }
    
    .collection-status.active {
        display: block;
    }
    
    .progress-info {
        font-size: 14px;
        color: #666;
        margin-top: 10px;
    }
    
    .result-summary {
        background-color: #e8f5e9;
        border-left: 4px solid #4caf50;
        padding: 15px;
        margin-top: 20px;
        border-radius: 4px;
    }
    
    .error-summary {
        background-color: #ffebee;
        border-left: 4px solid #f44336;
        padding: 15px;
        margin-top: 20px;
        border-radius: 4px;
    }

    .collection-type-card {
        cursor: pointer;
        border: 2px solid #dee2e6;
        transition: all 0.3s ease;
        margin-bottom: 10px;
    }
    
    .collection-type-card:hover {
        border-color: #0d6efd;
        background-color: #f8f9fa;
    }
    
    .collection-type-card.selected {
        border-color: #0d6efd;
        background-color: #e7f3ff;
    }
    
    .collection-type-card h5 {
        color: #0d6efd;
        margin-bottom: 10px;
    }
    
    .collection-type-card p {
        color: #666;
        font-size: 14px;
        margin-bottom: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="collector-container">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2 mb-3">
                <i class="bi bi-shield-lock-fill text-primary"></i> SECUDIUM 수집기
            </h1>
            <p class="text-muted">SK쉴더스 SECUDIUM Center의 블랙리스트 IP를 수집합니다.</p>
        </div>
    </div>

    <!-- 상태 카드 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card status-card">
                <div class="card-body text-center">
                    <h5 class="card-title">마지막 수집</h5>
                    <p class="card-text text-primary fs-5" id="lastCollection">-</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card status-card">
                <div class="card-body text-center">
                    <h5 class="card-title">수집된 IP</h5>
                    <p class="card-text text-success fs-5" id="totalIPs">0</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card status-card">
                <div class="card-body text-center">
                    <h5 class="card-title">신규 IP</h5>
                    <p class="card-text text-info fs-5" id="newIPs">0</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card status-card">
                <div class="card-body text-center">
                    <h5 class="card-title">수집 상태</h5>
                    <p class="card-text fs-5" id="collectionStatus">
                        <span class="badge bg-secondary">대기중</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- 수집 설정 -->
    <div class="collection-settings">
        <h4 class="mb-3">수집 설정</h4>
        
        <!-- 수집 유형 선택 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card collection-type-card" onclick="selectCollectionType('blackip')">
                    <div class="card-body">
                        <h5><i class="bi bi-shield-x"></i> Black IP 리스트</h5>
                        <p>SECUDIUM에서 공유하는 악성 IP 리스트를 수집합니다.</p>
                        <small class="text-muted">• SK쉴더스에서 탐지한 침해 IP</small><br>
                        <small class="text-muted">• Excel 파일 자동 다운로드 및 파싱</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card collection-type-card" onclick="selectCollectionType('firewall')">
                    <div class="card-body">
                        <h5><i class="bi bi-bricks"></i> 방화벽 정책</h5>
                        <p>방화벽 차단 정책에서 IP를 추출합니다.</p>
                        <small class="text-muted">• 실시간 방화벽 차단 IP</small><br>
                        <small class="text-muted">• 정책별 소스/목적지 IP 수집</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 날짜 범위 설정 (Black IP 선택시에만 표시) -->
        <div id="dateRangeSettings" style="display: none;">
            <div class="date-input-group mb-3">
                <div>
                    <label for="startDate" class="form-label">시작일</label>
                    <input type="date" class="form-control" id="startDate">
                </div>
                <div>
                    <label for="endDate" class="form-label">종료일</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
                <div>
                    <label class="form-label">&nbsp;</label><br>
                    <button class="btn btn-secondary" onclick="setDateRange('week')">최근 1주</button>
                    <button class="btn btn-secondary" onclick="setDateRange('month')">최근 1달</button>
                    <button class="btn btn-secondary" onclick="setDateRange('3months')">최근 3달</button>
                </div>
            </div>
        </div>

        <input type="hidden" id="selectedType" value="">
        
        <div class="row">
            <div class="col-12">
                <button class="btn btn-primary btn-lg" onclick="startCollection()" id="startBtn">
                    <i class="bi bi-play-circle"></i> 수집 시작
                </button>
                <button class="btn btn-danger btn-lg ms-2" onclick="stopCollection()" id="stopBtn" style="display: none;">
                    <i class="bi bi-stop-circle"></i> 수집 중지
                </button>
                <button class="btn btn-info btn-lg ms-2" onclick="testConnection()">
                    <i class="bi bi-wifi"></i> 연결 테스트
                </button>
            </div>
        </div>
    </div>

    <!-- 수집 진행 상태 -->
    <div class="collection-status" id="collectionProgress">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">수집 진행 상황</h5>
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         id="progressBar"
                         style="width: 0%">0%</div>
                </div>
                <div class="progress-info" id="progressInfo">
                    준비 중...
                </div>
            </div>
        </div>
    </div>

    <!-- 수집 결과 요약 -->
    <div id="resultSummary" style="display: none;"></div>

    <!-- 로그 뷰어 -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-terminal"></i> 수집 로그
                <button class="btn btn-sm btn-outline-secondary float-end" onclick="clearLogs()">
                    <i class="bi bi-trash"></i> 로그 초기화
                </button>
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="log-viewer" id="logViewer">
                대기 중...
            </div>
        </div>
    </div>
</div>

<!-- 로딩 모달 -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p id="loadingText">처리 중...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let collectionInterval = null;
let logInterval = null;
let selectedCollectionType = '';

// 날짜 초기화
document.addEventListener('DOMContentLoaded', function() {
    // 기본값: 오늘 ~ 6개월 전
    const today = new Date();
    const sixMonthsAgo = new Date();
    sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
    
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    document.getElementById('startDate').value = sixMonthsAgo.toISOString().split('T')[0];
    
    // 상태 업데이트
    updateStatus();
});

// 수집 유형 선택
function selectCollectionType(type) {
    selectedCollectionType = type;
    document.getElementById('selectedType').value = type;
    
    // UI 업데이트
    document.querySelectorAll('.collection-type-card').forEach(card => {
        card.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
    
    // Black IP 선택시에만 날짜 범위 표시
    if (type === 'blackip') {
        document.getElementById('dateRangeSettings').style.display = 'block';
    } else {
        document.getElementById('dateRangeSettings').style.display = 'none';
    }
}

// 날짜 범위 설정
function setDateRange(range) {
    const endDate = new Date();
    const startDate = new Date();
    
    switch(range) {
        case 'week':
            startDate.setDate(startDate.getDate() - 7);
            break;
        case 'month':
            startDate.setMonth(startDate.getMonth() - 1);
            break;
        case '3months':
            startDate.setMonth(startDate.getMonth() - 3);
            break;
    }
    
    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
}

// 연결 테스트
async function testConnection() {
    showLoading('SECUDIUM 연결 테스트 중...');
    addLog('[INFO] SECUDIUM 연결 테스트 시작...');
    
    try {
        const response = await fetch('/api/collection/secudium/test', {
            method: 'POST'
        });
        
        const data = await response.json();
        hideLoading();
        
        if (data.success) {
            addLog('[SUCCESS] SECUDIUM 연결 성공!');
            showAlert('success', 'SECUDIUM 연결에 성공했습니다.');
        } else {
            addLog(`[ERROR] SECUDIUM 연결 실패: ${data.error}`);
            showAlert('error', `연결 실패: ${data.error}`);
        }
    } catch (error) {
        hideLoading();
        addLog(`[ERROR] 연결 테스트 중 오류: ${error.message}`);
        showAlert('error', '연결 테스트 중 오류가 발생했습니다.');
    }
}

// 수집 시작
async function startCollection() {
    const collectionType = document.getElementById('selectedType').value;
    if (!collectionType) {
        showAlert('warning', '수집 유형을 선택해주세요.');
        return;
    }
    
    document.getElementById('startBtn').style.display = 'none';
    document.getElementById('stopBtn').style.display = 'inline-block';
    document.getElementById('collectionProgress').classList.add('active');
    document.getElementById('resultSummary').style.display = 'none';
    
    clearLogs();
    addLog(`[INFO] SECUDIUM ${collectionType === 'blackip' ? 'Black IP' : '방화벽 정책'} 수집 시작...`);
    
    const params = {
        collection_type: collectionType
    };
    
    // Black IP 수집시 날짜 범위 추가
    if (collectionType === 'blackip') {
        params.start_date = document.getElementById('startDate').value;
        params.end_date = document.getElementById('endDate').value;
        addLog(`[INFO] 수집 기간: ${params.start_date} ~ ${params.end_date}`);
    }
    
    try {
        const response = await fetch('/api/collection/secudium/trigger', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(params)
        });
        
        const data = await response.json();
        
        if (data.success) {
            addLog('[SUCCESS] 수집 작업이 시작되었습니다.');
            
            // 진행 상황 모니터링
            collectionInterval = setInterval(updateProgress, 2000);
            
            // 실시간 로그 업데이트
            logInterval = setInterval(updateLogs, 1000);
        } else {
            throw new Error(data.error || '수집 시작 실패');
        }
    } catch (error) {
        addLog(`[ERROR] 수집 시작 실패: ${error.message}`);
        showAlert('error', `수집 시작 실패: ${error.message}`);
        resetUI();
    }
}

// 수집 중지
async function stopCollection() {
    try {
        const response = await fetch('/api/collection/secudium/stop', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            addLog('[INFO] 수집이 중지되었습니다.');
            showAlert('info', '수집이 중지되었습니다.');
        }
    } catch (error) {
        addLog(`[ERROR] 수집 중지 실패: ${error.message}`);
    }
    
    resetUI();
}

// 진행 상황 업데이트
async function updateProgress() {
    try {
        const response = await fetch('/api/collection/secudium/progress');
        const data = await response.json();
        
        if (data.status === 'completed') {
            clearInterval(collectionInterval);
            clearInterval(logInterval);
            
            // 최종 결과 표시
            showResult(data);
            resetUI();
            updateStatus();
        } else if (data.status === 'error') {
            clearInterval(collectionInterval);
            clearInterval(logInterval);
            
            showError(data.error);
            resetUI();
        } else {
            // 진행률 업데이트
            const progress = data.progress || 0;
            updateProgressBar(progress, data.message);
        }
    } catch (error) {
        console.error('Progress update error:', error);
    }
}

// 실시간 로그 업데이트
async function updateLogs() {
    try {
        const response = await fetch('/api/collection/secudium/logs');
        const data = await response.json();
        
        if (data.logs && data.logs.length > 0) {
            data.logs.forEach(log => addLog(log, false));
        }
    } catch (error) {
        console.error('Log update error:', error);
    }
}

// 상태 업데이트
async function updateStatus() {
    try {
        const response = await fetch('/api/collection/secudium/status');
        const data = await response.json();
        
        document.getElementById('lastCollection').textContent = 
            data.last_collection || '-';
        document.getElementById('totalIPs').textContent = 
            data.total_ips || '0';
        document.getElementById('newIPs').textContent = 
            data.new_ips_today || '0';
        
        const statusBadge = document.getElementById('collectionStatus').querySelector('.badge');
        if (data.is_running) {
            statusBadge.className = 'badge bg-warning';
            statusBadge.textContent = '수집중';
        } else {
            statusBadge.className = 'badge bg-success';
            statusBadge.textContent = '대기중';
        }
    } catch (error) {
        console.error('Status update error:', error);
    }
}

// 진행률 바 업데이트
function updateProgressBar(progress, message) {
    const progressBar = document.getElementById('progressBar');
    progressBar.style.width = progress + '%';
    progressBar.textContent = progress + '%';
    
    if (message) {
        document.getElementById('progressInfo').textContent = message;
    }
}

// 결과 표시
function showResult(data) {
    const resultDiv = document.getElementById('resultSummary');
    resultDiv.style.display = 'block';
    resultDiv.className = 'result-summary';
    resultDiv.innerHTML = `
        <h5><i class="bi bi-check-circle"></i> 수집 완료</h5>
        <p class="mb-1">총 수집 IP: <strong>${data.total_ips || 0}개</strong></p>
        <p class="mb-1">소스별 수집:
            ${Object.entries(data.sources || {}).map(([source, count]) => 
                `<span class="badge bg-info ms-2">${source}: ${count}개</span>`
            ).join('')}
        </p>
        <p class="mb-0">소요 시간: ${data.duration || '-'}</p>
    `;
    
    addLog(`[SUCCESS] 수집 완료! 총 ${data.total_ips || 0}개 IP 수집`);
}

// 오류 표시
function showError(error) {
    const resultDiv = document.getElementById('resultSummary');
    resultDiv.style.display = 'block';
    resultDiv.className = 'error-summary';
    resultDiv.innerHTML = `
        <h5><i class="bi bi-exclamation-circle"></i> 수집 실패</h5>
        <p class="mb-0">${error}</p>
    `;
    
    addLog(`[ERROR] 수집 실패: ${error}`);
}

// UI 초기화
function resetUI() {
    document.getElementById('startBtn').style.display = 'inline-block';
    document.getElementById('stopBtn').style.display = 'none';
    document.getElementById('collectionProgress').classList.remove('active');
    updateProgressBar(0, '대기 중...');
    
    if (collectionInterval) {
        clearInterval(collectionInterval);
        collectionInterval = null;
    }
    
    if (logInterval) {
        clearInterval(logInterval);
        logInterval = null;
    }
}

// 로그 추가
function addLog(message, autoScroll = true) {
    const logViewer = document.getElementById('logViewer');
    const timestamp = new Date().toLocaleTimeString('ko-KR');
    const logEntry = `[${timestamp}] ${message}\n`;
    
    if (logViewer.textContent === '대기 중...') {
        logViewer.textContent = '';
    }
    
    logViewer.textContent += logEntry;
    
    if (autoScroll) {
        logViewer.scrollTop = logViewer.scrollHeight;
    }
}

// 로그 초기화
function clearLogs() {
    document.getElementById('logViewer').textContent = '대기 중...';
}

// 로딩 표시
function showLoading(text) {
    document.getElementById('loadingText').textContent = text || '처리 중...';
    new bootstrap.Modal(document.getElementById('loadingModal')).show();
}

// 로딩 숨기기
function hideLoading() {
    bootstrap.Modal.getInstance(document.getElementById('loadingModal'))?.hide();
}

// 알림 표시
function showAlert(type, message) {
    const alertClass = type === 'error' ? 'danger' : type;
    const alertHtml = `
        <div class="alert alert-${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    const container = document.querySelector('.collector-container');
    container.insertAdjacentHTML('afterbegin', alertHtml);
    
    // 5초 후 자동 제거
    setTimeout(() => {
        container.querySelector('.alert')?.remove();
    }, 5000);
}
</script>
{% endblock %}