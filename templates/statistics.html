{% extends "base.html" %}

{% block title %}통계 분석 - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- 페이지 헤더 -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-6 mb-0">
                <i class="bi bi-graph-up-arrow text-primary"></i> 통계 분석
            </h1>
            <p class="text-muted mt-2">블랙리스트 데이터 심층 분석 및 인사이트</p>
        </div>
    </div>

    <!-- 필터 컨트롤 -->
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="modern-card">
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">기간 선택</label>
                            <select class="form-select" id="dateRangeFilter">
                                <option value="7d">최근 7일</option>
                                <option value="30d" selected>최근 30일</option>
                                <option value="90d">최근 90일</option>
                                <option value="180d">최근 6개월</option>
                                <option value="365d">최근 1년</option>
                                <option value="all">전체 기간</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">데이터 소스</label>
                            <select class="form-select" id="sourceFilter">
                                <option value="all">전체 소스</option>
                                <option value="regtech">REGTECH</option>
                                <option value="secudium">SECUDIUM</option>
                                <option value="public">Public Sources</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">IP 유형</label>
                            <select class="form-select" id="ipTypeFilter">
                                <option value="all">전체 유형</option>
                                <option value="ipv4">IPv4</option>
                                <option value="ipv6">IPv6</option>
                                <option value="cidr">CIDR Range</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary w-100" onclick="statisticsDashboard.refreshAllCharts()">
                                <i class="bi bi-arrow-clockwise"></i> 새로고침
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 요약 카드 -->
    <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="stat-card border-start border-primary border-5">
                <div class="card-body">
                    <h6 class="text-muted mb-2">총 위협 IP</h6>
                    <h3 class="mb-0" id="totalThreats">0</h3>
                    <small class="text-success">
                        <i class="bi bi-arrow-up"></i> 12% 증가
                    </small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card border-start border-danger border-5">
                <div class="card-body">
                    <h6 class="text-muted mb-2">활성 위협</h6>
                    <h3 class="mb-0" id="activeThreats">0</h3>
                    <small class="text-danger">
                        <i class="bi bi-arrow-up"></i> 5% 증가
                    </small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card border-start border-success border-5">
                <div class="card-body">
                    <h6 class="text-muted mb-2">차단률</h6>
                    <h3 class="mb-0" id="blockRate">0%</h3>
                    <small class="text-muted">
                        <i class="bi bi-dash"></i> 변동 없음
                    </small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card border-start border-info border-5">
                <div class="card-body">
                    <h6 class="text-muted mb-2">평균 대응 시간</h6>
                    <h3 class="mb-0" id="avgResponseTime">0분</h3>
                    <small class="text-success">
                        <i class="bi bi-arrow-down"></i> 15% 개선
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- 차트 섹션 -->
    <div class="row g-4 mb-4">
        <!-- 탐지 트렌드 -->
        <div class="col-lg-8">
            <div class="modern-card h-100">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-graph-up text-primary"></i> 탐지 트렌드
                        </h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary active">일별</button>
                            <button type="button" class="btn btn-outline-primary">주별</button>
                            <button type="button" class="btn btn-outline-primary">월별</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 400px;">
                        <canvas id="detectionTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 소스별 분포 -->
        <div class="col-lg-4">
            <div class="modern-card h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-pie-chart-fill text-info"></i> 소스별 분포
                    </h5>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 300px;">
                        <canvas id="sourceDistributionChart"></canvas>
                    </div>
                    <div class="mt-3" id="sourceDistributionLegend">
                        <!-- 동적으로 채워집니다 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <!-- IP 유형 분포 -->
        <div class="col-lg-4">
            <div class="modern-card h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-bar-chart-fill text-success"></i> IP 유형별 분포
                    </h5>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 300px;">
                        <canvas id="ipTypeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 지리적 분포 -->
        <div class="col-lg-4">
            <div class="modern-card h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-globe text-warning"></i> 지리적 분포
                    </h5>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 300px;">
                        <canvas id="geographicChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 시간대별 활동 -->
        <div class="col-lg-4">
            <div class="modern-card h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history text-danger"></i> 시간대별 활동
                    </h5>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 300px;">
                        <canvas id="hourlyActivityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 위협 레벨 분석 -->
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="modern-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-exclamation-triangle-fill text-danger"></i> 위협 레벨 분석
                    </h5>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 300px;">
                        <canvas id="threatLevelChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 통계 내보내기 -->
        <div class="col-lg-6">
            <div class="modern-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-download text-primary"></i> 통계 내보내기
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-4">
                        현재 필터 설정에 따른 통계 데이터를 다양한 형식으로 내보낼 수 있습니다.
                    </p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" id="exportStats">
                            <i class="bi bi-filetype-csv"></i> CSV 형식으로 내보내기
                        </button>
                        <button class="btn btn-outline-primary" onclick="window.print()">
                            <i class="bi bi-printer"></i> 보고서 인쇄
                        </button>
                    </div>
                    <hr class="my-4">
                    <h6>빠른 통계</h6>
                    <div class="small text-muted">
                        <div class="d-flex justify-content-between mb-2">
                            <span>마지막 업데이트:</span>
                            <span id="lastRefreshTime">-</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>분석 기간:</span>
                            <span id="analysisPeriod">30일</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>데이터 포인트:</span>
                            <span id="dataPoints">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 로딩 오버레이 -->
<div id="statisticsLoading" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.stat-card {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.modern-card {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    border: 1px solid rgba(0,0,0,0.05);
}

.card-header {
    border-bottom: 1px solid rgba(0,0,0,0.05);
    padding: 1rem 1.25rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// 페이지 로드 시 통계 대시보드 초기화
document.addEventListener('DOMContentLoaded', function() {
    if (typeof initializeStatisticsDashboard === 'function') {
        window.statisticsDashboard = initializeStatisticsDashboard();
    }
});
</script>
{% endblock %}