{% extends "base.html" %}

{% block title %}통계 분석 - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- 페이지 헤더 -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-6 mb-0">
                <i class="bi bi-graph-up-arrow text-primary"></i> 통계 분석
            </h1>
            <p class="text-muted mt-2">블랙리스트 데이터 심층 분석 및 인사이트</p>
        </div>
    </div>

    <!-- 필터 컨트롤 -->
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="modern-card">
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">기간 선택</label>
                            <select class="form-select" id="dateRangeFilter">
                                <option value="7d">최근 7일</option>
                                <option value="30d" selected>최근 30일</option>
                                <option value="90d">최근 90일</option>
                                <option value="180d">최근 6개월</option>
                                <option value="365d">최근 1년</option>
                                <option value="all">전체 기간</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">데이터 소스</label>
                            <select class="form-select" id="sourceFilter">
                                <option value="all">전체 소스</option>
                                <option value="regtech">REGTECH</option>
                                <option value="secudium">SECUDIUM</option>
                                <option value="public">Public Sources</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">IP 유형</label>
                            <select class="form-select" id="ipTypeFilter">
                                <option value="all">전체 유형</option>
                                <option value="ipv4">IPv4</option>
                                <option value="ipv6">IPv6</option>
                                <option value="cidr">CIDR Range</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary w-100" onclick="statisticsDashboard.refreshAllCharts()">
                                <i class="bi bi-arrow-clockwise"></i> 새로고침
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 요약 카드 -->
    <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="stat-card border-start border-primary border-5">
                <div class="card-body">
                    <h6 class="text-muted mb-2">총 위협 IP</h6>
                    <h3 class="mb-0" id="totalThreats">0</h3>
                    <small class="text-success">
                        <i class="bi bi-arrow-up"></i> 12% 증가
                    </small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card border-start border-danger border-5">
                <div class="card-body">
                    <h6 class="text-muted mb-2">활성 위협</h6>
                    <h3 class="mb-0" id="activeThreats">0</h3>
                    <small class="text-danger">
                        <i class="bi bi-arrow-up"></i> 5% 증가
                    </small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card border-start border-success border-5">
                <div class="card-body">
                    <h6 class="text-muted mb-2">차단률</h6>
                    <h3 class="mb-0" id="blockRate">0%</h3>
                    <small class="text-muted">
                        <i class="bi bi-dash"></i> 변동 없음
                    </small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card border-start border-info border-5">
                <div class="card-body">
                    <h6 class="text-muted mb-2">평균 대응 시간</h6>
                    <h3 class="mb-0" id="avgResponseTime">0분</h3>
                    <small class="text-success">
                        <i class="bi bi-arrow-down"></i> 15% 개선
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- 차트 섹션 -->
    <div class="row g-4 mb-4">
        <!-- 탐지 트렌드 -->
        <div class="col-lg-8">
            <div class="modern-card h-100">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-graph-up text-primary"></i> 탐지 트렌드
                        </h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary active">일별</button>
                            <button type="button" class="btn btn-outline-primary">주별</button>
                            <button type="button" class="btn btn-outline-primary">월별</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 400px;">
                        <canvas id="detectionTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 소스별 분포 -->
        <div class="col-lg-4">
            <div class="modern-card h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-pie-chart-fill text-info"></i> 소스별 분포
                    </h5>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 300px;">
                        <canvas id="sourceDistributionChart"></canvas>
                    </div>
                    <div class="mt-3" id="sourceDistributionLegend">
                        <!-- 동적으로 채워집니다 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <!-- IP 유형 분포 -->
        <div class="col-lg-4">
            <div class="modern-card h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-bar-chart-fill text-success"></i> IP 유형별 분포
                    </h5>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 300px;">
                        <canvas id="ipTypeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 지리적 분포 -->
        <div class="col-lg-4">
            <div class="modern-card h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-globe text-warning"></i> 지리적 분포
                    </h5>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 300px;">
                        <canvas id="geographicChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 시간대별 활동 -->
        <div class="col-lg-4">
            <div class="modern-card h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history text-danger"></i> 시간대별 활동
                    </h5>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 300px;">
                        <canvas id="hourlyActivityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 위협 레벨 분석 -->
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="modern-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-exclamation-triangle-fill text-danger"></i> 위협 레벨 분석
                    </h5>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 300px;">
                        <canvas id="threatLevelChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 통계 내보내기 -->
        <div class="col-lg-6">
            <div class="modern-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-download text-primary"></i> 통계 내보내기
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-4">
                        현재 필터 설정에 따른 통계 데이터를 다양한 형식으로 내보낼 수 있습니다.
                    </p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" id="exportStats">
                            <i class="bi bi-filetype-csv"></i> CSV 형식으로 내보내기
                        </button>
                        <button class="btn btn-outline-primary" onclick="window.print()">
                            <i class="bi bi-printer"></i> 보고서 인쇄
                        </button>
                    </div>
                    <hr class="my-4">
                    <h6>빠른 통계</h6>
                    <div class="small text-muted">
                        <div class="d-flex justify-content-between mb-2">
                            <span>마지막 업데이트:</span>
                            <span id="lastRefreshTime">-</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>분석 기간:</span>
                            <span id="analysisPeriod">30일</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>데이터 포인트:</span>
                            <span id="dataPoints">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 로딩 오버레이 -->
<div id="statisticsLoading" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.stat-card {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.modern-card {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    border: 1px solid rgba(0,0,0,0.05);
}

.card-header {
    border-bottom: 1px solid rgba(0,0,0,0.05);
    padding: 1rem 1.25rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Statistics Dashboard Class
class StatisticsDashboard {
    constructor() {
        this.charts = {};
        this.data = {};
        this.filters = {
            dateRange: '30d',
            source: 'all',
            ipType: 'all'
        };
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.loadInitialData();
        this.initializeCharts();
    }

    setupEventListeners() {
        // Filter controls
        document.getElementById('dateRangeFilter').addEventListener('change', (e) => {
            this.filters.dateRange = e.target.value;
            this.refreshAllCharts();
        });

        document.getElementById('sourceFilter').addEventListener('change', (e) => {
            this.filters.source = e.target.value;
            this.refreshAllCharts();
        });

        document.getElementById('ipTypeFilter').addEventListener('change', (e) => {
            this.filters.ipType = e.target.value;
            this.refreshAllCharts();
        });

        // Export button
        document.getElementById('exportStats').addEventListener('click', () => {
            this.exportStatistics();
        });
    }

    async loadInitialData() {
        this.showLoading();
        try {
            // Load multiple data sources in parallel
            const [systemHealth, enhancedData, monthlyData] = await Promise.all([
                this.fetchSystemHealth(),
                this.fetchEnhancedBlacklist(),
                this.fetchMonthlyData()
            ]);

            this.data = {
                systemHealth,
                enhancedData,
                monthlyData
            };

            this.updateSummaryCards();
            this.updateLastRefreshTime();
            
        } catch (error) {
            console.error('Failed to load initial data:', error);
            this.showError('데이터 로드 실패: ' + error.message);
        } finally {
            this.hideLoading();
        }
    }

    async fetchSystemHealth() {
        const response = await fetch('/api/stats');
        if (!response.ok) throw new Error('System health API failed');
        return response.json();
    }

    async fetchEnhancedBlacklist() {
        const params = new URLSearchParams({
            per_page: 1000,
            source: this.filters.source !== 'all' ? this.filters.source : ''
        });
        
        const response = await fetch(`/api/blacklist/enhanced?${params}`);
        if (!response.ok) throw new Error('Enhanced blacklist API failed');
        return response.json();
    }

    async fetchMonthlyData() {
        const response = await fetch('/api/stats/monthly-data');
        if (!response.ok) throw new Error('Monthly data API failed');
        return response.json();
    }

    updateSummaryCards() {
        const { systemHealth, enhancedData } = this.data;
        
        // Update total threats
        const totalThreats = systemHealth?.total_ips || enhancedData?.pagination?.total || 0;
        document.getElementById('totalThreats').textContent = totalThreats.toLocaleString();

        // Update active threats
        const activeThreats = enhancedData?.expiry_stats?.active || systemHealth?.active_ips || 0;
        document.getElementById('activeThreats').textContent = activeThreats.toLocaleString();

        // Calculate block rate
        const blockRate = totalThreats > 0 ? Math.round((activeThreats / totalThreats) * 100) : 0;
        document.getElementById('blockRate').textContent = blockRate + '%';

        // Update data sources count
        const activeSources = Object.keys(systemHealth?.sources || {}).filter(
            key => systemHealth.sources[key]?.enabled
        ).length;
        document.getElementById('dataSources').textContent = activeSources;

        // Update data points
        document.getElementById('dataPoints').textContent = (enhancedData?.data?.length || 0).toLocaleString();
    }

    initializeCharts() {
        this.createTrendChart();
        this.createSourceChart();
        this.createThreatLevelChart();
        this.createIpTypeChart();
        this.createGeographicChart();
        this.createHourlyActivityChart();
    }

    createTrendChart() {
        const ctx = document.getElementById('detectionTrendChart').getContext('2d');
        const monthlyData = this.data.monthlyData || [];
        
        // Prepare data for the last 12 months
        const labels = monthlyData.map(item => item.label || item.month).slice(-12);
        const data = monthlyData.map(item => item.total_ips || item.count || 0).slice(-12);

        this.charts.trend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '블랙리스트 IP 수',
                    data: data,
                    borderColor: '#5046e5',
                    backgroundColor: 'rgba(80, 70, 229, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    createSourceChart() {
        const ctx = document.getElementById('sourceDistributionChart').getContext('2d');
        const { systemHealth } = this.data;
        
        const regtechCount = systemHealth?.regtech_count || 0;
        const secudiumCount = systemHealth?.secudium_count || 0;
        const publicCount = systemHealth?.public_count || 0;

        this.charts.source = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['REGTECH', 'SECUDIUM', 'Public'],
                datasets: [{
                    data: [regtechCount, secudiumCount, publicCount],
                    backgroundColor: ['#5046e5', '#10b981', '#f59e0b'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    createThreatLevelChart() {
        const ctx = document.getElementById('threatLevelChart').getContext('2d');
        const { enhancedData } = this.data;
        
        const stats = enhancedData?.expiry_stats || {};
        const active = stats.active || 0;
        const warning = stats.warning || 0;
        const expired = stats.expired || 0;

        this.charts.threatLevel = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['활성', '주의 (7일 내 만료)', '만료됨'],
                datasets: [{
                    label: 'IP 수',
                    data: [active, warning, expired],
                    backgroundColor: ['#10b981', '#f59e0b', '#dc2626'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    createIpTypeChart() {
        const ctx = document.getElementById('ipTypeChart').getContext('2d');
        
        // 예시 데이터 (실제로는 API에서 가져와야 함)
        const ipv4Count = this.data.enhancedData?.data?.filter(item => 
            item.ip.includes('.') && !item.ip.includes(':')
        ).length || 0;
        const ipv6Count = this.data.enhancedData?.data?.filter(item => 
            item.ip.includes(':')
        ).length || 0;
        const cidrCount = this.data.enhancedData?.data?.filter(item => 
            item.ip.includes('/')
        ).length || 0;

        this.charts.ipType = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['IPv4', 'IPv6', 'CIDR'],
                datasets: [{
                    label: 'IP 개수',
                    data: [ipv4Count, ipv6Count, cidrCount],
                    backgroundColor: ['#10b981', '#3b82f6', '#f59e0b'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    createGeographicChart() {
        const ctx = document.getElementById('geographicChart').getContext('2d');
        
        // 예시 데이터 (실제로는 API에서 가져와야 함)
        const countries = {};
        this.data.enhancedData?.data?.forEach(item => {
            const country = item.country || 'Unknown';
            countries[country] = (countries[country] || 0) + 1;
        });

        const topCountries = Object.entries(countries)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);

        this.charts.geographic = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: topCountries.map(([country]) => country),
                datasets: [{
                    data: topCountries.map(([, count]) => count),
                    backgroundColor: [
                        '#5046e5', '#10b981', '#f59e0b', '#dc2626', '#8b5cf6',
                        '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6b7280'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '50%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            fontSize: 10
                        }
                    }
                }
            }
        });
    }

    createHourlyActivityChart() {
        const ctx = document.getElementById('hourlyActivityChart').getContext('2d');
        
        // 예시 데이터 (시간대별 활동)
        const hourlyData = Array.from({length: 24}, (_, i) => Math.floor(Math.random() * 100));

        this.charts.hourlyActivity = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: 24}, (_, i) => i + '시'),
                datasets: [{
                    label: '탐지 건수',
                    data: hourlyData,
                    borderColor: '#dc2626',
                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    async refreshAllCharts() {
        this.showLoading();
        try {
            await this.loadInitialData();
            
            // Destroy existing charts
            Object.values(this.charts).forEach(chart => chart.destroy());
            this.charts = {};
            
            // Recreate charts
            this.initializeCharts();
            
        } catch (error) {
            console.error('Failed to refresh charts:', error);
            this.showError('차트 새로고침 실패: ' + error.message);
        } finally {
            this.hideLoading();
        }
    }

    exportStatistics() {
        const csvData = this.generateCSVData();
        const blob = new Blob([csvData], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `blacklist_statistics_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
    }

    generateCSVData() {
        const { enhancedData } = this.data;
        const headers = ['ID', 'IP', '등록일', '만료일', '소스', '국가', '공격유형', '상태'];
        
        let csv = headers.join(',') + '\n';
        
        if (enhancedData?.data) {
            enhancedData.data
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at)) // 최근 등록일부터 정렬
                .forEach(item => {
                    const row = [
                        item.id,
                        item.ip,
                        item.created_at.split('T')[0],
                        item.expiry_date,
                        item.source,
                        item.country,
                        item.attack_type,
                        item.expiry_status
                    ];
                    csv += row.join(',') + '\n';
                });
        }
        
        return csv;
    }

    updateLastRefreshTime() {
        const now = new Date().toLocaleString('ko-KR');
        document.getElementById('lastRefreshTime').textContent = now;
        
        // Update analysis period
        const periodMap = {
            '7d': '7일',
            '30d': '30일',
            '90d': '90일',
            '180d': '6개월',
            '365d': '1년',
            'all': '전체'
        };
        document.getElementById('analysisPeriod').textContent = periodMap[this.filters.dateRange] || '30일';
    }

    showLoading() {
        document.getElementById('statisticsLoading').style.display = 'flex';
    }

    hideLoading() {
        document.getElementById('statisticsLoading').style.display = 'none';
    }

    showError(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 end-0 m-3';
        alert.style.zIndex = '9999';
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 5000);
    }
}

// Initialize statistics dashboard
let statisticsDashboard;
document.addEventListener('DOMContentLoaded', function() {
    statisticsDashboard = new StatisticsDashboard();
});
</script>
{% endblock %}

{% block extra_js %}
<script>
// 페이지 로드 시 통계 대시보드 초기화
document.addEventListener('DOMContentLoaded', function() {
    if (typeof initializeStatisticsDashboard === 'function') {
        window.statisticsDashboard = initializeStatisticsDashboard();
    }
});
</script>
{% endblock %}