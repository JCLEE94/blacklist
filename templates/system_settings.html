{% extends "base.html" %}

{% block title %}시스템 설정 - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-6 mb-0">
                <i class="bi bi-gear-fill text-primary"></i> 시스템 설정
            </h1>
            <p class="text-muted mt-2">수집기 제어 및 시스템 설정 관리</p>
        </div>
    </div>

    <!-- Collection Control Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-toggle2-on"></i> 수집기 제어
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Master Collection Control -->
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle"></i> 
                        수집기를 활성화하면 설정된 주기에 따라 자동으로 데이터를 수집합니다.
                        비활성화하면 모든 자동 수집이 중단되지만, 수동 수집은 가능합니다.
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center justify-content-between p-3 border rounded">
                                <div>
                                    <h6 class="mb-1">마스터 수집 컨트롤</h6>
                                    <small class="text-muted">모든 수집기의 자동 수집을 제어합니다</small>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="masterCollectionSwitch" style="transform: scale(1.5);">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="status-icon bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                        <i class="bi bi-collection"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h4 class="mb-0" id="active-collectors">0</h4>
                                    <small class="text-muted">활성 수집기</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Individual Collectors Control -->
                    <h6 class="mb-3">개별 수집기 설정</h6>
                    <div class="row">
                        <!-- REGTECH -->
                        <div class="col-md-6 mb-3">
                            <div class="border rounded p-3">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <div>
                                        <h6 class="mb-0 text-primary">
                                            <i class="bi bi-bank"></i> REGTECH
                                        </h6>
                                        <small class="text-muted">금융보안원 위협 정보</small>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="regtechSwitch">
                                    </div>
                                </div>
                                <div class="small">
                                    <div class="d-flex justify-content-between">
                                        <span>상태:</span>
                                        <span class="badge bg-secondary" id="regtech-status">비활성</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>마지막 수집:</span>
                                        <span id="regtech-last-run">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SECUDIUM -->
                        <div class="col-md-6 mb-3">
                            <div class="border rounded p-3">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <div>
                                        <h6 class="mb-0 text-success">
                                            <i class="bi bi-shield-check"></i> SECUDIUM
                                        </h6>
                                        <small class="text-muted">보안 위협 정보</small>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="secudiumSwitch">
                                    </div>
                                </div>
                                <div class="small">
                                    <div class="d-flex justify-content-between">
                                        <span>상태:</span>
                                        <span class="badge bg-secondary" id="secudium-status">비활성</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>마지막 수집:</span>
                                        <span id="secudium-last-run">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Settings Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-sliders text-primary"></i> 시스템 설정
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Update Interval -->
                        <div class="col-md-6 mb-4">
                            <label class="form-label">자동 수집 주기</label>
                            <select class="form-select" id="updateInterval">
                                <option value="900000">15분</option>
                                <option value="1800000">30분</option>
                                <option value="3600000">1시간</option>
                                <option value="10800000" selected>3시간</option>
                                <option value="21600000">6시간</option>
                                <option value="43200000">12시간</option>
                                <option value="86400000">24시간</option>
                            </select>
                            <small class="text-muted">데이터 자동 수집 실행 간격</small>
                        </div>

                        <!-- Data Retention -->
                        <div class="col-md-6 mb-4">
                            <label class="form-label">데이터 보관 기간</label>
                            <select class="form-select" id="dataRetention">
                                <option value="30">30일</option>
                                <option value="60">60일</option>
                                <option value="90" selected>90일</option>
                                <option value="180">180일</option>
                                <option value="365">365일</option>
                            </select>
                            <small class="text-muted">오래된 데이터 자동 삭제 기준</small>
                        </div>

                        <!-- Cache TTL -->
                        <div class="col-md-6 mb-4">
                            <label class="form-label">캐시 유효 시간</label>
                            <select class="form-select" id="cacheTTL">
                                <option value="60">1분</option>
                                <option value="300" selected>5분</option>
                                <option value="600">10분</option>
                                <option value="1800">30분</option>
                                <option value="3600">1시간</option>
                            </select>
                            <small class="text-muted">API 응답 캐시 보관 시간</small>
                        </div>

                        <!-- Log Level -->
                        <div class="col-md-6 mb-4">
                            <label class="form-label">로그 레벨</label>
                            <select class="form-select" id="logLevel">
                                <option value="ERROR">ERROR - 오류만</option>
                                <option value="WARNING">WARNING - 경고 이상</option>
                                <option value="INFO" selected>INFO - 정보 이상</option>
                                <option value="DEBUG">DEBUG - 모든 로그</option>
                            </select>
                            <small class="text-muted">시스템 로그 기록 수준</small>
                        </div>
                    </div>

                    <div class="mt-4">
                        <button class="btn btn-primary" onclick="saveSettings()">
                            <i class="bi bi-save"></i> 설정 저장
                        </button>
                        <button class="btn btn-outline-secondary ms-2" onclick="resetSettings()">
                            <i class="bi bi-arrow-clockwise"></i> 기본값 복원
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Actions -->
    <div class="row">
        <div class="col-12">
            <div class="modern-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-tools text-warning"></i> 고급 작업
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning mb-3">
                        <i class="bi bi-exclamation-triangle"></i> 
                        아래 작업은 시스템에 중대한 영향을 미칠 수 있습니다. 신중하게 사용하세요.
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <button class="btn btn-outline-warning w-100" onclick="cleanupOldData()">
                                <i class="bi bi-calendar-x"></i> 오래된 데이터 정리
                            </button>
                        </div>
                        <div class="col-md-4 mb-3">
                            <button class="btn btn-outline-warning w-100" onclick="clearCache()">
                                <i class="bi bi-arrow-repeat"></i> 캐시 초기화
                            </button>
                        </div>
                        <div class="col-md-4 mb-3">
                            <button class="btn btn-outline-danger w-100" onclick="clearAllData()">
                                <i class="bi bi-trash3-fill"></i> 전체 DB 클리어
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.modern-card {
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.08);
    margin-bottom: 1.5rem;
    transition: all 0.3s ease;
}

.modern-card:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.card-header {
    border-radius: 0.75rem 0.75rem 0 0 !important;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.status-icon {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.8; }
    100% { opacity: 1; }
}

.form-check-input:checked {
    background-color: #667eea;
    border-color: #667eea;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #5a67d8 0%, #68428e 100%);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// System Settings JavaScript
class SystemSettings {
    constructor() {
        this.init();
    }
    
    init() {
        this.loadCurrentSettings();
        this.setupEventListeners();
        this.checkCollectionStatus();
    }
    
    // Load current settings from server
    async loadCurrentSettings() {
        try {
            const response = await fetch('/api/settings');
            const data = await response.json();
            
            if (data.success) {
                // Apply settings to UI
                this.applySettingsToUI(data.settings);
            }
        } catch (error) {
            console.error('Failed to load settings:', error);
        }
    }
    
    // Apply settings to UI elements
    applySettingsToUI(settings) {
        // Update interval
        const updateInterval = settings.update_interval || 10800000;
        document.getElementById('updateInterval').value = updateInterval;
        
        // Data retention
        const dataRetention = settings.data_retention || 90;
        document.getElementById('dataRetention').value = dataRetention;
        
        // Cache TTL
        const cacheTTL = settings.cache_ttl || 300;
        document.getElementById('cacheTTL').value = cacheTTL;
        
        // Log level
        const logLevel = settings.log_level || 'INFO';
        document.getElementById('logLevel').value = logLevel;
        
        // Store in localStorage for other pages
        localStorage.setItem('unifiedControlUpdateInterval', updateInterval);
    }
    
    // Setup event listeners
    setupEventListeners() {
        // Master switch
        document.getElementById('masterCollectionSwitch').addEventListener('change', (e) => {
            this.toggleMasterCollection(e.target.checked);
        });
        
        // Individual switches
        document.getElementById('regtechSwitch').addEventListener('change', (e) => {
            this.toggleCollector('regtech', e.target.checked);
        });
        
        document.getElementById('secudiumSwitch').addEventListener('change', (e) => {
            this.toggleCollector('secudium', e.target.checked);
        });
    }
    
    // Check collection status
    async checkCollectionStatus() {
        try {
            const response = await fetch('/api/collection/status');
            const data = await response.json();
            
            this.updateCollectionUI(data);
        } catch (error) {
            console.error('Failed to check collection status:', error);
        }
    }
    
    // Update collection UI
    updateCollectionUI(data) {
        // Master switch
        document.getElementById('masterCollectionSwitch').checked = data.collection_enabled;
        
        // Active collectors count
        const activeCount = Object.values(data.sources || {}).filter(s => s.enabled).length;
        document.getElementById('active-collectors').textContent = activeCount;
        
        // Individual collectors
        if (data.sources?.regtech) {
            document.getElementById('regtechSwitch').checked = data.sources.regtech.enabled;
            this.updateCollectorStatus('regtech', data.sources.regtech);
        }
        
        if (data.sources?.secudium) {
            document.getElementById('secudiumSwitch').checked = data.sources.secudium.enabled;
            this.updateCollectorStatus('secudium', data.sources.secudium);
        }
    }
    
    // Update collector status display
    updateCollectorStatus(collector, status) {
        const statusBadge = document.getElementById(`${collector}-status`);
        const lastRun = document.getElementById(`${collector}-last-run`);
        
        if (status.enabled) {
            statusBadge.className = 'badge bg-success';
            statusBadge.textContent = '활성';
        } else {
            statusBadge.className = 'badge bg-secondary';
            statusBadge.textContent = '비활성';
        }
        
        if (status.last_collection) {
            lastRun.textContent = new Date(status.last_collection).toLocaleString('ko-KR');
        }
    }
    
    // Toggle master collection
    async toggleMasterCollection(enable) {
        try {
            const endpoint = enable ? '/api/collection/enable' : '/api/collection/disable';
            const response = await fetch(endpoint, { method: 'POST' });
            const data = await response.json();
            
            if (data.success) {
                showNotification('success', enable ? '수집기가 활성화되었습니다.' : '수집기가 비활성화되었습니다.');
                this.checkCollectionStatus();
            } else {
                showNotification('error', data.error || '작업 실패');
                // Revert switch
                document.getElementById('masterCollectionSwitch').checked = !enable;
            }
        } catch (error) {
            console.error('Failed to toggle collection:', error);
            showNotification('error', '네트워크 오류가 발생했습니다.');
            // Revert switch
            document.getElementById('masterCollectionSwitch').checked = !enable;
        }
    }
    
    // Toggle individual collector
    async toggleCollector(collector, enable) {
        // For now, individual collector toggles will affect the master switch
        // You can implement individual control API endpoints later
        console.log(`Toggle ${collector}: ${enable}`);
        showNotification('info', '개별 수집기 제어는 준비 중입니다.');
    }
}

// Save settings
async function saveSettings() {
    const settings = {
        update_interval: parseInt(document.getElementById('updateInterval').value),
        data_retention: parseInt(document.getElementById('dataRetention').value),
        cache_ttl: parseInt(document.getElementById('cacheTTL').value),
        log_level: document.getElementById('logLevel').value
    };
    
    try {
        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('success', '설정이 저장되었습니다.');
            // Update localStorage
            localStorage.setItem('unifiedControlUpdateInterval', settings.update_interval);
        } else {
            showNotification('error', data.error || '설정 저장 실패');
        }
    } catch (error) {
        console.error('Failed to save settings:', error);
        showNotification('error', '네트워크 오류가 발생했습니다.');
    }
}

// Reset settings to defaults
function resetSettings() {
    if (confirm('모든 설정을 기본값으로 복원하시겠습니까?')) {
        document.getElementById('updateInterval').value = '10800000';
        document.getElementById('dataRetention').value = '90';
        document.getElementById('cacheTTL').value = '300';
        document.getElementById('logLevel').value = 'INFO';
        
        showNotification('info', '기본값으로 복원되었습니다. 저장 버튼을 클릭하여 적용하세요.');
    }
}

// Cleanup old data
async function cleanupOldData() {
    if (!confirm('오래된 데이터를 정리하시겠습니까?')) return;
    
    try {
        const response = await fetch('/api/maintenance/cleanup', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            showNotification('success', `${data.deleted_count || 0}개의 레코드가 정리되었습니다.`);
        } else {
            showNotification('error', data.error || '정리 작업 실패');
        }
    } catch (error) {
        console.error('Failed to cleanup data:', error);
        showNotification('error', '네트워크 오류가 발생했습니다.');
    }
}

// Clear cache
async function clearCache() {
    if (!confirm('모든 캐시를 초기화하시겠습니까?')) return;
    
    try {
        const response = await fetch('/api/maintenance/clear-cache', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            showNotification('success', '캐시가 초기화되었습니다.');
        } else {
            showNotification('error', data.error || '캐시 초기화 실패');
        }
    } catch (error) {
        console.error('Failed to clear cache:', error);
        showNotification('error', '네트워크 오류가 발생했습니다.');
    }
}

// Clear all data
async function clearAllData() {
    if (!confirm('정말로 모든 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다!')) return;
    if (!confirm('마지막 확인: 모든 블랙리스트 데이터가 삭제됩니다. 계속하시겠습니까?')) return;
    
    try {
        const response = await fetch('/api/db/clear', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            showNotification('success', '모든 데이터가 삭제되었습니다.');
            setTimeout(() => window.location.reload(), 2000);
        } else {
            showNotification('error', data.error || 'DB 클리어 실패');
        }
    } catch (error) {
        console.error('Failed to clear data:', error);
        showNotification('error', '네트워크 오류가 발생했습니다.');
    }
}

// Show notification
function showNotification(type, message) {
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    }[type] || 'alert-info';
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert ${alertClass} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Initialize on DOM load
document.addEventListener('DOMContentLoaded', () => {
    new SystemSettings();
});
</script>
{% endblock %}