{% extends "base.html" %}

{% block title %}í†µí•© ê´€ë¦¬ íŒ¨ë„ - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-6 mb-0">
                <i class="bi bi-gear-wide-connected text-primary"></i> í†µí•© ê´€ë¦¬ íŒ¨ë„
            </h1>
            <p class="text-muted mt-2">ìˆ˜ì§‘ ì œì–´ ë° ë°ì´í„° ê´€ë¦¬ë¥¼ í•œ ê³³ì—ì„œ</p>
        </div>
    </div>

    <!-- Collection Control Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card">
                <div class="card-header bg-light">
                    <div class="d-flex align-items-center justify-content-between">
                        <h5 class="mb-0">
                            <i class="bi bi-toggles text-primary"></i> ì „ì²´ ìˆ˜ì§‘ ì œì–´
                        </h5>
                        <div id="collection-status-badge">
                            <span class="badge bg-secondary">í™•ì¸ ì¤‘...</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <p class="mb-0">
                                ìˆ˜ì§‘ ê¸°ëŠ¥ì„ í™œì„±í™”í•˜ë©´ REGTECHì™€ SECUDIUMì—ì„œ ìë™ìœ¼ë¡œ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤.
                                <br>
                                <small class="text-warning">
                                    <i class="bi bi-exclamation-triangle"></i> 
                                    ì£¼ì˜: ìˆ˜ì§‘ í™œì„±í™” ì‹œ ê¸°ì¡´ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.
                                </small>
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group" role="group">
                                <button class="btn btn-success" id="enable-collection" onclick="toggleCollection(true)">
                                    <i class="bi bi-play-circle"></i> ìˆ˜ì§‘ í™œì„±í™”
                                </button>
                                <button class="btn btn-danger" id="disable-collection" onclick="toggleCollection(false)">
                                    <i class="bi bi-stop-circle"></i> ìˆ˜ì§‘ ë¹„í™œì„±í™”
                                </button>
                                <button class="btn btn-warning text-white" onclick="clearAllData()" data-bs-toggle="tooltip" title="ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ìƒˆë¡œ ì‹œì‘">
                                    <i class="bi bi-trash3"></i> DB í´ë¦¬ì–´
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Overview -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="modern-card border-start border-primary border-5">
                <div class="card-body">
                    <h6 class="text-muted mb-2">ì „ì²´ ë¸”ë™ë¦¬ìŠ¤íŠ¸ IP</h6>
                    <h3 class="mb-0" id="total-ips">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="modern-card border-start border-success border-5">
                <div class="card-body">
                    <h6 class="text-muted mb-2">í™œì„± ìˆ˜ì§‘ê¸°</h6>
                    <h3 class="mb-0" id="active-collectors">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="modern-card border-start border-warning border-5">
                <div class="card-body">
                    <h6 class="text-muted mb-2">ì˜¤ëŠ˜ ìˆ˜ì§‘ëœ IP</h6>
                    <h3 class="mb-0" id="today-collected">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="modern-card border-start border-info border-5">
                <div class="card-body">
                    <h6 class="text-muted mb-2">ë§ˆì§€ë§‰ ìˆ˜ì§‘</h6>
                    <h3 class="mb-0" id="last-collection">-</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Collection Control -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card">
                <div class="card-header bg-light">
                    <div class="d-flex align-items-center justify-content-between">
                        <h5 class="mb-0">
                            <i class="bi bi-calendar-day text-success"></i> ì¼ì¼ ìë™ ìˆ˜ì§‘ ì œì–´
                        </h5>
                        <div id="daily-collection-status-badge">
                            <span class="badge bg-secondary">í™•ì¸ ì¤‘...</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <p class="mb-0">
                                ì¼ì¼ ìë™ ìˆ˜ì§‘: ë§¤ì¼ ìµœê·¼ 3ì¼ê°„ì˜ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤ (ì¤‘ë³µ ì œê±°)
                                <br>
                                <small class="text-info">
                                    <i class="bi bi-info-circle"></i> 
                                    ì´ˆê¸° ìˆ˜ì§‘ ì‹œ: 3ê°œì›” ì´ë‚´ ëª¨ë“  ë°ì´í„° ìˆ˜ì§‘, ì´í›„ ì¼ì¼ ìˆ˜ì§‘: 3ì¼ ë°ì´í„°ë§Œ ìˆ˜ì§‘
                                </small>
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-success" id="enable-daily-collection" onclick="toggleDailyCollection(true)">
                                    <i class="bi bi-calendar-check"></i> ì¼ì¼ìˆ˜ì§‘ í™œì„±í™”
                                </button>
                                <button class="btn btn-outline-danger" id="disable-daily-collection" onclick="toggleDailyCollection(false)">
                                    <i class="bi bi-calendar-x"></i> ì¼ì¼ìˆ˜ì§‘ ë¹„í™œì„±í™”
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Individual Collectors -->
    <div class="row mb-4">
        <!-- REGTECH Collector -->
        <div class="col-lg-6 mb-4">
            <div class="modern-card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-bank"></i> REGTECH ìˆ˜ì§‘ê¸°
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>ìƒíƒœ</span>
                            <span class="badge bg-secondary" id="regtech-status">ë¹„í™œì„±</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>ë§ˆì§€ë§‰ ìˆ˜ì§‘</span>
                            <span id="regtech-last-run">-</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>ìˆ˜ì§‘ëœ IP ìˆ˜</span>
                            <span id="regtech-ip-count">0</span>
                        </div>
                    </div>
                    
                    <div class="progress mb-3" style="height: 20px;">
                        <div class="progress-bar bg-primary" id="regtech-progress" 
                             role="progressbar" style="width: 0%">0%</div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="triggerCollection('regtech')" 
                                id="regtech-trigger" disabled>
                            <i class="bi bi-cloud-download"></i> ìˆ˜ë™ ìˆ˜ì§‘ ì‹¤í–‰
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECUDIUM Collector -->
        <div class="col-lg-6 mb-4">
            <div class="modern-card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-shield-check"></i> SECUDIUM ìˆ˜ì§‘ê¸°
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>ìƒíƒœ</span>
                            <span class="badge bg-secondary" id="secudium-status">ë¹„í™œì„±</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>ë§ˆì§€ë§‰ ìˆ˜ì§‘</span>
                            <span id="secudium-last-run">-</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>ìˆ˜ì§‘ëœ IP ìˆ˜</span>
                            <span id="secudium-ip-count">0</span>
                        </div>
                    </div>
                    
                    <div class="progress mb-3" style="height: 20px;">
                        <div class="progress-bar bg-success" id="secudium-progress" 
                             role="progressbar" style="width: 0%">0%</div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="triggerCollection('secudium')" 
                                id="secudium-trigger" disabled>
                            <i class="bi bi-cloud-download"></i> ìˆ˜ë™ ìˆ˜ì§‘ ì‹¤í–‰
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Data Section -->
    <div class="modern-card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="bi bi-calendar-month text-primary"></i> ì›”ë³„ ë°ì´í„° í˜„í™©
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="monthly-data-table">
                    <thead>
                        <tr>
                            <th>ì›”</th>
                            <th>IP ìˆ˜</th>
                            <th>ì²« ê²€ì¶œ</th>
                            <th>ë§ˆì§€ë§‰ ê²€ì¶œ</th>
                            <th>ìƒíƒœ</th>
                            <th>ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6" class="text-center text-muted">ë°ì´í„° ë¡œë”© ì¤‘...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row">
        <div class="col-12">
            <div class="modern-card">
                <div class="card-body text-center">
                    <div class="btn-group" role="group">
                        <button class="btn btn-primary" onclick="refreshData()">
                            <i class="bi bi-arrow-clockwise"></i> ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                        </button>
                        <a href="/api/export/txt" class="btn btn-secondary">
                            <i class="bi bi-download"></i> TXT ë‚´ë³´ë‚´ê¸°
                        </a>
                        <a href="/api/export/json" class="btn btn-secondary">
                            <i class="bi bi-download"></i> JSON ë‚´ë³´ë‚´ê¸°
                        </a>
                        <button class="btn btn-warning" onclick="cleanupOldData()">
                            <i class="bi bi-trash"></i> ì˜¤ë˜ëœ ë°ì´í„° ì •ë¦¬
                        </button>
                        <button class="btn btn-danger" onclick="clearAllData()">
                            <i class="bi bi-trash3-fill"></i> DB í´ë¦¬ì–´
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Collection Logs -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="modern-card">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-journal-text text-info"></i> ìˆ˜ì§‘ ë¡œê·¸
                        </h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs()">
                            <i class="bi bi-trash"></i> ë¡œê·¸ ì§€ìš°ê¸°
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="log-viewer" id="collection-logs">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-clock-history"></i> ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.log-viewer {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 1rem;
    height: 300px;
    overflow-y: auto;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 0.875rem;
}

.log-entry {
    margin-bottom: 0.5rem;
    padding: 0.5rem;
    border-radius: 0.25rem;
    animation: fadeIn 0.3s;
}

.log-entry.info {
    background: rgba(13, 110, 253, 0.1);
    border-left: 3px solid #0d6efd;
}

.log-entry.success {
    background: rgba(25, 135, 84, 0.1);
    border-left: 3px solid #198754;
}

.log-entry.warning {
    background: rgba(255, 193, 7, 0.1);
    border-left: 3px solid #ffc107;
}

.log-entry.error {
    background: rgba(220, 53, 69, 0.1);
    border-left: 3px solid #dc3545;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Unified Control JavaScript
class UnifiedControl {
    constructor() {
        this.statusInterval = null;
        this.logBuffer = [];
        this.maxLogs = 100;
        this.monthlyData = [];
        
        // localStorageì—ì„œ ë¡œê·¸ ë³µì›
        this.loadLogsFromStorage();
        
        this.init();
    }
    
    init() {
        this.checkCollectionStatus();
        this.loadMonthlyData();
        this.loadCollectionLogs(); // ì„œë²„ì—ì„œ ë¡œê·¸ ë¡œë“œ
        this.startStatusPolling();
        this.renderLogs(); // ì €ì¥ëœ ë¡œê·¸ í‘œì‹œ
    }
    
    // localStorageì—ì„œ ë¡œê·¸ ë¡œë“œ
    loadLogsFromStorage() {
        try {
            const savedLogs = localStorage.getItem('unifiedControlLogs');
            if (savedLogs) {
                this.logBuffer = JSON.parse(savedLogs);
                // ì˜¤ë˜ëœ ë¡œê·¸ ì œê±° (24ì‹œê°„ ì´ìƒ)
                const now = new Date().getTime();
                this.logBuffer = this.logBuffer.filter(log => {
                    const logTime = new Date(log.fullTimestamp).getTime();
                    return (now - logTime) < (24 * 60 * 60 * 1000);
                });
            }
        } catch (error) {
            console.error('Failed to load logs from storage:', error);
            this.logBuffer = [];
        }
    }
    
    // localStorageì— ë¡œê·¸ ì €ì¥
    saveLogsToStorage() {
        try {
            localStorage.setItem('unifiedControlLogs', JSON.stringify(this.logBuffer));
        } catch (error) {
            console.error('Failed to save logs to storage:', error);
        }
    }
    
    // Check collection status
    async checkCollectionStatus() {
        try {
            const response = await fetch('/api/collection/status');
            const data = await response.json();
            
            this.updateOverallStatus(data);
            this.updateCollectorStatus('regtech', data.sources?.regtech);
            this.updateCollectorStatus('secudium', data.sources?.secudium);
            
            // Update buttons
            document.getElementById('enable-collection').disabled = data.enabled;
            document.getElementById('disable-collection').disabled = !data.enabled;
            
            // Update trigger buttons
            document.getElementById('regtech-trigger').disabled = !data.enabled;
            document.getElementById('secudium-trigger').disabled = !data.enabled;
            
            // Check daily collection status
            this.checkDailyCollectionStatus();
            
        } catch (error) {
            console.error('Status check failed:', error);
            this.addLog('error', 'Failed to check collection status');
        }
    }
    
    // Check daily collection status
    async checkDailyCollectionStatus() {
        try {
            const response = await fetch('/api/collection/daily/status');
            const data = await response.json();
            
            if (data.success) {
                updateDailyCollectionStatus(data);
            } else {
                console.error('Daily collection status check failed:', data.error);
            }
        } catch (error) {
            console.error('Daily collection status check failed:', error);
        }
    }
    
    // Update overall status
    updateOverallStatus(data) {
        const statusBadge = document.querySelector('#collection-status-badge .badge');
        const totalIps = document.getElementById('total-ips');
        const activeCollectors = document.getElementById('active-collectors');
        const todayCollected = document.getElementById('today-collected');
        const lastCollection = document.getElementById('last-collection');
        
        if (data.enabled) {
            statusBadge.className = 'badge bg-success';
            statusBadge.textContent = 'ìˆ˜ì§‘ í™œì„±';
            activeCollectors.textContent = Object.values(data.sources || {})
                .filter(s => s.enabled).length;
        } else {
            statusBadge.className = 'badge bg-secondary';
            statusBadge.textContent = 'ìˆ˜ì§‘ ë¹„í™œì„±';
            activeCollectors.textContent = '0';
        }
        
        // Update stats
        if (data.stats) {
            totalIps.textContent = (data.stats.total_ips || 0).toLocaleString();
            todayCollected.textContent = (data.stats.today_collected || 0).toLocaleString();
        }
        
        if (data.last_collection) {
            lastCollection.textContent = this.formatTime(data.last_collection);
        }
    }
    
    // Update individual collector status
    updateCollectorStatus(collector, status) {
        if (!status) return;
        
        const elements = {
            status: document.getElementById(`${collector}-status`),
            lastRun: document.getElementById(`${collector}-last-run`),
            ipCount: document.getElementById(`${collector}-ip-count`),
            progress: document.getElementById(`${collector}-progress`)
        };
        
        // Status badge
        if (status.enabled) {
            if (status.running) {
                elements.status.className = 'badge bg-primary';
                elements.status.textContent = 'ìˆ˜ì§‘ ì¤‘';
            } else {
                elements.status.className = 'badge bg-success';
                elements.status.textContent = 'í™œì„±';
            }
        } else {
            elements.status.className = 'badge bg-secondary';
            elements.status.textContent = 'ë¹„í™œì„±';
        }
        
        // Last run
        if (status.last_collection) {
            elements.lastRun.textContent = this.formatTime(status.last_collection);
        }
        
        // IP count
        if (status.total_ips !== undefined) {
            elements.ipCount.textContent = status.total_ips.toLocaleString();
        }
        
        // Progress
        if (status.progress !== undefined) {
            elements.progress.style.width = `${status.progress}%`;
            elements.progress.textContent = `${status.progress}%`;
        }
    }
    
    // Load monthly data
    async loadMonthlyData() {
        try {
            const response = await fetch('/api/monthly-data');
            const data = await response.json();
            
            if (data.status === 'success') {
                this.monthlyData = data.monthly_data;
                this.displayMonthlyData();
            } else {
                // Fallback to stats API if monthly-data fails
                try {
                    const statsResponse = await fetch('/api/stats/monthly-data');
                    const statsData = await statsResponse.json();
                    
                    if (statsData && Array.isArray(statsData)) {
                        this.monthlyData = statsData.map(item => ({
                            month: item.label || item.month,
                            ip_count: item.total_ips || item.count || 0,
                            details: {
                                first_detection: '-',
                                last_detection: '-',
                                status: 'active'
                            }
                        }));
                        this.displayMonthlyData();
                    } else {
                        throw new Error('Invalid stats data format');
                    }
                } catch (statsError) {
                    console.error('Stats API also failed:', statsError);
                    this.generateFallbackMonthlyData();
                }
            }
        } catch (error) {
            console.error('Failed to load monthly data:', error);
            this.addLog('error', 'Failed to load monthly data');
            this.generateFallbackMonthlyData();
        }
    }
    
    // Generate fallback monthly data based on current stats
    generateFallbackMonthlyData() {
        try {
            const currentDate = new Date();
            const currentMonth = currentDate.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long' });
            
            // Get current total IPs from dashboard
            const totalIpsElement = document.getElementById('total-ips');
            const currentTotal = totalIpsElement ? parseInt(totalIpsElement.textContent) || 0 : 0;
            
            this.monthlyData = [{
                month: currentMonth,
                ip_count: currentTotal,
                details: {
                    first_detection: currentDate.toISOString().split('T')[0],
                    last_detection: currentDate.toISOString().split('T')[0],
                    status: 'active'
                }
            }];
            
            this.displayMonthlyData();
        } catch (error) {
            console.error('Failed to generate fallback data:', error);
            this.monthlyData = [];
            this.displayMonthlyData();
        }
    }
    
    // Display monthly data
    displayMonthlyData() {
        const tbody = document.querySelector('#monthly-data-table tbody');
        
        if (this.monthlyData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            return;
        }
        
        tbody.innerHTML = this.monthlyData.map(month => `
            <tr>
                <td><strong>${month.month}</strong></td>
                <td>${month.ip_count.toLocaleString()}</td>
                <td>${month.details.first_detection || '-'}</td>
                <td>${month.details.last_detection || '-'}</td>
                <td><span class="badge bg-success">${month.details.status}</span></td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="viewMonthDetails('${month.month}')">
                        <i class="bi bi-eye"></i> ìƒì„¸ë³´ê¸°
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    // Load collection logs from server
    async loadCollectionLogs() {
        try {
            const response = await fetch('/api/collection/logs');
            const data = await response.json();
            
            if (data.success && data.logs) {
                // ì„œë²„ì—ì„œ ë°›ì€ ë¡œê·¸ë¥¼ ê¸°ì¡´ ë¡œê·¸ì™€ ë³‘í•©
                data.logs.forEach(log => {
                    // ìƒì„¸ ì •ë³´ ì¶”ì¶œ
                    const details = log.details || {};
                    const message = this.formatCollectionLogMessage(log.source, log.action, details);
                    
                    this.addServerLog(
                        this.getLogLevel(log.action),
                        message,
                        log.source,
                        details,
                        log.timestamp
                    );
                });
                
                this.renderLogs();
            }
        } catch (error) {
            console.error('Failed to load collection logs:', error);
        }
    }
    
    // Format collection log message
    formatCollectionLogMessage(source, action, details) {
        const ip_count = details.ip_count || details.collected_count || 0;
        const sourceName = source === 'regtech' ? 'REGTECH' : 
                          source === 'secudium' ? 'SECUDIUM' : source.toUpperCase();
        
        switch (action) {
            case 'collection_start':
                return `${sourceName} ìˆ˜ì§‘ ì‹œì‘`;
            case 'collection_complete':
                return `${sourceName} ìˆ˜ì§‘ ì™„ë£Œ: ${ip_count.toLocaleString()}ê°œ IP`;
            case 'collection_error':
                return `${sourceName} ìˆ˜ì§‘ ì‹¤íŒ¨: ${details.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
            case 'db_clear':
                return `ë°ì´í„°ë² ì´ìŠ¤ í´ë¦¬ì–´: ${details.total_deleted || 0}ê°œ ë ˆì½”ë“œ ì‚­ì œ`;
            case 'enable':
                return `${sourceName} ìˆ˜ì§‘ í™œì„±í™”`;
            case 'disable':
                return `${sourceName} ìˆ˜ì§‘ ë¹„í™œì„±í™”`;
            default:
                return `${sourceName}: ${action}`;
        }
    }
    
    // Get log level based on action
    getLogLevel(action) {
        switch (action) {
            case 'collection_complete':
            case 'enable':
                return 'success';
            case 'collection_error':
                return 'error';
            case 'db_clear':
            case 'disable':
                return 'warning';
            default:
                return 'info';
        }
    }
    
    // Add server log (different from addLog to avoid duplicates)
    addServerLog(level, message, collector = null, details = null, timestamp = null) {
        const serverTimestamp = timestamp ? new Date(timestamp) : new Date();
        const displayTimestamp = serverTimestamp.toLocaleTimeString('ko-KR');
        const collectorTag = collector ? `[${collector.toUpperCase()}]` : '';
        
        // ìƒì„¸ ì •ë³´ í¬ë§·íŒ…
        let detailsHtml = '';
        if (details && Object.keys(details).length > 0) {
            const detailsArray = [];
            if (details.ip_count !== undefined) {
                detailsArray.push(`IP ê°œìˆ˜: ${details.ip_count.toLocaleString()}ê°œ`);
            }
            if (details.total_deleted !== undefined) {
                detailsArray.push(`ì‚­ì œëœ ë ˆì½”ë“œ: ${details.total_deleted.toLocaleString()}ê°œ`);
            }
            if (details.duration !== undefined) {
                detailsArray.push(`ì†Œìš”ì‹œê°„: ${details.duration}ì´ˆ`);
            }
            if (details.file_name) {
                detailsArray.push(`íŒŒì¼: ${details.file_name}`);
            }
            if (details.error) {
                detailsArray.push(`ì˜¤ë¥˜: ${details.error}`);
            }
            
            if (detailsArray.length > 0) {
                detailsHtml = `
                    <div class="log-details mt-2">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> ${detailsArray.join(' | ')}
                        </small>
                    </div>
                `;
            }
        }
        
        const logEntry = {
            timestamp: displayTimestamp,
            fullTimestamp: serverTimestamp.toISOString(),
            level,
            message,
            collector,
            details,
            html: `
                <div class="log-entry ${level}">
                    <div class="log-main">
                        <strong>${displayTimestamp}</strong> ${collectorTag} ${message}
                    </div>
                    ${detailsHtml}
                </div>
            `
        };
        
        // ì„œë²„ ë¡œê·¸ëŠ” ì¤‘ë³µ ì²´í¬ í›„ ì¶”ê°€
        const exists = this.logBuffer.some(log => 
            log.fullTimestamp === logEntry.fullTimestamp && 
            log.message === logEntry.message
        );
        
        if (!exists) {
            this.logBuffer.push(logEntry);
        }
        
        // Limit log buffer
        if (this.logBuffer.length > this.maxLogs) {
            this.logBuffer.shift();
        }
    }
    
    // Start status polling
    startStatusPolling() {
        this.statusInterval = setInterval(() => {
            this.checkCollectionStatus();
            this.loadCollectionLogs(); // ì£¼ê¸°ì ìœ¼ë¡œ ë¡œê·¸ë„ ì—…ë°ì´íŠ¸
        }, 15000); // Every 15 seconds
    }
    
    // Add log entry with detailed information
    addLog(level, message, collector = null, details = null) {
        const now = new Date();
        const timestamp = now.toLocaleTimeString('ko-KR');
        const collectorTag = collector ? `[${collector.toUpperCase()}]` : '';
        
        // ìƒì„¸ ì •ë³´ í¬ë§·íŒ…
        let detailsHtml = '';
        if (details && Object.keys(details).length > 0) {
            const detailsArray = [];
            if (details.ip_count !== undefined) {
                detailsArray.push(`IP ê°œìˆ˜: ${details.ip_count.toLocaleString()}ê°œ`);
            }
            if (details.total_deleted !== undefined) {
                detailsArray.push(`ì‚­ì œëœ ë ˆì½”ë“œ: ${details.total_deleted.toLocaleString()}ê°œ`);
            }
            if (details.cleared_tables) {
                detailsArray.push(`í´ë¦¬ì–´ëœ í…Œì´ë¸”: ${details.cleared_tables.join(', ')}`);
            }
            if (details.table_counts) {
                const tableCounts = Object.entries(details.table_counts)
                    .map(([table, count]) => `${table}: ${count}ê°œ`)
                    .join(', ');
                detailsArray.push(`í…Œì´ë¸”ë³„ ì‚­ì œ: ${tableCounts}`);
            }
            if (details.error) {
                detailsArray.push(`ì˜¤ë¥˜: ${details.error}`);
            }
            if (details.duration !== undefined) {
                detailsArray.push(`ì†Œìš”ì‹œê°„: ${details.duration}ì´ˆ`);
            }
            if (details.file_name) {
                detailsArray.push(`íŒŒì¼: ${details.file_name}`);
            }
            if (details.source_url) {
                detailsArray.push(`URL: ${details.source_url}`);
            }
            
            if (detailsArray.length > 0) {
                detailsHtml = `
                    <div class="log-details mt-2">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> ${detailsArray.join(' | ')}
                        </small>
                    </div>
                `;
            }
        }
        
        const logEntry = {
            timestamp,
            fullTimestamp: now.toISOString(),
            level,
            message,
            collector,
            details,
            html: `
                <div class="log-entry ${level}">
                    <div class="log-main">
                        <strong>${timestamp}</strong> ${collectorTag} ${message}
                    </div>
                    ${detailsHtml}
                </div>
            `
        };
        
        this.logBuffer.push(logEntry);
        
        // Limit log buffer
        if (this.logBuffer.length > this.maxLogs) {
            this.logBuffer.shift();
        }
        
        this.renderLogs();
        this.saveLogsToStorage(); // ë¡œê·¸ ì €ì¥
    }
    
    // Clear logs
    clearLogs() {
        this.logBuffer = [];
        this.saveLogsToStorage();
        this.renderLogs();
        this.addLog('info', 'ë¡œê·¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
    
    // Render logs
    renderLogs() {
        const logContainer = document.getElementById('collection-logs');
        
        if (this.logBuffer.length === 0) {
            logContainer.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="bi bi-clock-history"></i> ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
                </div>
            `;
            return;
        }
        
        logContainer.innerHTML = this.logBuffer
            .map(log => log.html)
            .reverse()
            .join('');
        
        // Auto scroll
        logContainer.scrollTop = 0;
    }
    
    // Clear logs
    clearLogs() {
        this.logBuffer = [];
        this.renderLogs();
        this.addLog('info', 'Logs cleared');
    }
    
    // Format time
    formatTime(timeString) {
        const date = new Date(timeString);
        const now = new Date();
        const diff = now - date;
        
        if (diff < 60000) {
            return 'ë°©ê¸ˆ ì „';
        }
        
        if (diff < 3600000) {
            return `${Math.floor(diff / 60000)}ë¶„ ì „`;
        }
        
        if (diff < 86400000) {
            return `${Math.floor(diff / 3600000)}ì‹œê°„ ì „`;
        }
        
        return date.toLocaleDateString('ko-KR');
    }
    
    // Cleanup
    destroy() {
        if (this.statusInterval) {
            clearInterval(this.statusInterval);
        }
    }
}

// Global instance
let unifiedControl = null;

// Toggle collection
async function toggleCollection(enable) {
    const action = enable ? 'enable' : 'disable';
    
    if (enable && !confirm('ìˆ˜ì§‘ì„ í™œì„±í™”í•˜ë©´ ê¸°ì¡´ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/collection/${action}`, { method: 'POST' });
        const data = await response.json();
        
        if (data.success || data.status === 'success') {
            showNotification(`ìˆ˜ì§‘ì´ ${enable ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            unifiedControl.checkCollectionStatus();
            unifiedControl.addLog('info', 
                `Collection ${enable ? 'enabled' : 'disabled'}`);
        } else {
            throw new Error(data.message || 'Operation failed');
        }
    } catch (error) {
        showNotification(`Error: ${error.message}`, 'danger');
        unifiedControl.addLog('error', `Failed to ${action} collection: ${error.message}`);
    }
}

// Trigger collection
async function triggerCollection(collector) {
    if (!confirm(`${collector.toUpperCase()} ìˆ˜ì§‘ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }
    
    try {
        const button = document.getElementById(`${collector}-trigger`);
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ìˆ˜ì§‘ ì¤‘...';
        
        const response = await fetch(`/api/collection/${collector}/trigger`, { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        });
        const data = await response.json();
        
        if (data.success === true) {
            showNotification(`${collector.toUpperCase()} ìˆ˜ì§‘ ì™„ë£Œ - ${data.ip_count || data.collected_count || 0}ê°œ IP`, 'success');
            
            // ìƒì„¸ ì •ë³´ ì¶”ì¶œ ë° ë¡œê·¸ ì¶”ê°€
            const details = {
                ip_count: data.ip_count || data.collected_count || 0,
                duration: data.duration,
                file_name: data.file_name,
                source_url: data.source_url,
                ...data.details
            };
            
            const sourceName = collector === 'regtech' ? 'REGTECH' : 
                              collector === 'secudium' ? 'SECUDIUM' : collector.toUpperCase();
            
            unifiedControl.addLog('success', 
                `${sourceName} ìˆ˜ì§‘ ì™„ë£Œ: ${details.ip_count.toLocaleString()}ê°œ IP`, 
                collector, details);
                
            // Refresh status and logs
            unifiedControl.checkCollectionStatus();
            unifiedControl.loadMonthlyData();
            unifiedControl.loadCollectionLogs(); // ìƒˆë¡œìš´ ë¡œê·¸ ë¡œë“œ
        } else {
            throw new Error(data.message || data.error || 'Collection failed');
        }
    } catch (error) {
        showNotification(`Error: ${error.message}`, 'danger');
        unifiedControl.addLog('error', 
            `${collector.toUpperCase()} collection failed: ${error.message}`, 
            collector);
    } finally {
        const button = document.getElementById(`${collector}-trigger`);
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-cloud-download"></i> ìˆ˜ë™ ìˆ˜ì§‘ ì‹¤í–‰';
    }
}

// View month details
function viewMonthDetails(month) {
    // Redirect to data management page with month parameter
    window.location.href = `/data-management?month=${month}`;
}

// Refresh data
async function refreshData() {
    showNotification('Refreshing data...', 'info');
    await unifiedControl.checkCollectionStatus();
    await unifiedControl.loadMonthlyData();
    showNotification('Data refreshed successfully', 'success');
}

// Cleanup old data
async function cleanupOldData() {
    if (!confirm('3ê°œì›” ì´ìƒ ëœ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/cleanup-old-data', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            showNotification('Old data cleaned up successfully', 'success');
            unifiedControl.addLog('success', `Cleaned up ${data.deleted_count || 0} old records`);
            await unifiedControl.loadMonthlyData();
        } else {
            throw new Error(data.message || 'Cleanup failed');
        }
    } catch (error) {
        showNotification(`Error: ${error.message}`, 'danger');
        unifiedControl.addLog('error', `Cleanup failed: ${error.message}`);
    }
}

// Clear logs
function clearLogs() {
    if (confirm('ëª¨ë“  ë¡œê·¸ë¥¼ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        unifiedControl.clearLogs();
    }
}

// Clear all database data
async function clearAllData() {
    if (!confirm('âš ï¸ ê²½ê³ : ëª¨ë“  ë°ì´í„°ë² ì´ìŠ¤ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.\n\nì •ë§ë¡œ ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    if (!confirm('ğŸš¨ ìµœì¢… í™•ì¸: ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!\n\nëª¨ë“  IP ë°ì´í„°, í†µê³„, ë¡œê·¸ê°€ ì‚­ì œë©ë‹ˆë‹¤.\n\nì •ë§ë¡œ DBë¥¼ í´ë¦¬ì–´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/database/clear', { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ confirm: true })
        });
        const data = await response.json();
        
        if (data.success) {
            showNotification('ë°ì´í„°ë² ì´ìŠ¤ê°€ ì„±ê³µì ìœ¼ë¡œ í´ë¦¬ì–´ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            
            // ìƒì„¸ ì •ë³´ ì¶”ì¶œ
            const details = {
                total_deleted: data.total_deleted,
                cleared_tables: data.cleared_tables,
                table_counts: data.table_counts,
                id_sequences_reset: data.id_sequences_reset,
                cache_cleared: data.cache_cleared
            };
            
            unifiedControl.addLog('warning', `Database cleared: ${data.message || 'All data removed'}`, null, details);
            // Refresh all data
            await unifiedControl.checkCollectionStatus();
            await unifiedControl.loadMonthlyData();
        } else {
            throw new Error(data.message || 'DB í´ë¦¬ì–´ ì‹¤íŒ¨');
        }
    } catch (error) {
        showNotification(`Error: ${error.message}`, 'danger');
        unifiedControl.addLog('error', `DB clear failed: ${error.message}`);
    }
}

// Toggle daily collection
async function toggleDailyCollection(enable) {
    try {
        const action = enable ? 'enable' : 'disable';
        const endpoint = `/api/collection/daily/${action}`;
        
        const response = await fetch(endpoint, { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                enable: enable,
                collection_strategy: enable ? 'daily_3days' : null 
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            const message = enable ? 'ì¼ì¼ ìë™ ìˆ˜ì§‘ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì¼ì¼ ìë™ ìˆ˜ì§‘ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.';
            showNotification(message, 'success');
            
            // Update daily collection status badge
            const dailyBadge = document.querySelector('#daily-collection-status-badge .badge');
            if (enable) {
                dailyBadge.className = 'badge bg-success';
                dailyBadge.textContent = 'ì¼ì¼ìˆ˜ì§‘ í™œì„±';
            } else {
                dailyBadge.className = 'badge bg-secondary';
                dailyBadge.textContent = 'ì¼ì¼ìˆ˜ì§‘ ë¹„í™œì„±';
            }
            
            // Update button states
            document.getElementById('enable-daily-collection').disabled = enable;
            document.getElementById('disable-daily-collection').disabled = !enable;
            
            // Add log entry
            const details = {
                strategy: enable ? '3ì¼ ë°ì´í„° ìˆ˜ì§‘' : 'ë¹„í™œì„±í™”',
                mode: enable ? 'ìë™ ì¼ì¼ ìˆ˜ì§‘' : 'ìˆ˜ë™ ìˆ˜ì§‘ë§Œ'
            };
            
            unifiedControl.addLog(enable ? 'success' : 'warning', 
                `Daily collection ${enable ? 'enabled' : 'disabled'}`, 
                'system', details);
                
            // Refresh collection status
            await unifiedControl.checkCollectionStatus();
        } else {
            throw new Error(data.message || `Failed to ${action} daily collection`);
        }
    } catch (error) {
        showNotification(`Error: ${error.message}`, 'danger');
        unifiedControl.addLog('error', `Daily collection toggle failed: ${error.message}`, 'system');
    }
}

// Check daily collection status (add to UnifiedControl class method)
// This will be called from checkCollectionStatus
function updateDailyCollectionStatus(data) {
    const dailyBadge = document.querySelector('#daily-collection-status-badge .badge');
    const dailyEnabled = data.daily_collection_enabled || false;
    
    if (dailyEnabled) {
        dailyBadge.className = 'badge bg-success';
        dailyBadge.textContent = 'ì¼ì¼ìˆ˜ì§‘ í™œì„±';
    } else {
        dailyBadge.className = 'badge bg-secondary';
        dailyBadge.textContent = 'ì¼ì¼ìˆ˜ì§‘ ë¹„í™œì„±';
    }
    
    // Update button states
    document.getElementById('enable-daily-collection').disabled = dailyEnabled;
    document.getElementById('disable-daily-collection').disabled = !dailyEnabled;
}

// Show notification
function showNotification(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    unifiedControl = new UnifiedControl();
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (unifiedControl) {
        unifiedControl.destroy();
    }
});
</script>
{% endblock %}