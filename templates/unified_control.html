{% extends "base.html" %}

{% block title %}í†µí•© ê´€ë¦¬ íŒ¨ë„ - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-6 mb-0">
                <i class="bi bi-gear-wide-connected text-primary"></i> í†µí•© ê´€ë¦¬ íŒ¨ë„
            </h1>
            <p class="text-muted mt-2">ìˆ˜ì§‘ ì œì–´ ë° ë°ì´í„° ê´€ë¦¬ë¥¼ í•œ ê³³ì—ì„œ</p>
        </div>
    </div>

    <!-- Main Control Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card">
                <div class="card-header bg-gradient-primary text-white">
                    <div class="d-flex align-items-center justify-content-between">
                        <h5 class="mb-0">
                            <i class="bi bi-calendar-week"></i> ì¼ë³„ IP ë°ì´í„° í˜„í™©
                        </h5>
                        <div id="collection-status-badge">
                            <span class="badge bg-light text-dark">ìë™ ìˆ˜ì§‘ ì¤‘</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Collection Status Overview -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="status-icon bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                        <i class="bi bi-database"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h4 class="mb-0" id="total-ips">0</h4>
                                    <small class="text-muted">ì „ì²´ IP</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="status-icon bg-info text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                        <i class="bi bi-calendar-day"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h4 class="mb-0" id="today-collected">0</h4>
                                    <small class="text-muted">ì˜¤ëŠ˜ ìˆ˜ì§‘</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="status-icon bg-warning text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                        <i class="bi bi-clock-history"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h4 class="mb-0" id="last-collection">-</h4>
                                    <small class="text-muted">ë§ˆì§€ë§‰ ìˆ˜ì§‘</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Daily Data Table -->
                    <div class="row">
                        <div class="col-12">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th><i class="bi bi-calendar3"></i> ë‚ ì§œ</th>
                                            <th><i class="bi bi-database"></i> ì „ì²´ IP</th>
                                            <th class="text-primary">REGTECH</th>
                                            <th class="text-info">Public</th>
                                            <th><i class="bi bi-plus-circle"></i> ì‹ ê·œ</th>
                                            <th><i class="bi bi-x-circle"></i> ë§Œë£Œ</th>
                                            <th>ìƒíƒœ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="daily-stats-tbody">
                                        <tr>
                                            <td colspan="8" class="text-center">
                                                <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                ì¼ë³„ ë°ì´í„° ë¡œë”© ì¤‘...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> 
                                    ìµœê·¼ 30ì¼ê°„ì˜ ì¼ë³„ ìˆ˜ì§‘ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤. ë°ì´í„°ëŠ” ë§¤ì¼ ìë™ìœ¼ë¡œ ìˆ˜ì§‘ë˜ë©° ì¤‘ë³µì´ ì œê±°ë©ë‹ˆë‹¤.
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ë‚ ì§œë³„ ìˆ˜ì§‘ ì‹œê°í™” ì°¨íŠ¸ -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="border rounded p-3 bg-light">
                                <h6 class="mb-3">
                                    <i class="bi bi-bar-chart-line"></i> ë‚ ì§œë³„ ìˆ˜ì§‘ íŠ¸ë Œë“œ
                                </h6>
                                <div style="height: 400px;">
                                    <canvas id="dailyCollectionChart"></canvas>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h5 class="mb-0 text-primary" id="chart-total-regtech">0</h5>
                                            <small class="text-muted">REGTECH ì´ê³„</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h5 class="mb-0 text-danger" id="chart-total-secudium">0</h5>
                                            <small class="text-muted">SECUDIUM ì´ê³„</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h5 class="mb-0 text-warning" id="chart-total-duplicates">0</h5>
                                            <small class="text-muted">ì¤‘ë³µ ì œê±°</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h5 class="mb-0 text-success" id="chart-collection-days">0</h5>
                                            <small class="text-muted">ìˆ˜ì§‘ ì¼ìˆ˜</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Collection Control Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card">
                <div class="card-header bg-gradient-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-play-circle"></i> ìˆ˜ì§‘ ì œì–´
                    </h5>
                </div>
                <div class="card-body">
                    <!-- ê¸°ê°„ ì„ íƒ UI -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="border rounded p-3 bg-light">
                                <h6 class="mb-3">
                                    <i class="bi bi-calendar-range"></i> ìˆ˜ì§‘ ê¸°ê°„ ì„¤ì •
                                </h6>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label for="manual-start-date" class="form-label">ì‹œì‘ì¼</label>
                                        <input type="date" class="form-control" id="manual-start-date">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="manual-end-date" class="form-label">ì¢…ë£Œì¼</label>
                                        <input type="date" class="form-control" id="manual-end-date">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">ì„¤ëª…</label>
                                        <div class="form-text mt-2">
                                            <i class="bi bi-info-circle"></i> 
                                            ê¸°ê°„ì„ ë¯¸ì§€ì •í•˜ë©´ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ìˆ˜ì§‘ë©ë‹ˆë‹¤. ê³¼ê±° ë°ì´í„° ìˆ˜ì§‘ ì‹œ ë²”ìœ„ë¥¼ ì§€ì •í•˜ì„¸ìš”.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="d-grid">
                                <button id="manual-collection-btn" class="btn btn-success btn-lg" onclick="triggerManualCollection()">
                                    <i class="bi bi-download-cloud"></i> ìˆ˜ë™ ìˆ˜ì§‘ ì‹œì‘
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid">
                                <button class="btn btn-outline-info btn-lg" onclick="showCookieSettings()">
                                    <i class="bi bi-gear"></i> REGTECH ì¿ í‚¤ ì„¤ì •
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid">
                                <button class="btn btn-outline-warning btn-lg" onclick="showAutoCollectionSettings()">
                                    <i class="bi bi-clock-history"></i> ìë™ ìˆ˜ì§‘ ì„¤ì •
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì‹œê°ì  ìˆ˜ì§‘ ë¡œê·¸ -->
                    <div class="mt-4">
                        <h6 class="text-muted mb-3">
                            <i class="bi bi-eye"></i> ì‹¤ì‹œê°„ ìˆ˜ì§‘ ìƒíƒœ
                        </h6>
                        <div class="log-viewer" id="visual-collection-log" style="height: 200px; overflow-y: auto; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px;">
                            <div class="text-center text-muted py-3">
                                <i class="bi bi-info-circle"></i> ìˆ˜ì§‘ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì‹¤ì‹œê°„ ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Management Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-tools text-primary"></i> ë°ì´í„° ê´€ë¦¬
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="d-grid">
                                <button class="btn btn-outline-primary" onclick="refreshData()">
                                    <i class="bi bi-arrow-clockwise"></i> ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                        <i class="bi bi-download"></i> ë‚´ë³´ë‚´ê¸°
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="/api/export/txt">
                                            <i class="bi bi-file-text"></i> TXT í˜•ì‹
                                        </a></li>
                                        <li><a class="dropdown-item" href="/api/export/json">
                                            <i class="bi bi-file-code"></i> JSON í˜•ì‹
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-warning dropdown-toggle" data-bs-toggle="dropdown">
                                        <i class="bi bi-trash"></i> ë°ì´í„° ì •ë¦¬
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="cleanupOldData()">
                                            <i class="bi bi-calendar-x"></i> ì˜¤ë˜ëœ ë°ì´í„° ì •ë¦¬
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="clearAllData()">
                                            <i class="bi bi-trash3-fill"></i> ì „ì²´ DB í´ë¦¬ì–´
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Collection Logs -->
    <div class="row">
        <div class="col-12">
            <div class="modern-card">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-journal-text text-info"></i> ìˆ˜ì§‘ ë¡œê·¸
                        </h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs()">
                            <i class="bi bi-trash"></i> ë¡œê·¸ ì§€ìš°ê¸°
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="log-viewer" id="collection-logs">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-clock-history"></i> ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.modern-card {
    background: white;
    border-radius: 1rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    border: 1px solid rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
}

.modern-card:hover {
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.status-icon {
    font-size: 1.25rem;
}

.log-viewer {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1rem;
    height: 300px;
    overflow-y: auto;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 0.875rem;
}

.log-entry {
    margin-bottom: 0.5rem;
    padding: 0.5rem;
    border-radius: 0.25rem;
    animation: fadeIn 0.3s;
}

.log-entry.info {
    background: rgba(13, 110, 253, 0.1);
    border-left: 3px solid #0d6efd;
}

.log-entry.success {
    background: rgba(25, 135, 84, 0.1);
    border-left: 3px solid #198754;
}

.log-entry.warning {
    background: rgba(255, 193, 7, 0.1);
    border-left: 3px solid #ffc107;
}

.log-entry.error {
    background: rgba(220, 53, 69, 0.1);
    border-left: 3px solid #dc3545;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Card animation */
.modern-card {
    opacity: 0;
    transform: translateY(20px);
    animation: slideUp 0.5s ease forwards;
}

@keyframes slideUp {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Stagger animation for cards */
.modern-card:nth-child(1) { animation-delay: 0.1s; }
.modern-card:nth-child(2) { animation-delay: 0.2s; }
.modern-card:nth-child(3) { animation-delay: 0.3s; }
.modern-card:nth-child(4) { animation-delay: 0.4s; }
</style>
{% endblock %}

{% block extra_js %}
<script>
// Unified Control JavaScript
class UnifiedControl {
    constructor() {
        this.statusInterval = null;
        this.logBuffer = [];
        this.maxLogs = 100;
        
        // ì„¤ì •ì—ì„œ ì—…ë°ì´íŠ¸ ê°„ê²© ê°€ì ¸ì˜¤ê¸° (ê¸°ë³¸ê°’: 3ì‹œê°„ = 10800000ms)
        this.updateInterval = parseInt(localStorage.getItem('unifiedControlUpdateInterval')) || 10800000;
        
        // localStorageì—ì„œ ë¡œê·¸ ë³µì›
        this.loadLogsFromStorage();
        
        this.init();
    }
    
    init() {
        this.checkCollectionStatus();
        this.loadCollectionLogs(); // ì„œë²„ì—ì„œ ë¡œê·¸ ë¡œë“œ
        this.loadDailyStats(); // ì¼ë³„ ë°ì´í„° ë¡œë“œ
        this.startStatusPolling();
        this.renderLogs(); // ì €ì¥ëœ ë¡œê·¸ í‘œì‹œ
    }
    
    // localStorageì—ì„œ ë¡œê·¸ ë¡œë“œ
    loadLogsFromStorage() {
        try {
            const savedLogs = localStorage.getItem('unifiedControlLogs');
            if (savedLogs) {
                this.logBuffer = JSON.parse(savedLogs);
                // ì˜¤ë˜ëœ ë¡œê·¸ ì œê±° (24ì‹œê°„ ì´ìƒ)
                const now = new Date().getTime();
                this.logBuffer = this.logBuffer.filter(log => {
                    const logTime = new Date(log.fullTimestamp).getTime();
                    return (now - logTime) < (24 * 60 * 60 * 1000);
                });
            }
        } catch (error) {
            console.error('Failed to load logs from storage:', error);
            this.logBuffer = [];
        }
    }
    
    // localStorageì— ë¡œê·¸ ì €ì¥
    saveLogsToStorage() {
        try {
            localStorage.setItem('unifiedControlLogs', JSON.stringify(this.logBuffer));
        } catch (error) {
            console.error('Failed to save logs to storage:', error);
        }
    }
    
    // ì„œë²„ì—ì„œ ìµœì‹  ë¡œê·¸ ì—…ë°ì´íŠ¸
    async updateLogs() {
        try {
            const response = await fetch('/api/collection/status');
            const data = await response.json();
            
            if (data.logs && Array.isArray(data.logs)) {
                // ì„œë²„ ë¡œê·¸ë¥¼ ë¡œì»¬ ë¡œê·¸ì™€ ë³‘í•©
                data.logs.forEach(log => {
                    // ì•¡ì…˜ì— ë”°ë¥¸ ë¡œê·¸ ë©”ì‹œì§€ ìƒì„±
                    let message = '';
                    let type = 'info';
                    
                    switch(log.action) {
                        case 'collection_enabled':
                            message = 'ìˆ˜ì§‘ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤';
                            type = 'success';
                            break;
                        case 'collection_disabled':
                            message = 'ìˆ˜ì§‘ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤';
                            type = 'warning';
                            break;
                        case 'collection_triggered':
                            message = `${log.source.toUpperCase()} ìˆ˜ì§‘ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤`;
                            type = 'info';
                            break;
                        case 'collection_completed':
                            message = `${log.source.toUpperCase()} ìˆ˜ì§‘ ì™„ë£Œ: ${log.details.ips_collected || 0}ê°œ IP`;
                            type = 'success';
                            break;
                        case 'collection_failed':
                            message = `${log.source.toUpperCase()} ìˆ˜ì§‘ ì‹¤íŒ¨: ${log.details.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
                            type = 'error';
                            break;
                        default:
                            message = `${log.source}: ${log.action}`;
                            type = 'info';
                    }
                    
                    // ì¤‘ë³µ ì œê±°ë¥¼ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ í™•ì¸
                    const exists = this.logBuffer.some(
                        existingLog => existingLog.fullTimestamp === log.timestamp
                    );
                    
                    if (!exists && message) {
                        this.addLog(type, message, new Date(log.timestamp));
                    }
                });
                
                this.renderLogs();
            }
        } catch (error) {
            console.error('Failed to update logs:', error);
        }
    }
    
    // Check collection status
    async checkCollectionStatus() {
        try {
            // ëŒ€ì‹œë³´ë“œì™€ ë™ì¼í•œ API ì‚¬ìš©í•˜ì—¬ ì¼ê´€ì„± ë³´ì¥
            const [statusResponse, statsResponse] = await Promise.all([
                fetch('/api/collection/status'),
                fetch('/api/stats')
            ]);
            
            const statusData = await statusResponse.json();
            const statsData = await statsResponse.json();
            
            // í†µê³„ ë°ì´í„°ë¥¼ ìš°ì„  ì‚¬ìš© (ëŒ€ì‹œë³´ë“œì™€ ë™ì¼í•œ ë°ì´í„°)
            const combinedData = {
                ...statusData,
                stats: {
                    total_ips: statsData.details?.total_ips || statusData.stats?.total_ips || 0,
                    active_ips: statsData.details?.active_ips || statusData.stats?.total_ips || 0,
                    regtech_count: statsData.details?.regtech_count || 0,
                    today_collected: statusData.stats?.today_collected || 0
                }
            };
            
            this.updateOverallStatus(combinedData);
            this.updateCollectorStatus('regtech', statusData.sources?.regtech);
            
            // Update buttons
            document.getElementById('enable-collection').disabled = statusData.collection_enabled;
            document.getElementById('disable-collection').disabled = !statusData.collection_enabled;
            
            // Update trigger buttons (ìˆ˜ë™ìˆ˜ì§‘ì€ í•­ìƒ í™œì„±í™”)
            document.getElementById('regtech-trigger').disabled = false;
            
            // Check daily collection status
            this.checkDailyCollectionStatus();
            
        } catch (error) {
            console.error('Status check failed:', error);
            this.addLog('error', 'Failed to check collection status');
        }
    }
    
    // Check daily collection status
    async checkDailyCollectionStatus() {
        try {
            const response = await fetch('/api/collection/daily/status');
            const data = await response.json();
            
            if (data.success) {
                updateDailyCollectionStatus(data);
            } else {
                console.error('Daily collection status check failed:', data.error);
            }
        } catch (error) {
            console.error('Daily collection status check failed:', error);
        }
    }
    
    // Update overall status
    updateOverallStatus(data) {
        const statusBadge = document.querySelector('#collection-status-badge .badge');
        const totalIps = document.getElementById('total-ips');
        const todayCollected = document.getElementById('today-collected');
        const lastCollection = document.getElementById('last-collection');
        
        if (data.collection_enabled) {
            statusBadge.className = 'badge bg-success';
            statusBadge.textContent = 'ìë™ ìˆ˜ì§‘ í™œì„±';
        } else {
            statusBadge.className = 'badge bg-light text-dark';
            statusBadge.textContent = 'ìë™ ìˆ˜ì§‘ ë¹„í™œì„±';
        }
        
        // ëŒ€ì‹œë³´ë“œì™€ ë™ì¼í•œ í†µê³„ ë°ì´í„° ì‚¬ìš©
        if (data.stats) {
            totalIps.textContent = (data.stats.total_ips || 0).toLocaleString();
            todayCollected.textContent = (data.stats.today_collected || 0).toLocaleString();
        } else if (data.summary) {
            // í´ë°±: ê¸°ì¡´ summary ë°ì´í„° ì‚¬ìš©
            totalIps.textContent = (data.summary.total_ips_collected || 0).toLocaleString();
            todayCollected.textContent = '0';
        }
        
        if (data.last_enabled_at) {
            lastCollection.textContent = this.formatTime(data.last_enabled_at);
        }
    }
    
    // Update individual collector status
    updateCollectorStatus(collector, status) {
        if (!status) return;
        
        const elements = {
            status: document.getElementById(`${collector}-status`),
            lastRun: document.getElementById(`${collector}-last-run`),
            ipCount: document.getElementById(`${collector}-ip-count`),
            progress: document.getElementById(`${collector}-progress`)
        };
        
        // Status badge
        if (status.enabled) {
            elements.status.className = 'badge bg-success';
            elements.status.textContent = 'í™œì„±';
        } else {
            elements.status.className = 'badge bg-secondary';
            elements.status.textContent = 'ë¹„í™œì„±';
        }
        
        // Last run
        if (status.last_collection) {
            elements.lastRun.textContent = this.formatTime(status.last_collection);
        }
        
        // IP count
        if (status.total_ips !== undefined) {
            elements.ipCount.textContent = status.total_ips.toLocaleString();
        }
    }
    
    // Load collection logs from server
    async loadCollectionLogs() {
        try {
            const response = await fetch('/api/collection/logs');
            const data = await response.json();
            
            if (data.success && data.logs) {
                // ì„œë²„ì—ì„œ ë°›ì€ ë¡œê·¸ë¥¼ ê¸°ì¡´ ë¡œê·¸ì™€ ë³‘í•©
                data.logs.forEach(log => {
                    // ìƒì„¸ ì •ë³´ ì¶”ì¶œ
                    const details = log.details || {};
                    const message = this.formatCollectionLogMessage(log.source, log.action, details);
                    
                    this.addServerLog(
                        this.getLogLevel(log.action),
                        message,
                        log.source,
                        details,
                        log.timestamp
                    );
                });
                
                this.renderLogs();
            }
        } catch (error) {
            console.error('Failed to load collection logs:', error);
        }
    }
    
    // Format collection log message
    formatCollectionLogMessage(source, action, details) {
        const ip_count = details.ip_count || details.collected_count || 0;
        const sourceName = source === 'regtech' ? 'REGTECH' : 
        
        switch (action) {
            case 'collection_start':
                return `${sourceName} ìˆ˜ì§‘ ì‹œì‘`;
            case 'collection_complete':
                return `${sourceName} ìˆ˜ì§‘ ì™„ë£Œ: ${ip_count.toLocaleString()}ê°œ IP`;
            case 'collection_error':
                return `${sourceName} ìˆ˜ì§‘ ì‹¤íŒ¨: ${details.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
            case 'db_clear':
                return `ë°ì´í„°ë² ì´ìŠ¤ í´ë¦¬ì–´: ${details.total_deleted || 0}ê°œ ë ˆì½”ë“œ ì‚­ì œ`;
            case 'enable':
                return `${sourceName} ìˆ˜ì§‘ í™œì„±í™”`;
            case 'disable':
                return `${sourceName} ìˆ˜ì§‘ ë¹„í™œì„±í™”`;
            default:
                return `${sourceName}: ${action}`;
        }
    }
    
    // Get log level based on action
    getLogLevel(action) {
        switch (action) {
            case 'collection_complete':
            case 'enable':
                return 'success';
            case 'collection_error':
                return 'error';
            case 'db_clear':
            case 'disable':
                return 'warning';
            default:
                return 'info';
        }
    }
    
    // Add server log (different from addLog to avoid duplicates)
    addServerLog(level, message, collector = null, details = null, timestamp = null) {
        const serverTimestamp = timestamp ? new Date(timestamp) : new Date();
        const displayTimestamp = serverTimestamp.toLocaleTimeString('ko-KR');
        const collectorTag = collector ? `[${collector.toUpperCase()}]` : '';
        
        const logEntry = {
            timestamp: displayTimestamp,
            fullTimestamp: serverTimestamp.toISOString(),
            level,
            message,
            collector,
            details,
            html: `
                <div class="log-entry ${level}">
                    <div class="log-main">
                        <strong>${displayTimestamp}</strong> ${collectorTag} ${message}
                    </div>
                </div>
            `
        };
        
        // ì„œë²„ ë¡œê·¸ëŠ” ì¤‘ë³µ ì²´í¬ í›„ ì¶”ê°€
        const exists = this.logBuffer.some(log => 
            log.fullTimestamp === logEntry.fullTimestamp && 
            log.message === logEntry.message
        );
        
        if (!exists) {
            this.logBuffer.push(logEntry);
        }
        
        // Limit log buffer
        if (this.logBuffer.length > this.maxLogs) {
            this.logBuffer.shift();
        }
    }
    
    // Load daily stats
    async loadDailyStats() {
        try {
            const response = await fetch('/api/collection/daily-stats?days=30');
            const data = await response.json();
            
            if (data.success && data.data) {
                this.renderDailyStats(data.data);
                
                // ì‹œê°í™” ì°¨íŠ¸ ë Œë”ë§
                if (data.visualization) {
                    this.renderDailyChart(data.visualization);
                }
            }
        } catch (error) {
            console.error('Failed to load daily stats:', error);
            this.showError('ì¼ë³„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    // Render daily stats table
    renderDailyStats(stats) {
        const tbody = document.getElementById('daily-stats-tbody');
        if (!tbody) return;
        
        if (stats.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-muted">
                        ì¼ë³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = stats.map(stat => {
            const date = new Date(stat.date);
            const dateStr = date.toLocaleDateString('ko-KR', { 
                month: '2-digit', 
                day: '2-digit',
                weekday: 'short'
            });
            
            const totalIPs = stat.total_ips || 0;
            const regtech = stat.regtech_count || 0;
            const publicCount = stat.public_count || 0;
            const newIPs = stat.new_ips || 0;
            const expiredIPs = stat.expired_ips || 0;
            
            const statusBadge = totalIPs > 0 
                ? '<span class="badge bg-success">ìˆ˜ì§‘ë¨</span>'
                : '<span class="badge bg-secondary">ë°ì´í„° ì—†ìŒ</span>';
            
            return `
                <tr>
                    <td>${dateStr}</td>
                    <td><strong>${totalIPs.toLocaleString()}</strong></td>
                    <td class="text-primary">${regtech.toLocaleString()}</td>
                    <td class="text-info">${publicCount.toLocaleString()}</td>
                    <td><span class="text-success">+${newIPs.toLocaleString()}</span></td>
                    <td><span class="text-danger">-${expiredIPs.toLocaleString()}</span></td>
                    <td>${statusBadge}</td>
                </tr>
            `;
        }).join('');
    }
    
    // Render daily collection chart
    renderDailyChart(visualization) {
        const ctx = document.getElementById('dailyCollectionChart');
        if (!ctx) return;
        
        // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
        if (this.dailyChart) {
            this.dailyChart.destroy();
        }
        
        // ìƒˆ ì°¨íŠ¸ ìƒì„±
        this.dailyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: visualization.labels,
                datasets: visualization.datasets.map(dataset => ({
                    ...dataset,
                    fill: false,
                    tension: 0.3
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'ë‚ ì§œë³„ ìˆ˜ì§‘ í˜„í™© (ìµœê·¼ 30ì¼)'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'IP ê°œìˆ˜'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'ë‚ ì§œ'
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        if (visualization.totals) {
            document.getElementById('chart-total-regtech').textContent = 
                visualization.totals.regtech_total.toLocaleString();
            document.getElementById('chart-total-secudium').textContent = 
                visualization.totals.secudium_total.toLocaleString();
            document.getElementById('chart-total-duplicates').textContent = 
                visualization.totals.total_duplicates.toLocaleString();
        }
        
        // ìˆ˜ì§‘ ì¼ìˆ˜ ê³„ì‚°
        const collectionDays = visualization.labels.length;
        document.getElementById('chart-collection-days').textContent = collectionDays;
    }
    
    // Start status polling
    startStatusPolling() {
        this.statusInterval = setInterval(() => {
            this.checkCollectionStatus();
            this.loadCollectionLogs(); // ì£¼ê¸°ì ìœ¼ë¡œ ë¡œê·¸ë„ ì—…ë°ì´íŠ¸
            this.loadDailyStats(); // ì¼ë³„ ë°ì´í„°ë„ ì—…ë°ì´íŠ¸
        }, this.updateInterval); // ì„¤ì •ëœ ê°„ê²©ìœ¼ë¡œ ì—…ë°ì´íŠ¸
        
        // ì—…ë°ì´íŠ¸ ê°„ê²© í‘œì‹œ
        this.showUpdateInterval();
    }
    
    // ì—…ë°ì´íŠ¸ ê°„ê²© í‘œì‹œ
    showUpdateInterval() {
        const hours = Math.floor(this.updateInterval / 3600000);
        const minutes = Math.floor((this.updateInterval % 3600000) / 60000);
        let intervalText = '';
        
        if (hours > 0) {
            intervalText = `${hours}ì‹œê°„`;
            if (minutes > 0) {
                intervalText += ` ${minutes}ë¶„`;
            }
        } else {
            intervalText = `${minutes}ë¶„`;
        }
        
        console.log(`í†µí•© ì œì–´ í˜ì´ì§€ ìë™ ì—…ë°ì´íŠ¸ ê°„ê²©: ${intervalText}`);
    }
    
    // Add log entry with detailed information
    addLog(level, message, timestampOrCollector = null, details = null) {
        let now, collector;
        
        // íƒ€ì„ìŠ¤íƒ¬í”„ì™€ collector êµ¬ë¶„
        if (timestampOrCollector instanceof Date) {
            now = timestampOrCollector;
            collector = null;
        } else {
            now = new Date();
            collector = timestampOrCollector;
        }
        
        const timestamp = now.toLocaleTimeString('ko-KR');
        const collectorTag = collector ? `[${collector.toUpperCase()}]` : '';
        
        const logEntry = {
            timestamp,
            fullTimestamp: now.toISOString(),
            level,
            message,
            collector,
            details,
            html: `
                <div class="log-entry ${level}">
                    <div class="log-main">
                        <strong>${timestamp}</strong> ${collectorTag} ${message}
                    </div>
                </div>
            `
        };
        
        this.logBuffer.push(logEntry);
        
        // Limit log buffer
        if (this.logBuffer.length > this.maxLogs) {
            this.logBuffer.shift();
        }
        
        this.renderLogs();
        this.saveLogsToStorage(); // ë¡œê·¸ ì €ì¥
    }
    
    // Clear logs
    clearLogs() {
        this.logBuffer = [];
        this.saveLogsToStorage();
        this.renderLogs();
        this.addLog('info', 'ë¡œê·¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
    
    // Render logs
    renderLogs() {
        const logContainer = document.getElementById('collection-logs');
        
        if (this.logBuffer.length === 0) {
            logContainer.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="bi bi-clock-history"></i> ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
                </div>
            `;
            return;
        }
        
        logContainer.innerHTML = this.logBuffer
            .map(log => log.html)
            .reverse()
            .join('');
        
        // Auto scroll
        logContainer.scrollTop = 0;
    }
    
    // Format time
    formatTime(timeString) {
        const date = new Date(timeString);
        const now = new Date();
        const diff = now - date;
        
        if (diff < 60000) {
            return 'ë°©ê¸ˆ ì „';
        }
        
        if (diff < 3600000) {
            return `${Math.floor(diff / 60000)}ë¶„ ì „`;
        }
        
        if (diff < 86400000) {
            return `${Math.floor(diff / 3600000)}ì‹œê°„ ì „`;
        }
        
        return date.toLocaleDateString('ko-KR');
    }
    
    // Cleanup
    destroy() {
        if (this.statusInterval) {
            clearInterval(this.statusInterval);
        }
    }
}

// Global instance
let unifiedControl = null;

// Toggle collection
async function toggleCollection(enable) {
    const action = enable ? 'enable' : 'disable';
    
    if (enable && !confirm('ìˆ˜ì§‘ì„ í™œì„±í™”í•˜ë©´ ê¸°ì¡´ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/collection/${action}`, { method: 'POST' });
        const data = await response.json();
        
        if (data.success || data.status === 'success') {
            showNotification(`ìˆ˜ì§‘ì´ ${enable ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            unifiedControl.checkCollectionStatus();
            unifiedControl.addLog('success', 
                `ìˆ˜ì§‘ì´ ${enable ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            // ë¡œê·¸ ìƒˆë¡œê³ ì¹¨
            setTimeout(() => {
                unifiedControl.updateLogs();
            }, 1000);
        } else {
            throw new Error(data.message || 'Operation failed');
        }
    } catch (error) {
        showNotification(`Error: ${error.message}`, 'danger');
        unifiedControl.addLog('error', `Failed to ${action} collection: ${error.message}`);
    }
}

// Trigger collection
async function triggerCollection(collector) {
    if (!confirm(`${collector.toUpperCase()} ìˆ˜ì§‘ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }
    
    try {
        const button = document.getElementById(`${collector}-trigger`);
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ìˆ˜ì§‘ ì¤‘...';
        
        const response = await fetch(`/api/collection/${collector}/trigger`, { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        });
        const data = await response.json();
        
        if (data.success === true) {
            showNotification(`${collector.toUpperCase()} ìˆ˜ì§‘ ì™„ë£Œ`, 'success');
            unifiedControl.addLog('success', 
                `${collector.toUpperCase()} ìˆ˜ì§‘ ì™„ë£Œ: ${data.details?.collected || 0}ê°œ IP`, 
                collector);
                
            // Refresh status
            unifiedControl.checkCollectionStatus();
        } else {
            throw new Error(data.message || data.error || 'Collection failed');
        }
    } catch (error) {
        showNotification(`Error: ${error.message}`, 'danger');
        unifiedControl.addLog('error', 
            `${collector.toUpperCase()} collection failed: ${error.message}`, 
            collector);
    } finally {
        const button = document.getElementById(`${collector}-trigger`);
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-cloud-download"></i> ìˆ˜ë™ ìˆ˜ì§‘ ì‹¤í–‰';
    }
}

// Refresh data
async function refreshData() {
    showNotification('ë°ì´í„°ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤...', 'info');
    await unifiedControl.checkCollectionStatus();
    showNotification('ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ', 'success');
}

// Cleanup old data
async function cleanupOldData() {
    if (!confirm('3ê°œì›” ì´ìƒ ëœ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/cleanup-old-data', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            showNotification('ì˜¤ë˜ëœ ë°ì´í„° ì •ë¦¬ ì™„ë£Œ', 'success');
            unifiedControl.addLog('success', `Cleaned up ${data.deleted_count || 0} old records`);
        } else {
            throw new Error(data.message || 'Cleanup failed');
        }
    } catch (error) {
        showNotification(`Error: ${error.message}`, 'danger');
        unifiedControl.addLog('error', `Cleanup failed: ${error.message}`);
    }
}

// Clear logs
function clearLogs() {
    if (confirm('ëª¨ë“  ë¡œê·¸ë¥¼ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        unifiedControl.clearLogs();
    }
}

// Clear all database data
async function clearAllData() {
    if (!confirm('âš ï¸ ê²½ê³ : ëª¨ë“  ë°ì´í„°ë² ì´ìŠ¤ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.\n\nì •ë§ë¡œ ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    if (!confirm('ğŸš¨ ìµœì¢… í™•ì¸: ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!\n\nëª¨ë“  IP ë°ì´í„°, í†µê³„, ë¡œê·¸ê°€ ì‚­ì œë©ë‹ˆë‹¤.\n\nì •ë§ë¡œ DBë¥¼ í´ë¦¬ì–´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/database/clear', { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ confirm: true })
        });
        const data = await response.json();
        
        if (data.success) {
            showNotification('ë°ì´í„°ë² ì´ìŠ¤ê°€ ì„±ê³µì ìœ¼ë¡œ í´ë¦¬ì–´ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            unifiedControl.addLog('warning', `Database cleared: ${data.message || 'All data removed'}`);
            // Refresh all data
            await unifiedControl.checkCollectionStatus();
        } else {
            throw new Error(data.message || 'DB í´ë¦¬ì–´ ì‹¤íŒ¨');
        }
    } catch (error) {
        showNotification(`Error: ${error.message}`, 'danger');
        unifiedControl.addLog('error', `DB clear failed: ${error.message}`);
    }
}

// Toggle daily collection
async function toggleDailyCollection(enable) {
    try {
        const action = enable ? 'enable' : 'disable';
        const endpoint = `/api/collection/daily/${action}`;
        
        const response = await fetch(endpoint, { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                enable: enable,
                collection_strategy: enable ? 'daily_3days' : null 
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            const message = enable ? 'ì¼ì¼ ìë™ ìˆ˜ì§‘ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì¼ì¼ ìë™ ìˆ˜ì§‘ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.';
            showNotification(message, 'success');
            
            // Update daily collection status badge
            const dailyBadge = document.querySelector('#daily-collection-status-badge .badge');
            if (enable) {
                dailyBadge.className = 'badge bg-success';
                dailyBadge.textContent = 'ì¼ì¼ìˆ˜ì§‘ í™œì„±';
            } else {
                dailyBadge.className = 'badge bg-secondary';
                dailyBadge.textContent = 'ì¼ì¼ìˆ˜ì§‘ ë¹„í™œì„±';
            }
            
            // Update button states
            document.getElementById('enable-daily-collection').disabled = enable;
            document.getElementById('disable-daily-collection').disabled = !enable;
            
            unifiedControl.addLog(enable ? 'success' : 'warning', 
                `Daily collection ${enable ? 'enabled' : 'disabled'}`, 
                'system');
                
            // Refresh collection status
            await unifiedControl.checkCollectionStatus();
        } else {
            throw new Error(data.message || `Failed to ${action} daily collection`);
        }
    } catch (error) {
        showNotification(`Error: ${error.message}`, 'danger');
        unifiedControl.addLog('error', `Daily collection toggle failed: ${error.message}`, 'system');
    }
}

// Check daily collection status (add to UnifiedControl class method)
// This will be called from checkCollectionStatus
function updateDailyCollectionStatus(data) {
    const dailyBadge = document.querySelector('#daily-collection-status-badge .badge');
    const dailyEnabled = data.daily_collection_enabled || false;
    
    if (dailyEnabled) {
        dailyBadge.className = 'badge bg-success';
        dailyBadge.textContent = 'ì¼ì¼ìˆ˜ì§‘ í™œì„±';
    } else {
        dailyBadge.className = 'badge bg-secondary';
        dailyBadge.textContent = 'ì¼ì¼ìˆ˜ì§‘ ë¹„í™œì„±';
    }
    
    // Update button states
    document.getElementById('enable-daily-collection').disabled = dailyEnabled;
    document.getElementById('disable-daily-collection').disabled = !dailyEnabled;
}

// Show notification
function showNotification(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// === ìˆ˜ì§‘ ê´€ë ¨ í•¨ìˆ˜ë“¤ ===

// ìˆ˜ë™ ìˆ˜ì§‘ íŠ¸ë¦¬ê±°
async function triggerManualCollection() {
    const btn = document.getElementById('manual-collection-btn');
    const logContainer = document.getElementById('visual-collection-log');
    
    // ë²„íŠ¼ ë¹„í™œì„±í™”
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> ìˆ˜ì§‘ ì¤‘...';
    
    // ë¡œê·¸ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
    logContainer.innerHTML = '';
    
    try {
        // ì‹œê°ì  ë¡œê·¸ í•¨ìˆ˜
        const addVisualLog = (message, type = 'info') => {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `
                <small class="text-muted">${new Date().toLocaleTimeString()}</small>
                <br>
                ${message}
            `;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        };
        
        // ê¸°ê°„ ì„ íƒ ê°’ ê°€ì ¸ì˜¤ê¸°
        const startDate = document.getElementById('manual-start-date').value;
        const endDate = document.getElementById('manual-end-date').value;
        
        // ë‚ ì§œ í¬ë§· ë³€í™˜ (YYYY-MM-DD -> YYYYMMDD)
        const formatDate = (dateStr) => dateStr ? dateStr.replace(/-/g, '') : null;
        
        const requestData = {
            source: 'regtech'
        };
        
        // ê¸°ê°„ì´ ì§€ì •ëœ ê²½ìš° ì¶”ê°€
        if (startDate && endDate) {
            requestData.start_date = formatDate(startDate);
            requestData.end_date = formatDate(endDate);
            addVisualLog(`ğŸ“… ìˆ˜ì§‘ ê¸°ê°„: ${startDate} ~ ${endDate}`, 'info');
        } else {
            addVisualLog('ğŸ“… ê¸°ê°„ ë¯¸ì§€ì • - ì˜¤ëŠ˜ ë‚ ì§œë¡œ ìˆ˜ì§‘', 'info');
        }
        
        addVisualLog('ğŸš€ ìˆ˜ì§‘ ìš”ì²­ì„ ì„œë²„ë¡œ ì „ì†¡ ì¤‘...', 'info');
        
        const response = await fetch('/api/collection/regtech/trigger', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        const result = await response.json();
        
        // ì„œë²„ì—ì„œ ë°˜í™˜ëœ ì‹œê°ì  ë¡œê·¸ í‘œì‹œ
        if (result.visual_log && Array.isArray(result.visual_log)) {
            logContainer.innerHTML = ''; // ê¸°ì¡´ ë¡œê·¸ ì‚­ì œ
            result.visual_log.forEach((logMessage, index) => {
                setTimeout(() => {
                    addVisualLog(logMessage, getLogTypeFromMessage(logMessage));
                }, index * 500); // 0.5ì´ˆ ê°„ê²©ìœ¼ë¡œ í‘œì‹œ
            });
        }
        
        if (result.success) {
            // ì„±ê³µì‹œ ì¶”ê°€ ì •ë³´ í‘œì‹œ
            setTimeout(() => {
                addVisualLog(`âœ… ìˆ˜ì§‘ ì™„ë£Œ: ${result.details?.collected || 0}ê°œ IP ìˆ˜ì§‘ë¨`, 'success');
            }, result.visual_log ? result.visual_log.length * 500 : 1000);
            
            showNotification(result.message || 'ìˆ˜ì§‘ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            
            // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
            setTimeout(() => {
                refreshData();
            }, 2000);
        } else {
            addVisualLog(`âŒ ìˆ˜ì§‘ ì‹¤íŒ¨: ${result.message}`, 'error');
            showNotification(result.message || 'ìˆ˜ì§‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
        }
        
    } catch (error) {
        console.error('Manual collection error:', error);
        const logContainer = document.getElementById('visual-collection-log');
        logContainer.innerHTML = `
            <div class="log-entry error">
                <small class="text-muted">${new Date().toLocaleTimeString()}</small>
                <br>
                âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}
            </div>
        `;
        showNotification('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
    } finally {
        // ë²„íŠ¼ ë³µêµ¬
        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-download-cloud"></i> ìˆ˜ë™ ìˆ˜ì§‘ ì‹œì‘';
        }, 3000);
    }
}

// ë¡œê·¸ ë©”ì‹œì§€ì—ì„œ íƒ€ì… ì¶”ì¶œ
function getLogTypeFromMessage(message) {
    if (message.includes('âŒ') || message.includes('ì˜¤ë¥˜') || message.includes('ì‹¤íŒ¨')) {
        return 'error';
    } else if (message.includes('âœ…') || message.includes('ì™„ë£Œ') || message.includes('ì„±ê³µ')) {
        return 'success';
    } else if (message.includes('âš ï¸') || message.includes('ê²½ê³ ')) {
        return 'warning';
    } else {
        return 'info';
    }
}

// REGTECH ì¿ í‚¤ ì„¤ì • ëª¨ë‹¬ í‘œì‹œ
function showCookieSettings() {
    // Bootstrap ëª¨ë‹¬ ìƒì„±
    const modalHtml = `
        <div class="modal fade" id="cookieSettingsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-gear"></i> REGTECH ì¿ í‚¤ ì„¤ì •
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            REGTECH ì‚¬ì´íŠ¸ì—ì„œ ë¡œê·¸ì¸ í›„ ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ì—ì„œ ì¿ í‚¤ ê°’ì„ ë³µì‚¬í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”.
                        </div>
                        
                        <form id="cookieSettingsForm">
                            <div class="mb-3">
                                <label class="form-label">Google Analytics ì¿ í‚¤ (_ga)</label>
                                <input type="text" class="form-control" id="regtech_cookie_ga" placeholder="GA1.1.1689204774.1752555033">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Front ì„¸ì…˜ ì¿ í‚¤ (regtech-front)</label>
                                <input type="text" class="form-control" id="regtech_cookie_front" placeholder="2F3B7CE1B26084FCD546BDB56CE9ABAC">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">ì¸ì¦ í† í° ì¿ í‚¤ (regtech-va)</label>
                                <textarea class="form-control" id="regtech_cookie_va" rows="3" placeholder="Bearer eyJ0eXAiOi..."></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">GA Analytics ì¿ í‚¤ (_ga_7WRDYHF66J)</label>
                                <input type="text" class="form-control" id="regtech_cookie_ga_analytics" placeholder="GS2.1.s1752743223$o3$g1$t1752746099$j38$l0$h0">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                        <button type="button" class="btn btn-primary" onclick="saveCookieSettings()">ì €ì¥</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
    const existingModal = document.getElementById('cookieSettingsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // ìƒˆ ëª¨ë‹¬ ì¶”ê°€
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // í˜„ì¬ ì„¤ì • ë¡œë“œ
    loadCurrentCookieSettings();
    
    // ëª¨ë‹¬ í‘œì‹œ
    const modal = new bootstrap.Modal(document.getElementById('cookieSettingsModal'));
    modal.show();
}

// í˜„ì¬ ì¿ í‚¤ ì„¤ì • ë¡œë“œ
async function loadCurrentCookieSettings() {
    try {
        const response = await fetch('/api/settings/regtech/cookies');
        const result = await response.json();
        
        if (result.success && result.cookies) {
            document.getElementById('regtech_cookie_ga').value = result.cookies.regtech_cookie_ga || '';
            document.getElementById('regtech_cookie_front').value = result.cookies.regtech_cookie_front || '';
            document.getElementById('regtech_cookie_va').value = result.cookies.regtech_cookie_va || '';
            document.getElementById('regtech_cookie_ga_analytics').value = result.cookies.regtech_cookie_ga_analytics || '';
        }
    } catch (error) {
        console.error('Failed to load cookie settings:', error);
    }
}

// ì¿ í‚¤ ì„¤ì • ì €ì¥
async function saveCookieSettings() {
    const cookieData = {
        regtech_cookie_ga: document.getElementById('regtech_cookie_ga').value,
        regtech_cookie_front: document.getElementById('regtech_cookie_front').value,
        regtech_cookie_va: document.getElementById('regtech_cookie_va').value,
        regtech_cookie_ga_analytics: document.getElementById('regtech_cookie_ga_analytics').value
    };
    
    try {
        const response = await fetch('/api/settings/regtech/cookies', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(cookieData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(result.message || 'ì¿ í‚¤ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            
            // ëª¨ë‹¬ ë‹«ê¸°
            const modal = bootstrap.Modal.getInstance(document.getElementById('cookieSettingsModal'));
            modal.hide();
        } else {
            showNotification(result.message || 'ì¿ í‚¤ ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
        }
    } catch (error) {
        console.error('Failed to save cookie settings:', error);
        showNotification('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
    }
}

// ìë™ ìˆ˜ì§‘ ì„¤ì • ëª¨ë‹¬ í‘œì‹œ
function showAutoCollectionSettings() {
    const modalHtml = `
        <div class="modal fade" id="autoCollectionModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-clock-history"></i> ìë™ ìˆ˜ì§‘ ì„¤ì •
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            ìë™ ìˆ˜ì§‘ì€ ì„œë²„ê°€ ì •ê¸°ì ìœ¼ë¡œ REGTECH ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤. ì¿ í‚¤ ì„¤ì •ì´ ì˜¬ë°”ë¥´ê²Œ êµ¬ì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
                        </div>
                        
                        <form id="autoCollectionForm">
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="auto_collection_enabled">
                                    <label class="form-check-label" for="auto_collection_enabled">
                                        ìë™ ìˆ˜ì§‘ í™œì„±í™”
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3" id="auto-collection-options">
                                <label class="form-label">ìˆ˜ì§‘ ì£¼ê¸° (ë¶„)</label>
                                <select class="form-select" id="collection_interval_minutes">
                                    <option value="30">30ë¶„</option>
                                    <option value="60" selected>1ì‹œê°„</option>
                                    <option value="120">2ì‹œê°„</option>
                                    <option value="360">6ì‹œê°„</option>
                                    <option value="720">12ì‹œê°„</option>
                                    <option value="1440">24ì‹œê°„</option>
                                </select>
                            </div>
                            
                            <div class="mb-3" id="schedule-options">
                                <label class="form-label">ì‹œì‘ ì‹œê°„</label>
                                <select class="form-select" id="collection_schedule_hour">
                                    ${Array.from({length: 24}, (_, i) => 
                                        `<option value="${i}" ${i === 9 ? 'selected' : ''}>${i.toString().padStart(2, '0')}:00</option>`
                                    ).join('')}
                                </select>
                                <div class="form-text">ìë™ ìˆ˜ì§‘ì„ ì‹œì‘í•  ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”.</div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="regtech_auto_enabled" checked>
                                    <label class="form-check-label" for="regtech_auto_enabled">
                                        REGTECH ìë™ ìˆ˜ì§‘ í¬í•¨
                                    </label>
                                </div>
                            </div>
                        </form>
                        
                        <div id="auto-collection-status" class="mt-3">
                            <small class="text-muted">í˜„ì¬ ì„¤ì •ì„ ë¡œë“œ ì¤‘...</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                        <button type="button" class="btn btn-primary" onclick="saveAutoCollectionSettings()">ì €ì¥</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
    const existingModal = document.getElementById('autoCollectionModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // ìƒˆ ëª¨ë‹¬ ì¶”ê°€
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // ìë™ ìˆ˜ì§‘ ì˜µì…˜ í† ê¸€ ì´ë²¤íŠ¸
    document.getElementById('auto_collection_enabled').addEventListener('change', function() {
        const options = document.getElementById('auto-collection-options');
        const scheduleOptions = document.getElementById('schedule-options');
        if (this.checked) {
            options.style.display = 'block';
            scheduleOptions.style.display = 'block';
        } else {
            options.style.display = 'none';
            scheduleOptions.style.display = 'none';
        }
    });
    
    // í˜„ì¬ ì„¤ì • ë¡œë“œ
    loadCurrentAutoCollectionSettings();
    
    // ëª¨ë‹¬ í‘œì‹œ
    const modal = new bootstrap.Modal(document.getElementById('autoCollectionModal'));
    modal.show();
}

// í˜„ì¬ ìë™ ìˆ˜ì§‘ ì„¤ì • ë¡œë“œ
async function loadCurrentAutoCollectionSettings() {
    try {
        const response = await fetch('/api/collection/auto/config');
        const result = await response.json();
        
        if (result.success && result.config) {
            const config = result.config;
            
            document.getElementById('auto_collection_enabled').checked = config.auto_collection_enabled || false;
            document.getElementById('collection_interval_minutes').value = config.collection_interval_minutes || 60;
            document.getElementById('collection_schedule_hour').value = config.collection_schedule_hour || 9;
            document.getElementById('regtech_auto_enabled').checked = config.regtech_auto_enabled !== false; // ê¸°ë³¸ê°’ true
            
            // ì˜µì…˜ í‘œì‹œ/ìˆ¨ê¹€
            const enabled = config.auto_collection_enabled || false;
            document.getElementById('auto-collection-options').style.display = enabled ? 'block' : 'none';
            document.getElementById('schedule-options').style.display = enabled ? 'block' : 'none';
            
            // ìƒíƒœ í‘œì‹œ
            const statusDiv = document.getElementById('auto-collection-status');
            if (config.last_auto_collection) {
                const lastTime = new Date(config.last_auto_collection).toLocaleString('ko-KR');
                statusDiv.innerHTML = `<small class="text-success">ë§ˆì§€ë§‰ ìë™ ìˆ˜ì§‘: ${lastTime}</small>`;
            } else {
                statusDiv.innerHTML = `<small class="text-muted">ì•„ì§ ìë™ ìˆ˜ì§‘ì´ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</small>`;
            }
        }
    } catch (error) {
        console.error('Failed to load auto collection settings:', error);
        document.getElementById('auto-collection-status').innerHTML = 
            `<small class="text-danger">ì„¤ì • ë¡œë“œ ì‹¤íŒ¨: ${error.message}</small>`;
    }
}

// ìë™ ìˆ˜ì§‘ ì„¤ì • ì €ì¥
async function saveAutoCollectionSettings() {
    const configData = {
        auto_collection_enabled: document.getElementById('auto_collection_enabled').checked,
        collection_interval_minutes: parseInt(document.getElementById('collection_interval_minutes').value),
        collection_schedule_hour: parseInt(document.getElementById('collection_schedule_hour').value),
        regtech_auto_enabled: document.getElementById('regtech_auto_enabled').checked
    };
    
    try {
        const response = await fetch('/api/collection/auto/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(configData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(result.message || 'ìë™ ìˆ˜ì§‘ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            
            // ëª¨ë‹¬ ë‹«ê¸°
            const modal = bootstrap.Modal.getInstance(document.getElementById('autoCollectionModal'));
            modal.hide();
            
            // ì‹œê°ì  ë¡œê·¸ì— ì„¤ì • ë³€ê²½ ì‚¬í•­ í‘œì‹œ
            const logContainer = document.getElementById('visual-collection-log');
            if (logContainer) {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry success';
                logEntry.innerHTML = `
                    <small class="text-muted">${new Date().toLocaleTimeString()}</small>
                    <br>
                    âš™ï¸ ìë™ ìˆ˜ì§‘ ì„¤ì • ì—…ë°ì´íŠ¸ë¨: ${configData.auto_collection_enabled ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}
                `;
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        } else {
            showNotification(result.message || 'ìë™ ìˆ˜ì§‘ ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
        }
    } catch (error) {
        console.error('Failed to save auto collection settings:', error);
        showNotification('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    unifiedControl = new UnifiedControl();
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (unifiedControl) {
        unifiedControl.destroy();
    }
});
</script>
{% endblock %}